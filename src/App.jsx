import React, { useState, useMemo, useRef, useEffect } from 'react';
import { Target, Calendar, ChevronLeft, ChevronRight, Plus, Trash2, BarChart3, CalendarDays, TrendingUp, TrendingDown, Award, CheckCircle2, XCircle, Home, ChevronDown, ChevronUp, LogOut, User, Sparkles, MessageCircle, Lightbulb, Wand2, Send, Loader2, Quote, Download, RefreshCw, Flame, Trophy, MessageSquare, Star, Crown, Medal, Heart, ThumbsUp, Zap, Camera, Image, Users, DollarSign, Swords, Gift, PartyPopper, MapPin, X, Edit3, Eye, Lock, Check, Sun, Moon, AlertCircle, Clock, Timer, Play, Pause, RotateCcw, Brain, Repeat, FileText, Coffee, ArrowRight, CheckSquare, Settings, Focus, Inbox, ListTodo, CalendarClock } from 'lucide-react';
import { XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart as RechartsPie, Pie, Cell, AreaChart, Area, RadarChart, Radar, PolarGrid, PolarAngleAxis, PolarRadiusAxis, BarChart, Bar } from 'recharts';

// Firebase imports
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy } from 'firebase/firestore';

// Supabase configuration
const SUPABASE_URL = 'https://nqwssoupzsrovtmshlht.supabase.co';
const SUPABASE_KEY = 'sb_publishable_BJubswL_3XMPckQNKibi4A_Ds6_M5wc';

// Anthropic API configuration
const ANTHROPIC_API_KEY = 'sk-ant-api03-placeholder'; // Replace with actual key or use environment variable

// Brand Logo (base64 encoded)
const LOGO_BASE64 = "data:image/png;base64,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";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBKRKnQjV2r7DDEL_BHIyl5Fi0JDAl4foc",
  authDomain: "the-accountability-group.firebaseapp.com",
  projectId: "the-accountability-group",
  storageBucket: "the-accountability-group.firebasestorage.app",
  messagingSenderId: "1060411657406",
  appId: "1:1060411657406:web:473bdee102d480a1e7e2ef",
  measurementId: "G-5W573SPKVB"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const googleProvider = new GoogleAuthProvider();

// Constants
const PARTICIPANTS = ['Taylor', 'Brandon', 'John'];
const DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
const STATUS_CONFIG = {
  'Exceeded': { color: '#10b981', bgColor: 'bg-emerald-100', textColor: 'text-emerald-700', darkBg: 'bg-emerald-500/20', darkText: 'text-emerald-400' },
  'Done': { color: '#22c55e', bgColor: 'bg-green-100', textColor: 'text-green-700', darkBg: 'bg-green-500/20', darkText: 'text-green-400' },
  'On Track': { color: '#3b82f6', bgColor: 'bg-blue-100', textColor: 'text-blue-700', darkBg: 'bg-blue-500/20', darkText: 'text-blue-400' },
  'At Risk': { color: '#f59e0b', bgColor: 'bg-amber-100', textColor: 'text-amber-700', darkBg: 'bg-amber-500/20', darkText: 'text-amber-400' },
  'Missed': { color: '#ef4444', bgColor: 'bg-red-100', textColor: 'text-red-700', darkBg: 'bg-red-500/20', darkText: 'text-red-400' },
  'Pending': { color: '#6b7280', bgColor: 'bg-gray-100', textColor: 'text-gray-600', darkBg: 'bg-gray-500/20', darkText: 'text-gray-400' }
};
const PARTICIPANT_COLORS = { 'Taylor': '#8b5cf6', 'Brandon': '#06b6d4', 'John': '#f97316' };

// Watermark Logo (base64 encoded - actual PNG)
const WATERMARK_BASE64 = "data:image/png;base64,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";

// Initial data - this will be loaded into Firebase on first run
const initialData = [
  { id: 1, habit: "Workout 4 Times", participant: "Taylor", weekStart: "2025-09-15", daysCompleted: [1, 4], target: 4 },
  { id: 2, habit: "Workout 4 Times", participant: "Brandon", weekStart: "2025-09-15", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 3, habit: "Explore Monday.com", participant: "Taylor", weekStart: "2025-09-15", daysCompleted: [2], target: 1 },
  { id: 4, habit: "No Panic Selling", participant: "Brandon", weekStart: "2025-09-15", daysCompleted: [0, 1, 3, 4], target: 5 },
  { id: 5, habit: "Explore CoHatch", participant: "Taylor", weekStart: "2025-09-15", daysCompleted: [], target: 1 },
  { id: 6, habit: "Buy Groceries", participant: "Brandon", weekStart: "2025-09-15", daysCompleted: [2], target: 1 },
  { id: 7, habit: "No Social Media 9-5pm", participant: "Taylor", weekStart: "2025-09-15", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 8, habit: "Real-Time Journaling", participant: "Brandon", weekStart: "2025-09-15", daysCompleted: [0, 2, 4], target: 5 },
  { id: 9, habit: "No J'n Around", participant: "Taylor", weekStart: "2025-09-15", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 10, habit: "No Social Media 9-5pm", participant: "Brandon", weekStart: "2025-09-15", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 11, habit: "Trade Execution", participant: "Brandon", weekStart: "2025-09-15", daysCompleted: [0, 2, 4], target: 5 },
  { id: 12, habit: "5:30am Run", participant: "Taylor", weekStart: "2025-09-22", daysCompleted: [], target: 3 },
  { id: 13, habit: "Workout 3 Times", participant: "Taylor", weekStart: "2025-09-22", daysCompleted: [], target: 3 },
  { id: 14, habit: "Dispo all deals from last week", participant: "Taylor", weekStart: "2025-09-22", daysCompleted: [], target: 1 },
  { id: 15, habit: "Visit One Client Unannounced", participant: "Taylor", weekStart: "2025-09-22", daysCompleted: [], target: 1 },
  { id: 16, habit: "File Taxes for 2023, 2024", participant: "Taylor", weekStart: "2025-09-22", daysCompleted: [], target: 1 },
  { id: 17, habit: "No Social Media 9-5pm", participant: "Taylor", weekStart: "2025-09-22", daysCompleted: [], target: 3 },
  { id: 18, habit: "Workout 4 Times", participant: "Brandon", weekStart: "2025-09-22", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 19, habit: "Meditate", participant: "Brandon", weekStart: "2025-09-22", daysCompleted: [0, 1, 2, 3, 4, 5], target: 5 },
  { id: 20, habit: "Follow through on Trades", participant: "Brandon", weekStart: "2025-09-22", daysCompleted: [2], target: 5 },
  { id: 21, habit: "Real-Time Journaling", participant: "Brandon", weekStart: "2025-09-22", daysCompleted: [0, 1, 3, 4], target: 5 },
  { id: 22, habit: "No Social Media 9-5pm", participant: "Brandon", weekStart: "2025-09-22", daysCompleted: [0, 1, 3, 4], target: 5 },
  { id: 23, habit: "Execute Trades", participant: "Brandon", weekStart: "2025-09-22", daysCompleted: [0, 2, 4], target: 5 },
  { id: 24, habit: "Cardio", participant: "John", weekStart: "2025-09-22", daysCompleted: [], target: 4 },
  { id: 25, habit: "Track everything I eat", participant: "John", weekStart: "2025-09-22", daysCompleted: [], target: 7 },
  { id: 26, habit: "Work on app 10 minutes", participant: "John", weekStart: "2025-09-22", daysCompleted: [], target: 7 },
  { id: 27, habit: "Meditate 20 min", participant: "John", weekStart: "2025-09-22", daysCompleted: [], target: 7 },
  { id: 28, habit: "No Social Media 9-5pm", participant: "John", weekStart: "2025-09-22", daysCompleted: [], target: 5 },
  { id: 29, habit: "Talk with or hang with 1+ friend/fam", participant: "John", weekStart: "2025-09-22", daysCompleted: [], target: 6 },
  { id: 30, habit: "Workout 4 Times", participant: "Brandon", weekStart: "2025-09-29", daysCompleted: [0, 2, 4], target: 4 },
  { id: 31, habit: "Meditate", participant: "Brandon", weekStart: "2025-09-29", daysCompleted: [0, 1, 3, 4], target: 5 },
  { id: 32, habit: "Follow through on Trades", participant: "Brandon", weekStart: "2025-09-29", daysCompleted: [], target: 5 },
  { id: 33, habit: "Real-Time Journaling", participant: "Brandon", weekStart: "2025-09-29", daysCompleted: [2], target: 5 },
  { id: 34, habit: "No Social Media 9-5pm", participant: "Brandon", weekStart: "2025-09-29", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 35, habit: "Execute Trades", participant: "Brandon", weekStart: "2025-09-29", daysCompleted: [1, 4], target: 5 },
  { id: 36, habit: "build a check list", participant: "Brandon", weekStart: "2025-09-29", daysCompleted: [2], target: 1 },
  { id: 37, habit: "end of the day review", participant: "Brandon", weekStart: "2025-09-29", daysCompleted: [2], target: 4 },
  { id: 38, habit: "Post 1 TikTok about Branches", participant: "John", weekStart: "2025-09-29", daysCompleted: [], target: 7 },
  { id: 39, habit: "Work on app 10 minutes", participant: "John", weekStart: "2025-09-29", daysCompleted: [], target: 7 },
  { id: 40, habit: "Track everything I eat", participant: "John", weekStart: "2025-09-29", daysCompleted: [], target: 7 },
  { id: 41, habit: "Cardio", participant: "John", weekStart: "2025-09-29", daysCompleted: [], target: 3 },
  { id: 42, habit: "Meditate 20 min", participant: "John", weekStart: "2025-09-29", daysCompleted: [], target: 7 },
  { id: 43, habit: "No Social Media 9-5pm", participant: "John", weekStart: "2025-09-29", daysCompleted: [], target: 5 },
  { id: 44, habit: "Talk with or hang with 1+ friend/fam", participant: "John", weekStart: "2025-09-29", daysCompleted: [], target: 7 },
  { id: 45, habit: "workout 4 times", participant: "Brandon", weekStart: "2025-10-06", daysCompleted: [2], target: 4 },
  { id: 46, habit: "Meditate", participant: "Brandon", weekStart: "2025-10-06", daysCompleted: [2], target: 5 },
  { id: 47, habit: "follow through on Trades", participant: "Brandon", weekStart: "2025-10-06", daysCompleted: [], target: 1 },
  { id: 48, habit: "Real-Time Journaling", participant: "Brandon", weekStart: "2025-10-06", daysCompleted: [2], target: 1 },
  { id: 49, habit: "no social media 9-5pm", participant: "Brandon", weekStart: "2025-10-06", daysCompleted: [2], target: 5 },
  { id: 50, habit: "execute trades", participant: "Brandon", weekStart: "2025-10-06", daysCompleted: [], target: 1 },
  { id: 51, habit: "end of day review", participant: "Brandon", weekStart: "2025-10-06", daysCompleted: [], target: 1 },
  { id: 52, habit: "Post 1 TikTok related to Branches", participant: "John", weekStart: "2025-10-06", daysCompleted: [0, 1, 2, 3, 4, 5], target: 7 },
  { id: 53, habit: "Code on app 10 minutes", participant: "John", weekStart: "2025-10-06", daysCompleted: [0, 1, 2, 3, 4, 5, 6], target: 7 },
  { id: 54, habit: "Cardio", participant: "John", weekStart: "2025-10-06", daysCompleted: [0, 2, 4], target: 3 },
  { id: 55, habit: "Meditate 20 min", participant: "John", weekStart: "2025-10-06", daysCompleted: [0, 1, 2, 3, 4, 5, 6], target: 7 },
  { id: 56, habit: "No Social Media before 5pm", participant: "John", weekStart: "2025-10-06", daysCompleted: [0, 1, 2, 3, 4], target: 7 },
  { id: 57, habit: "Talk with or hang with 1+ friend/fam", participant: "John", weekStart: "2025-10-06", daysCompleted: [0, 1, 2, 3, 4, 5], target: 7 },
  { id: 58, habit: "Exercise 5 Days", participant: "Taylor", weekStart: "2025-10-13", daysCompleted: [0, 1, 3, 4], target: 5 },
  { id: 59, habit: "Find Buyers for 2 Deals", participant: "Taylor", weekStart: "2025-10-13", daysCompleted: [], target: 1 },
  { id: 60, habit: "Renegotiate 2 Deals", participant: "Taylor", weekStart: "2025-10-13", daysCompleted: [1, 4], target: 1 },
  { id: 61, habit: "Begin Disposition Training", participant: "Taylor", weekStart: "2025-10-13", daysCompleted: [], target: 1 },
  { id: 62, habit: "Eat Lean Meals", participant: "Taylor", weekStart: "2025-10-13", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 63, habit: "Have Lunch with 1 Client", participant: "Taylor", weekStart: "2025-10-13", daysCompleted: [2], target: 1 },
  { id: 64, habit: "No Social Media 9-5pm", participant: "Taylor", weekStart: "2025-10-13", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 65, habit: "Track Grady's KPI's", participant: "Taylor", weekStart: "2025-10-13", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 66, habit: "Post 1 TikTok related to Branches", participant: "John", weekStart: "2025-10-13", daysCompleted: [0, 2, 4], target: 7 },
  { id: 67, habit: "Code on app 10 minutes", participant: "John", weekStart: "2025-10-13", daysCompleted: [0, 1, 2, 3, 4], target: 7 },
  { id: 68, habit: "Cardio", participant: "John", weekStart: "2025-10-13", daysCompleted: [2], target: 3 },
  { id: 69, habit: "Meditate 20 min", participant: "John", weekStart: "2025-10-13", daysCompleted: [0, 1, 2, 3, 4, 5, 6], target: 7 },
  { id: 70, habit: "No Social Media before 5pm", participant: "John", weekStart: "2025-10-13", daysCompleted: [0, 1, 2, 3, 4, 5], target: 6 },
  { id: 71, habit: "Talk with or hang with 1+ friend/fam", participant: "John", weekStart: "2025-10-13", daysCompleted: [0, 1, 2, 3, 4, 5, 6], target: 7 },
  { id: 72, habit: "Make mobile convert to flashcard look better", participant: "John", weekStart: "2025-10-13", daysCompleted: [], target: 1 },
  { id: 73, habit: "Add core spaced repetition review logic/data", participant: "John", weekStart: "2025-10-13", daysCompleted: [], target: 1 },
  { id: 74, habit: "add delete flashcard mechanism", participant: "John", weekStart: "2025-10-13", daysCompleted: [], target: 1 },
  { id: 75, habit: "workout 4 times", participant: "Brandon", weekStart: "2025-10-13", daysCompleted: [0, 2, 4], target: 4 },
  { id: 76, habit: "Meditate", participant: "Brandon", weekStart: "2025-10-13", daysCompleted: [0, 2, 4], target: 5 },
  { id: 77, habit: "follow through on Trades", participant: "Brandon", weekStart: "2025-10-13", daysCompleted: [2], target: 1 },
  { id: 78, habit: "Real-Time Journaling", participant: "Brandon", weekStart: "2025-10-13", daysCompleted: [2], target: 5 },
  { id: 79, habit: "no social media 9-5pm", participant: "Brandon", weekStart: "2025-10-13", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 80, habit: "execute trades", participant: "Brandon", weekStart: "2025-10-13", daysCompleted: [2], target: 1 },
  { id: 81, habit: "end of day review", participant: "Brandon", weekStart: "2025-10-13", daysCompleted: [], target: 5 },
  { id: 82, habit: "Clean up editing to use Redux/fix editing bugs", participant: "John", weekStart: "2025-10-20", daysCompleted: [], target: 1 },
  { id: 83, habit: "Get iOS web mobile view working", participant: "John", weekStart: "2025-10-20", daysCompleted: [], target: 1 },
  { id: 84, habit: "interview or demo 3 users", participant: "John", weekStart: "2025-10-20", daysCompleted: [2], target: 1 },
  { id: 85, habit: "Code on app 10 minutes", participant: "John", weekStart: "2025-10-20", daysCompleted: [0, 1, 2, 3, 4, 5], target: 7 },
  { id: 86, habit: "Cardio", participant: "John", weekStart: "2025-10-20", daysCompleted: [0, 2, 4], target: 3 },
  { id: 87, habit: "Meditate 20 min", participant: "John", weekStart: "2025-10-20", daysCompleted: [0, 1, 2, 3, 4, 5, 6], target: 7 },
  { id: 88, habit: "No Social Media before 5pm", participant: "John", weekStart: "2025-10-20", daysCompleted: [0, 1, 2, 3, 4, 5, 6], target: 6 },
  { id: 89, habit: "Talk with or hang with 1+ friend/fam", participant: "John", weekStart: "2025-10-20", daysCompleted: [0, 1, 2, 3, 4, 5, 6], target: 7 },
  { id: 90, habit: "Erica's physical therapy", participant: "John", weekStart: "2025-10-20", daysCompleted: [0, 1, 2, 3, 4, 5], target: 7 },
  { id: 91, habit: "Exercise 4 Days", participant: "Taylor", weekStart: "2025-10-20", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 92, habit: "Find Buyers for 2 Deals", participant: "Taylor", weekStart: "2025-10-20", daysCompleted: [2], target: 2 },
  { id: 93, habit: "Renegotiation Calls with Grady", participant: "Taylor", weekStart: "2025-10-20", daysCompleted: [0, 1, 2, 3, 4], target: 4 },
  { id: 94, habit: "Begin Disposition Training", participant: "Taylor", weekStart: "2025-10-20", daysCompleted: [], target: 1 },
  { id: 95, habit: "Eat Lean Meals", participant: "Taylor", weekStart: "2025-10-20", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 96, habit: "Have Lunch with 1 Client", participant: "Taylor", weekStart: "2025-10-20", daysCompleted: [], target: 1 },
  { id: 97, habit: "No Social Media 9-5pm", participant: "Taylor", weekStart: "2025-10-20", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 98, habit: "Track Grady's KPI's at the end of each day", participant: "Taylor", weekStart: "2025-10-20", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 99, habit: "Workout 3 times", participant: "Brandon", weekStart: "2025-10-20", daysCompleted: [1, 4], target: 3 },
  { id: 100, habit: "Meditate", participant: "Brandon", weekStart: "2025-10-20", daysCompleted: [2], target: 4 },
  { id: 101, habit: "follow through on Trades", participant: "Brandon", weekStart: "2025-10-20", daysCompleted: [2], target: 2 },
  { id: 102, habit: "Real-Time Journaling", participant: "Brandon", weekStart: "2025-10-20", daysCompleted: [1, 4], target: 3 },
  { id: 103, habit: "no social media 9-5pm", participant: "Brandon", weekStart: "2025-10-20", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 104, habit: "execute trades", participant: "Brandon", weekStart: "2025-10-20", daysCompleted: [0, 2, 4], target: 1 },
  { id: 105, habit: "end of day review", participant: "Brandon", weekStart: "2025-10-20", daysCompleted: [0, 2, 4], target: 3 },
  { id: 106, habit: "Get iOS web mobile view working", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 1 },
  { id: 107, habit: "interview or demo to 1 user", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 1 },
  { id: 108, habit: "Code on app 10 minutes", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 6 },
  { id: 109, habit: "ask for preorder payment for app", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 1 },
  { id: 110, habit: "Cardio", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 3 },
  { id: 111, habit: "Meditate 20 min", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 7 },
  { id: 112, habit: "No Social Media before 5pm", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 6 },
  { id: 113, habit: "Talk with or hang with 1+ friend/fam", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 7 },
  { id: 114, habit: "Message nutritionist", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 1 },
  { id: 115, habit: "message pt", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 1 },
  { id: 116, habit: "improve diet/meal plan", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 1 },
  { id: 117, habit: "order probiotic", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 1 },
  { id: 118, habit: "have lunch and dinner ready", participant: "John", weekStart: "2025-10-27", daysCompleted: [0, 1, 2, 3, 4, 5], target: 7 },
  { id: 119, habit: "thoracic mobility exercises", participant: "John", weekStart: "2025-10-27", daysCompleted: [0, 1, 2, 3, 4, 5], target: 5 },
  { id: 120, habit: "lacrosse ball release", participant: "John", weekStart: "2025-10-27", daysCompleted: [0, 1, 2, 3, 4, 5], target: 3 },
  { id: 121, habit: "prone PT exercises", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 6 },
  { id: 122, habit: "seated/standing PT exercises", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 6 },
  { id: 123, habit: "in bed by 9:30pm", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 1 },
  { id: 124, habit: "in bed by 10:30pm", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 1 },
  { id: 125, habit: "out of bed by 6:30am", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 4 },
  { id: 126, habit: "out of bed by 7:30am", participant: "John", weekStart: "2025-10-27", daysCompleted: [], target: 3 },
  { id: 127, habit: "Workout 4 times", participant: "Brandon", weekStart: "2025-10-27", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 128, habit: "Meditate 5 days a week", participant: "Brandon", weekStart: "2025-10-27", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 129, habit: "follow through on Trades", participant: "Brandon", weekStart: "2025-10-27", daysCompleted: [], target: 1 },
  { id: 130, habit: "Real-Time Journaling", participant: "Brandon", weekStart: "2025-10-27", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 131, habit: "no social media 9-5pm", participant: "Brandon", weekStart: "2025-10-27", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 132, habit: "execute trades", participant: "Brandon", weekStart: "2025-10-27", daysCompleted: [0, 2, 4], target: 4 },
  { id: 133, habit: "end of day review", participant: "Brandon", weekStart: "2025-10-27", daysCompleted: [0, 1, 3, 4], target: 5 },
  { id: 134, habit: "Read one chapter a day", participant: "Brandon", weekStart: "2025-10-27", daysCompleted: [0, 1, 2, 3, 4], target: 7 },
  { id: 135, habit: "Exercise 4 Days", participant: "Taylor", weekStart: "2025-10-27", daysCompleted: [0, 2, 4], target: 4 },
  { id: 136, habit: "Lock up 1 Assignment Contract", participant: "Taylor", weekStart: "2025-10-27", daysCompleted: [2], target: 1 },
  { id: 137, habit: "Talk to 5 Buyers per Day", participant: "Taylor", weekStart: "2025-10-27", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 138, habit: "Grady Begin CRM Training", participant: "Taylor", weekStart: "2025-10-27", daysCompleted: [2], target: 1 },
  { id: 139, habit: "Eat Lean Meals", participant: "Taylor", weekStart: "2025-10-27", daysCompleted: [0, 1, 3, 4], target: 5 },
  { id: 140, habit: "Have Lunch with 1 Client", participant: "Taylor", weekStart: "2025-10-27", daysCompleted: [2], target: 1 },
  { id: 141, habit: "No Social Media 9-5pm", participant: "Taylor", weekStart: "2025-10-27", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 142, habit: "Track Grady's KPI's", participant: "Taylor", weekStart: "2025-10-27", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 143, habit: "1 Day at Coworking Space", participant: "Taylor", weekStart: "2025-10-27", daysCompleted: [], target: 1 },
  { id: 144, habit: "Cook 1 Meal", participant: "Taylor", weekStart: "2025-10-27", daysCompleted: [], target: 1 },
  { id: 145, habit: "Grocery Shopping", participant: "Taylor", weekStart: "2025-10-27", daysCompleted: [2], target: 1 },
  { id: 146, habit: "View recently viewed pages", participant: "John", weekStart: "2025-11-03", daysCompleted: [], target: 1 },
  { id: 147, habit: "Code on app 10 minutes", participant: "John", weekStart: "2025-11-03", daysCompleted: [], target: 6 },
  { id: 148, habit: "Demo app to one user", participant: "John", weekStart: "2025-11-03", daysCompleted: [], target: 1 },
  { id: 149, habit: "call/hang with 1 friend/fam", participant: "John", weekStart: "2025-11-03", daysCompleted: [], target: 7 },
  { id: 150, habit: "Follow sleep schedule", participant: "John", weekStart: "2025-11-03", daysCompleted: [], target: 7 },
  { id: 151, habit: "Do each day's PT", participant: "John", weekStart: "2025-11-03", daysCompleted: [], target: 7 },
  { id: 152, habit: "lunch and dinner ready", participant: "John", weekStart: "2025-11-03", daysCompleted: [], target: 7 },
  { id: 153, habit: "No social media before 5pm", participant: "John", weekStart: "2025-11-03", daysCompleted: [], target: 6 },
  { id: 154, habit: "Workout 4 times", participant: "Brandon", weekStart: "2025-11-03", daysCompleted: [0, 2, 4], target: 4 },
  { id: 155, habit: "Meditate 5 days a week", participant: "Brandon", weekStart: "2025-11-03", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 156, habit: "follow through on Trades", participant: "Brandon", weekStart: "2025-11-03", daysCompleted: [2], target: 1 },
  { id: 157, habit: "Real-Time Journaling", participant: "Brandon", weekStart: "2025-11-03", daysCompleted: [2], target: 1 },
  { id: 158, habit: "execute trades", participant: "Brandon", weekStart: "2025-11-03", daysCompleted: [0, 1, 2, 3, 4], target: 1 },
  { id: 159, habit: "end of day review", participant: "Brandon", weekStart: "2025-11-03", daysCompleted: [0, 2, 4], target: 5 },
  { id: 160, habit: "Read one chapter", participant: "Brandon", weekStart: "2025-11-03", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 161, habit: "Exercise 4 Days", participant: "Taylor", weekStart: "2025-11-03", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 162, habit: "Lock up 1 Assignment Contract", participant: "Taylor", weekStart: "2025-11-03", daysCompleted: [], target: 1 },
  { id: 163, habit: "Talk to 5 Buyers per Day", participant: "Taylor", weekStart: "2025-11-03", daysCompleted: [0, 1, 3, 4], target: 5 },
  { id: 164, habit: "30 Minutes of Reading Per Day", participant: "Taylor", weekStart: "2025-11-03", daysCompleted: [0, 1, 2, 3, 4], target: 4 },
  { id: 165, habit: "Eat Lean Meals", participant: "Taylor", weekStart: "2025-11-03", daysCompleted: [0, 1, 2, 3, 4, 5], target: 4 },
  { id: 166, habit: "Meet in Person with 1 Client", participant: "Taylor", weekStart: "2025-11-03", daysCompleted: [2], target: 1 },
  { id: 167, habit: "Write Daily Goals", participant: "Taylor", weekStart: "2025-11-03", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 168, habit: "Track Grady's KPI's", participant: "Taylor", weekStart: "2025-11-03", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 169, habit: "Learn 1 New Prayer", participant: "Taylor", weekStart: "2025-11-03", daysCompleted: [], target: 1 },
  { id: 170, habit: "File Taxes for 2023", participant: "Taylor", weekStart: "2025-11-03", daysCompleted: [], target: 1 },
  { id: 171, habit: "Fix pressing Enter bug", participant: "John", weekStart: "2025-11-10", daysCompleted: [2], target: 1 },
  { id: 172, habit: "Code on app 10 minutes", participant: "John", weekStart: "2025-11-10", daysCompleted: [0, 1, 2, 3, 4], target: 6 },
  { id: 173, habit: "get 25 people to say no", participant: "John", weekStart: "2025-11-10", daysCompleted: [], target: 1 },
  { id: 174, habit: "call/hang with 1 friend/fam", participant: "John", weekStart: "2025-11-10", daysCompleted: [0, 1, 2, 3, 4, 5, 6], target: 7 },
  { id: 175, habit: "Text taylor at 5:30am", participant: "John", weekStart: "2025-11-10", daysCompleted: [1, 4], target: 5 },
  { id: 176, habit: "Follow CBT-i sleep schedule", participant: "John", weekStart: "2025-11-10", daysCompleted: [0, 1, 3, 4], target: 7 },
  { id: 177, habit: "Do each day's PT", participant: "John", weekStart: "2025-11-10", daysCompleted: [0, 1, 2, 3, 4, 5], target: 7 },
  { id: 178, habit: "lunch and dinner ready", participant: "John", weekStart: "2025-11-10", daysCompleted: [0, 1, 2, 3, 4, 5, 6], target: 7 },
  { id: 179, habit: "No social media before 5pm", participant: "John", weekStart: "2025-11-10", daysCompleted: [0, 2, 4], target: 7 },
  { id: 180, habit: "Workout 4 times", participant: "Brandon", weekStart: "2025-11-10", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 181, habit: "Meditate 5 days a week", participant: "Brandon", weekStart: "2025-11-10", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 182, habit: "execute trades", participant: "Brandon", weekStart: "2025-11-10", daysCompleted: [2], target: 1 },
  { id: 183, habit: "no cutting trades", participant: "Brandon", weekStart: "2025-11-10", daysCompleted: [2], target: 1 },
  { id: 184, habit: "Text the group each trade", participant: "Brandon", weekStart: "2025-11-10", daysCompleted: [2], target: 1 },
  { id: 185, habit: "Real-Time Journaling", participant: "Brandon", weekStart: "2025-11-10", daysCompleted: [0, 2, 4], target: 1 },
  { id: 186, habit: "end of day review", participant: "Brandon", weekStart: "2025-11-10", daysCompleted: [0, 1, 3, 4], target: 5 },
  { id: 187, habit: "Read one chapter", participant: "Brandon", weekStart: "2025-11-10", daysCompleted: [0, 1, 2, 3, 4, 5], target: 5 },
  { id: 188, habit: "Exercise 3 Days", participant: "Taylor", weekStart: "2025-11-10", daysCompleted: [0, 2, 4], target: 3 },
  { id: 189, habit: "Lock up 1 Assignment Contract", participant: "Taylor", weekStart: "2025-11-10", daysCompleted: [], target: 1 },
  { id: 190, habit: "Wake up at 5:30am", participant: "Taylor", weekStart: "2025-11-10", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 191, habit: "30 Minutes of Reading Per Day", participant: "Taylor", weekStart: "2025-11-10", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 192, habit: "Eat Lean Meals", participant: "Taylor", weekStart: "2025-11-10", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 193, habit: "Meet in Person with 1 Client", participant: "Taylor", weekStart: "2025-11-10", daysCompleted: [2], target: 1 },
  { id: 194, habit: "Write Daily Goals", participant: "Taylor", weekStart: "2025-11-10", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 195, habit: "Track Grady's KPI's", participant: "Taylor", weekStart: "2025-11-10", daysCompleted: [0, 2, 4], target: 3 },
  { id: 196, habit: "Learn 1 New Prayer", participant: "Taylor", weekStart: "2025-11-10", daysCompleted: [], target: 1 },
  { id: 197, habit: "File Taxes for 2023", participant: "Taylor", weekStart: "2025-11-10", daysCompleted: [], target: 1 },
  { id: 198, habit: "Workout 4 times", participant: "Brandon", weekStart: "2025-11-17", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 199, habit: "Meditate 5 days a week", participant: "Brandon", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4, 5], target: 5 },
  { id: 200, habit: "execute trades", participant: "Brandon", weekStart: "2025-11-17", daysCompleted: [], target: 1 },
  { id: 201, habit: "no cutting trades", participant: "Brandon", weekStart: "2025-11-17", daysCompleted: [], target: 1 },
  { id: 202, habit: "Text the group each trade", participant: "Brandon", weekStart: "2025-11-17", daysCompleted: [0, 2, 4], target: 1 },
  { id: 203, habit: "Real-Time Journaling", participant: "Brandon", weekStart: "2025-11-17", daysCompleted: [], target: 1 },
  { id: 204, habit: "end of day review", participant: "Brandon", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4], target: 4 },
  { id: 205, habit: "Read one chapter", participant: "Brandon", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4, 5], target: 5 },
  { id: 206, habit: "no social media in the morning", participant: "Brandon", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 207, habit: "Exercise 3 Days", participant: "Taylor", weekStart: "2025-11-17", daysCompleted: [0, 1, 3, 4], target: 3 },
  { id: 208, habit: "Lock up 1 Assignment Contract", participant: "Taylor", weekStart: "2025-11-17", daysCompleted: [], target: 1 },
  { id: 209, habit: "Wake up at 5:30am", participant: "Taylor", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 210, habit: "30 Minutes of Reading Per Day", participant: "Taylor", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 211, habit: "Eat Lean Meals", participant: "Taylor", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4, 5], target: 5 },
  { id: 212, habit: "Meet in Person with 2 Clients", participant: "Taylor", weekStart: "2025-11-17", daysCompleted: [0, 2, 4], target: 2 },
  { id: 213, habit: "Write Daily Goals", participant: "Taylor", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 214, habit: "Learn 1 New Prayer", participant: "Taylor", weekStart: "2025-11-17", daysCompleted: [], target: 1 },
  { id: 215, habit: "File Taxes for 2023", participant: "Taylor", weekStart: "2025-11-17", daysCompleted: [], target: 1 },
  { id: 216, habit: "No phone until after written goals", participant: "Taylor", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 217, habit: "Write long term goals", participant: "John", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4, 5, 6], target: 3 },
  { id: 218, habit: "Code on app 10 minutes", participant: "John", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4, 5], target: 4 },
  { id: 219, habit: "Get 1 no for branches", participant: "John", weekStart: "2025-11-17", daysCompleted: [], target: 1 },
  { id: 220, habit: "Long term vision doc", participant: "John", weekStart: "2025-11-17", daysCompleted: [2], target: 1 },
  { id: 221, habit: "call/hang with 1 friend/fam", participant: "John", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4, 5, 6], target: 6 },
  { id: 222, habit: "in bed reading by 9:45pm", participant: "John", weekStart: "2025-11-17", daysCompleted: [1, 4], target: 3 },
  { id: 223, habit: "Do each day's PT", participant: "John", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4, 5], target: 4 },
  { id: 224, habit: "lunch and dinner ready", participant: "John", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4, 5], target: 3 },
  { id: 225, habit: "do food journal", participant: "John", weekStart: "2025-11-17", daysCompleted: [0, 1, 2, 3, 4], target: 3 },
  { id: 226, habit: "<30min social media before 5pm", participant: "John", weekStart: "2025-11-17", daysCompleted: [1, 4], target: 3 },
  { id: 227, habit: "meditate 20 min", participant: "John", weekStart: "2025-11-17", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 228, habit: "Workout 3 times", participant: "Brandon", weekStart: "2025-11-24", daysCompleted: [2], target: 3 },
  { id: 229, habit: "Meditate 4 days a week", participant: "Brandon", weekStart: "2025-11-24", daysCompleted: [2], target: 4 },
  { id: 230, habit: "execute trades", participant: "Brandon", weekStart: "2025-11-24", daysCompleted: [2], target: 1 },
  { id: 231, habit: "no cutting trades", participant: "Brandon", weekStart: "2025-11-24", daysCompleted: [], target: 1 },
  { id: 232, habit: "Text the group each trade", participant: "Brandon", weekStart: "2025-11-24", daysCompleted: [2], target: 1 },
  { id: 233, habit: "Real-Time Journaling", participant: "Brandon", weekStart: "2025-11-24", daysCompleted: [2], target: 1 },
  { id: 234, habit: "end of day review", participant: "Brandon", weekStart: "2025-11-24", daysCompleted: [], target: 3 },
  { id: 235, habit: "Read one chapter", participant: "Brandon", weekStart: "2025-11-24", daysCompleted: [2], target: 5 },
  { id: 236, habit: "no social media in the morning", participant: "Brandon", weekStart: "2025-11-24", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 237, habit: "handwrite goals", participant: "John", weekStart: "2025-11-24", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 238, habit: "Code on app 10 minutes", participant: "John", weekStart: "2025-11-24", daysCompleted: [2], target: 5 },
  { id: 239, habit: "call/hang with 1 friend/fam", participant: "John", weekStart: "2025-11-24", daysCompleted: [0, 1, 2, 3, 4], target: 6 },
  { id: 240, habit: "in bed reading by 9:45pm", participant: "John", weekStart: "2025-11-24", daysCompleted: [], target: 2 },
  { id: 241, habit: "Do each day's PT", participant: "John", weekStart: "2025-11-24", daysCompleted: [0, 2, 4], target: 5 },
  { id: 242, habit: "lunch and dinner ready", participant: "John", weekStart: "2025-11-24", daysCompleted: [0, 1, 3, 4], target: 5 },
  { id: 243, habit: "do food journal", participant: "John", weekStart: "2025-11-24", daysCompleted: [0, 1, 3, 4], target: 5 },
  { id: 244, habit: "<30min social media before 5pm", participant: "John", weekStart: "2025-11-24", daysCompleted: [], target: 2 },
  { id: 245, habit: "meditate 20 min", participant: "John", weekStart: "2025-11-24", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 246, habit: "track # of times looking", participant: "John", weekStart: "2025-11-24", daysCompleted: [1, 4], target: 3 },
  { id: 247, habit: "Exercise", participant: "Taylor", weekStart: "2025-11-24", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 248, habit: "Lock up a Contract", participant: "Taylor", weekStart: "2025-11-24", daysCompleted: [1, 4], target: 1 },
  { id: 249, habit: "Wake up at 5am", participant: "Taylor", weekStart: "2025-11-24", daysCompleted: [], target: 5 },
  { id: 250, habit: "30 Minutes of Reading Per Day", participant: "Taylor", weekStart: "2025-11-24", daysCompleted: [], target: 5 },
  { id: 251, habit: "Eat Lean Meals", participant: "Taylor", weekStart: "2025-11-24", daysCompleted: [0, 2, 4], target: 5 },
  { id: 252, habit: "Meet in Person with Clients", participant: "Taylor", weekStart: "2025-11-24", daysCompleted: [0, 2, 4], target: 2 },
  { id: 253, habit: "Get out of the house after work", participant: "Taylor", weekStart: "2025-11-24", daysCompleted: [0, 1, 3, 4], target: 3 },
  { id: 254, habit: "Learn New Prayer", participant: "Taylor", weekStart: "2025-11-24", daysCompleted: [2], target: 1 },
  { id: 255, habit: "File Taxes for 2023", participant: "Taylor", weekStart: "2025-11-24", daysCompleted: [], target: 1 },
  { id: 256, habit: "No phone until after written goals", participant: "Taylor", weekStart: "2025-11-24", daysCompleted: [], target: 5 },
  { id: 257, habit: "Exercise", participant: "Taylor", weekStart: "2025-12-01", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 258, habit: "Lock up Contracts", participant: "Taylor", weekStart: "2025-12-01", daysCompleted: [1, 4], target: 2 },
  { id: 259, habit: "Wake up at 5am", participant: "Taylor", weekStart: "2025-12-01", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 260, habit: "30 Minutes of Reading Per Day", participant: "Taylor", weekStart: "2025-12-01", daysCompleted: [1, 4], target: 5 },
  { id: 261, habit: "Eat Lean Meals (no fast food)", participant: "Taylor", weekStart: "2025-12-01", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 262, habit: "Meet in Person with Clients", participant: "Taylor", weekStart: "2025-12-01", daysCompleted: [1, 4], target: 2 },
  { id: 263, habit: "Complete Results Driven Course", participant: "Taylor", weekStart: "2025-12-01", daysCompleted: [], target: 1 },
  { id: 264, habit: "Reanalyze Quickbooks", participant: "Taylor", weekStart: "2025-12-01", daysCompleted: [1, 4], target: 1 },
  { id: 265, habit: "No social media until 5pm", participant: "Taylor", weekStart: "2025-12-01", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 266, habit: "Workout 3 times", participant: "Brandon", weekStart: "2025-12-01", daysCompleted: [1, 4], target: 3 },
  { id: 267, habit: "Meditate 5 days a week", participant: "Brandon", weekStart: "2025-12-01", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 268, habit: "execute trades", participant: "Brandon", weekStart: "2025-12-01", daysCompleted: [], target: 1 },
  { id: 269, habit: "no cutting trades", participant: "Brandon", weekStart: "2025-12-01", daysCompleted: [], target: 1 },
  { id: 270, habit: "Text the group each trade", participant: "Brandon", weekStart: "2025-12-01", daysCompleted: [2], target: 1 },
  { id: 271, habit: "Real-Time Journaling", participant: "Brandon", weekStart: "2025-12-01", daysCompleted: [], target: 1 },
  { id: 272, habit: "end of day review", participant: "Brandon", weekStart: "2025-12-01", daysCompleted: [0, 1, 3, 4], target: 5 },
  { id: 273, habit: "Read one chapter", participant: "Brandon", weekStart: "2025-12-01", daysCompleted: [0, 2, 4], target: 5 },
  { id: 274, habit: "no social media in the morning", participant: "Brandon", weekStart: "2025-12-01", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 275, habit: "Hide phone 2 hours", participant: "John", weekStart: "2025-12-01", daysCompleted: [2], target: 1 },
  { id: 276, habit: "Hide phone 2 hours", participant: "John", weekStart: "2025-12-08", daysCompleted: [0, 1, 2, 3, 4, 5], target: 5 },
  { id: 277, habit: "Do each day's PT", participant: "John", weekStart: "2025-12-08", daysCompleted: [1, 4], target: 3 },
  { id: 278, habit: "lunch and dinner ready", participant: "John", weekStart: "2025-12-08", daysCompleted: [0, 1, 3, 4], target: 3 },
  { id: 279, habit: "do food journal", participant: "John", weekStart: "2025-12-08", daysCompleted: [1, 4], target: 2 },
  { id: 280, habit: "meditate 20 min", participant: "John", weekStart: "2025-12-08", daysCompleted: [0, 2, 4], target: 4 },
  { id: 281, habit: "in bed reading by 9:45pm", participant: "John", weekStart: "2025-12-08", daysCompleted: [2], target: 2 },
  { id: 282, habit: "handwrite goals", participant: "John", weekStart: "2025-12-08", daysCompleted: [0, 1, 2, 3, 4, 5, 6], target: 6 },
  { id: 283, habit: "call/hang with 1 friend/fam", participant: "John", weekStart: "2025-12-08", daysCompleted: [0, 1, 2, 3, 4, 5], target: 5 },
  { id: 284, habit: "Reach out to contact", participant: "John", weekStart: "2025-12-08", daysCompleted: [2], target: 1 },
  { id: 285, habit: "Work on accountability tracker", participant: "John", weekStart: "2025-12-08", daysCompleted: [], target: 1 },
  { id: 286, habit: "Exercise", participant: "Taylor", weekStart: "2025-12-08", daysCompleted: [0, 1, 3, 4], target: 4 },
  { id: 287, habit: "Lock up Contracts / Close Deals", participant: "Taylor", weekStart: "2025-12-08", daysCompleted: [1, 4], target: 2 },
  { id: 288, habit: "Wake up at 5am", participant: "Taylor", weekStart: "2025-12-08", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 289, habit: "30 Minutes of Reading Per Day", participant: "Taylor", weekStart: "2025-12-08", daysCompleted: [2], target: 3 },
  { id: 290, habit: "Eat Lean Meals (No eating out)", participant: "Taylor", weekStart: "2025-12-08", daysCompleted: [0, 1, 2, 3, 4, 5], target: 6 },
  { id: 291, habit: "Meet in Person with Clients", participant: "Taylor", weekStart: "2025-12-08", daysCompleted: [0, 2, 4], target: 2 },
  { id: 292, habit: "Complete Results Driven Course", participant: "Taylor", weekStart: "2025-12-08", daysCompleted: [1, 4], target: 1 },
  { id: 293, habit: "Reanalyze Quickbooks", participant: "Taylor", weekStart: "2025-12-08", daysCompleted: [2], target: 1 },
  { id: 294, habit: "No social media until 5pm", participant: "Taylor", weekStart: "2025-12-08", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 295, habit: "Workout 3 times", participant: "Brandon", weekStart: "2025-12-08", daysCompleted: [0, 2, 4], target: 3 },
  { id: 296, habit: "Meditate 5 days a week", participant: "Brandon", weekStart: "2025-12-08", daysCompleted: [0, 1, 2, 3, 4], target: 5 },
  { id: 297, habit: "execute trades", participant: "Brandon", weekStart: "2025-12-08", daysCompleted: [], target: 1 },
  { id: 298, habit: "no cutting trades", participant: "Brandon", weekStart: "2025-12-08", daysCompleted: [], target: 1 },
  { id: 299, habit: "Text the group each trade", participant: "Brandon", weekStart: "2025-12-08", daysCompleted: [2], target: 1 },
  { id: 300, habit: "Real-Time Journaling", participant: "Brandon", weekStart: "2025-12-08", daysCompleted: [], target: 1 },
  { id: 301, habit: "end of day review", participant: "Brandon", weekStart: "2025-12-08", daysCompleted: [0, 2, 4], target: 3 },
  { id: 302, habit: "Read one chapter", participant: "Brandon", weekStart: "2025-12-08", daysCompleted: [2], target: 4 },
  { id: 303, habit: "start timer when doing PT", participant: "John", weekStart: "2025-12-15", daysCompleted: [], target: 1 },
  { id: 304, habit: "Hide phone 2 hours", participant: "John", weekStart: "2025-12-15", daysCompleted: [], target: 5 },
  { id: 305, habit: "Do each day's PT", participant: "John", weekStart: "2025-12-15", daysCompleted: [], target: 1 },
  { id: 306, habit: "lunch and dinner ready", participant: "John", weekStart: "2025-12-15", daysCompleted: [], target: 3 },
  { id: 307, habit: "do food journal", participant: "John", weekStart: "2025-12-15", daysCompleted: [], target: 2 },
  { id: 308, habit: "meditate 20 min", participant: "John", weekStart: "2025-12-15", daysCompleted: [], target: 3 },
  { id: 309, habit: "in bed reading by 9:45pm", participant: "John", weekStart: "2025-12-15", daysCompleted: [], target: 1 },
  { id: 310, habit: "handwrite goals", participant: "John", weekStart: "2025-12-15", daysCompleted: [], target: 6 },
  { id: 311, habit: "call/hang with 1 friend/fam", participant: "John", weekStart: "2025-12-15", daysCompleted: [], target: 5 },
  { id: 312, habit: "Take gut bacteria test", participant: "John", weekStart: "2025-12-15", daysCompleted: [], target: 1 },
  { id: 313, habit: "Rehearse presentation 3 times", participant: "John", weekStart: "2025-12-15", daysCompleted: [], target: 3 },
  { id: 314, habit: "Exercise", participant: "Taylor", weekStart: "2025-12-15", daysCompleted: [], target: 4 },
  { id: 315, habit: "Lock up Contracts / Close Deals", participant: "Taylor", weekStart: "2025-12-15", daysCompleted: [], target: 2 },
  { id: 316, habit: "Wake up at 5am", participant: "Taylor", weekStart: "2025-12-15", daysCompleted: [], target: 3 },
  { id: 317, habit: "30 Minutes of Reading Per Day", participant: "Taylor", weekStart: "2025-12-15", daysCompleted: [], target: 2 },
  { id: 318, habit: "Eat Lean Meals (No eating out)", participant: "Taylor", weekStart: "2025-12-15", daysCompleted: [], target: 4 },
  { id: 319, habit: "One on One Call with Grady", participant: "Taylor", weekStart: "2025-12-15", daysCompleted: [], target: 1 },
  { id: 320, habit: "Reanalyze Quickbooks", participant: "Taylor", weekStart: "2025-12-15", daysCompleted: [], target: 1 },
  { id: 321, habit: "No social media until 5pm", participant: "Taylor", weekStart: "2025-12-15", daysCompleted: [], target: 3 },
  { id: 322, habit: "Workout", participant: "Brandon", weekStart: "2025-12-15", daysCompleted: [0, 2, 4], target: 3 },
  { id: 323, habit: "Meditate 5 days a week", participant: "Brandon", weekStart: "2025-12-15", daysCompleted: [1, 4], target: 5 },
  { id: 324, habit: "execute trades", participant: "Brandon", weekStart: "2025-12-15", daysCompleted: [], target: 1 },
  { id: 325, habit: "no cutting trades", participant: "Brandon", weekStart: "2025-12-15", daysCompleted: [2], target: 1 },
  { id: 326, habit: "Text the group each trade", participant: "Brandon", weekStart: "2025-12-15", daysCompleted: [2], target: 1 },
  { id: 327, habit: "Real-Time Journal every trade", participant: "Brandon", weekStart: "2025-12-15", daysCompleted: [], target: 1 },
  { id: 328, habit: "end of day review", participant: "Brandon", weekStart: "2025-12-15", daysCompleted: [0, 2, 4], target: 3 },
  { id: 329, habit: "Read one chapter", participant: "Brandon", weekStart: "2025-12-15", daysCompleted: [0, 2, 4], target: 2 },
  { id: 330, habit: "Look for 1 swing trade to place", participant: "Brandon", weekStart: "2025-12-15", daysCompleted: [1, 4], target: 1 },
];

// Helper functions
const formatWeekString = (weekStr) => new Date(weekStr + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
const getStatus = (h) => { 
  // Handle percentage-based habits (with instances tracking)
  if (h.habitType === 'percentage') {
    const instances = h.instances || [];
    if (instances.length === 0) return 'Pending';
    
    const successes = instances.filter(i => i.success).length;
    const percentage = Math.round((successes / instances.length) * 100);
    const target = h.target;
    
    if (percentage > target) return 'Exceeded';
    if (percentage >= target) return 'Done';
    if (percentage >= target * 0.75) return 'On Track';
    if (percentage >= target * 0.5) return 'At Risk';
    return 'Missed';
  }
  // Handle daily habits (default)
  const c = (h.daysCompleted || []).length;
  const t = h.target; 
  return c > t ? 'Exceeded' : c >= t ? 'Done' : c >= t * 0.75 ? 'On Track' : c >= t * 0.5 ? 'At Risk' : 'Missed'; 
};
const getWeekStartFromDate = (date) => {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  d.setDate(diff);
  return d.toISOString().split('T')[0];
};

// Components
const NAV_ITEMS = [
  { id: 'dashboard', icon: Home, label: 'Home' },
  { id: 'feed', icon: Users, label: 'Feed' },
  { id: 'compete', icon: Trophy, label: 'Compete' },
  { id: 'tracker', icon: Calendar, label: 'Track' },
  { id: 'insights', icon: BarChart3, label: 'Insights' },
  { id: 'vision', icon: Star, label: 'Vision' },
  { id: 'ai-coach', icon: Sparkles, label: 'Coach' }
];

// Task categories
const TASK_CATEGORIES = [
  { id: 'Work', icon: '', color: 'bg-blue-100 text-blue-700' },
  { id: 'Health', icon: '', color: 'bg-green-100 text-green-700' },
  { id: 'Finance', icon: '', color: 'bg-yellow-100 text-yellow-700' },
  { id: 'Learning', icon: '', color: 'bg-purple-100 text-purple-700' },
  { id: 'Personal', icon: '', color: 'bg-pink-100 text-pink-700' },
  { id: 'Spiritual', icon: '', color: 'bg-indigo-100 text-indigo-700' }
];

// Habit categories (matching the 7 life domains)
const HABIT_CATEGORIES = [
  { id: 'Fitness', icon: '', color: 'bg-orange-100 text-orange-700', darkColor: 'bg-orange-500/20 text-orange-400' },
  { id: 'Business', icon: '', color: 'bg-blue-100 text-blue-700', darkColor: 'bg-blue-500/20 text-blue-400' },
  { id: 'Finance', icon: '', color: 'bg-emerald-100 text-emerald-700', darkColor: 'bg-emerald-500/20 text-emerald-400' },
  { id: 'Health', icon: '', color: 'bg-red-100 text-red-700', darkColor: 'bg-red-500/20 text-red-400' },
  { id: 'Learning', icon: '', color: 'bg-purple-100 text-purple-700', darkColor: 'bg-purple-500/20 text-purple-400' },
  { id: 'Relationships', icon: '', color: 'bg-pink-100 text-pink-700', darkColor: 'bg-pink-500/20 text-pink-400' },
  { id: 'Spiritual', icon: '', color: 'bg-indigo-100 text-indigo-700', darkColor: 'bg-indigo-500/20 text-indigo-400' }
];

// Owner who can see all individual metrics
const OWNER_PARTICIPANT = 'Taylor';

const PRIORITY_CONFIG = {
  'High': { color: 'bg-red-500', textColor: 'text-red-600', icon: '' },
  'Medium': { color: 'bg-yellow-500', textColor: 'text-yellow-600', icon: '' },
  'Low': { color: 'bg-blue-500', textColor: 'text-blue-600', icon: '' },
  'Optional': { color: 'bg-gray-400', textColor: 'text-gray-500', icon: '' }
};

// Emoji reactions
const REACTIONS = ['', '', '', '', '', ''];

const Sidebar = ({ activeView, setActiveView, user, userProfile, onSignOut, darkMode, setDarkMode, onAddHabit }) => {
  const desktopLabels = { 
    'dashboard': 'Dashboard', 
    'feed': 'Community Feed',
    'compete': 'Compete',
    'tracker': 'Habit Tracker', 
    'monthly': 'Monthly View',
    'tasks': 'Task List',
    'scorecard': 'Scorecard', 
    'insights': 'Insights',
    'add': 'Add Habit', 
    'quotes': 'Quotes', 
    'ai-coach': 'AI Coach',
    'vision': '2026 Vision',
    'profile': 'My Profile'
  };
  const allNavItems = [
    { id: 'dashboard', icon: Home, label: 'Home' },
    { id: 'feed', icon: Users, label: 'Feed' },
    { id: 'compete', icon: Trophy, label: 'Compete' },
    { id: 'tracker', icon: Calendar, label: 'Track' },
    { id: 'monthly', icon: CalendarDays, label: 'Monthly' },
    { id: 'tasks', icon: Target, label: 'Tasks' },
    { id: 'insights', icon: BarChart3, label: 'Insights' },
    { id: 'scorecard', icon: Award, label: 'Score' },
    { id: 'quotes', icon: Quote, label: 'Quotes' },
    { id: 'vision', icon: Star, label: '2026 Vision' },
    { id: 'ai-coach', icon: Sparkles, label: 'Coach' }
  ];
  
  const displayPhoto = userProfile?.photoURL || user?.photoURL;
  const displayName = userProfile?.displayName || user?.displayName || 'User';
  
  return (
  <div className={`hidden md:flex w-56 min-h-screen p-4 flex-col backdrop-blur-xl border-r transition-colors duration-300 ${
    darkMode 
      ? 'bg-gray-900 border-gray-700' 
      : 'bg-white/80 border-gray-200/50'
  }`}>
    <div className="flex items-center gap-2 mb-6">
      <img src={LOGO_BASE64} alt="Logo" className="w-9 h-9" />
      <span className={`text-lg font-bold ${darkMode ? 'text-gray-100' : 'text-[#1E3A5F]'}`}>Accountability</span>
    </div>
    
    {/* Theme Toggle */}
    <div className={`mb-4 p-1 rounded-xl ${darkMode ? 'bg-gray-800' : 'bg-gray-100/80'}`}>
      <div className="flex">
        <button 
          onClick={() => setDarkMode(false)}
          className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-xs font-medium transition-all ${
            !darkMode ? 'bg-white shadow-sm text-gray-800' : 'text-gray-500 hover:text-gray-300'
          }`}
        >
          <Sun className="w-3.5 h-3.5" /> Light
        </button>
        <button 
          onClick={() => setDarkMode(true)}
          className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-xs font-medium transition-all ${
            darkMode ? 'bg-gradient-to-r from-[#1E3A5F] to-[#2d4a6f] shadow-lg text-white' : 'text-gray-400 hover:text-gray-600'
          }`}
        >
          <Moon className="w-3.5 h-3.5" /> Dark
        </button>
      </div>
    </div>
    
    <nav className="flex-1 space-y-1">
      {allNavItems.map(item => (
        <button 
          key={item.id} 
          onClick={() => item.isAction ? onAddHabit?.() : setActiveView(item.id)} 
          className={`w-full flex items-center gap-2 px-3 py-2.5 rounded-xl text-sm transition-all ${
            activeView === item.id 
              ? darkMode 
                ? 'bg-gradient-to-r from-[#1E3A5F]/80 to-[#2d4a6f]/60 text-white font-medium shadow-lg shadow-blue-500/10 border border-gray-600' 
                : 'bg-[#1E3A5F]/10 text-[#1E3A5F] font-medium'
              : darkMode 
                ? 'text-gray-400 hover:bg-gray-800 hover:text-gray-200' 
                : 'text-gray-500 hover:bg-gray-100/50'
          }`}
        >
          <item.icon className="w-4 h-4" />{desktopLabels[item.id] || item.label}
        </button>
      ))}
    </nav>
    {user && (
      <div className={`pt-4 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200/50'}`}>
        <button 
          onClick={() => setActiveView('profile')}
          className={`w-full flex items-center gap-2 px-2 mb-2 p-2 rounded-xl transition-all ${
            activeView === 'profile' 
              ? darkMode ? 'bg-gray-700 border border-gray-600' : 'bg-[#1E3A5F]/10'
              : darkMode ? 'hover:bg-gray-800' : 'hover:bg-gray-100/50'
          }`}
        >
          {displayPhoto ? (
            <img src={displayPhoto} alt="" className={`w-8 h-8 rounded-full object-cover ring-2 ${darkMode ? 'ring-[#1E3A5F]' : 'ring-white/20'}`} />
          ) : (
            <div className={`w-8 h-8 rounded-full flex items-center justify-center ${darkMode ? 'bg-gradient-to-br from-[#1E3A5F] to-[#2d4a6f]' : 'bg-[#EBE6D3]'}`}>
              <User className={`w-4 h-4 ${darkMode ? 'text-white' : 'text-[#162D4D]'}`} />
            </div>
          )}
          <div className="flex-1 min-w-0 text-left">
            <p className={`text-sm font-medium truncate ${darkMode ? 'text-gray-100' : 'text-gray-800'}`}>{displayName}</p>
            <p className={`text-xs truncate ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>{user.email}</p>
          </div>
        </button>
        <button 
          onClick={onSignOut} 
          className={`w-full flex items-center gap-2 px-3 py-2 rounded-xl text-sm transition-all ${
            darkMode ? 'text-gray-300 hover:bg-red-500/10 hover:text-red-400' : 'text-gray-500 hover:bg-gray-100/50'
          }`}
        >
          <LogOut className="w-4 h-4" />Sign Out
        </button>
      </div>
    )}
  </div>
);};

const MobileNav = ({ activeView, setActiveView, darkMode, onAddHabit }) => {
  // Show different items based on current view for context
  const mobileNavItems = [
    { id: 'dashboard', icon: Home, label: 'Home' },
    { id: 'tracker', icon: Calendar, label: 'Track' },
    { id: 'insights', icon: BarChart3, label: 'Insights' },
    { id: 'feed', icon: Users, label: 'Feed' },
    { id: 'more', icon: Plus, label: 'More' }
  ];
  
  const [showMoreMenu, setShowMoreMenu] = React.useState(false);
  
  const moreItems = [
    { id: 'compete', icon: Trophy, label: 'Compete' },
    { id: 'monthly', icon: CalendarDays, label: 'Monthly' },
    { id: 'tasks', icon: Target, label: 'Tasks' },
    { id: 'scorecard', icon: Award, label: 'Scorecard' },
    { id: 'quotes', icon: Quote, label: 'Quotes' },
    { id: 'vision', icon: Star, label: '2026 Vision' },
    { id: 'ai-coach', icon: Sparkles, label: 'AI Coach' },
    { id: 'profile', icon: User, label: 'Profile' }
  ];
  
  return (
    <>
      {/* More menu overlay */}
      {showMoreMenu && (
        <div 
          className="md:hidden fixed inset-0 z-40"
          onClick={() => setShowMoreMenu(false)}
        >
          <div className={`absolute bottom-20 left-3 right-3 rounded-2xl p-2 backdrop-blur-xl shadow-2xl ${
            darkMode 
              ? 'bg-gray-800 border border-gray-600 shadow-black/50' 
              : 'bg-white/95 border border-gray-200'
          }`}>
            <div className="grid grid-cols-4 gap-1">
              {moreItems.map(item => (
                <button
                  key={item.id}
                  onClick={(e) => {
                    e.stopPropagation();
                    if (item.isAction) {
                      onAddHabit?.();
                    } else {
                      setActiveView(item.id);
                    }
                    setShowMoreMenu(false);
                  }}
                  className={`flex flex-col items-center py-3 px-2 rounded-xl transition-all ${
                    activeView === item.id 
                      ? darkMode ? 'bg-[#1E3A5F]/50 text-[#F5B800] border border-[#F5B800]/30' : 'bg-[#1E3A5F]/10 text-[#1E3A5F]'
                      : darkMode ? 'text-gray-400 active:bg-gray-800 active:text-gray-200' : 'text-gray-500 active:bg-gray-100'
                  }`}
                >
                  <item.icon className="w-5 h-5 mb-1" />
                  <span className="text-[10px]">{item.label}</span>
                </button>
              ))}
            </div>
          </div>
        </div>
      )}
      
      {/* Bottom nav bar */}
      <div className={`md:hidden fixed bottom-0 left-0 right-0 backdrop-blur-xl px-2 pt-2 z-50 border-t transition-colors duration-300 ${
        darkMode 
          ? 'bg-gray-900 border-gray-700' 
          : 'bg-white/90 border-gray-200/50'
      }`} style={{ paddingBottom: 'max(0.75rem, env(safe-area-inset-bottom))' }}>
        <div className="flex justify-around items-center">
          {mobileNavItems.map(item => (
            <button
              key={item.id}
              onClick={() => {
                if (item.id === 'more') {
                  setShowMoreMenu(!showMoreMenu);
                } else {
                  setActiveView(item.id);
                  setShowMoreMenu(false);
                }
              }}
              className={`flex flex-col items-center py-2 px-3 rounded-xl transition-all ${
                (item.id === 'more' && showMoreMenu) || (item.id !== 'more' && activeView === item.id)
                  ? darkMode ? 'text-[#F5B800] bg-[#F5B800]/10' : 'text-[#1E3A5F] bg-[#1E3A5F]/10'
                  : darkMode ? 'text-gray-300 active:text-gray-300' : 'text-gray-400 active:text-[#1E3A5F]'
              }`}
            >
              <item.icon className="w-6 h-6" />
              <span className="text-[10px] mt-0.5 font-medium">{item.label}</span>
            </button>
          ))}
        </div>
      </div>
    </>
  );
};

const StatCard = ({ title, value, icon: Icon, trend, trendUp, color }) => {
  const colors = { green: 'bg-emerald-50 text-emerald-600', blue: 'bg-blue-50 text-blue-600', purple: 'bg-[#F5F3E8] text-[#162D4D]', orange: 'bg-orange-50 text-orange-600' };
  return (
    <div className="bg-white rounded-2xl p-4 border border-gray-100 shadow-sm">
      <div className="flex items-start justify-between mb-2">
        <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${colors[color]}`}><Icon className="w-5 h-5" /></div>
        {trend && <div className={`flex items-center gap-1 text-xs font-medium ${trendUp ? 'text-emerald-600' : 'text-red-500'}`}>{trendUp ? <TrendingUp className="w-3 h-3" /> : <TrendingDown className="w-3 h-3" />}{trend}</div>}
      </div>
      <p className="text-2xl font-bold text-gray-800">{value}</p>
      <p className="text-gray-500 text-sm">{title}</p>
    </div>
  );
};

// Simple Markdown renderer
const Markdown = ({ children }) => {
  if (!children) return null;
  
  const lines = children.split('\n');
  
  return (
    <div className="space-y-2">
      {lines.map((line, i) => {
        // Headers
        if (line.startsWith('### ')) return <h3 key={i} className="font-bold text-gray-800 mt-3">{line.slice(4)}</h3>;
        if (line.startsWith('## ')) return <h2 key={i} className="font-bold text-gray-800 text-lg mt-4">{line.slice(3)}</h2>;
        if (line.startsWith('# ')) return <h1 key={i} className="font-bold text-gray-800 text-xl mt-4">{line.slice(2)}</h1>;
        
        // Bullet points
        if (line.startsWith('- ') || line.startsWith('* ')) {
          const content = line.slice(2);
          return <div key={i} className="flex gap-2 ml-2"><span className="text-[#1E3A5F]"></span><span>{formatInline(content)}</span></div>;
        }
        
        // Numbered lists
        const numberedMatch = line.match(/^(\d+)\.\s(.+)/);
        if (numberedMatch) {
          return <div key={i} className="flex gap-2 ml-2"><span className="text-[#1E3A5F] font-medium">{numberedMatch[1]}.</span><span>{formatInline(numberedMatch[2])}</span></div>;
        }
        
        // Empty lines
        if (!line.trim()) return <div key={i} className="h-2" />;
        
        // Regular paragraphs
        return <p key={i}>{formatInline(line)}</p>;
      })}
    </div>
  );
};

// Format inline markdown (bold, italic)
const formatInline = (text) => {
  const parts = [];
  let remaining = text;
  let key = 0;
  
  while (remaining) {
    // Bold **text**
    const boldMatch = remaining.match(/\*\*(.+?)\*\*/);
    if (boldMatch && boldMatch.index === 0) {
      parts.push(<strong key={key++} className="font-semibold text-gray-800">{boldMatch[1]}</strong>);
      remaining = remaining.slice(boldMatch[0].length);
      continue;
    }
    
    // Italic *text*
    const italicMatch = remaining.match(/\*(.+?)\*/);
    if (italicMatch && italicMatch.index === 0) {
      parts.push(<em key={key++}>{italicMatch[1]}</em>);
      remaining = remaining.slice(italicMatch[0].length);
      continue;
    }
    
    // Find next special char or end
    const nextSpecial = remaining.search(/\*/);
    if (nextSpecial === -1) {
      parts.push(remaining);
      break;
    } else if (nextSpecial > 0) {
      parts.push(remaining.slice(0, nextSpecial));
      remaining = remaining.slice(nextSpecial);
    } else {
      parts.push(remaining[0]);
      remaining = remaining.slice(1);
    }
  }
  
  return parts;
};

const LoginScreen = ({ onSignIn, loading }) => (
  <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
    <div className="bg-white rounded-2xl p-8 shadow-lg max-w-md w-full text-center">
      <img src={LOGO_BASE64} alt="The Accountability Group" className="w-24 h-24 mx-auto mb-6" />
      <h1 className="text-2xl font-bold text-[#1E3A5F] mb-2">The Accountability Group</h1>
      <p className="text-gray-500 mb-8">Sign in to track habits with your team. All changes sync in real-time.</p>
      <button
        onClick={onSignIn}
        disabled={loading}
        className="w-full bg-[#1E3A5F] hover:bg-[#162D4D] text-white py-3 px-4 rounded-xl font-medium flex items-center justify-center gap-3 transition-colors disabled:opacity-50"
      >
        <svg className="w-5 h-5" viewBox="0 0 24 24">
          <path fill="#fff" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#fff" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#F5B800" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#fff" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        {loading ? 'Signing in...' : 'Sign in with Google'}
      </button>
    </div>
  </div>
);

export default function AccountabilityTracker() {
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  const [habits, setHabits] = useState([]);
  const [habitNormGroups, setHabitNormGroups] = useState({}); // { "normalizedName": ["Exercise", "Workout", "Gym"] }
  const [categorizingHabits, setCategorizingHabits] = useState(false);
  const [normalizingHabits, setNormalizingHabits] = useState(false);
  const [dataLoading, setDataLoading] = useState(true);
  const [activeView, setActiveView] = useState('dashboard');
  const [selectedWeek, setSelectedWeek] = useState(null); // Store week string, not index
  const [selectedParticipant, setSelectedParticipant] = useState('All');
  const [scorecardRange, setScorecardRange] = useState('4weeks');
  const [newHabit, setNewHabit] = useState({ habit: '', participant: 'Taylor', target: 5, habitType: 'daily', category: '' }); // habitType: 'daily' or 'percentage'
  const [bulkHabits, setBulkHabits] = useState('');
  const [bulkParticipant, setBulkParticipant] = useState('Taylor');
  const [bulkTarget, setBulkTarget] = useState(5);
  const [addMode, setAddMode] = useState('single');
  const [showCalendar, setShowCalendar] = useState(false);
  const [calendarMonth, setCalendarMonth] = useState({ year: new Date().getFullYear(), month: new Date().getMonth() });
  
  // Theme state - iOS Glass Theme
  const [darkMode, setDarkMode] = useState(() => {
    if (typeof window !== 'undefined') {
      const saved = localStorage.getItem('darkMode');
      return saved ? JSON.parse(saved) : window.matchMedia('(prefers-color-scheme: dark)').matches;
    }
    return false;
  });
  
  // Save dark mode preference
  useEffect(() => {
    localStorage.setItem('darkMode', JSON.stringify(darkMode));
  }, [darkMode]);
  
  // AI Coach state
  const [aiLoading, setAiLoading] = useState(false);
  const [aiResponse, setAiResponse] = useState('');
  const [aiGoal, setAiGoal] = useState('');
  const [selectedAiParticipant, setSelectedAiParticipant] = useState('Taylor');
  const [aiConversation, setAiConversation] = useState([]); // {role: 'user'|'assistant', content: string}
  const [aiFollowUp, setAiFollowUp] = useState('');
  const [suggestedHabits, setSuggestedHabits] = useState([]); // [{habit: string, target: number, added: boolean}]
  const [quoteHabitSuggestions, setQuoteHabitSuggestions] = useState([]); // Suggestions from quote
  const [quoteHabitLoading, setQuoteHabitLoading] = useState(false);
  
  // Quotes state
  const [quotes, setQuotes] = useState([]);
  const [quoteLoading, setQuoteLoading] = useState(false);
  const [selectedQuoteIndex, setSelectedQuoteIndex] = useState(0);
  const [quotesExpanded, setQuotesExpanded] = useState(true);
  
  // Feed/Posts state
  const [posts, setPosts] = useState([]);
  const [newPostText, setNewPostText] = useState('');
  const [newPostImage, setNewPostImage] = useState(null);
  const [postImagePreview, setPostImagePreview] = useState(null);
  const [showComments, setShowComments] = useState({});
  const [commentTexts, setCommentTexts] = useState({});
  
  // Bets/Challenges state
  const [bets, setBets] = useState([]);
  const [newBet, setNewBet] = useState({ challenger: '', challenged: [], goal: '', reward: '', deadline: '', isGroup: false, allowMultipleWinners: false });
  const [showNewBet, setShowNewBet] = useState(false);
  const [editingBet, setEditingBet] = useState(null);
  const [showIncomingChallenge, setShowIncomingChallenge] = useState(null); // For dramatic challenge reveal
  const [challengeSuggestions, setChallengeSuggestions] = useState([]);
  const [prizeSuggestions, setPrizeSuggestions] = useState([]);
  const [loadingChallengeSuggestions, setLoadingChallengeSuggestions] = useState(false);
  const [loadingPrizeSuggestions, setLoadingPrizeSuggestions] = useState(false);
  
  // Profile state
  const [profiles, setProfiles] = useState([]);
  const [userProfile, setUserProfile] = useState(null);
  const [profileForm, setProfileForm] = useState({ 
    displayName: '', 
    bio: '', 
    linkedParticipant: '',
    location: '',
    goals: '',
    photoURL: ''
  });
  const [showAddParticipant, setShowAddParticipant] = useState(false);
  const [newParticipantName, setNewParticipantName] = useState('');
  const [viewingProfile, setViewingProfile] = useState(null); // For viewing other profiles
  const [profilePhotoPreview, setProfilePhotoPreview] = useState(null);
  
  // Onboarding state
  const [showOnboarding, setShowOnboarding] = useState(false);
  const [onboardingSlide, setOnboardingSlide] = useState(0);
  const [onboardingData, setOnboardingData] = useState({
    displayName: '',
    nickname: '',
    participantType: 'existing', // 'existing' or 'new'
    linkedParticipant: '',
    newParticipantName: '',
    primaryGoal: '',
    focusAreas: [], // ['Fitness', 'Business', 'Finance', etc.]
    experienceLevel: 'beginner', // 'beginner', 'intermediate', 'advanced'
    accountabilityStyle: 'supportive', // 'supportive', 'competitive', 'balanced'
    initialHabits: ['', '', ''],
    reminderPreference: 'daily',
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
  });
  
  // Habit editing state
  const [editingHabit, setEditingHabit] = useState(null); // {id, habit, target, category}
  const [showAddHabitModal, setShowAddHabitModal] = useState(false); // Add habit popup
  const [showHabitManagerModal, setShowHabitManagerModal] = useState(false); // Habit categorization/normalization manager
  const [habitManagerTab, setHabitManagerTab] = useState('uncategorized'); // 'uncategorized' | 'groups'
  const [weekHabitSuggestions, setWeekHabitSuggestions] = useState([]); // AI suggestions for new week
  const [weekSuggestLoading, setWeekSuggestLoading] = useState(false);
  const [editingPastWeek, setEditingPastWeek] = useState(false); // Allow editing locked past weeks;
  
  // Tasks state
  const [tasks, setTasks] = useState([]);
  const [newTask, setNewTask] = useState({ task: '', dueDate: '', priority: 'Medium', category: 'Work', timeSlot: '', timeEstimate: 15, notes: '', recurring: null });
  const [showAddTask, setShowAddTask] = useState(false);
  const [taskFilter, setTaskFilter] = useState('today'); // all, today, inbox, overdue, completed, scheduled
  const [editingTask, setEditingTask] = useState(null);
  
  // Enhanced task features
  const [quickTaskInput, setQuickTaskInput] = useState('');
  const [taskViewMode, setTaskViewMode] = useState('list'); // list, planner, focus
  const [expandedTask, setExpandedTask] = useState(null);
  const [pomodoroTask, setPomodoroTask] = useState(null);
  const [pomodoroTime, setPomodoroTime] = useState(25 * 60);
  const [pomodoroRunning, setPomodoroRunning] = useState(false);
  const [showMorningPlanning, setShowMorningPlanning] = useState(false);
  const [top3Today, setTop3Today] = useState([]); // IDs of top 3 tasks for today
  const [focusTask, setFocusTask] = useState(null); // Currently focused task
  const [aiScheduling, setAiScheduling] = useState(false); // AI scheduling in progress
  const [showRecurringModal, setShowRecurringModal] = useState(false);
  const [taskProductivity, setTaskProductivity] = useState({ tasksCompleted: 0, streak: 0, avgPerDay: 0 });
  
  // Non-Negotiables state - 3 core habits that never change
  const [nonNegotiables, setNonNegotiables] = useState([]);
  const [showNonNegotiableModal, setShowNonNegotiableModal] = useState(false);
  const [newNonNegotiable, setNewNonNegotiable] = useState({ habit: '', description: '', frequency: 'Daily' });
  
  // Mood tracking state  
  const [moodData, setMoodData] = useState([]); // {date, mood: 1-10, motivation: 1-10, notes}
  const [showMoodModal, setShowMoodModal] = useState(false);
  const [todayMood, setTodayMood] = useState({ mood: 5, motivation: 5, notes: '' });
  
  // 2026 Vision state
  const [visionData, setVisionData] = useState(null); // Saved vision document
  const [showVisionWrapped, setShowVisionWrapped] = useState(false); // Full wrapped experience
  const [visionSlide, setVisionSlide] = useState(0); // Current slide in wrapped
  const [visionAnswers, setVisionAnswers] = useState({
    wordOfYear: '',
    biggestGoal: '',
    whyMatters: '',
    mainObstacle: '',
    overcomeStrategy: '',
    dailyHabit: '',
    monthlyMilestone: '',
    supportPerson: '',
    rewardForSuccess: '',
    fitnessScore: 5,
    businessScore: 5,
    financeScore: 5,
    healthScore: 5,
    learningScore: 5,
    relationshipsScore: 5,
    spiritualScore: 5,
    nonNegotiable1: '',
    nonNegotiable2: '',
    nonNegotiable3: '',
    letterToSelf: ''
  });
  
  // 2025 Reflection state
  const [reflectionData, setReflectionData] = useState(null); // Saved reflection document
  const [showReflectionModal, setShowReflectionModal] = useState(false); // Reflection experience modal
  const [reflectionSlide, setReflectionSlide] = useState(0); // Current slide
  const [reflectionAnswers, setReflectionAnswers] = useState({
    biggestWin: '',
    proudestMoment: '',
    biggestChallenge: '',
    lessonLearned: '',
    unexpectedJoy: '',
    relationshipHighlight: '',
    skillDeveloped: '',
    habitMastered: '',
    habitStruggled: '',
    gratefulFor: '',
    wordToDescribe2025: '',
    letterFromPastSelf: '',
    adviceToFutureSelf: '',
    fitnessReflection: 5,
    businessReflection: 5,
    financeReflection: 5,
    healthReflection: 5,
    learningReflection: 5,
    relationshipsReflection: 5,
    spiritualReflection: 5
  });
  
  // Time Capsule state
  const [timeCapsuleData, setTimeCapsuleData] = useState(null);
  const [showTimeCapsule, setShowTimeCapsule] = useState(false);
  const [timeCapsuleAnswers, setTimeCapsuleAnswers] = useState({
    currentMood: '',
    currentChallenge: '',
    hopesForEndOfYear: '',
    predictionsFor2026: '',
    secretGoal: '',
    messageToFutureSelf: '',
    currentFavorites: '', // song, show, food, etc
    gratitudeList: ''
  });
  
  // Time capsule unlock dates
  const MID_YEAR_UNLOCK = new Date('2026-07-01');
  const END_YEAR_UNLOCK = new Date('2026-12-26');
  const today = new Date();
  const isMidYearUnlocked = today >= MID_YEAR_UNLOCK;
  const isEndYearUnlocked = today >= END_YEAR_UNLOCK;
  
  // Monthly view state
  const [monthlyViewMonth, setMonthlyViewMonth] = useState({ year: new Date().getFullYear(), month: new Date().getMonth() });
  
  // Habit breakdown modal state
  const [showHabitBreakdown, setShowHabitBreakdown] = useState(null); // 'exceeded' | 'missed' | 'completed' | 'total' | null
  
  // Participant AI summaries
  const [participantSummaries, setParticipantSummaries] = useState({});
  const [summaryLoading, setSummaryLoading] = useState(false);
  
  // Daily view state
  const [selectedDay, setSelectedDay] = useState(null); // 0-6 for Mon-Sun
  
  // Weekly Check-ins state (legacy - now part of feed)
  const [checkIns, setCheckIns] = useState([]);
  const [checkInText, setCheckInText] = useState('');
  const [checkInWins, setCheckInWins] = useState('');
  const [checkInChallenges, setCheckInChallenges] = useState('');
  
  // Splash screen state
  const [showSplash, setShowSplash] = useState(true);
  const [splashFading, setSplashFading] = useState(false);
  
  // Quote generation modal state
  const [showQuoteModal, setShowQuoteModal] = useState(false);
  const [quoteCustomDirection, setQuoteCustomDirection] = useState('');
  const [quoteThemeType, setQuoteThemeType] = useState('random'); // 'random', 'motivational', 'stoic', 'business', 'custom'
  
  // Analytics & Reports state (no Firebase needed)
  const [showAnalytics, setShowAnalytics] = useState(false);
  const [analyticsTab, setAnalyticsTab] = useState('overview');
  const [showMonthlyReport, setShowMonthlyReport] = useState(false);
  const [reportMonth, setReportMonth] = useState({ year: new Date().getFullYear(), month: new Date().getMonth() });
  
  const calendarRef = useRef(null);
  const fileInputRef = useRef(null);
  const postTextRef = useRef(null);
  const profilePhotoRef = useRef(null);

  // Set favicon on mount
  useEffect(() => {
    const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
    link.type = 'image/png';
    link.rel = 'icon';
    link.href = LOGO_BASE64;
    document.getElementsByTagName('head')[0].appendChild(link);
    document.title = 'The Accountability Group';
  }, []);

  // Splash screen fade out effect
  useEffect(() => {
    const fadeTimer = setTimeout(() => {
      setSplashFading(true);
    }, 1500); // Start fading after 1.5 seconds
    
    const hideTimer = setTimeout(() => {
      setShowSplash(false);
    }, 2500); // Fully hidden after 2.5 seconds
    
    return () => {
      clearTimeout(fadeTimer);
      clearTimeout(hideTimer);
    };
  }, []);

  // Auth listener
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setUser(user);
      setAuthLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // Firestore listener
  useEffect(() => {
    if (!user) {
      setHabits([]);
      setDataLoading(false);
      return;
    }

    const q = query(collection(db, 'habits'), orderBy('weekStart', 'desc'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      if (snapshot.empty) {
        // First time - load initial data
        console.log('No habits found, loading initial data...');
        loadInitialData();
      } else {
        const habitsData = snapshot.docs.map(doc => ({
          ...doc.data(),
          id: doc.id
        }));
        setHabits(habitsData);
        setDataLoading(false);
      }
    }, (error) => {
      console.error('Firestore error:', error);
      setDataLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  // Quotes Firestore listener
  useEffect(() => {
    if (!user) {
      setQuotes([]);
      return;
    }

    const q = query(collection(db, 'quotes'), orderBy('createdAt', 'desc'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const quotesData = snapshot.docs.map(doc => ({
        ...doc.data(),
        id: doc.id
      }));
      setQuotes(quotesData);
    }, (error) => {
      console.error('Quotes error:', error);
    });

    return () => unsubscribe();
  }, [user]);

  // Check-ins Firestore listener
  useEffect(() => {
    if (!user) {
      setCheckIns([]);
      return;
    }

    const q = query(collection(db, 'checkIns'), orderBy('createdAt', 'desc'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const checkInsData = snapshot.docs.map(doc => ({
        ...doc.data(),
        id: doc.id
      }));
      setCheckIns(checkInsData);
    }, (error) => {
      console.error('Check-ins error:', error);
    });

    return () => unsubscribe();
  }, [user]);

  // Posts Firestore listener
  useEffect(() => {
    if (!user) {
      setPosts([]);
      return;
    }

    const q = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const postsData = snapshot.docs.map(doc => ({
        ...doc.data(),
        id: doc.id
      }));
      setPosts(postsData);
    }, (error) => {
      console.error('Posts error:', error);
    });

    return () => unsubscribe();
  }, [user]);

  // Bets Firestore listener
  useEffect(() => {
    if (!user) {
      setBets([]);
      return;
    }

    const q = query(collection(db, 'bets'), orderBy('createdAt', 'desc'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const betsData = snapshot.docs.map(doc => ({
        ...doc.data(),
        id: doc.id
      }));
      setBets(betsData);
    }, (error) => {
      console.error('Bets error:', error);
    });

    return () => unsubscribe();
  }, [user]);

  // Profiles Firestore listener
  useEffect(() => {
    if (!user) {
      setProfiles([]);
      setUserProfile(null);
      return;
    }

    const q = query(collection(db, 'profiles'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const profilesData = snapshot.docs.map(doc => ({
        ...doc.data(),
        id: doc.id
      }));
      setProfiles(profilesData);
      
      // Find current user's profile
      const myProfile = profilesData.find(p => p.odingUserId === user.uid);
      setUserProfile(myProfile || null);
      if (myProfile) {
        setProfileForm({
          displayName: myProfile.displayName || '',
          bio: myProfile.bio || '',
          linkedParticipant: myProfile.linkedParticipant || '',
          location: myProfile.location || '',
          goals: myProfile.goals || '',
          photoURL: myProfile.photoURL || ''
        });
        setProfilePhotoPreview(myProfile.photoURL || null);
        // Close onboarding if profile exists
        setShowOnboarding(false);
      } else {
        // No profile - show onboarding for new users
        setShowOnboarding(true);
        setOnboardingSlide(0);
        // Pre-fill with Google account info
        setOnboardingData(prev => ({
          ...prev,
          displayName: user.displayName || '',
          nickname: user.displayName?.split(' ')[0] || ''
        }));
      }
    }, (error) => {
      console.error('Profiles error:', error);
    });

    return () => unsubscribe();
  }, [user]);

  // Listen for non-negotiables
  useEffect(() => {
    if (!user) {
      setNonNegotiables([]);
      return;
    }

    const q = query(collection(db, 'nonNegotiables'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const nnData = snapshot.docs.map(doc => ({
        ...doc.data(),
        id: doc.id
      }));
      setNonNegotiables(nnData);
    }, (error) => {
      console.error('Non-negotiables error:', error);
    });

    return () => unsubscribe();
  }, [user]);

  // Fetch tasks from Supabase
  const fetchTasks = async () => {
    try {
      const response = await fetch(
        `${SUPABASE_URL}/rest/v1/tasks?order=due_date.asc`,
        {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        }
      );
      
      if (!response.ok) throw new Error('Failed to fetch tasks');
      
      const data = await response.json();
      console.log('Supabase tasks:', data);
      const tasksData = data.map(t => ({
        id: t.id,
        task: t.task,
        dueDate: t.due_date,
        priority: t.priority,
        category: t.category,
        status: t.status,
        participant: t.participant,
        createdAt: t.created_at,
        completedAt: t.completed_at,
        createdBy: t.created_by
      }));
      setTasks(tasksData);
    } catch (error) {
      console.error('Tasks error:', error);
    }
  };

  // Listen for tasks - poll Supabase every 10 seconds
  useEffect(() => {
    if (!user) return;
    
    // Fetch immediately
    const doFetch = async () => {
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/tasks?order=due_date.asc`,
          {
            headers: {
              'apikey': SUPABASE_KEY,
              'Authorization': `Bearer ${SUPABASE_KEY}`
            }
          }
        );
        
        if (!response.ok) throw new Error('Failed to fetch tasks');
        
        const data = await response.json();
        console.log('Supabase tasks loaded:', data.length);
        const tasksData = data.map(t => ({
          id: t.id,
          task: t.task,
          dueDate: t.due_date,
          priority: t.priority,
          category: t.category,
          status: t.status,
          participant: t.participant,
          createdAt: t.created_at,
          completedAt: t.completed_at,
          createdBy: t.created_by
        }));
        setTasks(tasksData);
      } catch (error) {
        console.error('Tasks error:', error);
      }
    };
    
    doFetch();
    const interval = setInterval(doFetch, 10000);
    
    return () => clearInterval(interval);
  }, [user]);

  // Listen for mood data
  useEffect(() => {
    if (!user) return;
    
    const q = query(collection(db, 'moods'), orderBy('date', 'desc'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const moodsData = snapshot.docs.map(doc => ({
        ...doc.data(),
        id: doc.id
      }));
      setMoodData(moodsData);
    }, (error) => {
      console.error('Mood error:', error);
    });

    return () => unsubscribe();
  }, [user]);

  // Listen for vision data
  useEffect(() => {
    if (!user) return;
    
    const visionRef = doc(db, 'visions', `vision_2026_${user.uid}`);
    const unsubscribe = onSnapshot(visionRef, (snapshot) => {
      if (snapshot.exists()) {
        setVisionData(snapshot.data());
        // Also populate visionAnswers for editing
        setVisionAnswers(prev => ({ ...prev, ...snapshot.data() }));
      }
    }, (error) => {
      console.error('Vision error:', error);
    });

    return () => unsubscribe();
  }, [user]);

  // Listen for 2025 reflection data
  useEffect(() => {
    if (!user) return;
    
    const reflectionRef = doc(db, 'reflections', `reflection_2025_${user.uid}`);
    const unsubscribe = onSnapshot(reflectionRef, (snapshot) => {
      if (snapshot.exists()) {
        setReflectionData(snapshot.data());
        setReflectionAnswers(prev => ({ ...prev, ...snapshot.data() }));
      }
    }, (error) => {
      console.error('Reflection error:', error);
    });

    return () => unsubscribe();
  }, [user]);

  // Listen for time capsule data
  useEffect(() => {
    if (!user) return;
    
    const capsuleRef = doc(db, 'timeCapsules', `capsule_2026_${user.uid}`);
    const unsubscribe = onSnapshot(capsuleRef, (snapshot) => {
      if (snapshot.exists()) {
        setTimeCapsuleData(snapshot.data());
        setTimeCapsuleAnswers(prev => ({ ...prev, ...snapshot.data() }));
      }
    }, (error) => {
      console.error('Time capsule error:', error);
    });

    return () => unsubscribe();
  }, [user]);

  // Save vision document
  const saveVision = async () => {
    if (!user) return;
    
    const visionDoc = {
      ...visionAnswers,
      odify: user.uid,
      participant: userProfile?.linkedParticipant || user?.displayName,
      updatedAt: new Date().toISOString(),
      year: 2026
    };
    
    await setDoc(doc(db, 'visions', `vision_2026_${user.uid}`), visionDoc);
    setShowVisionWrapped(false);
    setVisionSlide(0);
  };

  // Save 2025 reflection document
  const saveReflection = async () => {
    if (!user) return;
    
    const reflectionDoc = {
      ...reflectionAnswers,
      userId: user.uid,
      participant: userProfile?.linkedParticipant || user?.displayName,
      updatedAt: new Date().toISOString(),
      year: 2025
    };
    
    await setDoc(doc(db, 'reflections', `reflection_2025_${user.uid}`), reflectionDoc);
    setShowReflectionModal(false);
    setReflectionSlide(0);
  };

  // Save time capsule document
  const saveTimeCapsule = async () => {
    if (!user) return;
    
    const capsuleDoc = {
      ...timeCapsuleAnswers,
      userId: user.uid,
      participant: userProfile?.linkedParticipant || user?.displayName,
      createdAt: timeCapsuleData?.createdAt || new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      year: 2026,
      midYearUnlockDate: '2026-07-01',
      endYearUnlockDate: '2026-12-26'
    };
    
    await setDoc(doc(db, 'timeCapsules', `capsule_2026_${user.uid}`), capsuleDoc);
    setShowTimeCapsule(false);
  };

  // Complete onboarding and create profile
  const completeOnboarding = async () => {
    if (!user) return;
    
    try {
      // Determine participant name
      const participantName = onboardingData.participantType === 'new' 
        ? onboardingData.newParticipantName 
        : onboardingData.linkedParticipant;
      
      // Create user profile
      const profileDoc = {
        odingUserId: user.uid,
        displayName: onboardingData.displayName,
        nickname: onboardingData.nickname,
        linkedParticipant: participantName,
        email: user.email,
        photoURL: user.photoURL || '',
        bio: onboardingData.primaryGoal,
        goals: onboardingData.primaryGoal,
        focusAreas: onboardingData.focusAreas,
        experienceLevel: onboardingData.experienceLevel,
        accountabilityStyle: onboardingData.accountabilityStyle,
        reminderPreference: onboardingData.reminderPreference,
        timezone: onboardingData.timezone,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        onboardingCompleted: true
      };
      
      await setDoc(doc(db, 'profiles', `profile_${user.uid}`), profileDoc);
      
      // Create initial habits for current week if provided
      const initialHabits = onboardingData.initialHabits.filter(h => h.trim());
      if (initialHabits.length > 0) {
        const today = new Date();
        const dayOfWeek = today.getDay();
        const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        const monday = new Date(today);
        monday.setDate(today.getDate() + mondayOffset);
        const weekStart = monday.toISOString().split('T')[0];
        
        for (const habitName of initialHabits) {
          const habitDoc = {
            habit: habitName,
            participant: participantName,
            weekStart,
            target: 5,
            daysCompleted: [],
            createdAt: new Date().toISOString(),
            createdBy: user.uid
          };
          await setDoc(doc(db, 'habits', `${participantName}_${weekStart}_${habitName.replace(/\s+/g, '_')}`), habitDoc);
        }
      }
      
      // Close onboarding
      setShowOnboarding(false);
      setOnboardingSlide(0);
      
    } catch (error) {
      console.error('Onboarding error:', error);
    }
  };

  // Get profile by participant name
  const getProfileByParticipant = (participantName) => {
    return profiles.find(p => p.linkedParticipant === participantName);
  };

  // Get profile photo for a participant
  const getParticipantPhoto = (participantName) => {
    const profile = getProfileByParticipant(participantName);
    return profile?.photoURL || null;
  };

  // Get all participants (base + any added via profiles)
  const allParticipants = useMemo(() => {
    const baseParticipants = [...PARTICIPANTS];
    profiles.forEach(p => {
      if (p.linkedParticipant && !baseParticipants.includes(p.linkedParticipant)) {
        baseParticipants.push(p.linkedParticipant);
      }
    });
    // Also add any participants from habits that aren't in the base list
    habits.forEach(h => {
      if (h.participant && !baseParticipants.includes(h.participant)) {
        baseParticipants.push(h.participant);
      }
    });
    return baseParticipants;
  }, [profiles, habits]);

  // Helper: Get current week start string (for excluding from past metrics)
  const currentWeekStart = useMemo(() => {
    const today = new Date();
    const dayOfWeek = today.getDay();
    const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    const monday = new Date(today);
    monday.setDate(today.getDate() + mondayOffset);
    return monday.toISOString().split('T')[0];
  }, []);

  // Calculate streaks for each participant (excluding current week)
  // Calculate streaks for each participant (excluding current week from the streak-breaking check)
  const calculateStreaks = useMemo(() => {
    const streaks = {};
    allParticipants.forEach(p => {
      // Group habits by week for this participant (exclude current week - it's incomplete)
      const participantHabits = habits.filter(h => h.participant === p && h.weekStart !== currentWeekStart);
      const weeklyData = {};
      
      participantHabits.forEach(h => {
        if (!weeklyData[h.weekStart]) weeklyData[h.weekStart] = [];
        weeklyData[h.weekStart].push(h);
      });
      
      // Sort weeks from most recent to oldest and count consecutive weeks with >70% completion
      const sortedWeeks = Object.keys(weeklyData).sort().reverse();
      let currentStreak = 0;
      
      for (const week of sortedWeeks) {
        const weekHabits = weeklyData[week];
        const totalPossible = weekHabits.reduce((sum, h) => sum + (h.target || 5), 0);
        // Use daysCompleted array length (the actual data structure)
        const totalCompleted = weekHabits.reduce((sum, h) => {
          return sum + (h.daysCompleted?.length || 0);
        }, 0);
        
        if (totalPossible > 0 && (totalCompleted / totalPossible) >= 0.7) {
          currentStreak++;
        } else {
          break;
        }
      }
      
      streaks[p] = currentStreak;
    });
    return streaks;
  }, [habits, allParticipants, currentWeekStart]);

  // Calculate leaderboard (excluding current week for fair comparison)
  const leaderboard = useMemo(() => {
    return allParticipants.map(p => {
      const participantHabits = habits.filter(h => h.participant === p && h.weekStart !== currentWeekStart);
      const totalPossible = participantHabits.reduce((sum, h) => sum + (h.target || 5), 0);
      const totalCompleted = participantHabits.reduce((sum, h) => {
        return sum + (h.daysCompleted?.length || 0);
      }, 0);
      const rate = totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;
      
      return {
        name: p,
        rate,
        streak: calculateStreaks[p] || 0,
        totalCompleted,
        score: rate + (calculateStreaks[p] || 0) * 10 // Rate + streak bonus
      };
    }).sort((a, b) => b.score - a.score);
  }, [habits, calculateStreaks, allParticipants, currentWeekStart]);

  // Calculate Wrapped Stats for the current user
  const wrappedStats = useMemo(() => {
    const myParticipantName = userProfile?.linkedParticipant || user?.displayName;
    if (!myParticipantName || habits.length === 0) return null;
    
    // Filter to only PAST weeks (exclude current week)
    const myHabits = habits.filter(h => h.participant === myParticipantName && h.weekStart !== currentWeekStart);
    if (myHabits.length === 0) return null;
    
    // Basic totals
    const totalHabitsTracked = myHabits.length;
    const totalDaysCompleted = myHabits.reduce((sum, h) => {
      const days = h.daysCompleted?.length || DAYS.filter(d => h.days?.[d]).length;
      return sum + days;
    }, 0);
    const totalTargetDays = myHabits.reduce((sum, h) => sum + (h.target || 5), 0);
    const overallCompletionRate = totalTargetDays > 0 ? Math.round((totalDaysCompleted / totalTargetDays) * 100) : 0;
    
    // Unique weeks tracked (past weeks only)
    const weeksTracked = [...new Set(myHabits.map(h => h.weekStart))].sort();
    const totalWeeks = weeksTracked.length;
    
    // Calculate per-habit stats
    const habitStats = {};
    myHabits.forEach(h => {
      const habitName = h.habit?.toLowerCase().trim() || 'unknown';
      if (!habitStats[habitName]) {
        habitStats[habitName] = { name: h.habit, completed: 0, target: 0, weeks: 0 };
      }
      const days = h.daysCompleted?.length || DAYS.filter(d => h.days?.[d]).length;
      habitStats[habitName].completed += days;
      habitStats[habitName].target += (h.target || 5);
      habitStats[habitName].weeks++;
    });
    
    // Sort habits by completion rate
    const habitRankings = Object.values(habitStats)
      .map(h => ({
        ...h,
        rate: h.target > 0 ? Math.round((h.completed / h.target) * 100) : 0
      }))
      .filter(h => h.weeks >= 2) // At least 2 weeks of data
      .sort((a, b) => b.rate - a.rate);
    
    const topHabit = habitRankings[0] || null;
    const worstHabit = habitRankings[habitRankings.length - 1] || null;
    const perfectHabits = habitRankings.filter(h => h.rate >= 100);
    
    // Calculate weekly performance
    const weeklyPerformance = {};
    weeksTracked.forEach(week => {
      const weekHabits = myHabits.filter(h => h.weekStart === week);
      const weekTarget = weekHabits.reduce((sum, h) => sum + (h.target || 5), 0);
      const weekCompleted = weekHabits.reduce((sum, h) => {
        return sum + (h.daysCompleted?.length || DAYS.filter(d => h.days?.[d]).length);
      }, 0);
      weeklyPerformance[week] = {
        week,
        target: weekTarget,
        completed: weekCompleted,
        rate: weekTarget > 0 ? Math.round((weekCompleted / weekTarget) * 100) : 0,
        habitCount: weekHabits.length
      };
    });
    
    const weeklyRankings = Object.values(weeklyPerformance).sort((a, b) => b.rate - a.rate);
    const bestWeek = weeklyRankings[0] || null;
    const worstWeek = weeklyRankings[weeklyRankings.length - 1] || null;
    const perfectWeeks = weeklyRankings.filter(w => w.rate >= 100).length;
    
    // Category breakdown (infer from habit names)
    const categories = {
      fitness: { keywords: ['workout', 'run', 'gym', 'exercise', 'cardio', 'lift', 'walk', 'stretch', 'yoga'], count: 0, completed: 0 },
      health: { keywords: ['sleep', 'water', 'eat', 'diet', 'vitamin', 'meditat', 'health', 'track food', 'no sugar', 'no alcohol'], count: 0, completed: 0 },
      business: { keywords: ['work', 'client', 'call', 'email', 'meeting', 'sales', 'deal', 'business', 'lead', 'prospect', 'tiktok', 'post'], count: 0, completed: 0 },
      finance: { keywords: ['trade', 'invest', 'money', 'budget', 'save', 'finance', 'stock', 'crypto', 'portfolio'], count: 0, completed: 0 },
      learning: { keywords: ['read', 'learn', 'study', 'course', 'book', 'podcast', 'app', 'code', 'practice'], count: 0, completed: 0 },
      mindfulness: { keywords: ['journal', 'gratitude', 'reflect', 'pray', 'meditat', 'mindful', 'quiet', 'breathe'], count: 0, completed: 0 },
      social: { keywords: ['friend', 'family', 'call', 'hang', 'connect', 'relationship', 'date'], count: 0, completed: 0 },
      discipline: { keywords: ['no social', 'no phone', 'wake', 'morning', 'routine', 'habit', 'discipline', 'focus'], count: 0, completed: 0 }
    };
    
    myHabits.forEach(h => {
      const habitLower = (h.habit || '').toLowerCase();
      const days = h.daysCompleted?.length || DAYS.filter(d => h.days?.[d]).length;
      
      for (const [cat, data] of Object.entries(categories)) {
        if (data.keywords.some(kw => habitLower.includes(kw))) {
          data.count++;
          data.completed += days;
          break;
        }
      }
    });
    
    const categoryRankings = Object.entries(categories)
      .map(([name, data]) => ({ name, ...data }))
      .filter(c => c.count > 0)
      .sort((a, b) => b.count - a.count);
    
    const topCategory = categoryRankings[0] || null;
    
    // Streak calculation (consecutive weeks with 70%+ completion)
    let longestStreak = 0;
    let currentStreak = 0;
    let tempStreak = 0;
    
    weeksTracked.sort().forEach(week => {
      const perf = weeklyPerformance[week];
      if (perf && perf.rate >= 70) {
        tempStreak++;
        longestStreak = Math.max(longestStreak, tempStreak);
      } else {
        tempStreak = 0;
      }
    });
    
    // Current streak (from most recent week backwards)
    const recentWeeks = [...weeksTracked].sort().reverse();
    for (const week of recentWeeks) {
      const perf = weeklyPerformance[week];
      if (perf && perf.rate >= 70) {
        currentStreak++;
      } else {
        break;
      }
    }
    
    // Fun facts
    const funFacts = [];
    
    if (totalDaysCompleted > 100) {
      funFacts.push(`You completed ${totalDaysCompleted} habit days - that's like building a skyscraper one brick at a time! `);
    }
    if (perfectWeeks > 0) {
      funFacts.push(`You had ${perfectWeeks} PERFECT week${perfectWeeks > 1 ? 's' : ''} where you crushed every single goal! `);
    }
    if (topHabit && topHabit.rate >= 90) {
      funFacts.push(`"${topHabit.name}" became your signature move with ${topHabit.rate}% completion! `);
    }
    if (longestStreak >= 4) {
      funFacts.push(`Your ${longestStreak}-week streak proves you've got serious staying power! `);
    }
    if (categoryRankings.length >= 3) {
      funFacts.push(`You tracked habits across ${categoryRankings.length} different life areas - true balance! `);
    }
    const morningHabits = myHabits.filter(h => (h.habit || '').toLowerCase().includes('morning') || (h.habit || '').toLowerCase().includes('wake') || (h.habit || '').toLowerCase().includes('5:30') || (h.habit || '').toLowerCase().includes('6am'));
    if (morningHabits.length > 0) {
      funFacts.push(`You committed to ${morningHabits.length} morning routine habits - early bird gets the gains! `);
    }
    const noHabits = myHabits.filter(h => (h.habit || '').toLowerCase().startsWith('no '));
    if (noHabits.length >= 3) {
      funFacts.push(`${noHabits.length} "No" habits tracked - saying no to distractions is saying yes to success! `);
    }
    
    // Group comparison (also excluding current week for fair comparison)
    const groupStats = allParticipants.map(p => {
      const pHabits = habits.filter(h => h.participant === p && h.weekStart !== currentWeekStart);
      const pCompleted = pHabits.reduce((sum, h) => sum + (h.daysCompleted?.length || DAYS.filter(d => h.days?.[d]).length), 0);
      const pTarget = pHabits.reduce((sum, h) => sum + (h.target || 5), 0);
      return {
        name: p,
        rate: pTarget > 0 ? Math.round((pCompleted / pTarget) * 100) : 0,
        totalHabits: pHabits.length,
        totalCompleted: pCompleted
      };
    }).sort((a, b) => b.rate - a.rate);
    
    const myRank = groupStats.findIndex(g => g.name === myParticipantName) + 1;
    const groupLeader = groupStats[0];
    
    // Motivational grade
    let grade = 'C';
    let gradeMessage = "Room for growth - let's make 2026 your breakout year!";
    let gradeEmoji = '';
    
    if (overallCompletionRate >= 90) {
      grade = 'A+';
      gradeMessage = "LEGENDARY! You're in the top tier of habit champions!";
      gradeEmoji = '';
    } else if (overallCompletionRate >= 80) {
      grade = 'A';
      gradeMessage = "Outstanding! Your consistency is truly impressive!";
      gradeEmoji = '';
    } else if (overallCompletionRate >= 70) {
      grade = 'B+';
      gradeMessage = "Strong performance! You showed up when it mattered!";
      gradeEmoji = '';
    } else if (overallCompletionRate >= 60) {
      grade = 'B';
      gradeMessage = "Solid effort! You've built a foundation to grow on!";
      gradeEmoji = '';
    } else if (overallCompletionRate >= 50) {
      grade = 'C+';
      gradeMessage = "You showed up! Now let's level up in 2026!";
      gradeEmoji = '';
    }
    
    return {
      totalHabitsTracked,
      totalDaysCompleted,
      totalTargetDays,
      overallCompletionRate,
      totalWeeks,
      weeksTracked,
      topHabit,
      worstHabit,
      perfectHabits,
      habitRankings,
      bestWeek,
      worstWeek,
      perfectWeeks,
      weeklyPerformance,
      categoryRankings,
      topCategory,
      longestStreak,
      currentStreak,
      funFacts,
      groupStats,
      myRank,
      groupLeader,
      grade,
      gradeMessage,
      gradeEmoji,
      myParticipantName
    };
  }, [habits, userProfile, user, allParticipants, currentWeekStart]);

  // Submit weekly check-in
  const submitCheckIn = async () => {
    if (!checkInWins.trim() && !checkInChallenges.trim() && !checkInText.trim()) return;
    
    const checkIn = {
      id: `checkin_${Date.now()}`,
      participant: user.displayName || 'Anonymous',
      participantPhoto: user.photoURL || null,
      weekStart: currentWeek,
      wins: checkInWins,
      challenges: checkInChallenges,
      reflection: checkInText,
      createdAt: new Date().toISOString()
    };
    
    await setDoc(doc(db, 'checkIns', checkIn.id), checkIn);
    setCheckInWins('');
    setCheckInChallenges('');
    setCheckInText('');
  };

  // Delete check-in
  const deleteCheckIn = async (checkInId) => {
    if (window.confirm('Delete this check-in?')) {
      await deleteDoc(doc(db, 'checkIns', checkInId));
    }
  };

  // Compress image before upload
  const compressImage = (file, maxWidth = 800, quality = 0.7) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = () => reject(new Error('Failed to read file'));
      reader.onload = (e) => {
        const img = new Image();
        img.onerror = () => reject(new Error('Failed to load image'));
        img.onload = () => {
          try {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // Scale down if too large
            if (width > maxWidth) {
              height = Math.round((height * maxWidth) / width);
              width = maxWidth;
            }
            
            // Also limit height
            const maxHeight = 800;
            if (height > maxHeight) {
              width = Math.round((width * maxHeight) / height);
              height = maxHeight;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, width, height);
            ctx.drawImage(img, 0, 0, width, height);
            
            // Convert to compressed base64
            let compressedBase64 = canvas.toDataURL('image/jpeg', quality);
            console.log(`Image compressed: ${width}x${height}, quality ${quality}, size: ${compressedBase64.length}`);
            
            // Progressively reduce quality if still too large (Firestore limit ~1MB per doc)
            const maxSize = 700000; // Leave room for other document fields
            let currentQuality = quality;
            
            while (compressedBase64.length > maxSize && currentQuality > 0.1) {
              currentQuality -= 0.1;
              compressedBase64 = canvas.toDataURL('image/jpeg', currentQuality);
              console.log(`Re-compressed at quality ${currentQuality.toFixed(1)}, size: ${compressedBase64.length}`);
            }
            
            // If still too large, reduce dimensions
            if (compressedBase64.length > maxSize) {
              const scale = 0.7;
              canvas.width = Math.round(width * scale);
              canvas.height = Math.round(height * scale);
              ctx.fillStyle = '#FFFFFF';
              ctx.fillRect(0, 0, canvas.width, canvas.height);
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              compressedBase64 = canvas.toDataURL('image/jpeg', 0.5);
              console.log(`Scaled down to ${canvas.width}x${canvas.height}, size: ${compressedBase64.length}`);
            }
            
            resolve(compressedBase64);
          } catch (err) {
            console.error('Canvas error:', err);
            reject(err);
          }
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  };

  // Handle image selection for post
  const handleImageSelect = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    console.log('Selected file:', file.name, file.type, file.size);
    
    if (file.size > 10 * 1024 * 1024) {
      alert('Image must be less than 10MB');
      return;
    }
    
    // Check file type
    if (!file.type.startsWith('image/')) {
      alert('Please select an image file');
      return;
    }
    
    try {
      // Compress the image aggressively for posts
      const compressedImage = await compressImage(file, 500, 0.6);
      console.log('Final compressed image size:', compressedImage.length, 'characters');
      
      if (compressedImage.length > 900000) {
        alert('Image is still too large after compression. Please try a smaller image.');
        return;
      }
      
      setNewPostImage(compressedImage);
      setPostImagePreview(compressedImage);
    } catch (error) {
      console.error('Error compressing image:', error);
      alert('Failed to process image: ' + error.message);
    }
    
    // Reset the input so the same file can be selected again
    e.target.value = '';
  };

  // Apply text formatting
  const applyFormat = (format) => {
    const textarea = postTextRef.current;
    if (!textarea) return;
    
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = newPostText;
    const selectedText = text.substring(start, end);
    
    let formattedText = '';
    let cursorOffset = 0;
    
    switch (format) {
      case 'bold':
        formattedText = `**${selectedText}**`;
        cursorOffset = 2;
        break;
      case 'italic':
        formattedText = `_${selectedText}_`;
        cursorOffset = 1;
        break;
      case 'bullet':
        formattedText = `\n ${selectedText}`;
        cursorOffset = 3;
        break;
      default:
        return;
    }
    
    const newText = text.substring(0, start) + formattedText + text.substring(end);
    setNewPostText(newText);
    
    // Reset cursor position
    setTimeout(() => {
      textarea.focus();
      const newPos = start + cursorOffset + (selectedText ? selectedText.length + cursorOffset : 0);
      textarea.setSelectionRange(newPos, newPos);
    }, 0);
  };

  // Render formatted text
  const renderFormattedText = (text) => {
    if (!text) return null;
    
    // Convert markdown-style formatting to HTML
    let formatted = text
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/_(.*?)_/g, '<em>$1</em>')
      .replace(/\n/g, '<br/>');
    
    return <span dangerouslySetInnerHTML={{ __html: formatted }} />;
  };

  // Create new post
  const createPost = async () => {
    if (!newPostText.trim() && !newPostImage) return;
    
    try {
      // Use profile photo if available, otherwise Google photo
      const authorPhoto = userProfile?.photoURL || user.photoURL || null;
      
      const post = {
        id: `post_${Date.now()}`,
        author: userProfile?.linkedParticipant || user.displayName || 'Anonymous',
        authorPhoto: authorPhoto,
        authorId: user.uid,
        content: newPostText,
        image: newPostImage || null,
        reactions: {},
        comments: [],
        createdAt: new Date().toISOString()
      };
      
      console.log('Creating post, image size:', newPostImage ? newPostImage.length : 0);
      
      await setDoc(doc(db, 'posts', post.id), post);
      setNewPostText('');
      setNewPostImage(null);
      setPostImagePreview(null);
    } catch (error) {
      console.error('Error creating post:', error);
      if (error.message?.includes('bytes') || error.code === 'invalid-argument') {
        alert('Image is too large for the database. Please try a smaller image or post without an image.');
      } else {
        alert('Failed to create post: ' + error.message);
      }
    }
  };

  // Add reaction to post
  const addReaction = async (postId, emoji) => {
    const post = posts.find(p => p.id === postId);
    if (!post) return;
    
    const reactions = { ...post.reactions };
    const userKey = user.uid;
    
    if (reactions[emoji]?.includes(userKey)) {
      // Remove reaction
      reactions[emoji] = reactions[emoji].filter(id => id !== userKey);
      if (reactions[emoji].length === 0) delete reactions[emoji];
    } else {
      // Add reaction
      if (!reactions[emoji]) reactions[emoji] = [];
      reactions[emoji].push(userKey);
    }
    
    await setDoc(doc(db, 'posts', postId), { ...post, reactions }, { merge: true });
  };

  // Add comment to post
  const addComment = async (postId) => {
    const commentText = commentTexts[postId];
    if (!commentText?.trim()) return;
    
    const post = posts.find(p => p.id === postId);
    if (!post) return;
    
    const newComment = {
      id: `comment_${Date.now()}`,
      author: user.displayName || 'Anonymous',
      authorPhoto: user.photoURL || null,
      authorId: user.uid,
      text: commentText,
      createdAt: new Date().toISOString()
    };
    
    const comments = [...(post.comments || []), newComment];
    await setDoc(doc(db, 'posts', postId), { ...post, comments }, { merge: true });
    setCommentTexts({ ...commentTexts, [postId]: '' });
  };

  // Delete post
  const deletePost = async (postId) => {
    if (window.confirm('Delete this post?')) {
      await deleteDoc(doc(db, 'posts', postId));
    }
  };

  // Create new challenge
  const createBet = async () => {
    // For group challenges, check if at least one participant selected
    // For 1v1, check if challenged is set
    const hasParticipants = newBet.isGroup 
      ? (newBet.challenged && newBet.challenged.length > 0)
      : newBet.challenged;
    
    if (!hasParticipants || !newBet.goal) return;
    
    const bet = {
      id: `bet_${Date.now()}`,
      challenger: userProfile?.linkedParticipant || user.displayName || 'Anonymous',
      challengerId: user.uid,
      challengerPhoto: userProfile?.photoURL || user.photoURL,
      challenged: newBet.isGroup ? newBet.challenged : [newBet.challenged], // Always store as array
      isGroup: newBet.isGroup || false,
      allowMultipleWinners: newBet.allowMultipleWinners || false,
      goal: newBet.goal,
      reward: newBet.reward || 'Bragging rights! ',
      deadline: newBet.deadline || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      status: 'pending', // pending, accepted, declined, completed
      acceptedBy: [], // Track who has accepted (for group challenges)
      declinedBy: [], // Track who has declined
      acceptedAt: null,
      completedAt: null,
      winner: null, // Can be string or array now
      winners: [], // New field for multiple winners
      createdAt: new Date().toISOString()
    };
    
    await setDoc(doc(db, 'bets', bet.id), bet);
    setNewBet({ challenger: '', challenged: [], goal: '', reward: '', deadline: '', isGroup: false, allowMultipleWinners: false });
    setShowNewBet(false);
    setChallengeSuggestions([]);
    setPrizeSuggestions([]);
  };

  // Update/Edit challenge
  const updateBet = async () => {
    if (!editingBet || !editingBet.goal) return;
    
    await setDoc(doc(db, 'bets', editingBet.id), {
      ...editingBet
    }, { merge: true });
    setEditingBet(null);
  };

  // Accept challenge (updated for group support)
  const acceptBet = async (betId) => {
    const bet = bets.find(b => b.id === betId);
    if (!bet) return;
    
    const myName = userProfile?.linkedParticipant || user.displayName;
    
    if (bet.isGroup) {
      // For group challenges, add to acceptedBy array
      const acceptedBy = [...(bet.acceptedBy || [])];
      if (!acceptedBy.includes(myName)) {
        acceptedBy.push(myName);
      }
      
      // Check if all participants have accepted
      const allAccepted = bet.challenged.every(p => acceptedBy.includes(p));
      
      await setDoc(doc(db, 'bets', betId), { 
        ...bet, 
        acceptedBy,
        status: allAccepted ? 'accepted' : 'pending',
        acceptedAt: allAccepted ? new Date().toISOString() : null
      }, { merge: true });
    } else {
      // 1v1 challenge - original behavior
      await setDoc(doc(db, 'bets', betId), { 
        ...bet, 
        status: 'accepted',
        acceptedBy: [myName],
        acceptedAt: new Date().toISOString()
      }, { merge: true });
    }
    
    // Close the incoming challenge modal if open
    setShowIncomingChallenge(null);
  };

  // Decline challenge
  const declineBet = async (betId) => {
    const bet = bets.find(b => b.id === betId);
    if (!bet) return;
    
    const myName = userProfile?.linkedParticipant || user.displayName;
    const declinedBy = [...(bet.declinedBy || [])];
    if (!declinedBy.includes(myName)) {
      declinedBy.push(myName);
    }
    
    await setDoc(doc(db, 'bets', betId), { 
      ...bet,
      declinedBy,
      status: 'declined'
    }, { merge: true });
    
    setShowIncomingChallenge(null);
  };

  // Complete challenge (mark winner - now supports multiple winners)
  const completeBet = async (betId, winnerName, isMultiple = false) => {
    const bet = bets.find(b => b.id === betId);
    if (!bet) return;
    
    if (isMultiple && bet.allowMultipleWinners) {
      // Toggle winner in the winners array
      const currentWinners = [...(bet.winners || [])];
      const idx = currentWinners.indexOf(winnerName);
      if (idx >= 0) {
        currentWinners.splice(idx, 1);
      } else {
        currentWinners.push(winnerName);
      }
      
      await setDoc(doc(db, 'bets', betId), { 
        ...bet, 
        winners: currentWinners,
        // Don't mark as completed until explicitly done
      }, { merge: true });
    } else {
      // Single winner - complete immediately
      await setDoc(doc(db, 'bets', betId), { 
        ...bet, 
        status: 'completed',
        winner: winnerName,
        winners: [winnerName],
        completedAt: new Date().toISOString()
      }, { merge: true });
    }
  };

  // Finalize challenge with multiple winners
  const finalizeBetWithWinners = async (betId) => {
    const bet = bets.find(b => b.id === betId);
    if (!bet || !bet.winners || bet.winners.length === 0) return;
    
    await setDoc(doc(db, 'bets', betId), { 
      ...bet, 
      status: 'completed',
      winner: bet.winners.length === 1 ? bet.winners[0] : bet.winners.join(', '),
      completedAt: new Date().toISOString()
    }, { merge: true });
  };

  // AI Generate Challenge Suggestions
  const generateChallengeSuggestions = async () => {
    setLoadingChallengeSuggestions(true);
    try {
      const participants = newBet.isGroup 
        ? newBet.challenged.join(', ')
        : newBet.challenged;
      
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': ANTHROPIC_API_KEY,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 500,
          messages: [{
            role: 'user',
            content: `Generate 5 fun and motivating accountability challenge ideas for habit tracking. The challenger is "${userProfile?.linkedParticipant || 'Someone'}" and they're challenging "${participants || 'a friend'}".

Mix of challenge types:
- Completion-based (hit X% completion)
- Streak-based (maintain habits for X days/weeks)
- Head-to-head (who performs better)
- Group achievement (everyone hits a goal)

Return ONLY a JSON array of 5 strings, each being a complete challenge description. Make them specific, measurable, and exciting! Examples:
["Hit 90% habit completion for the next 2 weeks", "7-day perfect streak showdown", "Most improved completion rate wins"]

JSON array only, no other text:`
          }]
        })
      });
      
      const data = await response.json();
      const text = data.content?.[0]?.text || '[]';
      const suggestions = JSON.parse(text.replace(/```json|```/g, '').trim());
      setChallengeSuggestions(suggestions);
    } catch (error) {
      console.error('Challenge suggestions error:', error);
      setChallengeSuggestions([
        "Hit 85% habit completion this week",
        "7-day streak challenge - no missed habits",
        "Most habits exceeded by end of month wins",
        "Complete every habit for 5 days straight",
        "Beat your personal best completion rate"
      ]);
    }
    setLoadingChallengeSuggestions(false);
  };

  // AI Generate Prize Suggestions
  const generatePrizeSuggestions = async () => {
    setLoadingPrizeSuggestions(true);
    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': ANTHROPIC_API_KEY,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 400,
          messages: [{
            role: 'user',
            content: `Generate 6 fun prize/reward ideas for an accountability challenge between friends. Mix of:
- Free/fun stakes (bragging rights, social media shoutout)
- Small stakes ($5-20 value)
- Medium stakes (lunch, coffee, small gift)
- Funny/creative stakes (embarrassing task)

Return ONLY a JSON array of 6 strings with emoji. Examples:
[" Eternal bragging rights", " Loser buys coffee", " Winner gets a social media shoutout"]

JSON array only:`
          }]
        })
      });
      
      const data = await response.json();
      const text = data.content?.[0]?.text || '[]';
      const suggestions = JSON.parse(text.replace(/```json|```/g, '').trim());
      setPrizeSuggestions(suggestions);
    } catch (error) {
      console.error('Prize suggestions error:', error);
      setPrizeSuggestions([
        " Eternal bragging rights",
        " Loser buys winner coffee",
        " Pizza on the loser",
        " Winner gets a hype post on social media",
        " Loser does 50 burpees on video",
        " Loser has to do winner's least favorite habit for a week"
      ]);
    }
    setLoadingPrizeSuggestions(false);
  };

  // Delete challenge
  const deleteBet = async (betId) => {
    if (window.confirm('Delete this challenge?')) {
      await deleteDoc(doc(db, 'bets', betId));
    }
  };

  // Handle profile photo upload
  const handleProfilePhotoSelect = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    console.log('Profile photo selected:', file.name, file.type, file.size);
    
    if (file.size > 10 * 1024 * 1024) {
      alert('Image must be less than 10MB');
      return;
    }
    
    if (!file.type.startsWith('image/')) {
      alert('Please select an image file');
      return;
    }
    
    try {
      // Compress profile photo to smaller size (profile photos are small)
      const compressedImage = await compressImage(file, 150, 0.7);
      console.log('Profile photo compressed, size:', compressedImage.length);
      
      if (compressedImage.length > 200000) {
        // Profile photos should be small
        const smallerImage = await compressImage(file, 100, 0.5);
        setProfilePhotoPreview(smallerImage);
        setProfileForm({ ...profileForm, photoURL: smallerImage });
      } else {
        setProfilePhotoPreview(compressedImage);
        setProfileForm({ ...profileForm, photoURL: compressedImage });
      }
    } catch (error) {
      console.error('Error compressing profile image:', error);
      alert('Failed to process image: ' + error.message);
    }
    
    // Reset the input
    e.target.value = '';
  };

  // Save profile
  const saveProfile = async () => {
    if (!user) return;
    
    try {
      const profile = {
        odingUserId: user.uid,
        odingEmail: user.email,
        odingDisplayName: user.displayName,
        odingPhoto: user.photoURL,
        displayName: profileForm.displayName || user.displayName,
        bio: profileForm.bio || '',
        linkedParticipant: profileForm.linkedParticipant || '',
        location: profileForm.location || '',
        goals: profileForm.goals || '',
        photoURL: profileForm.photoURL || user.photoURL || '',
        updatedAt: new Date().toISOString()
      };
      
      const profileId = userProfile?.id || `profile_${user.uid}`;
      await setDoc(doc(db, 'profiles', profileId), profile, { merge: true });
      alert('Profile saved!');
    } catch (error) {
      console.error('Error saving profile:', error);
      alert('Failed to save profile. Please try again.');
    }
  };

  // Open profile view for a participant
  const openProfileView = (participantName) => {
    const profile = getProfileByParticipant(participantName);
    if (profile) {
      setViewingProfile({ ...profile, participantName });
    } else {
      // Create a minimal profile view for unlinked participants
      setViewingProfile({ 
        participantName,
        displayName: participantName,
        linkedParticipant: participantName
      });
    }
  };

  // Add new participant
  const addNewParticipant = async () => {
    if (!newParticipantName.trim()) return;
    
    // Just set it as the linked participant - it will automatically be added to allParticipants
    setProfileForm({ ...profileForm, linkedParticipant: newParticipantName.trim() });
    setNewParticipantName('');
    setShowAddParticipant(false);
  };

  // Load initial data to Firestore
  const loadInitialData = async () => {
    try {
      for (const habit of initialData) {
        await setDoc(doc(db, 'habits', `habit_${habit.id}`), habit);
      }
      console.log('Initial data loaded successfully');
    } catch (error) {
      console.error('Error loading initial data:', error);
    }
  };

  // Sign in
  const handleSignIn = async () => {
    try {
      await signInWithPopup(auth, googleProvider);
    } catch (error) {
      console.error('Sign in error:', error);
    }
  };

  // Sign out
  const handleSignOut = () => signOut(auth);

  // Close calendar on click outside
  useEffect(() => {
    const handleClickOutside = (e) => {
      if (calendarRef.current && !calendarRef.current.contains(e.target)) {
        setShowCalendar(false);
      }
    };
    if (showCalendar) document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [showCalendar]);

  // Computed values - generate weeks from earliest habit through future
  const ALL_WEEKS = useMemo(() => {
    // Get weeks from existing habits
    const habitWeeks = [...new Set(habits.map(h => h.weekStart))].filter(Boolean);
    
    // Get current week's Monday
    const getMonday = (d) => {
      const date = new Date(d);
      const day = date.getDay();
      const diff = date.getDate() - day + (day === 0 ? -6 : 1);
      const monday = new Date(date.getFullYear(), date.getMonth(), diff);
      return monday.toISOString().split('T')[0];
    };
    
    const today = new Date();
    const currentMonday = getMonday(new Date(today)); // Pass a copy
    
    // Find the earliest week (from habits or default to 8 weeks ago)
    let earliestWeek = currentMonday;
    if (habitWeeks.length > 0) {
      earliestWeek = habitWeeks.sort()[0];
    } else {
      // Default start: 8 weeks ago
      const eightWeeksAgo = new Date(today);
      eightWeeksAgo.setDate(eightWeeksAgo.getDate() - 56);
      earliestWeek = getMonday(new Date(eightWeeksAgo));
    }
    
    // Generate all weeks from earliest through 52 weeks into future (1 year ahead)
    const weeks = [];
    const startDate = new Date(earliestWeek + 'T00:00:00');
    const futureDate = new Date();
    futureDate.setFullYear(futureDate.getFullYear() + 1); // 1 year ahead
    
    let current = new Date(startDate);
    while (current <= futureDate) {
      weeks.push(current.toISOString().split('T')[0]);
      current.setDate(current.getDate() + 7);
    }
    
    // Ensure current week is always included
    if (!weeks.includes(currentMonday)) {
      weeks.push(currentMonday);
      weeks.sort();
    }
    
    return weeks;
  }, [habits]);
  
  // Calculate current Monday
  const getCurrentMonday = () => {
    const today = new Date();
    const day = today.getDay();
    const diff = today.getDate() - day + (day === 0 ? -6 : 1);
    const mondayDate = new Date(today.getFullYear(), today.getMonth(), diff);
    return mondayDate.toISOString().split('T')[0];
  };
  
  // Auto-initialize to current week when data loads
  useEffect(() => {
    // Only auto-set when we don't have a selected week yet
    if (!selectedWeek && ALL_WEEKS.length > 0) {
      const currentMon = getCurrentMonday();
      if (ALL_WEEKS.includes(currentMon)) {
        console.log('Auto-selecting current week:', currentMon);
        setSelectedWeek(currentMon);
      } else if (ALL_WEEKS.length > 0) {
        // Fallback to most recent week
        console.log('Current week not found, using latest:', ALL_WEEKS[ALL_WEEKS.length - 1]);
        setSelectedWeek(ALL_WEEKS[ALL_WEEKS.length - 1]);
      }
    }
  }, [ALL_WEEKS, selectedWeek]);

  // Calculate current week and index from selectedWeek
  const currentWeek = useMemo(() => {
    if (selectedWeek && ALL_WEEKS.includes(selectedWeek)) {
      return selectedWeek;
    }
    // Fallback to current Monday
    const currentMon = getCurrentMonday();
    if (ALL_WEEKS.includes(currentMon)) {
      return currentMon;
    }
    // Ultimate fallback
    return ALL_WEEKS[ALL_WEEKS.length - 1] || '';
  }, [selectedWeek, ALL_WEEKS]);
  
  const safeWeekIndex = useMemo(() => {
    const idx = ALL_WEEKS.indexOf(currentWeek);
    return idx !== -1 ? idx : Math.max(0, ALL_WEEKS.length - 1);
  }, [currentWeek, ALL_WEEKS]);

  // Check if a week is in the past (Sunday of that week has passed)
  const isWeekPast = useMemo(() => {
    if (!currentWeek) return false;
    const weekStart = new Date(currentWeek + 'T00:00:00');
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekEnd.getDate() + 6); // Sunday
    weekEnd.setHours(23, 59, 59, 999);
    return new Date() > weekEnd;
  }, [currentWeek]);

  // Reset editingPastWeek when navigating to a different week
  useEffect(() => {
    setEditingPastWeek(false);
  }, [currentWeek]);

  // Get the user's assigned participant name
  const myParticipant = userProfile?.linkedParticipant || user?.displayName || '';

  // === ANALYTICS CALCULATIONS (no Firebase needed) ===
  
  // Calculate best/worst days of the week
  const dayAnalytics = useMemo(() => {
    if (!myParticipant) return { best: null, worst: null, dayStats: [] };
    
    const myHabits = habits.filter(h => h.participant === myParticipant);
    if (myHabits.length === 0) return { best: null, worst: null, dayStats: [] };
    
    const dayTotals = [0, 0, 0, 0, 0, 0, 0];
    const dayPossible = [0, 0, 0, 0, 0, 0, 0];
    
    myHabits.forEach(h => {
      for (let i = 0; i < 7; i++) {
        dayPossible[i]++;
        if ((h.daysCompleted || []).includes(i)) {
          dayTotals[i]++;
        }
      }
    });
    
    const dayStats = DAYS.map((day, i) => ({
      day,
      dayIndex: i,
      completed: dayTotals[i],
      possible: dayPossible[i],
      rate: dayPossible[i] > 0 ? Math.round((dayTotals[i] / dayPossible[i]) * 100) : 0
    }));
    
    const sorted = [...dayStats].sort((a, b) => b.rate - a.rate);
    
    return {
      best: sorted[0] || null,
      worst: sorted[sorted.length - 1] || null,
      dayStats
    };
  }, [habits, myParticipant]);

  // Calculate per-habit streaks
  const habitStreaks = useMemo(() => {
    if (!myParticipant) return {};
    
    const myHabits = habits.filter(h => h.participant === myParticipant);
    const habitMap = {};
    
    myHabits.forEach(h => {
      const name = h.habit?.toLowerCase().trim();
      if (!name) return;
      if (!habitMap[name]) habitMap[name] = [];
      habitMap[name].push(h);
    });
    
    const streaks = {};
    Object.entries(habitMap).forEach(([name, habitList]) => {
      const sorted = habitList.sort((a, b) => (a.weekStart || '').localeCompare(b.weekStart || ''));
      
      let currentStreak = 0;
      let longestStreak = 0;
      let totalDays = 0;
      
      sorted.forEach(h => {
        totalDays += h.daysCompleted?.length || 0;
        const completed = h.daysCompleted?.length || 0;
        const target = h.target || 5;
        if (completed >= target) {
          currentStreak++;
          longestStreak = Math.max(longestStreak, currentStreak);
        } else {
          currentStreak = 0;
        }
      });
      
      streaks[name] = {
        displayName: habitList[0]?.habit || name,
        currentStreak,
        longestStreak,
        totalDays,
        totalWeeks: sorted.length,
        avgPerWeek: sorted.length > 0 ? (totalDays / sorted.length).toFixed(1) : 0
      };
    });
    
    return streaks;
  }, [habits, myParticipant]);

  // Calculate habit correlations
  const habitCorrelations = useMemo(() => {
    if (!myParticipant) return [];
    
    const myHabits = habits.filter(h => h.participant === myParticipant);
    const weeklyHabits = {};
    
    myHabits.forEach(h => {
      if (!weeklyHabits[h.weekStart]) weeklyHabits[h.weekStart] = [];
      weeklyHabits[h.weekStart].push(h);
    });
    
    const pairStats = {};
    
    Object.values(weeklyHabits).forEach(weekHabits => {
      for (let i = 0; i < weekHabits.length; i++) {
        for (let j = i + 1; j < weekHabits.length; j++) {
          const h1 = weekHabits[i];
          const h2 = weekHabits[j];
          const key = [h1.habit, h2.habit].sort().join('|||');
          
          if (!pairStats[key]) {
            pairStats[key] = { habit1: h1.habit, habit2: h2.habit, bothDone: 0, total: 0 };
          }
          
          for (let d = 0; d < 7; d++) {
            pairStats[key].total++;
            if ((h1.daysCompleted || []).includes(d) && (h2.daysCompleted || []).includes(d)) {
              pairStats[key].bothDone++;
            }
          }
        }
      }
    });
    
    return Object.values(pairStats)
      .map(p => ({ ...p, correlation: p.total > 0 ? Math.round((p.bothDone / p.total) * 100) : 0 }))
      .filter(p => p.total >= 14)
      .sort((a, b) => b.correlation - a.correlation)
      .slice(0, 10);
  }, [habits, myParticipant]);

  // Calculate monthly stats
  const monthlyStats = useMemo(() => {
    if (!myParticipant) return null;
    
    const { year, month } = reportMonth;
    const monthStart = new Date(year, month, 1);
    const monthEnd = new Date(year, month + 1, 0);
    
    const myHabits = habits.filter(h => {
      if (h.participant !== myParticipant) return false;
      const weekDate = new Date(h.weekStart + 'T00:00:00');
      return weekDate >= monthStart && weekDate <= monthEnd;
    });
    
    if (myHabits.length === 0) return null;
    
    const totalCompleted = myHabits.reduce((sum, h) => sum + (h.daysCompleted?.length || 0), 0);
    const totalTarget = myHabits.reduce((sum, h) => sum + (h.target || 5), 0);
    
    const weeklyBreakdown = {};
    myHabits.forEach(h => {
      if (!weeklyBreakdown[h.weekStart]) weeklyBreakdown[h.weekStart] = { completed: 0, target: 0 };
      weeklyBreakdown[h.weekStart].completed += h.daysCompleted?.length || 0;
      weeklyBreakdown[h.weekStart].target += h.target || 5;
    });
    
    const habitPerformance = {};
    myHabits.forEach(h => {
      if (!habitPerformance[h.habit]) habitPerformance[h.habit] = { completed: 0, target: 0 };
      habitPerformance[h.habit].completed += h.daysCompleted?.length || 0;
      habitPerformance[h.habit].target += h.target || 5;
    });
    
    const topHabits = Object.entries(habitPerformance)
      .map(([name, s]) => ({ name, ...s, rate: s.target > 0 ? Math.round((s.completed / s.target) * 100) : 0 }))
      .sort((a, b) => b.rate - a.rate);
    
    return {
      monthName: monthStart.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
      totalCompleted,
      totalTarget,
      completionRate: totalTarget > 0 ? Math.round((totalCompleted / totalTarget) * 100) : 0,
      weeklyBreakdown: Object.entries(weeklyBreakdown)
        .map(([week, d]) => ({ week, ...d, rate: d.target > 0 ? Math.round((d.completed / d.target) * 100) : 0 }))
        .sort((a, b) => a.week.localeCompare(b.week)),
      topHabits: topHabits.slice(0, 5),
      perfectWeeks: Object.values(weeklyBreakdown).filter(w => w.completed >= w.target).length,
      totalWeeks: Object.keys(weeklyBreakdown).length
    };
  }, [habits, myParticipant, reportMonth]);

  // Set selectedParticipant to myParticipant when profile loads
  useEffect(() => {
    if (myParticipant && selectedParticipant === 'All') {
      setSelectedParticipant(myParticipant);
    }
  }, [myParticipant]);

  const calendarDays = useMemo(() => {
    const { year, month } = calendarMonth;
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startPad = (firstDay.getDay() + 6) % 7;
    const days = [];
    for (let i = 0; i < startPad; i++) days.push(null);
    for (let i = 1; i <= lastDay.getDate(); i++) days.push(new Date(year, month, i));
    return days;
  }, [calendarMonth]);

  const weeklyTrendData = useMemo(() => {
    // Get weeks based on selected range
    let weeksToShow = ALL_WEEKS;
    const today = new Date();
    
    // Filter to only past/current weeks
    weeksToShow = weeksToShow.filter(w => new Date(w + 'T00:00:00') <= today);
    
    if (scorecardRange === 'week') {
      const idx = weeksToShow.indexOf(currentWeek);
      if (idx !== -1) {
        weeksToShow = weeksToShow.slice(Math.max(0, idx - 7), idx + 1);
      }
    } else if (scorecardRange === '4weeks') {
      const idx = weeksToShow.indexOf(currentWeek);
      if (idx !== -1) {
        weeksToShow = weeksToShow.slice(Math.max(0, idx - 7), idx + 1);
      }
    } else if (scorecardRange === 'quarter') {
      const d = new Date(currentWeek + 'T00:00:00');
      const quarterStart = new Date(d.getFullYear(), Math.floor(d.getMonth() / 3) * 3, 1);
      weeksToShow = weeksToShow.filter(w => new Date(w + 'T00:00:00') >= quarterStart && new Date(w + 'T00:00:00') <= d);
    }
    
    return weeksToShow.map(week => {
      const wH = habits.filter(h => h.weekStart === week);
      const completed = wH.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
      const byP = {};
      allParticipants.forEach(p => {
        const pH = wH.filter(h => h.participant === p);
        byP[p] = pH.length > 0 ? Math.round((pH.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length / pH.length) * 100) : 0;
      });
      return { week: formatWeekString(week), rate: wH.length > 0 ? Math.round((completed / wH.length) * 100) : 0, ...byP };
    });
  }, [habits, ALL_WEEKS, scorecardRange, currentWeek, allParticipants]);

  const getRangeHabits = useMemo(() => {
    // "This Week" - show current week (user needs to see their progress)
    if (scorecardRange === 'week') return habits.filter(h => h.weekStart === currentWeek);
    
    // "Last 4 Weeks" - show last 4 COMPLETED weeks, excluding current incomplete week
    if (scorecardRange === '4weeks') { 
      const pastWeeks = ALL_WEEKS.filter(w => w < currentWeekStart).slice(-4);
      return habits.filter(h => pastWeeks.includes(h.weekStart)); 
    }
    
    // "Quarter" - show quarter but exclude current week
    if (scorecardRange === 'quarter') { 
      const d = new Date(currentWeek + 'T00:00:00'); 
      const qs = new Date(d.getFullYear(), Math.floor(d.getMonth() / 3) * 3, 1); 
      return habits.filter(h => new Date(h.weekStart + 'T00:00:00') >= qs && h.weekStart !== currentWeekStart); 
    }
    
    // "All Time" - exclude current week so incomplete weeks don't drag down metrics
    return habits.filter(h => h.weekStart !== currentWeekStart);
  }, [habits, currentWeek, scorecardRange, ALL_WEEKS, currentWeekStart]);

  // My habits in the selected range
  const myRangeHabits = useMemo(() => getRangeHabits.filter(h => h.participant === myParticipant), [getRangeHabits, myParticipant]);

  // Dashboard view mode state
  const [dashboardView, setDashboardView] = useState('personal'); // 'personal' or 'team'

  const statusDistribution = useMemo(() => {
    const habitsToUse = dashboardView === 'personal' ? myRangeHabits : getRangeHabits;
    return Object.keys(STATUS_CONFIG).map(s => ({ name: s, value: habitsToUse.filter(h => getStatus(h) === s).length, color: STATUS_CONFIG[s].color })).filter(d => d.value > 0);
  }, [getRangeHabits, myRangeHabits, dashboardView]);

  const overallStats = useMemo(() => {
    const habitsToUse = dashboardView === 'personal' ? myRangeHabits : getRangeHabits;
    const total = habitsToUse.length, completed = habitsToUse.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
    const exceeded = habitsToUse.filter(h => getStatus(h) === 'Exceeded').length, missed = habitsToUse.filter(h => getStatus(h) === 'Missed').length;
    const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
    return { total, completed, exceeded, missed, rate, trend: 5 };
  }, [getRangeHabits, myRangeHabits, dashboardView]);

  // Team comparison - calculate your rank
  const teamComparison = useMemo(() => {
    const participantRates = allParticipants.map(p => {
      const pH = getRangeHabits.filter(h => h.participant === p);
      const completed = pH.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
      return { name: p, rate: pH.length > 0 ? Math.round((completed / pH.length) * 100) : 0 };
    }).sort((a, b) => b.rate - a.rate);
    
    const myRank = participantRates.findIndex(p => p.name === myParticipant) + 1;
    const teamAvg = participantRates.length > 0 ? Math.round(participantRates.reduce((sum, p) => sum + p.rate, 0) / participantRates.length) : 0;
    const myRate = participantRates.find(p => p.name === myParticipant)?.rate || 0;
    const vsTeam = myRate - teamAvg;
    
    return { rank: myRank, total: participantRates.length, teamAvg, myRate, vsTeam };
  }, [getRangeHabits, allParticipants, myParticipant]);

  const participantData = useMemo(() => allParticipants.map(p => {
    const pH = getRangeHabits.filter(h => h.participant === p);
    const completed = pH.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
    return { name: p, rate: pH.length > 0 ? Math.round((completed / pH.length) * 100) : 0, completed, total: pH.length, color: PARTICIPANT_COLORS[p] || '#6366f1' };
  }), [getRangeHabits, allParticipants]);

  const currentWeekHabits = useMemo(() => habits.filter(h => h.weekStart === currentWeek), [habits, currentWeek]);
  
  // Get previous week's habits for copy feature
  const getPreviousWeekHabits = useMemo(() => {
    if (!myParticipant || !currentWeek) return [];
    
    const currentDate = new Date(currentWeek + 'T00:00:00');
    currentDate.setDate(currentDate.getDate() - 7);
    const lastWeek = currentDate.toISOString().split('T')[0];
    
    return habits.filter(h => h.participant === myParticipant && h.weekStart === lastWeek);
  }, [habits, myParticipant, currentWeek]);

  // Daily stats for current week (Week at a Glance)
  const dailyStats = useMemo(() => {
    const habitsToUse = dashboardView === 'personal' 
      ? currentWeekHabits.filter(h => h.participant === myParticipant)
      : currentWeekHabits;
    
    const weekStart = currentWeek ? new Date(currentWeek + 'T00:00:00') : new Date();
    
    return DAYS.map((dayName, dayIndex) => {
      const dayDate = new Date(weekStart);
      dayDate.setDate(dayDate.getDate() + dayIndex);
      
      const isToday = dayDate.toDateString() === new Date().toDateString();
      const isPast = dayDate < new Date() && !isToday;
      const isFuture = dayDate > new Date();
      
      // Count habits completed on this day
      let completed = 0;
      let total = 0;
      
      habitsToUse.forEach(h => {
        total++;
        if (h.daysCompleted?.includes(dayIndex)) {
          completed++;
        }
      });
      
      const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
      
      return {
        dayIndex,
        dayName,
        shortName: dayName.slice(0, 3),
        date: dayDate,
        dateStr: dayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
        completed,
        total,
        rate,
        isToday,
        isPast,
        isFuture
      };
    });
  }, [currentWeekHabits, currentWeek, dashboardView, myParticipant]);
  
  // Ensure selectedParticipant syncs to a valid value when data changes
  useEffect(() => {
    if (selectedParticipant !== 'All' && currentWeekHabits.length > 0) {
      const hasParticipant = currentWeekHabits.some(h => h.participant === selectedParticipant);
      if (!hasParticipant) {
        // Try to fall back to myParticipant
        const hasMyParticipant = currentWeekHabits.some(h => h.participant === myParticipant);
        if (hasMyParticipant) {
          setSelectedParticipant(myParticipant);
        } else {
          setSelectedParticipant('All');
        }
      }
    }
  }, [currentWeekHabits, selectedParticipant, myParticipant]);
  
  const filteredHabits = selectedParticipant === 'All' ? currentWeekHabits : currentWeekHabits.filter(h => h.participant === selectedParticipant);

  // Firestore operations
  const toggleDay = async (id, idx) => {
    const habit = habits.find(h => h.id === id);
    if (!habit) return;
    
    const newDaysCompleted = (habit.daysCompleted || []).includes(idx)
      ? habit.daysCompleted.filter(d => d !== idx)
      : [...(habit.daysCompleted || []), idx].sort((a, b) => a - b);
    
    await setDoc(doc(db, 'habits', id), { ...habit, daysCompleted: newDaysCompleted });
  };

  // Copy habits from previous week
  const copyHabitsFromLastWeek = async () => {
    if (!myParticipant || !currentWeek || getPreviousWeekHabits.length === 0) return;
    
    const thisWeekHabits = habits.filter(h => h.participant === myParticipant && h.weekStart === currentWeek);
    const existingNames = thisWeekHabits.map(h => h.habit?.toLowerCase().trim());
    
    let copied = 0;
    for (const habit of getPreviousWeekHabits) {
      if (!existingNames.includes(habit.habit?.toLowerCase().trim())) {
        const id = `habit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        await setDoc(doc(db, 'habits', id), {
          id,
          habit: habit.habit,
          participant: myParticipant,
          weekStart: currentWeek,
          habitType: habit.habitType || 'daily',
          target: habit.target || 5,
          daysCompleted: [],
          order: habit.order
        });
        copied++;
      }
    }
    
    if (copied > 0) {
      alert(`Copied ${copied} habit${copied !== 1 ? 's' : ''} from last week!`);
    } else {
      alert('All habits from last week already exist this week.');
    }
  };

  const addPercentageInstance = async (id, success) => {
    const habit = habits.find(h => h.id === id);
    if (!habit) return;
    
    const instances = habit.instances || [];
    const newInstance = { id: Date.now(), success };
    await setDoc(doc(db, 'habits', id), { ...habit, instances: [...instances, newInstance] });
  };

  // Toggle an existing instance between success/fail
  const togglePercentageInstance = async (habitId, instanceId) => {
    const habit = habits.find(h => h.id === habitId);
    if (!habit) return;
    
    const instances = (habit.instances || []).map(i => 
      i.id === instanceId ? { ...i, success: !i.success } : i
    );
    await setDoc(doc(db, 'habits', habitId), { ...habit, instances });
  };

  // Remove an instance from a percentage habit
  const removePercentageInstance = async (habitId, instanceId) => {
    const habit = habits.find(h => h.id === habitId);
    if (!habit) return;
    
    const instances = (habit.instances || []).filter(i => i.id !== instanceId);
    await setDoc(doc(db, 'habits', habitId), { ...habit, instances });
  };

  const addHabit = async () => {
    if (!newHabit.habit || !myParticipant) return;
    const id = `habit_${Date.now()}`;
    const habitData = {
      id,
      habit: newHabit.habit,
      participant: myParticipant, // Always use current user's participant name
      weekStart: currentWeek,
      habitType: newHabit.habitType || 'daily',
      target: parseInt(newHabit.target),
      category: newHabit.category || '' // Will be AI-categorized if blank
    };
    
    // Add type-specific fields
    if (newHabit.habitType === 'percentage') {
      habitData.instances = []; // Array of {id, success: true/false}
    } else {
      habitData.daysCompleted = [];
    }
    
    await setDoc(doc(db, 'habits', id), habitData);
    setNewHabit({ habit: '', participant: myParticipant, target: 5, habitType: 'daily', category: '' });
    setActiveView('tracker');
  };

  const addBulkHabits = async () => {
    if (!myParticipant) return;
    const lines = bulkHabits.split('\n').filter(l => l.trim());
    if (!lines.length) return;
    
    for (const line of lines) {
      const id = `habit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      await setDoc(doc(db, 'habits', id), {
        id,
        habit: line.trim(),
        participant: myParticipant, // Always use current user's participant name
        weekStart: currentWeek,
        habitType: 'daily', // Bulk add defaults to daily
        daysCompleted: [],
        target: parseInt(bulkTarget)
      });
    }
    setBulkHabits('');
    setActiveView('tracker');
  };

  const deleteHabit = async (id) => {
    await deleteDoc(doc(db, 'habits', id));
  };

  // Edit existing habit
  const updateHabit = async () => {
    if (!editingHabit || !editingHabit.habit.trim()) return;
    
    try {
      const habit = habits.find(h => h.id === editingHabit.id);
      if (!habit) {
        console.error('Habit not found:', editingHabit.id);
        return;
      }
      
      await setDoc(doc(db, 'habits', String(editingHabit.id)), {
        ...habit,
        habit: editingHabit.habit.trim(),
        target: parseInt(editingHabit.target),
        category: editingHabit.category || ''
      });
      
      console.log('Habit updated successfully:', editingHabit.id);
      setEditingHabit(null);
    } catch (error) {
      console.error('Error updating habit:', error);
      alert('Failed to save habit. Please try again.');
    }
  };

  // Move habit up or down in the list
  const moveHabit = async (habitId, direction) => {
    const participant = userProfile?.linkedParticipant || user?.displayName || '';
    const myHabits = currentWeekHabits.filter(h => h.participant === participant).sort((a, b) => (a.order || 0) - (b.order || 0));
    const idx = myHabits.findIndex(h => h.id === habitId);
    if (idx === -1) return;
    
    const newIdx = direction === 'up' ? idx - 1 : idx + 1;
    if (newIdx < 0 || newIdx >= myHabits.length) return;
    
    // Swap order values
    const habit1 = myHabits[idx];
    const habit2 = myHabits[newIdx];
    
    const order1 = habit1.order || idx;
    const order2 = habit2.order || newIdx;
    
    await setDoc(doc(db, 'habits', habit1.id), { ...habit1, order: order2 });
    await setDoc(doc(db, 'habits', habit2.id), { ...habit2, order: order1 });
  };

  // AI Categorize uncategorized habits (with rule-based fallback) - personalized per user
  const aiCategorizeHabits = async () => {
    const myHabitsOnly = habits.filter(h => h.participant === myParticipant);
    const uncategorized = myHabitsOnly.filter(h => !h.category);
    if (uncategorized.length === 0) {
      setHabitManagerTab('uncategorized');
      setShowHabitManagerModal(true);
      return;
    }
    
    setCategorizingHabits(true);
    
    // Rule-based categorization keywords
    const categoryKeywords = {
      'Fitness': ['exercise', 'workout', 'gym', 'run', 'walk', 'cardio', 'lift', 'weight', 'stretch', 'yoga', 'sport', 'train', 'swim', 'bike', 'hike', 'steps', 'pushup', 'squat', 'plank', 'fitness', 'active', 'physical'],
      'Business': ['work', 'meeting', 'email', 'project', 'client', 'business', 'sales', 'marketing', 'network', 'linkedin', 'pitch', 'proposal', 'deadline', 'task', 'productivity', 'focus', 'deep work', 'inbox', 'calls'],
      'Finance': ['budget', 'save', 'invest', 'money', 'expense', 'track spending', 'finance', 'stock', 'crypto', 'retire', 'debt', 'income', 'bill', 'tax', 'portfolio', 'trade', 'savings'],
      'Health': ['sleep', 'water', 'vitamin', 'medicine', 'medic', 'doctor', 'health', 'diet', 'eat', 'food', 'meal', 'vegetable', 'fruit', 'calorie', 'fast', 'sugar', 'alcohol', 'smoke', 'weight', 'bmi', 'checkup', 'supplement', 'protein'],
      'Learning': ['read', 'book', 'study', 'learn', 'course', 'tutorial', 'practice', 'skill', 'language', 'write', 'journal', 'podcast', 'video', 'lesson', 'class', 'education', 'research', 'article', 'news'],
      'Relationships': ['family', 'friend', 'call mom', 'call dad', 'date', 'spouse', 'wife', 'husband', 'kids', 'children', 'parent', 'social', 'connect', 'relationship', 'love', 'partner', 'text', 'message', 'visit', 'quality time'],
      'Spiritual': ['pray', 'meditat', 'church', 'bible', 'god', 'spirit', 'faith', 'worship', 'gratitude', 'grateful', 'mindful', 'reflect', 'devotion', 'scripture', 'religious', 'soul', 'peace', 'sermon', 'thankful']
    };
    
    let categorizedCount = 0;
    
    for (const habit of uncategorized) {
      const habitLower = habit.habit.toLowerCase();
      let matchedCategory = null;
      let highestScore = 0;
      
      // Check each category for keyword matches
      for (const [category, keywords] of Object.entries(categoryKeywords)) {
        let score = 0;
        for (const keyword of keywords) {
          if (habitLower.includes(keyword)) {
            score += keyword.length; // Longer matches = higher score
          }
        }
        if (score > highestScore) {
          highestScore = score;
          matchedCategory = category;
        }
      }
      
      // If we found a match, update the habit
      if (matchedCategory) {
        try {
          await setDoc(doc(db, 'habits', habit.id), { ...habit, category: matchedCategory });
          categorizedCount++;
        } catch (e) {
          console.error('Failed to update habit:', habit.id, e);
        }
      }
    }
    
    setCategorizingHabits(false);
    
    // Open the manager modal to show uncategorized habits
    setHabitManagerTab('uncategorized');
    setShowHabitManagerModal(true);
  };

  // Normalize similar habits for unified metrics (rule-based) - personalized per user
  const aiNormalizeHabits = async () => {
    const myHabitsOnly = habits.filter(h => h.participant === myParticipant);
    const allHabitNames = [...new Set(myHabitsOnly.map(h => h.habit))];
    if (allHabitNames.length < 2) {
      setHabitManagerTab('groups');
      setShowHabitManagerModal(true);
      return;
    }
    
    setNormalizingHabits(true);
    
    // Synonyms/similar words that should be grouped together
    const synonymGroups = [
      ['exercise', 'workout', 'gym', 'train', 'physical activity'],
      ['read', 'reading', 'book'],
      ['meditate', 'meditation', 'mindfulness', 'mindful'],
      ['run', 'running', 'jog', 'jogging'],
      ['walk', 'walking', 'steps', '10k steps', '10000 steps'],
      ['water', 'hydrate', 'drink water', 'hydration'],
      ['sleep', 'rest', 'bed'],
      ['journal', 'journaling', 'write', 'writing', 'diary'],
      ['pray', 'prayer', 'devotion', 'devotional'],
      ['study', 'studying', 'learn', 'learning'],
      ['stretch', 'stretching', 'flexibility'],
      ['call', 'phone', 'contact'],
      ['clean', 'cleaning', 'tidy', 'organize'],
      ['cook', 'cooking', 'meal prep', 'prepare food'],
      ['save', 'saving', 'budget', 'budgeting'],
      ['invest', 'investing', 'investment'],
    ];
    
    // Helper to normalize habit name for comparison
    const normalizeForComparison = (name) => {
      return name.toLowerCase()
        .replace(/[0-9]+\s*(min|mins|minutes|hour|hours|hr|hrs|times|x|days|weeks)/gi, '')
        .replace(/[^a-z\s]/g, '')
        .trim();
    };
    
    // Helper to get the canonical (shortest, cleanest) name for a group
    const getCanonicalName = (names) => {
      // Prefer names without numbers, then shortest
      const withoutNumbers = names.filter(n => !/\d/.test(n));
      const pool = withoutNumbers.length > 0 ? withoutNumbers : names;
      return pool.reduce((a, b) => a.length <= b.length ? a : b);
    };
    
    const groups = {};
    const assigned = new Set();
    
    // First pass: group by synonym matches
    for (const habitName of allHabitNames) {
      if (assigned.has(habitName)) continue;
      
      const normalized = normalizeForComparison(habitName);
      
      // Check if this habit matches any synonym group
      for (const synonyms of synonymGroups) {
        const matches = synonyms.some(syn => 
          normalized.includes(syn) || syn.includes(normalized)
        );
        
        if (matches) {
          // Find all habits that match this synonym group
          const matchingHabits = allHabitNames.filter(h => {
            const hNorm = normalizeForComparison(h);
            return synonyms.some(syn => hNorm.includes(syn) || syn.includes(hNorm));
          });
          
          if (matchingHabits.length > 1) {
            const canonical = getCanonicalName(matchingHabits);
            // Capitalize first letter
            const groupName = canonical.charAt(0).toUpperCase() + canonical.slice(1);
            groups[groupName] = matchingHabits;
            matchingHabits.forEach(h => assigned.add(h));
          }
          break;
        }
      }
    }
    
    // Second pass: group by similar prefixes (first 3+ characters)
    for (const habitName of allHabitNames) {
      if (assigned.has(habitName)) continue;
      
      const normalized = normalizeForComparison(habitName);
      if (normalized.length < 3) continue;
      
      const prefix = normalized.slice(0, Math.min(5, normalized.length));
      
      // Find other habits with similar prefix
      const similar = allHabitNames.filter(h => {
        if (assigned.has(h) || h === habitName) return false;
        const hNorm = normalizeForComparison(h);
        return hNorm.startsWith(prefix) || prefix.startsWith(hNorm.slice(0, 3));
      });
      
      if (similar.length > 0) {
        const allInGroup = [habitName, ...similar];
        const canonical = getCanonicalName(allInGroup);
        const groupName = canonical.charAt(0).toUpperCase() + canonical.slice(1);
        groups[groupName] = allInGroup;
        allInGroup.forEach(h => assigned.add(h));
      }
    }
    
    setNormalizingHabits(false);
    
    // Save groups per participant and open the modal
    setHabitNormGroups(groups);
    if (myParticipant) {
      localStorage.setItem(`habitNormGroups_${myParticipant}`, JSON.stringify(groups));
    }
    setHabitManagerTab('groups');
    setShowHabitManagerModal(true);
  };

  // Remove a habit from a normalization group - personalized
  const removeFromNormGroup = (groupName, habitName) => {
    const newGroups = { ...habitNormGroups };
    if (newGroups[groupName]) {
      newGroups[groupName] = newGroups[groupName].filter(h => h !== habitName);
      if (newGroups[groupName].length <= 1) {
        delete newGroups[groupName]; // Remove group if only 1 or 0 habits left
      }
    }
    setHabitNormGroups(newGroups);
    if (myParticipant) {
      localStorage.setItem(`habitNormGroups_${myParticipant}`, JSON.stringify(newGroups));
    }
  };

  // Delete an entire normalization group - personalized
  const deleteNormGroup = (groupName) => {
    const newGroups = { ...habitNormGroups };
    delete newGroups[groupName];
    setHabitNormGroups(newGroups);
    if (myParticipant) {
      localStorage.setItem(`habitNormGroups_${myParticipant}`, JSON.stringify(newGroups));
    }
  };

  // Clear all normalization groups - personalized
  const clearAllNormGroups = () => {
    setHabitNormGroups({});
    if (myParticipant) {
      localStorage.removeItem(`habitNormGroups_${myParticipant}`);
    }
  };

  // Get normalized habit name for metrics
  const getNormalizedHabitName = (habitName) => {
    for (const [normalized, variants] of Object.entries(habitNormGroups)) {
      if (variants.includes(habitName)) {
        return normalized;
      }
    }
    return habitName;
  };

  // Load habit normalization groups from localStorage when participant changes
  useEffect(() => {
    if (myParticipant) {
      const saved = localStorage.getItem(`habitNormGroups_${myParticipant}`);
      if (saved) {
        try {
          setHabitNormGroups(JSON.parse(saved));
        } catch (e) {
          console.error('Failed to load habit norm groups');
          setHabitNormGroups({});
        }
      } else {
        setHabitNormGroups({});
      }
    }
  }, [myParticipant]);

  // Check if current user is owner (can see all individual metrics)
  const isOwner = useMemo(() => {
    return myParticipant === OWNER_PARTICIPANT;
  }, [myParticipant]);

  // Update habit category
  const updateHabitCategory = async (habitId, category) => {
    const habit = habits.find(h => h.id === habitId);
    if (!habit) return;
    await setDoc(doc(db, 'habits', habitId), { ...habit, category });
  };

  // Task management functions
  const addTask = async () => {
    if (!newTask.task.trim()) return;
    
    const taskDoc = {
      id: `task_${Date.now()}`,
      task: newTask.task,
      due_date: newTask.dueDate || new Date().toISOString().split('T')[0],
      priority: newTask.priority,
      category: newTask.category,
      status: 'Not Started',
      created_at: new Date().toISOString(),
      created_by: user?.uid,
      participant: userProfile?.linkedParticipant || user?.displayName
    };
    
    try {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/tasks`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(taskDoc)
      });
      
      if (!response.ok) throw new Error('Failed to add task');
      
      fetchTasks();
      setNewTask({ task: '', dueDate: '', priority: 'Medium', category: 'Work' });
      setShowAddTask(false);
    } catch (error) {
      console.error('Add task error:', error);
    }
  };

  const updateTaskStatus = async (taskId, newStatus) => {
    try {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/tasks?id=eq.${taskId}`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({
          status: newStatus,
          completed_at: newStatus === 'Completed' ? new Date().toISOString() : null
        })
      });
      
      if (!response.ok) throw new Error('Failed to update task');
      
      fetchTasks();
    } catch (error) {
      console.error('Update task error:', error);
    }
  };

  const deleteTask = async (taskId) => {
    try {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/tasks?id=eq.${taskId}`, {
        method: 'DELETE',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      
      if (!response.ok) throw new Error('Failed to delete task');
      
      fetchTasks();
    } catch (error) {
      console.error('Delete task error:', error);
    }
  };

  // Update existing task
  const updateTask = async (taskId, updates) => {
    try {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/tasks?id=eq.${taskId}`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(updates)
      });
      
      if (!response.ok) throw new Error('Failed to update task');
      
      fetchTasks();
      setEditingTask(null);
    } catch (error) {
      console.error('Update task error:', error);
    }
  };

  // Quick add task with natural language parsing
  const quickAddTask = async (taskText, defaultDate = 'today') => {
    if (!taskText.trim()) return;
    
    const today = new Date();
    let dueDateStr = today.toISOString().split('T')[0];
    let timeSlot = null;
    let priority = 'Medium';
    let cleanText = taskText;
    
    // Parse priority (!high, !low, !urgent)
    if (/!high|!urgent|!important/i.test(taskText)) {
      priority = 'High';
      cleanText = cleanText.replace(/!high|!urgent|!important/gi, '').trim();
    } else if (/!low/i.test(taskText)) {
      priority = 'Low';
      cleanText = cleanText.replace(/!low/gi, '').trim();
    }
    
    // Parse date keywords
    if (/\btomorrow\b/i.test(cleanText)) {
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      dueDateStr = tomorrow.toISOString().split('T')[0];
      cleanText = cleanText.replace(/\btomorrow\b/gi, '').trim();
    } else if (/\btoday\b/i.test(cleanText)) {
      cleanText = cleanText.replace(/\btoday\b/gi, '').trim();
    } else if (/\bnext week\b/i.test(cleanText)) {
      const nextWeek = new Date(today);
      nextWeek.setDate(nextWeek.getDate() + 7);
      dueDateStr = nextWeek.toISOString().split('T')[0];
      cleanText = cleanText.replace(/\bnext week\b/gi, '').trim();
    } else if (/\bmonday\b|\btuesday\b|\bwednesday\b|\bthursday\b|\bfriday\b|\bsaturday\b|\bsunday\b/i.test(cleanText)) {
      const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
      const match = cleanText.match(/\b(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/i);
      if (match) {
        const targetDay = days.indexOf(match[1].toLowerCase());
        const currentDay = today.getDay();
        let daysUntil = targetDay - currentDay;
        if (daysUntil <= 0) daysUntil += 7;
        const targetDate = new Date(today);
        targetDate.setDate(targetDate.getDate() + daysUntil);
        dueDateStr = targetDate.toISOString().split('T')[0];
        cleanText = cleanText.replace(/\b(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/gi, '').trim();
      }
    } else if (defaultDate === 'tomorrow') {
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      dueDateStr = tomorrow.toISOString().split('T')[0];
    } else if (defaultDate === 'nextweek') {
      const nextWeek = new Date(today);
      nextWeek.setDate(nextWeek.getDate() + 7);
      dueDateStr = nextWeek.toISOString().split('T')[0];
    } else if (defaultDate === 'inbox') {
      dueDateStr = null; // No date = inbox
    }
    
    // Parse time (e.g., "at 3pm", "@ 14:00", "morning", "afternoon", "evening")
    const timeMatch = cleanText.match(/(?:at |@ ?)(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i);
    if (timeMatch) {
      let hours = parseInt(timeMatch[1]);
      const minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
      const period = timeMatch[3]?.toLowerCase();
      if (period === 'pm' && hours < 12) hours += 12;
      if (period === 'am' && hours === 12) hours = 0;
      timeSlot = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
      cleanText = cleanText.replace(/(?:at |@ ?)\d{1,2}(?::\d{2})?\s*(?:am|pm)?/gi, '').trim();
    } else if (/\bmorning\b/i.test(cleanText)) {
      timeSlot = '09:00';
      cleanText = cleanText.replace(/\bmorning\b/gi, '').trim();
    } else if (/\bafternoon\b/i.test(cleanText)) {
      timeSlot = '14:00';
      cleanText = cleanText.replace(/\bafternoon\b/gi, '').trim();
    } else if (/\bevening\b/i.test(cleanText)) {
      timeSlot = '18:00';
      cleanText = cleanText.replace(/\bevening\b/gi, '').trim();
    }
    
    // Clean up extra spaces
    cleanText = cleanText.replace(/\s+/g, ' ').trim();
    
    const taskDoc = {
      id: `task_${Date.now()}`,
      task: cleanText,
      due_date: dueDateStr,
      time_slot: timeSlot,
      priority: priority,
      category: 'Work',
      status: 'Not Started',
      created_at: new Date().toISOString(),
      created_by: user?.uid,
      participant: userProfile?.linkedParticipant || user?.displayName,
      notes: '',
      time_estimate: 15,
      recurring: null
    };
    
    try {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/tasks`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(taskDoc)
      });
      
      if (!response.ok) throw new Error('Failed to add task');
      
      fetchTasks();
      setQuickTaskInput('');
    } catch (error) {
      console.error('Quick add task error:', error);
    }
  };

  // AI-powered time slot recommendation
  const getAITimeSlot = async (taskId) => {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;
    
    setAiScheduling(true);
    
    // Get existing scheduled tasks for the day
    const taskDate = task.dueDate || new Date().toISOString().split('T')[0];
    const dayTasks = tasks.filter(t => t.dueDate === taskDate && t.time_slot && t.id !== taskId);
    const busySlots = dayTasks.map(t => ({ time: t.time_slot, duration: t.time_estimate || 30 }));
    
    const prompt = `You are a productivity scheduling assistant. Based on the task and context, recommend the best time slot.

Task: "${task.task}"
Priority: ${task.priority}
Estimated duration: ${task.time_estimate || 15} minutes
Date: ${taskDate}
Already scheduled tasks: ${busySlots.length > 0 ? busySlots.map(s => `${s.time} (${s.duration}min)`).join(', ') : 'None'}

Consider:
- High priority tasks should be scheduled during peak focus hours (9-11am or 2-4pm)
- Creative/complex tasks are best in morning
- Administrative tasks can be afternoon
- Avoid scheduling during typical lunch (12-1pm) unless necessary
- Leave buffer time between tasks

Respond with ONLY a JSON object in this exact format:
{"time": "HH:MM", "reason": "brief explanation"}

Example: {"time": "09:30", "reason": "High priority task scheduled during morning focus hours"}`;

    try {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': ANTHROPIC_API_KEY,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 200,
          messages: [{ role: 'user', content: prompt }]
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        const text = data.content[0]?.text || '';
        try {
          const suggestion = JSON.parse(text);
          if (suggestion.time) {
            await updateTask(taskId, { time_slot: suggestion.time });
            alert(`Scheduled for ${suggestion.time}\n\n${suggestion.reason}`);
          }
        } catch (e) {
          console.error('Failed to parse AI response:', text);
        }
      }
    } catch (error) {
      console.error('AI scheduling error:', error);
    }
    
    setAiScheduling(false);
  };

  // Reschedule task quickly
  const rescheduleTask = async (taskId, newDate) => {
    let dueDateStr;
    const today = new Date();
    if (newDate === 'today') {
      dueDateStr = today.toISOString().split('T')[0];
    } else if (newDate === 'tomorrow') {
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      dueDateStr = tomorrow.toISOString().split('T')[0];
    } else if (newDate === 'nextweek') {
      const nextWeek = new Date(today);
      nextWeek.setDate(nextWeek.getDate() + 7);
      dueDateStr = nextWeek.toISOString().split('T')[0];
    } else if (newDate === 'inbox') {
      dueDateStr = null;
    } else {
      dueDateStr = newDate;
    }
    
    await updateTask(taskId, { due_date: dueDateStr, time_slot: null });
  };

  // Snooze task (defer by time)
  const snoozeTask = async (taskId, duration) => {
    const now = new Date();
    let newTime;
    
    if (duration === '1h') {
      now.setHours(now.getHours() + 1);
    } else if (duration === '3h') {
      now.setHours(now.getHours() + 3);
    } else if (duration === 'tomorrow') {
      now.setDate(now.getDate() + 1);
      now.setHours(9, 0, 0, 0);
    } else if (duration === 'nextweek') {
      now.setDate(now.getDate() + 7);
      now.setHours(9, 0, 0, 0);
    }
    
    const dueDateStr = now.toISOString().split('T')[0];
    const timeSlot = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    
    await updateTask(taskId, { due_date: dueDateStr, time_slot: timeSlot });
  };

  // Set task as Top 3 for today
  const toggleTop3 = (taskId) => {
    if (top3Today.includes(taskId)) {
      setTop3Today(top3Today.filter(id => id !== taskId));
    } else if (top3Today.length < 3) {
      setTop3Today([...top3Today, taskId]);
    }
  };

  // Enter focus mode for a task
  const enterFocusMode = (taskId) => {
    setFocusTask(taskId);
    setTaskViewMode('focus');
    setPomodoroTask(taskId);
    setPomodoroTime(25 * 60);
    setPomodoroRunning(false);
  };

  // Exit focus mode
  const exitFocusMode = () => {
    setFocusTask(null);
    setTaskViewMode('list');
    setPomodoroRunning(false);
  };

  // Create recurring task
  const createRecurringTask = async (taskData, recurrence) => {
    const taskDoc = {
      ...taskData,
      id: `task_${Date.now()}`,
      recurring: recurrence, // { frequency: 'daily'|'weekly'|'monthly', days: [0-6] for weekly }
      created_at: new Date().toISOString(),
      created_by: user?.uid,
      participant: userProfile?.linkedParticipant || user?.displayName
    };
    
    try {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/tasks`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(taskDoc)
      });
      
      if (!response.ok) throw new Error('Failed to create recurring task');
      fetchTasks();
    } catch (error) {
      console.error('Recurring task error:', error);
    }
  };

  // Pomodoro timer effect
  useEffect(() => {
    let interval;
    if (pomodoroRunning && pomodoroTime > 0) {
      interval = setInterval(() => {
        setPomodoroTime(prev => prev - 1);
      }, 1000);
    } else if (pomodoroTime === 0 && pomodoroRunning) {
      setPomodoroRunning(false);
      if (Notification.permission === 'granted') {
        new Notification('Pomodoro Complete!', { body: 'Time for a break!' });
      }
    }
    return () => clearInterval(interval);
  }, [pomodoroRunning, pomodoroTime]);

  // Non-Negotiables management
  const saveNonNegotiable = async () => {
    if (!newNonNegotiable.habit.trim() || nonNegotiables.length >= 3) return;
    
    const nnDoc = {
      id: `nn_${Date.now()}_${user?.uid}`,
      habit: newNonNegotiable.habit,
      description: newNonNegotiable.description,
      frequency: newNonNegotiable.frequency,
      participant: userProfile?.linkedParticipant || user?.displayName,
      userId: user?.uid,
      createdAt: new Date().toISOString(),
      streak: 0
    };
    
    await setDoc(doc(db, 'nonNegotiables', nnDoc.id), nnDoc);
    setNewNonNegotiable({ habit: '', description: '', frequency: 'Daily' });
    setShowNonNegotiableModal(false);
  };

  const deleteNonNegotiable = async (nnId) => {
    if (window.confirm('Remove this non-negotiable? This cannot be undone.')) {
      await deleteDoc(doc(db, 'nonNegotiables', nnId));
    }
  };

  const updateNonNegotiableStreak = async (nnId, completed) => {
    const nn = nonNegotiables.find(n => n.id === nnId);
    if (!nn) return;
    
    const newStreak = completed ? (nn.streak || 0) + 1 : 0;
    await setDoc(doc(db, 'nonNegotiables', nnId), { ...nn, streak: newStreak, lastUpdated: new Date().toISOString() }, { merge: true });
  };

  // Mood tracking functions
  const saveMood = async () => {
    const today = new Date().toISOString().split('T')[0];
    const moodDoc = {
      id: `mood_${today}_${user?.uid}`,
      date: today,
      mood: todayMood.mood,
      motivation: todayMood.motivation,
      notes: todayMood.notes,
      participant: userProfile?.linkedParticipant || user?.displayName,
      userId: user?.uid,
      createdAt: new Date().toISOString()
    };
    
    await setDoc(doc(db, 'moods', moodDoc.id), moodDoc);
    setShowMoodModal(false);
    setTodayMood({ mood: 5, motivation: 5, notes: '' });
  };

  // Get today's mood entry
  const todaysMoodEntry = useMemo(() => {
    const today = new Date().toISOString().split('T')[0];
    return moodData.find(m => m.date === today && m.userId === user?.uid);
  }, [moodData, user]);

  // Auto-suggest habits based on past 4 weeks
  const suggestWeeklyHabits = async () => {
    setWeekSuggestLoading(true);
    setWeekHabitSuggestions([]);
    
    try {
      // Get habits from past 4 weeks
      const idx = ALL_WEEKS.indexOf(currentWeek);
      const past4Weeks = ALL_WEEKS.slice(Math.max(0, idx - 4), idx);
      const participant = userProfile?.linkedParticipant || selectedAiParticipant;
      
      const pastHabits = habits.filter(h => 
        h.participant === participant && 
        past4Weeks.includes(h.weekStart)
      );
      
      // Calculate success rates for each habit
      const habitStats = {};
      pastHabits.forEach(h => {
        const key = h.habit;
        if (!habitStats[key]) {
          habitStats[key] = { habit: key, totalCompleted: 0, totalTarget: 0, count: 0 };
        }
        habitStats[key].totalCompleted += h.daysCompleted?.length || 0;
        habitStats[key].totalTarget += h.target || 5;
        habitStats[key].count++;
      });
      
      const response = await fetch('/api/ai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'suggest-weekly',
          participant,
          pastHabits: Object.values(habitStats).map(s => ({
            habit: s.habit,
            successRate: s.totalTarget > 0 ? Math.round((s.totalCompleted / s.totalTarget) * 100) : 0,
            timesTracked: s.count
          }))
        })
      });
      
      const data = await response.json();
      
      if (!data.error && data.message) {
        const habitMatches = data.message.match(/(?:^|\n)[-*]\s*(.+?)(?:\s*[-]\s*(\d+)\s*(?:days?|x)?)?(?=\n|$)/gim);
        if (habitMatches) {
          const parsed = habitMatches.map(match => {
            const cleaned = match.replace(/^[\n\s]*[-*]\s*/, '').trim();
            const targetMatch = cleaned.match(/[-]\s*(\d+)\s*(?:days?|x)?/);
            const habitName = cleaned.replace(/\s*[-]\s*\d+\s*(?:days?|x)?\s*(?:per\s*)?(?:week)?$/i, '').trim();
            return {
              habit: habitName,
              target: targetMatch ? parseInt(targetMatch[1]) : 5,
              added: false
            };
          }).filter(h => 
            h.habit.length > 3 && 
            h.habit.length < 100 &&
            // Filter out section headers and markdown formatting
            !h.habit.startsWith('*') &&
            !h.habit.endsWith('**') &&
            !h.habit.endsWith(':') &&
            !h.habit.match(/^\*+.+:\*+$/) &&
            !h.habit.toLowerCase().includes('habits to continue') &&
            !h.habit.toLowerCase().includes('habits to try') &&
            !h.habit.toLowerCase().includes('struggling habits') &&
            !h.habit.toLowerCase().includes('modified versions') &&
            !h.habit.toLowerCase().includes('successful habits') &&
            !h.habit.toLowerCase().includes('new habits') &&
            !h.habit.toLowerCase().includes('here are') &&
            !h.habit.toLowerCase().includes('based on') &&
            !h.habit.toLowerCase().startsWith('continue') &&
            !h.habit.toLowerCase().startsWith('modify') &&
            !h.habit.toLowerCase().startsWith('suggestion')
          );
          setWeekHabitSuggestions(parsed);
        }
      }
    } catch (error) {
      console.error('Failed to suggest weekly habits:', error);
    }
    
    setWeekSuggestLoading(false);
  };

  // Add habit from weekly suggestions
  const addWeeklyHabit = async (habit, index) => {
    if (!currentWeek) return;
    
    const participant = userProfile?.linkedParticipant || selectedAiParticipant;
    const newHabitDoc = {
      id: `habit_${Date.now()}_weekly_${index}`,
      participant,
      habit: habit.habit,
      target: habit.target,
      daysCompleted: [],
      weekStart: currentWeek,
      order: currentWeekHabits.filter(h => h.participant === participant).length + index
    };
    
    await setDoc(doc(db, 'habits', newHabitDoc.id), newHabitDoc);
    
    setWeekHabitSuggestions(prev => prev.map((h, i) => 
      i === index ? { ...h, added: true } : h
    ));
  };

  // AI Coach function
  const callAI = async (action, goal = '', followUp = '') => {
    setAiLoading(true);
    
    // If it's a follow-up, don't clear the response
    if (!followUp) {
      setAiResponse('');
      setSuggestedHabits([]);
    }
    
    try {
      const participantHabits = selectedAiParticipant === 'All' 
        ? currentWeekHabits 
        : currentWeekHabits.filter(h => h.participant === selectedAiParticipant);
      
      // Get all historical habits for context (to suggest NEW things)
      const allParticipantHabits = habits.filter(h => h.participant === selectedAiParticipant);
      const existingHabitNames = [...new Set(allParticipantHabits.map(h => h.habit.toLowerCase()))];
      
      // Build conversation context
      const conversationContext = followUp ? aiConversation : [];
      
      // Determine the actual action and add context for diverse suggestions
      let effectiveAction = followUp ? 'follow-up' : action;
      let effectiveGoal = followUp || goal;
      
      // For explore-new, add context about existing habits to avoid
      if (action === 'explore-new') {
        effectiveAction = 'suggest-habits';
        effectiveGoal = `Suggest 5-7 NEW and DIFFERENT habits that I have NOT tried before. 
          I want habits OUTSIDE my comfort zone and from categories I haven't explored.
          My existing habits include: ${existingHabitNames.slice(0, 15).join(', ')}.
          Suggest something completely different - maybe creative, social, learning, or wellness habits I haven't considered.
          Focus on variety and growth in new areas.`;
      }
      
      // For category-specific suggestions
      if (action === 'category-suggest') {
        effectiveAction = 'suggest-habits';
        const categoryHabits = existingHabitNames.filter(h => 
          (goal === 'Fitness' && (h.includes('exercise') || h.includes('workout') || h.includes('cardio'))) ||
          (goal === 'Mental' && (h.includes('meditat') || h.includes('journal') || h.includes('read'))) ||
          (goal === 'Finance' && (h.includes('budget') || h.includes('save') || h.includes('invest'))) ||
          (goal === 'Learning' && (h.includes('learn') || h.includes('study') || h.includes('course'))) ||
          (goal === 'Social' && (h.includes('friend') || h.includes('family') || h.includes('network'))) ||
          (goal === 'Spiritual' && (h.includes('pray') || h.includes('gratitude') || h.includes('church'))) ||
          (goal === 'Creative' && (h.includes('draw') || h.includes('write') || h.includes('music') || h.includes('art'))) ||
          (goal === 'Growth' && (h.includes('goal') || h.includes('reflect') || h.includes('improve'))) ||
          (goal === 'Productivity' && (h.includes('task') || h.includes('plan') || h.includes('organize'))) ||
          (goal === 'Recovery' && (h.includes('sleep') || h.includes('rest') || h.includes('stretch')))
        );
        effectiveGoal = `Suggest 5 specific ${goal} habits that would complement my routine.
          I already do: ${categoryHabits.length > 0 ? categoryHabits.join(', ') : 'nothing in this category yet'}.
          Suggest DIFFERENT ${goal.toLowerCase()} habits I haven't tried, with specific targets.
          Be creative and suggest both beginner and advanced options.`;
      }
      
      // Lifestyle Change - Big picture transformational habits
      if (action === 'lifestyle-change') {
        effectiveAction = 'suggest-habits';
        effectiveGoal = `Suggest 5-7 TRANSFORMATIONAL lifestyle habits that could fundamentally improve my life.
          Think big picture: morning routines, evening wind-downs, relationship builders, health transformers.
          I currently track: ${existingHabitNames.slice(0, 10).join(', ')}.
          Suggest habits that could create lasting change - not just daily tasks but life-changing practices.
          Include habits around: sleep optimization, stress reduction, relationship nurturing, physical wellness, mental clarity.
          Each habit should be specific and measurable with a weekly target.`;
      }
      
      // Random Challenge - Fun, unconventional challenges
      if (action === 'random-challenge') {
        effectiveAction = 'suggest-habits';
        const challenges = ['cold showers', 'no phone mornings', 'walking meetings', 'gratitude jar', 'random acts of kindness', 'digital detox', 'sleep tracking', 'posture checks', 'deep breathing breaks'];
        const randomChallenge = challenges[Math.floor(Math.random() * challenges.length)];
        effectiveGoal = `Give me ONE fun and unconventional challenge habit related to "${randomChallenge}" or something equally creative.
          Make it specific, achievable, and include a target for the week.
          Then suggest 4 more totally random, outside-the-box challenge habits I've probably never considered.
          Think: quirky, fun, science-backed, or trending wellness practices.
          NOT basic stuff like "drink water" - I want INTERESTING challenges!`;
      }
      
      // Random Habit - Truly random suggestions
      if (action === 'random-habit') {
        effectiveAction = 'suggest-habits';
        effectiveGoal = `Surprise me with 5 COMPLETELY RANDOM habits from ANY category.
          Mix it up: one from fitness, one creative, one social, one mental, one wild card.
          I don't want suggestions based on what I do - give me a random selection of interesting habits people track.
          Make them specific with targets. Include at least one habit that's unusual or unexpected.`;
      }
      
      // 30-Day Sprint - Intensive short-term habits
      if (action === '30-day-sprint') {
        effectiveAction = 'suggest-habits';
        effectiveGoal = `Suggest 3-5 INTENSIVE 30-day challenge habits.
          These should be daily commitments designed for a focused sprint.
          Examples: 30 days of meditation, 30 days of no sugar, 30 days of journaling.
          Make them challenging but achievable. Focus on habits that create noticeable transformation in a month.
          Each should be trackable with a daily target of 1 (do it or don't).`;
      }
      
      // Habit Experiment - Testing new approaches
      if (action === 'habit-experiment') {
        effectiveAction = 'suggest-habits';
        effectiveGoal = `Suggest 5 EXPERIMENTAL habits to test for one week.
          These should be "hypothesis" habits - things to try and see if they work for me.
          Mix of: productivity experiments, wellness tests, mindset shifts, social experiments.
          Frame each as "Try X to see if Y happens" - make them like mini life experiments.
          Each should be measurable and have a clear target.`;
      }
      
      // Micro Habits - Tiny 2-minute habits
      if (action === 'micro-habits') {
        effectiveAction = 'suggest-habits';
        effectiveGoal = `Suggest 5-7 MICRO habits that take less than 2 minutes each.
          Based on the book "Atomic Habits" - tiny actions that build momentum.
          Examples: 2 pushups, 1 page of reading, 10 seconds of stretching.
          I want TINY versions of bigger habits - the minimum viable habit.
          Each should be embarrassingly small but stackable.`;
      }
      
      // Elite Level - High-performance habits
      if (action === 'elite-habits') {
        effectiveAction = 'suggest-habits';
        effectiveGoal = `Suggest 5 ELITE-LEVEL habits that high performers and successful people practice.
          Think: CEOs, athletes, top performers, thought leaders.
          I currently do: ${existingHabitNames.slice(0, 8).join(', ')}.
          Give me habits that would level-up my routine - advanced practices, not beginner stuff.
          Include specific protocols (time, duration, frequency).`;
      }
      
      // Trending Habits - Popular global practices
      if (action === 'trending-habits') {
        effectiveAction = 'suggest-habits';
        effectiveGoal = `Suggest 5 TRENDING habits that are popular in wellness, productivity, or self-improvement communities right now.
          Think: What are people on Reddit, Twitter, or in biohacking communities tracking?
          Include habits like: ice baths, breathwork protocols, dopamine fasting, zone 2 cardio, etc.
          Give me what's hot right now in the self-improvement world, with specific targets.
          Don't give me old basics - I want current, trending practices!`;
      }
      
      const response = await fetch('/api/ai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: effectiveAction,
          habits: action === 'insights' ? habits : participantHabits,
          participant: selectedAiParticipant,
          goal: effectiveGoal,
          conversation: conversationContext,
          existingHabits: existingHabitNames // Pass existing habits for context
        })
      });
      
      const data = await response.json();
      
      if (data.error) {
        setAiResponse(`Error: ${data.error}`);
      } else {
        const newMessage = data.message;
        setAiResponse(newMessage);
        
        // Update conversation history
        if (followUp) {
          setAiConversation([
            ...aiConversation,
            { role: 'user', content: followUp },
            { role: 'assistant', content: newMessage }
          ]);
        } else {
          setAiConversation([
            { role: 'user', content: `${action}: ${goal || selectedAiParticipant}` },
            { role: 'assistant', content: newMessage }
          ]);
        }
        
        // Parse suggested habits from response (for suggestion actions)
        const suggestionActions = ['suggest-habits', 'write-habit', 'explore-new', 'category-suggest', 
          'lifestyle-change', 'random-challenge', 'random-habit', '30-day-sprint', 
          'habit-experiment', 'micro-habits', 'elite-habits', 'trending-habits'];
        if (suggestionActions.includes(action)) {
          const habitMatches = newMessage.match(/(?:^|\n)[-*]\s*(.+?)(?:\s*[-]\s*(\d+)\s*(?:days?|x)?\s*(?:per\s*)?(?:week)?)?(?=\n|$)/gim);
          if (habitMatches) {
            const parsed = habitMatches.map(match => {
              const cleaned = match.replace(/^[\n\s]*[-*]\s*/, '').trim();
              const targetMatch = cleaned.match(/[-]\s*(\d+)\s*(?:days?|x)?/);
              const habitName = cleaned.replace(/\s*[-]\s*\d+\s*(?:days?|x)?\s*(?:per\s*)?(?:week)?$/i, '').trim();
              return {
                habit: habitName,
                target: targetMatch ? parseInt(targetMatch[1]) : 5,
                added: false
              };
            }).filter(h => 
              h.habit.length > 3 && 
              h.habit.length < 100 &&
              !h.habit.startsWith('*') &&
              !h.habit.endsWith('**') &&
              !h.habit.endsWith(':')
            );
            setSuggestedHabits(parsed);
          }
        }
      }
    } catch (error) {
      setAiResponse('Failed to connect to AI. Please try again.');
    }
    
    setAiLoading(false);
    setAiFollowUp('');
  };

  // Generate AI summaries for all participants
  const generateParticipantSummaries = async () => {
    if (summaryLoading) return;
    setSummaryLoading(true);
    
    try {
      // Get last 4 weeks of data
      const idx = ALL_WEEKS.indexOf(currentWeek);
      const past4Weeks = ALL_WEEKS.slice(Math.max(0, idx - 3), idx + 1);
      const recentHabits = habits.filter(h => past4Weeks.includes(h.weekStart));
      
      const summaries = {};
      
      for (const participant of allParticipants) {
        const pHabits = recentHabits.filter(h => h.participant === participant);
        if (pHabits.length === 0) {
          summaries[participant] = " No habits tracked recently";
          continue;
        }
        
        const completed = pHabits.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
        const exceeded = pHabits.filter(h => getStatus(h) === 'Exceeded').length;
        const missed = pHabits.filter(h => getStatus(h) === 'Missed').length;
        const rate = pHabits.length > 0 ? Math.round((completed / pHabits.length) * 100) : 0;
        
        // Get top habit names
        const habitNames = [...new Set(pHabits.map(h => h.habit))];
        const topHabit = habitNames[0] || '';
        
        // Generate contextual summary
        if (rate >= 90) {
          if (exceeded > 2) {
            summaries[participant] = ` On fire! Exceeding ${exceeded} goals`;
          } else {
            summaries[participant] = ` Excellent consistency at ${rate}%`;
          }
        } else if (rate >= 75) {
          summaries[participant] = ` Strong momentum, ${completed}/${pHabits.length} completed`;
        } else if (rate >= 60) {
          summaries[participant] = ` Good progress, building habits`;
        } else if (rate >= 40) {
          summaries[participant] = missed > 2 ? ` ${missed} habits need attention` : ` Growing, ${rate}% completion`;
        } else if (rate > 0) {
          summaries[participant] = ` Getting started, keep going!`;
        } else {
          summaries[participant] = ` Time to get back on track`;
        }
      }
      
      setParticipantSummaries(summaries);
    } catch (error) {
      console.error('Failed to generate summaries:', error);
    }
    
    setSummaryLoading(false);
  };

  // Auto-generate summaries when data changes (debounced)
  useEffect(() => {
    if (allParticipants.length > 0 && habits.length > 0) {
      const timer = setTimeout(() => {
        generateParticipantSummaries();
      }, 500);
      return () => clearTimeout(timer);
    }
  }, [allParticipants, habits, currentWeek]);

  // Add a suggested habit
  const addSuggestedHabit = async (habit, index) => {
    if (!currentWeek) return;
    
    const participant = userProfile?.linkedParticipant || selectedAiParticipant;
    const newHabitDoc = {
      id: `habit_${Date.now()}_${index}`,
      participant,
      habit: habit.habit,
      target: habit.target,
      daysCompleted: [],
      weekStart: currentWeek
    };
    
    await setDoc(doc(db, 'habits', newHabitDoc.id), newHabitDoc);
    
    // Mark as added
    setSuggestedHabits(prev => prev.map((h, i) => 
      i === index ? { ...h, added: true } : h
    ));
  };

  // Generate habit suggestions from a quote
  const suggestHabitsFromQuote = async (quote) => {
    setQuoteHabitLoading(true);
    setQuoteHabitSuggestions([]);
    
    try {
      const response = await fetch('/api/ai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'quote-habits',
          quote: quote.quote,
          author: quote.author,
          personalApplication: quote.personalApplication,
          businessApplication: quote.businessApplication,
          participant: userProfile?.linkedParticipant || selectedAiParticipant
        })
      });
      
      const data = await response.json();
      
      if (!data.error && data.message) {
        // Parse habits from the response
        const habitMatches = data.message.match(/(?:^|\n)[-*]\s*(.+?)(?:\s*[-]\s*(\d+)\s*(?:days?|x)?\s*(?:per\s*)?(?:week)?)?(?=\n|$)/gim);
        if (habitMatches) {
          const parsed = habitMatches.map(match => {
            const cleaned = match.replace(/^[\n\s]*[-*]\s*/, '').trim();
            const targetMatch = cleaned.match(/[-]\s*(\d+)\s*(?:days?|x)?/);
            const habitName = cleaned.replace(/\s*[-]\s*\d+\s*(?:days?|x)?\s*(?:per\s*)?(?:week)?$/i, '').trim();
            return {
              habit: habitName,
              target: targetMatch ? parseInt(targetMatch[1]) : 5,
              added: false
            };
          }).filter(h => 
            h.habit.length > 3 && 
            h.habit.length < 100 &&
            !h.habit.startsWith('*') &&
            !h.habit.endsWith('**') &&
            !h.habit.endsWith(':')
          );
          setQuoteHabitSuggestions(parsed);
        }
      }
    } catch (error) {
      console.error('Failed to suggest habits from quote:', error);
    }
    
    setQuoteHabitLoading(false);
  };

  // Add habit from quote suggestion
  const addQuoteHabit = async (habit, index) => {
    if (!currentWeek) return;
    
    const participant = userProfile?.linkedParticipant || selectedAiParticipant;
    const newHabitDoc = {
      id: `habit_${Date.now()}_quote_${index}`,
      participant,
      habit: habit.habit,
      target: habit.target,
      daysCompleted: [],
      weekStart: currentWeek
    };
    
    await setDoc(doc(db, 'habits', newHabitDoc.id), newHabitDoc);
    
    setQuoteHabitSuggestions(prev => prev.map((h, i) => 
      i === index ? { ...h, added: true } : h
    ));
  };

  // Generate new quote with custom direction
  const generateQuote = async (customDir = '') => {
    setQuoteLoading(true);
    setShowQuoteModal(false);
    
    // Build direction based on theme type and custom input
    let direction = customDir;
    if (!direction && quoteThemeType !== 'random') {
      const themeDirections = {
        'motivational': 'Focus on motivation, overcoming obstacles, and pushing through challenges',
        'stoic': 'Focus on Stoic philosophy - quotes from Marcus Aurelius, Seneca, Epictetus, or similar themes of control, virtue, and resilience',
        'business': 'Focus on business, entrepreneurship, leadership, and professional growth',
        'faith': 'Focus on faith, spirituality, trust in God, and biblical wisdom',
        'discipline': 'Focus on discipline, consistency, habits, and self-control'
      };
      direction = themeDirections[quoteThemeType] || '';
    }
    
    try {
      const response = await fetch('/api/quote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'generate-quote',
          existingQuotes: quotes,
          customDirection: direction || quoteCustomDirection
        })
      });
      
      const data = await response.json();
      
      if (data.error) {
        console.error('Quote error:', data.error);
      } else {
        // Save to Firestore
        await setDoc(doc(db, 'quotes', data.id), data);
      }
    } catch (error) {
      console.error('Failed to generate quote:', error);
    }
    setQuoteLoading(false);
    setQuoteCustomDirection('');
    setQuoteThemeType('random');
  };

  // Generate PowerPoint for a quote
  // Delete a quote
  const deleteQuote = async (quoteId) => {
    if (window.confirm('Are you sure you want to delete this quote?')) {
      await deleteDoc(doc(db, 'quotes', quoteId));
    }
  };

  const downloadQuotePPTX = async (quote) => {
    // Check if script is already loaded
    const existingScript = document.querySelector('script[src*="pptxgen"]');
    
    if (existingScript && window.PptxGenJS) {
      generatePPTX(quote);
      return;
    }
    
    // Remove any existing failed script
    if (existingScript) {
      existingScript.remove();
    }
    
    // Dynamically load pptxgenjs from CDN
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js';
    script.async = true;
    
    script.onload = () => {
      // Wait for library to fully initialize
      setTimeout(() => {
        if (window.PptxGenJS) {
          generatePPTX(quote);
        } else {
          console.error('PptxGenJS not found on window after load');
          alert('PowerPoint library failed to initialize. Please refresh the page and try again.');
        }
      }, 200);
    };
    
    script.onerror = (e) => {
      console.error('Script load error:', e);
      alert('Failed to load PowerPoint library. Please check your internet connection and try again.');
    };
    
    document.head.appendChild(script);
  };

  const generatePPTX = (quote) => {
    try {
      // Create new presentation instance
      const pptx = new window.PptxGenJS();
      pptx.layout = 'LAYOUT_16x9';
      pptx.title = `${quote.theme || 'Weekly Quote'} - ${quote.author || 'Unknown'}`;
      pptx.author = 'The Accountability Group';
      
      // Helper function to add watermark to a slide
      const addWatermark = (slide) => {
        // Add small logo in bottom right corner
        slide.addImage({ 
          data: WATERMARK_BASE64,
          x: 8.9, // Near right edge (10" wide slide)
          y: 4.7, // Near bottom (5.63" tall slide)
          w: 0.6, 
          h: 0.6,
          transparency: 30 // Slightly transparent
        });
      };
      
      // Slide 1: Title with Theme
      let slide1 = pptx.addSlide();
      slide1.addText('THE ACCOUNTABILITY GROUP', { 
        x: 0.5, y: 1.2, w: 9, h: 0.6, 
        fontSize: 28, bold: true, color: '1E3A5F',
        fontFace: 'Arial'
      });
      slide1.addShape(pptx.ShapeType.rect, { x: 0.5, y: 1.75, w: 3, h: 0.05, fill: { color: 'F5B800' } });
      
      // Theme - large and prominent
      slide1.addText(quote.theme || 'Weekly Wisdom', { 
        x: 0.5, y: 2.2, w: 9, h: 1, 
        fontSize: 44, bold: true, color: 'F5B800',
        fontFace: 'Arial'
      });
      
      const weekDate = quote.weekOf || quote.createdAt || new Date().toISOString();
      slide1.addText(`Week of ${new Date(weekDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`, { 
        x: 0.5, y: 3.3, w: 9, h: 0.5, 
        fontSize: 18, color: '666666',
        fontFace: 'Arial'
      });
      
      // Slide 2: Quote with Theme
      let slide2 = pptx.addSlide();
      slide2.addText(quote.theme || 'Weekly Wisdom', { 
        x: 0.5, y: 0.4, w: 9, h: 0.5, 
        fontSize: 20, bold: true, color: 'F5B800',
        fontFace: 'Arial'
      });
      slide2.addShape(pptx.ShapeType.rect, { x: 0.5, y: 0.9, w: 2, h: 0.05, fill: { color: 'F5B800' } });
      slide2.addText(`"${quote.quote || ''}"`, { 
        x: 0.5, y: 1.3, w: 9, h: 2.2, 
        fontSize: 28, color: '333333',
        fontFace: 'Georgia', valign: 'top'
      });
      slide2.addText(` ${quote.author || 'Unknown'}`, { 
        x: 0.5, y: 3.6, w: 9, h: 0.5, 
        fontSize: 18, color: '666666',
        fontFace: 'Arial'
      });
      if (quote.authorTitle) {
        slide2.addText(quote.authorTitle, { 
          x: 0.5, y: 4, w: 9, h: 0.4, 
          fontSize: 14, italic: true, color: '999999',
          fontFace: 'Arial'
        });
      }
      
      // Slide 3: About the Person
      let slide3 = pptx.addSlide();
      slide3.addText(`About ${quote.author || 'the Author'}`, { 
        x: 0.5, y: 0.5, w: 9, h: 0.6, 
        fontSize: 24, italic: true, color: '1E3A5F',
        fontFace: 'Georgia'
      });
      slide3.addShape(pptx.ShapeType.rect, { x: 0.5, y: 1, w: 2, h: 0.05, fill: { color: 'F5B800' } });
      slide3.addText(quote.authorTitle || '', { 
        x: 0.5, y: 1.3, w: 9, h: 0.5, 
        fontSize: 18, bold: true, color: 'F5B800',
        fontFace: 'Arial'
      });
      slide3.addText(quote.authorBio || '', { 
        x: 0.5, y: 1.9, w: 9, h: 1.5, 
        fontSize: 16, color: '333333',
        fontFace: 'Arial', valign: 'top'
      });
      slide3.addText('Why This Quote Matters:', { 
        x: 0.5, y: 3.3, w: 9, h: 0.4, 
        fontSize: 16, bold: true, color: '1E3A5F',
        fontFace: 'Arial'
      });
      slide3.addText(quote.whyItMatters || '', { 
        x: 0.5, y: 3.7, w: 9, h: 1, 
        fontSize: 14, color: '666666',
        fontFace: 'Arial', valign: 'top'
      });
      
      // Slide 4: Applications
      let slide4 = pptx.addSlide();
      slide4.addText('Applying This Lesson', { 
        x: 0.5, y: 0.5, w: 9, h: 0.6, 
        fontSize: 24, italic: true, color: '1E3A5F',
        fontFace: 'Georgia'
      });
      slide4.addShape(pptx.ShapeType.rect, { x: 0.5, y: 1, w: 2, h: 0.05, fill: { color: 'F5B800' } });
      
      slide4.addText('Personal Life:', { 
        x: 0.5, y: 1.3, w: 4, h: 0.4, 
        fontSize: 16, bold: true, color: '1E3A5F',
        fontFace: 'Arial'
      });
      // Handle both array and string formats
      const personalApp = quote.personalApplication || '';
      const personalPoints = Array.isArray(personalApp) 
        ? personalApp.slice(0, 4) 
        : (typeof personalApp === 'string' ? personalApp.split('\n').filter(p => p.trim()).slice(0, 4) : []);
      personalPoints.forEach((point, i) => {
        const pointText = typeof point === 'string' ? point.replace(/^[-]\s*/, '') : String(point);
        slide4.addText(` ${pointText}`, { 
          x: 0.5, y: 1.7 + (i * 0.4), w: 4, h: 0.4, 
          fontSize: 12, color: '333333',
          fontFace: 'Arial'
        });
      });
      
      slide4.addText('Business & Career:', { 
        x: 5, y: 1.3, w: 4.5, h: 0.4, 
        fontSize: 16, bold: true, color: '1E3A5F',
        fontFace: 'Arial'
      });
      // Handle both array and string formats
      const businessApp = quote.businessApplication || '';
      const businessPoints = Array.isArray(businessApp) 
        ? businessApp.slice(0, 4) 
        : (typeof businessApp === 'string' ? businessApp.split('\n').filter(p => p.trim()).slice(0, 4) : []);
      businessPoints.forEach((point, i) => {
        const pointText = typeof point === 'string' ? point.replace(/^[-]\s*/, '') : String(point);
        slide4.addText(` ${pointText}`, { 
          x: 5, y: 1.7 + (i * 0.4), w: 4.5, h: 0.4, 
          fontSize: 12, color: '333333',
          fontFace: 'Arial'
        });
      });
      
      // Slide 5: Closing
      let slide5 = pptx.addSlide();
      slide5.addText('Closing Thought', { 
        x: 0.5, y: 0.5, w: 9, h: 0.6, 
        fontSize: 24, italic: true, color: '1E3A5F',
        fontFace: 'Georgia'
      });
      slide5.addShape(pptx.ShapeType.rect, { x: 0.5, y: 1, w: 2, h: 0.05, fill: { color: 'F5B800' } });
      slide5.addText(quote.closingThought || '', { 
        x: 0.5, y: 1.5, w: 9, h: 2, 
        fontSize: 20, color: '333333',
        fontFace: 'Georgia', valign: 'top'
      });
      slide5.addText('THE ACCOUNTABILITY GROUP', { 
        x: 0.5, y: 4.5, w: 9, h: 0.5, 
        fontSize: 14, color: '999999',
        fontFace: 'Arial'
      });
      
      // Add watermark to all slides
      addWatermark(slide1);
      addWatermark(slide2);
      addWatermark(slide3);
      addWatermark(slide4);
      addWatermark(slide5);
      
      // Generate filename
      const themeName = (quote.theme || 'Quote').replace(/[^a-zA-Z0-9]/g, '_');
      const weekStr = quote.weekOf || new Date().toISOString().split('T')[0];
      
      // Download
      pptx.writeFile({ fileName: `${themeName}_${weekStr}.pptx` })
        .then(() => {
          console.log('PowerPoint generated successfully');
        })
        .catch(err => {
          console.error('Write file error:', err);
          alert('Failed to save PowerPoint file. Please try again.');
        });
        
    } catch (error) {
      console.error('PowerPoint generation error:', error);
      alert(`Failed to generate PowerPoint: ${error.message}`);
    }
  };

  // Get current week's quote
  const currentQuote = quotes.length > 0 ? quotes[0] : null;

  const prevWeek = () => {
    if (safeWeekIndex > 0) {
      setSelectedWeek(ALL_WEEKS[safeWeekIndex - 1]);
    }
  };
  const nextWeek = () => {
    if (safeWeekIndex < ALL_WEEKS.length - 1) {
      setSelectedWeek(ALL_WEEKS[safeWeekIndex + 1]);
    }
  };
  const goToCurrentWeek = () => {
    const currentMon = getCurrentMonday();
    if (ALL_WEEKS.includes(currentMon)) {
      setSelectedWeek(currentMon);
    }
  };
  const goToLastWeek = () => {
    const currentMon = getCurrentMonday();
    const currentIdx = ALL_WEEKS.indexOf(currentMon);
    if (currentIdx > 0) {
      setSelectedWeek(ALL_WEEKS[currentIdx - 1]);
    }
  };
  const isCurrentWeekSelected = currentWeek === getCurrentMonday();
  const isLastWeekSelected = (() => {
    const currentMon = getCurrentMonday();
    const currentIdx = ALL_WEEKS.indexOf(currentMon);
    return currentIdx > 0 && currentWeek === ALL_WEEKS[currentIdx - 1];
  })();

  const handleCalendarDayClick = (date) => {
    if (!date) return;
    const weekStr = getWeekStartFromDate(date);
    if (ALL_WEEKS.includes(weekStr)) {
      setSelectedWeek(weekStr);
      setShowCalendar(false);
    }
  };

  const rangeLabels = { week: 'This Week', '4weeks': 'Last 4 Weeks', quarter: 'Quarter', all: 'All Time' };

  // Loading state
  if (authLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="w-12 h-12 border-4 border-[#F5B800] border-t-[#1E3A5F] rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-gray-500">Loading...</p>
        </div>
      </div>
    );
  }

  // Login screen
  if (!user) {
    return <LoginScreen onSignIn={handleSignIn} loading={false} />;
  }

  // Data loading
  if (dataLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="w-12 h-12 border-4 border-[#F5B800] border-t-[#1E3A5F] rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-gray-500">Loading habits...</p>
        </div>
      </div>
    );
  }

  // Glass card class helper - DARK MODE FIXED
  const glassCard = darkMode 
    ? 'bg-gray-900/90 backdrop-blur-xl border border-gray-700/50 shadow-2xl' 
    : 'bg-white/60 backdrop-blur-xl border border-white shadow-xl';
  
  const glassBg = darkMode
    ? 'bg-gray-950'
    : 'bg-gradient-to-br from-blue-100 via-purple-50 to-pink-100';

  return (
    <div className={`flex min-h-screen transition-all duration-500 ${glassBg}`} style={{
      backgroundImage: darkMode 
        ? 'none'
        : 'radial-gradient(ellipse at top right, rgba(59, 130, 246, 0.2), transparent 50%), radial-gradient(ellipse at bottom left, rgba(236, 72, 153, 0.15), transparent 50%)'
    }}>
      {/* Splash Screen */}
      {showSplash && (
        <div 
          className={`fixed inset-0 z-[100] flex items-center justify-center bg-white transition-opacity duration-1000 ${splashFading ? 'opacity-0' : 'opacity-100'}`}
        >
          <div className={`transform transition-all duration-1000 ${splashFading ? 'scale-95 opacity-0' : 'scale-100 opacity-100'}`}>
            <img src={WATERMARK_BASE64} alt="Logo" className="w-48 h-48 md:w-64 md:h-64 drop-shadow-lg" />
          </div>
        </div>
      )}
      
      <Sidebar activeView={activeView} setActiveView={setActiveView} user={user} userProfile={userProfile} onSignOut={handleSignOut} darkMode={darkMode} setDarkMode={setDarkMode} onAddHabit={() => setShowAddHabitModal(true)} />
      <div className="flex-1 p-3 md:p-5 overflow-auto pb-32 md:pb-5">
        {/* Mobile Header */}
        <div className="md:hidden flex items-center justify-between mb-3">
          <div className="flex items-center gap-2">
            <img src={LOGO_BASE64} alt="Logo" className="w-7 h-7" />
            <span className={`font-bold text-sm ${darkMode ? 'text-white' : 'text-[#1E3A5F]'}`}>Accountability</span>
          </div>
          <div className="flex items-center gap-1.5">
            <button 
              onClick={() => setDarkMode(!darkMode)}
              className={`p-2 rounded-xl transition-all ${darkMode ? 'bg-[#F5B800]/20 text-[#F5B800]' : 'bg-white/70 text-gray-600'}`}
            >
              {darkMode ? <Sun className="w-4 h-4" /> : <Moon className="w-4 h-4" />}
            </button>
            <button onClick={() => setActiveView('profile')}>
              {(userProfile?.photoURL || user?.photoURL) ? (
                <img src={userProfile?.photoURL || user?.photoURL} alt="" className={`w-8 h-8 rounded-full object-cover ring-2 ${darkMode ? 'ring-[#1E3A5F]' : 'ring-white/20'}`} />
              ) : (
                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${darkMode ? 'bg-gradient-to-br from-[#1E3A5F] to-[#2d4a6f] text-white' : 'bg-[#1E3A5F] text-white'}`}>
                  {user?.displayName?.[0] || '?'}
                </div>
              )}
            </button>
          </div>
        </div>
        
        {/* Greeting + Week Controls */}
        <div className="mb-4">
          <div className="flex items-center justify-between mb-2">
            <div>
              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>{new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</p>
              <h1 className={`text-lg md:text-xl font-bold ${darkMode ? 'text-gray-100' : 'text-gray-800'}`}>Hello, {userProfile?.displayName?.split(' ')[0] || user?.displayName?.split(' ')[0] || 'Team'} </h1>
            </div>
            {/* Desktop week controls */}
            <div className="hidden md:flex items-center gap-2">
              {isCurrentWeekSelected && (
                <button 
                  onClick={goToLastWeek}
                  className={`px-3 py-2 rounded-xl text-sm font-medium transition-all ${
                    darkMode 
                      ? 'bg-amber-500/20 text-amber-400 hover:bg-amber-500/30' 
                      : 'bg-amber-500 text-white hover:bg-amber-600'
                  }`}
                >
                  Last week
                </button>
              )}
              {!isCurrentWeekSelected && (
                <button 
                  onClick={goToCurrentWeek}
                  className={`px-3 py-2 rounded-xl text-sm font-medium transition-all ${
                    darkMode 
                      ? 'bg-blue-500/20 text-blue-400 hover:bg-blue-500/30' 
                      : 'bg-blue-500 text-white hover:bg-blue-600'
                  }`}
                >
                  Today
                </button>
              )}
              <div className="relative" ref={calendarRef}>
                <button onClick={() => setShowCalendar(!showCalendar)} className={`flex items-center gap-2 px-3 py-2 rounded-xl text-sm transition-all backdrop-blur-sm ${
                  darkMode 
                    ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20 hover:bg-gray-700 text-white' 
                    : 'bg-white/70 border border-white/50 hover:border-[#F5B800] text-gray-700'
                }`}>
                  <CalendarDays className={`w-4 h-4 ${darkMode ? 'text-gray-400' : 'text-[#1E3A5F]'}`} />
                  <span className="font-medium">{currentWeek ? formatWeekString(currentWeek) : 'Select week'}</span>
                  <ChevronDown className={`w-3 h-3 transition-transform ${showCalendar ? 'rotate-180' : ''} ${darkMode ? 'text-gray-400' : 'text-gray-400'}`} />
                </button>
                {showCalendar && (
                  <div className={`absolute top-full right-0 mt-2 rounded-2xl p-4 shadow-2xl z-50 backdrop-blur-xl ${
                    darkMode 
                      ? 'bg-gray-800 border border-gray-600 shadow-black/50' 
                      : 'bg-white/90 border border-gray-200'
                  }`} style={{ minWidth: '300px' }}>
                    <div className="flex items-center justify-between mb-3">
                      <button onClick={() => setCalendarMonth(prev => { const d = new Date(prev.year, prev.month - 1, 1); return { year: d.getFullYear(), month: d.getMonth() }; })} className={`p-1.5 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'}`}><ChevronLeft className={`w-4 h-4 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`} /></button>
                      <span className={`font-semibold ${darkMode ? 'text-gray-100' : 'text-gray-800'}`}>{new Date(calendarMonth.year, calendarMonth.month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</span>
                      <button onClick={() => setCalendarMonth(prev => { const d = new Date(prev.year, prev.month + 1, 1); return { year: d.getFullYear(), month: d.getMonth() }; })} className={`p-1.5 rounded-lg transition-colors ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'}`}><ChevronRight className={`w-4 h-4 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`} /></button>
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center mb-2">{['M', 'T', 'W', 'T', 'F', 'S', 'S'].map((d, i) => <div key={i} className={`text-xs font-medium py-1 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>{d}</div>)}</div>
                    <div className="grid grid-cols-7 gap-1">{calendarDays.map((date, i) => {
                      if (!date) return <div key={i} className="w-9 h-9" />;
                      const weekStr = getWeekStartFromDate(date);
                      const hasData = ALL_WEEKS.includes(weekStr);
                      const isThisCurrentWeek = weekStr === currentWeek;
                      const isMonday = date.getDay() === 1;
                      return <button key={i} onClick={() => handleCalendarDayClick(date)} disabled={!hasData} className={`w-9 h-9 rounded-lg text-sm font-medium transition-all ${
                        isThisCurrentWeek 
                          ? 'bg-gradient-to-r from-[#1E3A5F] to-[#2d4a6f] text-white shadow-lg' 
                          : hasData 
                            ? isMonday 
                              ? darkMode ? 'bg-[#1E3A5F]/50 text-[#F5B800] hover:bg-[#F5B800] hover:text-gray-900' : 'bg-[#EBE6D3] text-[#0F2940] hover:bg-[#F5B800]' 
                              : darkMode ? 'text-gray-300 hover:bg-gray-700' : 'text-gray-700 hover:bg-gray-100'
                            : darkMode ? 'text-gray-300 cursor-not-allowed' : 'text-gray-300 cursor-not-allowed'
                      }`}>{date.getDate()}</button>;
                    })}</div>
                    <div className={`mt-3 pt-3 border-t ${darkMode ? 'border-gray-600' : 'border-gray-100'}`}><p className={`text-xs text-center ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>Click any date to jump to that week</p></div>
                  </div>
                )}
              </div>
              <button onClick={prevWeek} disabled={safeWeekIndex === 0} className={`p-2 rounded-xl transition-all disabled:opacity-50 backdrop-blur-sm ${
                darkMode 
                  ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20 hover:bg-gray-700' 
                  : 'bg-white/70 border border-white/50 hover:border-[#F5B800]'
              }`}><ChevronLeft className={`w-4 h-4 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`} /></button>
              <button onClick={nextWeek} disabled={safeWeekIndex === ALL_WEEKS.length - 1} className={`p-2 rounded-xl transition-all disabled:opacity-50 backdrop-blur-sm ${
                darkMode 
                  ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20 hover:bg-gray-700' 
                  : 'bg-white/70 border border-white/50 hover:border-[#F5B800]'
              }`}><ChevronRight className={`w-4 h-4 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`} /></button>
            </div>
          </div>
          
          {/* Mobile Week Selector - Simplified */}
          <div className="md:hidden flex items-center gap-2">
            <button onClick={prevWeek} disabled={safeWeekIndex === 0} className={`p-2.5 rounded-xl transition-all disabled:opacity-30 ${
              darkMode 
                ? 'bg-gray-700 active:bg-gray-500' 
                : 'bg-white/80 active:bg-white'
            }`}>
              <ChevronLeft className={`w-5 h-5 ${darkMode ? 'text-white' : 'text-gray-700'}`} />
            </button>
            <button 
              onClick={() => setShowCalendar(!showCalendar)} 
              className={`flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-xl transition-all ${
                darkMode 
                  ? 'bg-gray-700 active:bg-gray-500' 
                  : 'bg-white/80 active:bg-white'
              }`}
            >
              <CalendarDays className={`w-4 h-4 ${darkMode ? 'text-gray-400' : 'text-[#1E3A5F]'}`} />
              <span className={`font-semibold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                {currentWeek ? formatWeekString(currentWeek) : 'Select week'}
              </span>
            </button>
            {isCurrentWeekSelected && (
              <button 
                onClick={goToLastWeek}
                className={`px-3 py-2.5 rounded-xl text-sm font-medium transition-all ${
                  darkMode 
                    ? 'bg-amber-500/20 text-amber-400 active:bg-amber-500/30' 
                    : 'bg-amber-500 text-white active:bg-amber-600'
                }`}
              >
                Last wk
              </button>
            )}
            {!isCurrentWeekSelected && (
              <button 
                onClick={goToCurrentWeek}
                className={`px-3 py-2.5 rounded-xl text-sm font-medium transition-all ${
                  darkMode 
                    ? 'bg-blue-500/20 text-blue-400 active:bg-blue-500/30' 
                    : 'bg-blue-500 text-white active:bg-blue-600'
                }`}
              >
                Today
              </button>
            )}
            <button onClick={nextWeek} disabled={safeWeekIndex === ALL_WEEKS.length - 1} className={`p-2.5 rounded-xl transition-all disabled:opacity-30 ${
              darkMode 
                ? 'bg-gray-700 active:bg-gray-500' 
                : 'bg-white/80 active:bg-white'
            }`}>
              <ChevronRight className={`w-5 h-5 ${darkMode ? 'text-white' : 'text-gray-700'}`} />
            </button>
          </div>
          
          {/* Mobile Calendar Popup */}
          {showCalendar && (
            <div className="md:hidden mt-3">
              <div className={`rounded-2xl p-4 backdrop-blur-xl ${
                darkMode 
                  ? 'bg-gray-800/95 border border-gray-600' 
                  : 'bg-white/95 border border-gray-200'
              }`}>
                <div className="flex items-center justify-between mb-3">
                  <button onClick={() => setCalendarMonth(prev => { const d = new Date(prev.year, prev.month - 1, 1); return { year: d.getFullYear(), month: d.getMonth() }; })} className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 active:bg-gray-500' : 'hover:bg-gray-100 active:bg-gray-200'}`}>
                    <ChevronLeft className={`w-5 h-5 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`} />
                  </button>
                  <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {new Date(calendarMonth.year, calendarMonth.month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                  </span>
                  <button onClick={() => setCalendarMonth(prev => { const d = new Date(prev.year, prev.month + 1, 1); return { year: d.getFullYear(), month: d.getMonth() }; })} className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 active:bg-gray-500' : 'hover:bg-gray-100 active:bg-gray-200'}`}>
                    <ChevronRight className={`w-5 h-5 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`} />
                  </button>
                </div>
                <div className="grid grid-cols-7 gap-1 text-center mb-2">
                  {['M', 'T', 'W', 'T', 'F', 'S', 'S'].map((d, i) => (
                    <div key={i} className={`text-xs font-medium py-2 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>{d}</div>
                  ))}
                </div>
                <div className="grid grid-cols-7 gap-1">
                  {calendarDays.map((date, i) => {
                    if (!date) return <div key={i} className="w-full aspect-square" />;
                    const weekStr = getWeekStartFromDate(date);
                    const hasData = ALL_WEEKS.includes(weekStr);
                    const isCurrentWeek = weekStr === currentWeek;
                    const isMonday = date.getDay() === 1;
                    return (
                      <button 
                        key={i} 
                        onClick={() => { handleCalendarDayClick(date); setShowCalendar(false); }} 
                        disabled={!hasData} 
                        className={`w-full aspect-square rounded-xl text-sm font-medium transition-all ${
                          isCurrentWeek 
                            ? 'bg-[#1E3A5F] text-white' 
                            : hasData 
                              ? isMonday 
                                ? darkMode ? 'bg-white/15 text-white' : 'bg-[#EBE6D3] text-[#0F2940]' 
                                : darkMode ? 'text-gray-300 active:bg-gray-700' : 'text-gray-700 active:bg-gray-100'
                              : darkMode ? 'text-gray-700' : 'text-gray-300'
                        }`}
                      >
                        {date.getDate()}
                      </button>
                    );
                  })}
                </div>
              </div>
            </div>
          )}
        </div>

        {activeView === 'dashboard' && (
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-4">
            {/* Main content - left 3 columns */}
            <div className="lg:col-span-3 space-y-4">
              {/* Quote of the Week - compact */}
              {currentQuote && (
                <div className={`rounded-2xl overflow-hidden backdrop-blur-xl transition-colors duration-300 ${
                  darkMode 
                    ? 'bg-amber-500/10 border border-amber-500/20' 
                    : 'bg-gradient-to-r from-amber-50/80 to-orange-50/80 border border-amber-200/50'
                }`}>
                  <button 
                    onClick={() => setQuotesExpanded(!quotesExpanded)}
                    className={`w-full p-3 flex items-center justify-between text-left transition-colors ${
                      darkMode ? 'hover:bg-gray-800' : 'hover:bg-amber-100/30'
                    }`}
                  >
                    <div className="flex items-center gap-3">
                      <div className={`w-8 h-8 rounded-xl flex items-center justify-center ${darkMode ? 'bg-amber-500/20' : 'bg-amber-100'}`}>
                        <Quote className={`w-4 h-4 ${darkMode ? 'text-amber-400' : 'text-amber-600'}`} />
                      </div>
                      <div>
                        <span className={`text-[10px] font-medium ${darkMode ? 'text-amber-400/70' : 'text-amber-700'}`}>Weekly Theme</span>
                        <h3 className={`text-sm font-bold ${darkMode ? 'text-amber-300' : 'text-amber-800'}`}>{currentQuote.theme || 'Weekly Wisdom'}</h3>
                      </div>
                    </div>
                    <ChevronDown className={`w-4 h-4 transition-transform ${quotesExpanded ? 'rotate-180' : ''} ${darkMode ? 'text-amber-400' : 'text-amber-600'}`} />
                  </button>
                  
                  {quotesExpanded && (
                    <div className={`px-3 pb-3 border-t ${darkMode ? 'border-amber-500/20' : 'border-amber-200/50'}`}>
                      <blockquote className={`text-sm font-medium italic mt-2 ${darkMode ? 'text-gray-300' : 'text-gray-800'}`}>"{currentQuote.quote}"</blockquote>
                      <p className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}> {currentQuote.author}{currentQuote.authorTitle ? `, ${currentQuote.authorTitle}` : ''}</p>
                    </div>
                  )}
                </div>
              )}
              
              {/* Timeframe Selector + Personal/Team Toggle */}
              <div className="flex items-center justify-between flex-wrap gap-2">
                <div className="flex gap-2 flex-wrap">
                  {Object.entries(rangeLabels).map(([k, v]) => (
                    <button 
                      key={k} 
                      onClick={() => setScorecardRange(k)} 
                      className={`px-3 py-1.5 rounded-xl text-sm font-medium transition-all backdrop-blur-sm ${
                        scorecardRange === k 
                          ? 'bg-[#1E3A5F] text-white shadow-lg' 
                          : darkMode 
                            ? 'bg-gray-800 text-gray-400 border border-gray-600 hover:bg-gray-700' 
                            : 'bg-white/70 text-gray-600 border border-white/50 hover:border-[#F5B800]'
                      }`}
                    >
                      {v}
                    </button>
                  ))}
                </div>
                <div className={`flex gap-1 rounded-xl p-1 backdrop-blur-sm ${darkMode ? 'bg-gray-800' : 'bg-gray-100/80'}`}>
                  <button 
                    onClick={() => setDashboardView('personal')} 
                    className={`px-3 py-1 rounded-lg text-xs font-medium transition-all ${
                      dashboardView === 'personal' 
                        ? darkMode ? 'bg-gray-700 text-white shadow-sm' : 'bg-white text-[#1E3A5F] shadow-sm'
                        : darkMode ? 'text-gray-400' : 'text-gray-600'
                    }`}
                  >
                    My Stats
                  </button>
                  <button 
                    onClick={() => setDashboardView('team')} 
                    className={`px-3 py-1 rounded-lg text-xs font-medium transition-all ${
                      dashboardView === 'team' 
                        ? darkMode ? 'bg-gray-700 text-white shadow-sm' : 'bg-white text-[#1E3A5F] shadow-sm'
                        : darkMode ? 'text-gray-400' : 'text-gray-600'
                    }`}
                  >
                    Team
                  </button>
                </div>
              </div>
              
              {/* Stats row - clickable - Glass cards - Mobile optimized */}
              <div className="grid grid-cols-2 md:grid-cols-5 gap-2">
                <button 
                  onClick={() => setShowHabitBreakdown('completed')}
                  className={`rounded-2xl p-3 text-left transition-all backdrop-blur-xl ${
                    darkMode 
                      ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20 active:bg-gray-700' 
                      : 'bg-white/70 border border-white/50 active:bg-white/90'
                  }`}
                >
                  <div className="flex items-center justify-between">
                    <Target className="w-5 h-5 text-purple-500" />
                    {dashboardView === 'personal' && teamComparison.vsTeam !== 0 && (
                      <span className={`text-[10px] font-medium ${teamComparison.vsTeam > 0 ? 'text-green-500' : 'text-red-500'}`}>
                        {teamComparison.vsTeam > 0 ? '+' : ''}{teamComparison.vsTeam}%
                      </span>
                    )}
                  </div>
                  <p className={`text-2xl font-bold mt-1 ${darkMode ? 'text-white' : 'text-gray-800'}`}>{overallStats.rate}%</p>
                  <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Completion</p>
                </button>
                <button 
                  onClick={() => setShowHabitBreakdown('total')}
                  className={`rounded-2xl p-3 text-left transition-all backdrop-blur-xl ${
                    darkMode 
                      ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20 active:bg-gray-700' 
                      : 'bg-white/70 border border-white/50 active:bg-white/90'
                  }`}
                >
                  <CheckCircle2 className="w-5 h-5 text-blue-500" />
                  <p className={`text-2xl font-bold mt-1 ${darkMode ? 'text-white' : 'text-gray-800'}`}>{overallStats.total}</p>
                  <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Total Habits</p>
                </button>
                <button 
                  onClick={() => setShowHabitBreakdown('exceeded')}
                  className={`rounded-2xl p-3 text-left transition-all backdrop-blur-xl ${
                    darkMode 
                      ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20 active:bg-gray-700' 
                      : 'bg-white/70 border border-white/50 active:bg-white/90'
                  }`}
                >
                  <Award className="w-5 h-5 text-green-500" />
                  <p className={`text-2xl font-bold mt-1 ${darkMode ? 'text-white' : 'text-gray-800'}`}>{overallStats.exceeded}</p>
                  <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Exceeded</p>
                </button>
                <button 
                  onClick={() => setShowHabitBreakdown('missed')}
                  className={`rounded-2xl p-3 text-left transition-all backdrop-blur-xl ${
                    darkMode 
                      ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20 active:bg-gray-700' 
                      : 'bg-white/70 border border-white/50 active:bg-white/90'
                  }`}
                >
                  <XCircle className="w-5 h-5 text-red-500" />
                  <p className={`text-2xl font-bold mt-1 ${darkMode ? 'text-white' : 'text-gray-800'}`}>{overallStats.missed}</p>
                  <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Missed</p>
                </button>
                {dashboardView === 'personal' && (
                  <div className={`rounded-2xl p-3 col-span-2 md:col-span-1 backdrop-blur-xl ${
                    darkMode 
                      ? 'bg-indigo-500/10 border border-indigo-500/20' 
                      : 'bg-gradient-to-br from-indigo-50/80 to-purple-50/80 border border-indigo-200/50'
                  }`}>
                    <div className="flex items-center gap-3 md:block">
                      <Trophy className={`w-5 h-5 ${darkMode ? 'text-indigo-400' : 'text-indigo-500'}`} />
                      <div className="flex items-baseline gap-2 md:block">
                        <p className={`text-2xl font-bold ${darkMode ? 'text-indigo-300' : 'text-indigo-700'}`}>#{teamComparison.rank}</p>
                        <p className={`text-xs ${darkMode ? 'text-indigo-400' : 'text-indigo-600'}`}>of {teamComparison.total} on leaderboard</p>
                      </div>
                    </div>
                  </div>
                )}
              </div>
              
              {/* Week at a Glance - Redesigned for Weekly Goals */}
              <div className={`rounded-2xl p-4 backdrop-blur-xl transition-colors duration-300 ${
                darkMode 
                  ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20' 
                  : 'bg-white/70 border border-white/50'
              }`}>
                <div className="flex items-center justify-between mb-4">
                  <h3 className={`font-semibold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Week at a Glance</h3>
                  <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{currentWeek ? formatWeekString(currentWeek) : ''}</span>
                </div>
                
                {(() => {
                  // Calculate weekly stats
                  const habitsToShow = dashboardView === 'personal'
                    ? currentWeekHabits.filter(h => h.participant === myParticipant)
                    : currentWeekHabits;
                  
                  const dailyHabits = habitsToShow.filter(h => h.habitType !== 'percentage');
                  const percentageHabits = habitsToShow.filter(h => h.habitType === 'percentage');
                  
                  // Calculate completion for daily habits
                  const totalTarget = dailyHabits.reduce((sum, h) => sum + (h.target || 0), 0);
                  const totalCompleted = dailyHabits.reduce((sum, h) => sum + (h.daysCompleted?.length || 0), 0);
                  const weeklyPct = totalTarget > 0 ? Math.round((totalCompleted / totalTarget) * 100) : 0;
                  
                  // Status counts
                  const statusCounts = { done: 0, onTrack: 0, atRisk: 0, missed: 0, pending: 0 };
                  habitsToShow.forEach(h => {
                    const st = getStatus(h);
                    if (st === 'Done' || st === 'Exceeded') statusCounts.done++;
                    else if (st === 'On Track') statusCounts.onTrack++;
                    else if (st === 'At Risk') statusCounts.atRisk++;
                    else if (st === 'Pending') statusCounts.pending++;
                    else statusCounts.missed++;
                  });
                  
                  // Calculate days left in week
                  const today = new Date();
                  const weekStart = new Date(currentWeek + 'T00:00:00');
                  const weekEnd = new Date(weekStart);
                  weekEnd.setDate(weekEnd.getDate() + 6);
                  const daysLeft = Math.max(0, Math.ceil((weekEnd - today) / (1000 * 60 * 60 * 24)));
                  const dayOfWeek = Math.min(6, Math.floor((today - weekStart) / (1000 * 60 * 60 * 24)));
                  const isCurrentWeek = today >= weekStart && today <= weekEnd;
                  
                  // Progress ring calculations
                  const circumference = 2 * Math.PI * 45;
                  const strokeDashoffset = circumference - (weeklyPct / 100) * circumference;
                  const ringColor = weeklyPct >= 80 ? '#10b981' : weeklyPct >= 50 ? '#f59e0b' : weeklyPct > 0 ? '#ef4444' : darkMode ? '#374151' : '#d1d5db';
                  
                  return (
                    <div className="flex flex-col md:flex-row gap-4">
                      {/* Left: Big Progress Ring */}
                      <div className="flex flex-col items-center justify-center md:w-1/3">
                        <div className="relative w-32 h-32">
                          <svg className="w-32 h-32 transform -rotate-90" viewBox="0 0 120 120">
                            {/* Background ring */}
                            <circle
                              cx="60"
                              cy="60"
                              r="45"
                              stroke={darkMode ? '#374151' : '#e5e7eb'}
                              strokeWidth="8"
                              fill="none"
                            />
                            {/* Progress ring */}
                            <circle
                              cx="60"
                              cy="60"
                              r="45"
                              stroke={ringColor}
                              strokeWidth="8"
                              fill="none"
                              strokeLinecap="round"
                              strokeDasharray={circumference}
                              strokeDashoffset={strokeDashoffset}
                              className="transition-all duration-700"
                            />
                            {/* Day markers */}
                            {[0,1,2,3,4,5,6].map(d => {
                              const angle = (d / 7) * 360 - 90;
                              const rad = (angle * Math.PI) / 180;
                              const x = 60 + 54 * Math.cos(rad);
                              const y = 60 + 54 * Math.sin(rad);
                              const isPast = d <= dayOfWeek && isCurrentWeek;
                              return (
                                <circle
                                  key={d}
                                  cx={x}
                                  cy={y}
                                  r="3"
                                  fill={isPast ? (darkMode ? '#6b7280' : '#9ca3af') : (darkMode ? '#374151' : '#e5e7eb')}
                                />
                              );
                            })}
                          </svg>
                          <div className="absolute inset-0 flex flex-col items-center justify-center">
                            <span className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{weeklyPct}%</span>
                            <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              {totalCompleted}/{totalTarget}
                            </span>
                          </div>
                        </div>
                        {isCurrentWeek && (
                          <div className={`mt-2 text-center text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                            {daysLeft === 0 ? ' Last day!' : daysLeft === 1 ? ' 1 day left' : ` ${daysLeft} days left`}
                          </div>
                        )}
                      </div>
                      
                      {/* Right: Stats & Habit List */}
                      <div className="flex-1 space-y-3">
                        {/* Status Pills */}
                        <div className="flex flex-wrap gap-2">
                          {statusCounts.done > 0 && (
                            <div className="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-green-500/10 border border-green-500/20">
                              <div className="w-2 h-2 rounded-full bg-green-500" />
                              <span className={`text-xs font-medium ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                                {statusCounts.done} Done
                              </span>
                            </div>
                          )}
                          {statusCounts.onTrack > 0 && (
                            <div className="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-blue-500/10 border border-blue-500/20">
                              <div className="w-2 h-2 rounded-full bg-blue-500" />
                              <span className={`text-xs font-medium ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                                {statusCounts.onTrack} On Track
                              </span>
                            </div>
                          )}
                          {statusCounts.atRisk > 0 && (
                            <div className="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-amber-500/10 border border-amber-500/20">
                              <div className="w-2 h-2 rounded-full bg-amber-500" />
                              <span className={`text-xs font-medium ${darkMode ? 'text-amber-400' : 'text-amber-600'}`}>
                                {statusCounts.atRisk} At Risk
                              </span>
                            </div>
                          )}
                          {statusCounts.missed > 0 && (
                            <div className="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-red-500/10 border border-red-500/20">
                              <div className="w-2 h-2 rounded-full bg-red-500" />
                              <span className={`text-xs font-medium ${darkMode ? 'text-red-400' : 'text-red-600'}`}>
                                {statusCounts.missed} Missed
                              </span>
                            </div>
                          )}
                          {statusCounts.pending > 0 && (
                            <div className="flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-gray-500/10 border border-gray-500/20">
                              <div className="w-2 h-2 rounded-full bg-gray-500" />
                              <span className={`text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                {statusCounts.pending} Pending
                              </span>
                            </div>
                          )}
                        </div>
                        
                        {/* Compact Habit List */}
                        <div className={`rounded-xl p-2 max-h-36 overflow-y-auto ${darkMode ? 'bg-gray-800' : 'bg-gray-50'}`}>
                          {habitsToShow.length === 0 ? (
                            <p className={`text-xs text-center py-4 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>No habits this week</p>
                          ) : (
                            <div className="space-y-1">
                              {habitsToShow.map(h => {
                                const st = getStatus(h);
                                const cfg = STATUS_CONFIG[st];
                                const isPercentage = h.habitType === 'percentage';
                                const instances = h.instances || [];
                                const successCount = instances.filter(i => i.success).length;
                                const currentPct = instances.length > 0 ? Math.round((successCount / instances.length) * 100) : null;
                                const completed = h.daysCompleted?.length || 0;
                                
                                return (
                                  <div key={h.id} className={`flex items-center gap-2 px-2 py-1.5 rounded-lg ${
                                    st === 'Done' || st === 'Exceeded' 
                                      ? darkMode ? 'bg-green-500/10' : 'bg-green-50'
                                      : 'bg-transparent'
                                  }`}>
                                    {/* Status indicator */}
                                    <div className={`w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 ${
                                      st === 'Done' || st === 'Exceeded' ? 'bg-green-500 text-white' :
                                      st === 'On Track' ? 'bg-blue-500 text-white' :
                                      st === 'At Risk' ? 'bg-amber-500 text-white' :
                                      st === 'Missed' ? 'bg-red-500 text-white' :
                                      darkMode ? 'bg-gray-600 text-gray-400' : 'bg-gray-300 text-gray-500'
                                    }`}>
                                      {(st === 'Done' || st === 'Exceeded') ? (
                                        <Check className="w-3 h-3" />
                                      ) : isPercentage ? (
                                        <span className="text-[8px] font-bold">%</span>
                                      ) : (
                                        <span className="text-[8px] font-bold">{completed}</span>
                                      )}
                                    </div>
                                    
                                    {/* Habit name */}
                                    <span className={`text-xs flex-1 truncate ${
                                      st === 'Done' || st === 'Exceeded' 
                                        ? darkMode ? 'text-green-400' : 'text-green-700'
                                        : darkMode ? 'text-gray-300' : 'text-gray-700'
                                    }`}>
                                      {h.habit}
                                    </span>
                                    
                                    {/* Progress indicator */}
                                    <span className={`text-[10px] font-medium ${
                                      st === 'Done' || st === 'Exceeded' ? 'text-green-500' :
                                      st === 'On Track' ? 'text-blue-500' :
                                      st === 'At Risk' ? 'text-amber-500' :
                                      st === 'Missed' ? 'text-red-500' :
                                      darkMode ? 'text-gray-400' : 'text-gray-400'
                                    }`}>
                                      {isPercentage 
                                        ? (currentPct !== null ? `${currentPct}%` : '') 
                                        : `${completed}/${h.target}`
                                      }
                                    </span>
                                  </div>
                                );
                              })}
                            </div>
                          )}
                        </div>
                        
                        {/* Motivational message based on progress */}
                        <div className={`text-xs text-center py-1 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>
                          {weeklyPct >= 100 ? ' Perfect week! Keep it up!' :
                           weeklyPct >= 80 ? ' Crushing it! Almost there!' :
                           weeklyPct >= 60 ? ' Good progress! Push through!' :
                           weeklyPct >= 40 ? ' Building momentum...' :
                           weeklyPct > 0 ? ' Every step counts!' :
                           ' Ready to start your week?'}
                        </div>
                      </div>
                    </div>
                  );
                })()}
              </div>
              
              {/* Chart and breakdown side by side - Glass */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className={`md:col-span-2 rounded-2xl p-4 backdrop-blur-xl transition-colors duration-300 ${
                  darkMode 
                    ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20' 
                    : 'bg-white/70 border border-white/50'
                }`}>
                  <h3 className={`font-semibold text-sm mb-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Completion Trend ({scorecardRange === 'week' ? 'Week' : scorecardRange === '4weeks' ? '4 Weeks' : scorecardRange === 'quarter' ? 'Quarter' : 'All Time'})</h3>
                  <ResponsiveContainer width="100%" height={160}>
                    <AreaChart data={weeklyTrendData}>
                      <defs>{allParticipants.map(p => <linearGradient key={p} id={`g-${p}`} x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor={PARTICIPANT_COLORS[p] || '#6366f1'} stopOpacity={0.15} /><stop offset="95%" stopColor={PARTICIPANT_COLORS[p] || '#6366f1'} stopOpacity={0} /></linearGradient>)}</defs>
                      <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                      <XAxis dataKey="week" tick={{ fill: darkMode ? '#6b7280' : '#9ca3af', fontSize: 9 }} axisLine={false} tickLine={false} />
                      <YAxis tick={{ fill: darkMode ? '#6b7280' : '#9ca3af', fontSize: 9 }} axisLine={false} tickLine={false} domain={[0, 100]} />
                      <Tooltip contentStyle={{ borderRadius: '12px', border: darkMode ? '1px solid rgba(255,255,255,0.1)' : 'none', boxShadow: darkMode ? '0 8px 32px rgba(0,0,0,0.5)' : '0 4px 20px rgba(0,0,0,0.15)', fontSize: 10, backgroundColor: darkMode ? '#1a2332' : '#fff', color: darkMode ? '#e5e7eb' : '#000' }} />
                      {allParticipants.map(p => <Area key={p} type="monotone" dataKey={p} stroke={PARTICIPANT_COLORS[p] || '#6366f1'} strokeWidth={2} fill={`url(#g-${p})`} />)}
                    </AreaChart>
                  </ResponsiveContainer>
                </div>
                <div className={`rounded-2xl p-4 backdrop-blur-xl transition-colors duration-300 ${
                  darkMode 
                    ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20' 
                    : 'bg-white/70 border border-white/50'
                }`}>
                  <h3 className={`font-semibold text-sm mb-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Status</h3>
                  <ResponsiveContainer width="100%" height={100}>
                    <RechartsPie><Pie data={statusDistribution} cx="50%" cy="50%" innerRadius={25} outerRadius={40} paddingAngle={3} dataKey="value">{statusDistribution.map((e, i) => <Cell key={i} fill={e.color} />)}</Pie></RechartsPie>
                  </ResponsiveContainer>
                  <div className="flex flex-wrap justify-center gap-1 mt-1">{statusDistribution.slice(0,3).map(s => <span key={s.name} className={`text-[10px] ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{s.name}:{s.value}</span>)}</div>
                </div>
              </div>
              
              {/* Participant Performance - with AI summaries - Glass */}
              <div className={`rounded-2xl p-4 backdrop-blur-xl transition-colors duration-300 ${
                darkMode 
                  ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20' 
                  : 'bg-white/70 border border-white/50'
              }`}>
                <div className="flex items-center justify-between mb-3">
                  <h3 className={`font-semibold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Performance</h3>
                  <button 
                    onClick={generateParticipantSummaries}
                    disabled={summaryLoading}
                    className={`text-[10px] flex items-center gap-1 ${darkMode ? 'text-purple-400 hover:text-purple-300' : 'text-purple-600 hover:text-purple-800'}`}
                  >
                    {summaryLoading ? <Loader2 className="w-3 h-3 animate-spin" /> : <Sparkles className="w-3 h-3" />}
                    {summaryLoading ? 'Loading...' : 'Refresh AI'}
                  </button>
                </div>
                <div className="space-y-3">{participantData.map(p => {
                  const profile = getProfileByParticipant(p.name);
                  const summary = participantSummaries[p.name];
                  return (
                  <div key={p.name} className={`p-2 rounded-xl ${darkMode ? 'bg-gray-800' : 'bg-gray-50/80'}`}>
                    <div className="flex items-center gap-2 mb-1">
                      <button onClick={() => openProfileView(p.name)} className="flex items-center gap-2 hover:opacity-80">
                        {profile?.photoURL ? (
                          <img src={profile.photoURL} alt="" className="w-6 h-6 rounded-full object-cover ring-2 ring-white/20" />
                        ) : (
                          <div className="w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-bold text-white" style={{ backgroundColor: p.color }}>{p.name[0]}</div>
                        )}
                        <span className={`text-xs font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{p.name}</span>
                      </button>
                      <div className={`flex-1 h-2 rounded-full overflow-hidden ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>
                        <div className="h-full rounded-full transition-all" style={{ width: `${p.rate}%`, backgroundColor: p.color }} />
                      </div>
                      <div className="text-xs font-bold" style={{ color: p.color }}>{p.rate}%</div>
                    </div>
                    {summary && (
                      <p className={`text-[11px] pl-8 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{summary}</p>
                    )}
                  </div>
                );})}</div>
              </div>
              
              {/* Recent Activity - Glass */}
              <div className={`rounded-2xl p-4 backdrop-blur-xl transition-colors duration-300 ${
                darkMode 
                  ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20' 
                  : 'bg-white/70 border border-white/50'
              }`}>
                <div className="flex items-center justify-between mb-3">
                  <h3 className={`font-semibold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Recent Activity</h3>
                  <button onClick={() => setActiveView('feed')} className={`text-xs hover:underline ${darkMode ? 'text-blue-400' : 'text-[#1E3A5F]'}`}>View all </button>
                </div>
                {posts.slice(0, 2).map(post => {
                  const authorProfile = getProfileByParticipant(post.author);
                  const displayPhoto = authorProfile?.photoURL || post.authorPhoto;
                  return (
                  <div key={post.id} className={`flex gap-2 p-2 rounded-xl mb-2 ${darkMode ? 'bg-gray-800' : 'bg-gray-50/80'}`}>
                    <button onClick={() => openProfileView(post.author)}>
                      {displayPhoto ? <img src={displayPhoto} className="w-6 h-6 rounded-full object-cover hover:ring-2 hover:ring-[#F5B800]" alt="" /> : <div className="w-6 h-6 rounded-full bg-[#1E3A5F] text-white text-xs flex items-center justify-center">{post.author?.[0]}</div>}
                    </button>
                    <div className="flex-1 min-w-0">
                      <button onClick={() => openProfileView(post.author)} className={`text-xs font-medium hover:underline ${darkMode ? 'text-white hover:text-blue-400' : 'text-gray-800 hover:text-[#1E3A5F]'}`}>{post.author}</button>
                      <p className={`text-xs truncate ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{post.content}</p>
                    </div>
                  </div>
                );})}
                {posts.length === 0 && <p className={`text-xs text-center py-2 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>No posts yet</p>}
              </div>
            </div>
            
            {/* Right sidebar - Leaderboard & Streaks */}
            <div className="space-y-4">
              {/* Leaderboard - Glass dark */}
              <div className={`rounded-2xl p-4 text-white backdrop-blur-xl ${
                darkMode 
                  ? 'bg-gradient-to-br from-[#1E3A5F]/80 to-[#0F2940]/80 border border-gray-600' 
                  : 'bg-gradient-to-br from-[#1E3A5F] to-[#0F2940]'
              }`}>
                <div className="flex items-center gap-2 mb-3">
                  <Trophy className="w-4 h-4 text-[#F5B800]" />
                  <h3 className="font-semibold text-sm">Leaderboard</h3>
                </div>
                <div className="space-y-2">
                  {leaderboard.map((p, i) => {
                    const profile = getProfileByParticipant(p.name);
                    return (
                    <button key={p.name} onClick={() => openProfileView(p.name)} className="w-full flex items-center gap-2 hover:bg-gray-700 rounded-xl p-1 -m-1 transition-colors">
                      {profile?.photoURL ? (
                        <img src={profile.photoURL} alt="" className="w-6 h-6 rounded-full object-cover ring-2 ring-white/20" />
                      ) : (
                        <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs ${i === 0 ? 'bg-[#F5B800] text-[#1E3A5F]' : i === 1 ? 'bg-gray-300 text-gray-700' : i === 2 ? 'bg-amber-600 text-white' : 'bg-white/20'}`}>
                          {i === 0 ? '' : i + 1}
                        </div>
                      )}
                      <div className="flex-1 text-left">
                        <p className="text-sm font-medium">{p.name}</p>
                      </div>
                      <p className="text-sm font-bold text-[#F5B800]">{p.score}</p>
                    </button>
                  );})}
                </div>
                <button onClick={() => setActiveView('compete')} className="w-full mt-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-xl text-xs font-medium transition-colors backdrop-blur-sm">
                  View Challenges 
                </button>
              </div>
              
              {/* Non-Negotiables - Core Habits */}
              <div className={`rounded-2xl p-4 backdrop-blur-xl transition-colors duration-300 ${
                darkMode 
                  ? 'bg-gradient-to-br from-amber-500/10 to-orange-500/10 border border-amber-500/20 shadow-xl shadow-black/20' 
                  : 'bg-gradient-to-br from-amber-50/80 to-orange-50/80 border border-amber-200/50'
              }`}>
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${darkMode ? 'bg-amber-500/30' : 'bg-amber-200'}`}>
                      <Lock className={`w-4 h-4 ${darkMode ? 'text-amber-400' : 'text-amber-600'}`} />
                    </div>
                    <div>
                      <h3 className={`font-semibold text-sm ${darkMode ? 'text-amber-300' : 'text-amber-800'}`}>Non-Negotiables</h3>
                      <p className={`text-[10px] ${darkMode ? 'text-amber-400/60' : 'text-amber-600/70'}`}>Your 3 core commitments</p>
                    </div>
                  </div>
                  {nonNegotiables.filter(n => n.userId === user?.uid).length < 3 && (
                    <button 
                      onClick={() => setShowNonNegotiableModal(true)}
                      className={`w-6 h-6 rounded-full flex items-center justify-center transition-colors ${
                        darkMode ? 'bg-amber-500/30 hover:bg-amber-500/50 text-amber-300' : 'bg-amber-200 hover:bg-amber-300 text-amber-700'
                      }`}
                    >
                      <Plus className="w-3 h-3" />
                    </button>
                  )}
                </div>
                <div className="space-y-2">
                  {nonNegotiables.filter(n => n.userId === user?.uid).length === 0 ? (
                    <div className={`text-center py-4 rounded-xl border-2 border-dashed ${darkMode ? 'border-amber-500/30' : 'border-amber-300'}`}>
                      <Lock className={`w-8 h-8 mx-auto mb-2 ${darkMode ? 'text-amber-500/50' : 'text-amber-400'}`} />
                      <p className={`text-xs ${darkMode ? 'text-amber-400/70' : 'text-amber-600'}`}>Set up to 3 core habits you'll never skip</p>
                      <button 
                        onClick={() => setShowNonNegotiableModal(true)}
                        className={`mt-2 px-4 py-1.5 rounded-lg text-xs font-semibold transition-colors ${
                          darkMode 
                            ? 'bg-amber-500/30 hover:bg-amber-500/50 text-amber-300' 
                            : 'bg-amber-200 hover:bg-amber-300 text-amber-700'
                        }`}
                      >
                        + Add your first
                      </button>
                    </div>
                  ) : (
                    nonNegotiables.filter(n => n.userId === user?.uid).map((nn, idx) => (
                      <div key={nn.id} className={`flex items-center gap-2 p-2.5 rounded-xl group transition-colors ${
                        darkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white/60 hover:bg-white/80'
                      }`}>
                        <button
                          onClick={() => updateNonNegotiableStreak(nn.id, true)}
                          className={`w-7 h-7 rounded-lg flex items-center justify-center font-bold text-xs transition-all ${
                            darkMode 
                              ? 'bg-amber-500/30 text-amber-300 hover:bg-amber-500/50 hover:scale-105' 
                              : 'bg-amber-200 text-amber-700 hover:bg-amber-300 hover:scale-105'
                          }`}
                          title="Mark as done today"
                        >
                          {nn.streak > 0 ? <Check className="w-4 h-4" /> : (idx + 1)}
                        </button>
                        <div className="flex-1 min-w-0">
                          <p className={`text-xs font-medium truncate ${darkMode ? 'text-white' : 'text-gray-800'}`}>{nn.habit}</p>
                          <div className="flex items-center gap-2">
                            <p className={`text-[10px] ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{nn.frequency}</p>
                            {nn.streak > 0 && (
                              <div className="flex items-center gap-0.5">
                                <Flame className="w-2.5 h-2.5 text-orange-500" />
                                <span className="text-[10px] font-bold text-orange-500">{nn.streak} day streak</span>
                              </div>
                            )}
                          </div>
                        </div>
                        <div className="flex items-center gap-1">
                          <button 
                            onClick={() => updateNonNegotiableStreak(nn.id, false)}
                            className={`opacity-0 group-hover:opacity-100 p-1 rounded transition-opacity ${
                              darkMode ? 'text-gray-300 hover:text-orange-400 hover:bg-orange-500/20' : 'text-gray-400 hover:text-orange-500 hover:bg-orange-100'
                            }`}
                            title="Reset streak"
                          >
                            <RefreshCw className="w-3 h-3" />
                          </button>
                          <button 
                            onClick={() => deleteNonNegotiable(nn.id)}
                            className={`opacity-0 group-hover:opacity-100 p-1 rounded transition-opacity ${
                              darkMode ? 'text-gray-300 hover:text-red-400 hover:bg-red-500/20' : 'text-gray-400 hover:text-red-500 hover:bg-red-100'
                            }`}
                            title="Remove"
                          >
                            <X className="w-3 h-3" />
                          </button>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>

              {/* Today's Tasks - Glass */}
              <div className={`rounded-2xl p-4 backdrop-blur-xl transition-colors duration-300 ${
                darkMode 
                  ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20' 
                  : 'bg-white/70 border border-white/50'
              }`}>
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <CheckCircle2 className="w-4 h-4 text-blue-500" />
                    <h3 className={`font-semibold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Today's Tasks</h3>
                  </div>
                  <button 
                    onClick={() => setActiveView('tasks')}
                    className={`text-[10px] ${darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-800'}`}
                  >
                    View all 
                  </button>
                </div>
                <div className="space-y-2 max-h-48 overflow-y-auto">
                  {(() => {
                    const myTasks = tasks.filter(t => t.participant === myParticipant && t.status !== 'Completed');
                    const topTasks = myTasks.slice(0, 5);
                    
                    if (topTasks.length === 0) {
                      return <p className={`text-xs text-center py-2 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>No pending tasks </p>;
                    }
                    
                    return topTasks.map(task => (
                      <div key={task.id} className={`flex items-center gap-2 p-2 rounded-xl ${darkMode ? 'bg-gray-800' : 'bg-gray-50/80'}`}>
                        <button 
                          onClick={() => updateTaskStatus(task.id, task.status === 'Completed' ? 'Not Started' : 'Completed')}
                          className={`w-4 h-4 rounded border-2 flex-shrink-0 flex items-center justify-center ${
                            task.status === 'Completed' 
                              ? 'bg-green-500 border-green-500 text-white' 
                              : darkMode ? 'border-gray-600 hover:border-green-400' : 'border-gray-300 hover:border-green-400'
                          }`}
                        >
                          {task.status === 'Completed' && <Check className="w-3 h-3" />}
                        </button>
                        <span className={`text-xs flex-1 truncate ${task.status === 'Completed' ? 'text-gray-500 line-through' : darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                          {task.task}
                        </span>
                        {task.priority === 'high' && <span className="text-red-500 text-[10px]">!</span>}
                      </div>
                    ));
                  })()}
                </div>
              </div>
              
              {/* Streaks - compact - Glass */}
              <div className={`rounded-2xl p-4 backdrop-blur-xl transition-colors duration-300 ${
                darkMode 
                  ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20' 
                  : 'bg-white/70 border border-white/50'
              }`}>
                <div className="flex items-center gap-2 mb-3">
                  <Flame className="w-4 h-4 text-orange-500" />
                  <h3 className={`font-semibold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Streaks</h3>
                </div>
                <div className="space-y-2">
                  {allParticipants.map(p => {
                    const profile = getProfileByParticipant(p);
                    return (
                    <button key={p} onClick={() => openProfileView(p)} className={`w-full flex items-center gap-2 rounded-xl p-1 -m-1 transition-colors ${darkMode ? 'hover:bg-gray-800' : 'hover:bg-gray-50'}`}>
                      {profile?.photoURL ? (
                        <img src={profile.photoURL} alt="" className="w-5 h-5 rounded-full object-cover" />
                      ) : (
                        <span className="text-sm"></span>
                      )}
                      <span className={`flex-1 text-xs text-left ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{p}</span>
                      <span className="text-sm font-bold text-orange-500">{calculateStreaks[p] || 0}</span>
                    </button>
                  );})}
                </div>
              </div>
              
              {/* Active Challenges Preview - Glass */}
              <div className={`rounded-2xl p-4 backdrop-blur-xl transition-colors duration-300 ${
                darkMode 
                  ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20' 
                  : 'bg-white/70 border border-white/50'
              }`}>
                <div className="flex items-center gap-2 mb-3">
                  <Swords className="w-4 h-4 text-purple-500" />
                  <h3 className={`font-semibold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>Active Challenges</h3>
                </div>
                {bets.filter(b => b.status === 'accepted').slice(0, 2).map(bet => (
                  <div key={bet.id} className={`p-2 rounded-xl mb-2 ${darkMode ? 'bg-purple-500/10' : 'bg-purple-50'}`}>
                    <p className={`text-xs font-medium ${darkMode ? 'text-purple-300' : 'text-purple-800'}`}>{bet.challenger} vs {Array.isArray(bet.challenged) ? bet.challenged.join(', ') : bet.challenged}</p>
                    <p className={`text-[10px] ${darkMode ? 'text-purple-400' : 'text-purple-600'}`}>{bet.goal}</p>
                    {bet.reward && <p className={`text-[10px] ${darkMode ? 'text-purple-500' : 'text-purple-500'}`}> {bet.reward}</p>}
                  </div>
                ))}
                {bets.filter(b => b.status === 'accepted').length === 0 && (
                  <p className={`text-xs text-center py-2 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>No active challenges</p>
                )}
                <button onClick={() => setActiveView('compete')} className={`w-full mt-2 py-1.5 rounded-xl text-xs font-medium transition-colors ${
                  darkMode 
                    ? 'bg-purple-500/20 hover:bg-purple-500/30 text-purple-300' 
                    : 'bg-purple-100 hover:bg-purple-200 text-purple-700'
                }`}>
                  Create Challenge
                </button>
              </div>
            </div>
          </div>
        )}

        {/* FEED VIEW */}
        {activeView === 'feed' && (
          <div className="max-w-2xl mx-auto space-y-4">
            {/* Create Post */}
            <div className={`rounded-2xl p-4 backdrop-blur-xl transition-colors duration-300 ${
              darkMode 
                ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20' 
                : 'bg-white/70 border border-white/50'
            }`}>
              <div className="flex gap-3">
                {(userProfile?.photoURL || user?.photoURL) ? (
                  <img src={userProfile?.photoURL || user?.photoURL} className="w-10 h-10 rounded-full object-cover ring-2 ring-white/20" alt="" />
                ) : (
                  <div className={`w-10 h-10 rounded-full flex items-center justify-center font-medium ${darkMode ? 'bg-gray-700 text-white' : 'bg-[#1E3A5F] text-white'}`}>
                    {user?.displayName?.[0] || '?'}
                  </div>
                )}
                <div className="flex-1">
                  {/* Formatting Toolbar */}
                  <div className="flex gap-1 mb-2">
                    <button 
                      onClick={() => applyFormat('bold')}
                      className={`px-2 py-1 rounded text-xs font-bold transition-colors ${darkMode ? 'bg-gray-700 hover:bg-gray-600 text-gray-300' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'}`}
                      title="Bold"
                    >
                      B
                    </button>
                    <button 
                      onClick={() => applyFormat('italic')}
                      className="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs italic text-gray-600"
                      title="Italic"
                    >
                      I
                    </button>
                    <button 
                      onClick={() => applyFormat('bullet')}
                      className="px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded text-xs text-gray-600"
                      title="Bullet Point"
                    >
                       List
                    </button>
                    <span className="text-xs text-gray-400 ml-2 self-center">Select text then click to format</span>
                  </div>
                  <textarea
                    ref={postTextRef}
                    value={newPostText}
                    onChange={(e) => setNewPostText(e.target.value)}
                    placeholder="Share an update, win, or challenge... Use **bold** or _italic_"
                    className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-[#F5B800] resize-none"
                    rows={3}
                  />
                  {postImagePreview && (
                    <div className="relative mt-2">
                      <img src={postImagePreview} alt="Preview" className="max-h-48 rounded-lg" />
                      <button 
                        onClick={() => { setNewPostImage(null); setPostImagePreview(null); }}
                        className="absolute top-2 right-2 w-6 h-6 bg-black/50 rounded-full text-white flex items-center justify-center"
                      >
                        <XCircle className="w-4 h-4" />
                      </button>
                    </div>
                  )}
                  <div className="flex items-center justify-between mt-2">
                    <div className="flex gap-2">
                      <input
                        type="file"
                        ref={fileInputRef}
                        onChange={handleImageSelect}
                        accept="image/*"
                        className="hidden"
                      />
                      <button 
                        onClick={() => fileInputRef.current?.click()}
                        className="flex items-center gap-1 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs text-gray-600 transition-colors"
                      >
                        <Image className="w-4 h-4" />
                        Photo
                      </button>
                    </div>
                    <button 
                      onClick={createPost}
                      disabled={!newPostText.trim() && !newPostImage}
                      className="px-4 py-1.5 bg-[#1E3A5F] text-white rounded-lg text-sm font-medium hover:bg-[#162D4D] transition-colors disabled:opacity-50"
                    >
                      Post
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            {/* Posts Feed */}
            {posts.map(post => {
              const authorProfile = getProfileByParticipant(post.author);
              const displayPhoto = authorProfile?.photoURL || post.authorPhoto;
              return (
              <div key={post.id} className={`rounded-xl border overflow-hidden ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                {/* Post Header */}
                <div className="p-4 pb-0">
                  <div className="flex items-start gap-3">
                    <button onClick={() => openProfileView(post.author)} className="flex-shrink-0">
                      {displayPhoto ? (
                        <img src={displayPhoto} className="w-10 h-10 rounded-full object-cover hover:ring-2 hover:ring-[#F5B800] transition-all" alt="" />
                      ) : (
                        <div className="w-10 h-10 rounded-full bg-[#1E3A5F] text-white flex items-center justify-center font-medium hover:ring-2 hover:ring-[#F5B800] transition-all">
                          {post.author?.[0] || '?'}
                        </div>
                      )}
                    </button>
                    <div className="flex-1">
                      <div className="flex items-center gap-2">
                        <button onClick={() => openProfileView(post.author)} className={`font-semibold hover:underline ${darkMode ? 'text-white hover:text-[#F5B800]' : 'text-gray-800 hover:text-[#1E3A5F]'}`}>{post.author}</button>
                        <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>{new Date(post.createdAt).toLocaleDateString()}</span>
                      </div>
                      <div className={`mt-1 whitespace-pre-wrap ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{renderFormattedText(post.content)}</div>
                    </div>
                    {post.authorId === user?.uid && (
                      <button onClick={() => deletePost(post.id)} className={`${darkMode ? 'text-gray-500 hover:text-red-400' : 'text-gray-300 hover:text-red-400'}`}>
                        <Trash2 className="w-4 h-4" />
                      </button>
                    )}
                  </div>
                </div>
                
                {/* Post Image */}
                {post.image && (
                  <div className="mt-3">
                    <img src={post.image} alt="" className="w-full max-h-96 object-cover" />
                  </div>
                )}
                
                {/* Reactions */}
                <div className={`px-4 py-3 border-t mt-3 ${darkMode ? 'border-gray-700' : 'border-gray-100'}`}>
                  <div className="flex items-center gap-1 flex-wrap">
                    {REACTIONS.map(emoji => {
                      const count = post.reactions?.[emoji]?.length || 0;
                      const hasReacted = post.reactions?.[emoji]?.includes(user?.uid);
                      return (
                        <button
                          key={emoji}
                          onClick={() => addReaction(post.id, emoji)}
                          className={`flex items-center gap-1 px-2 py-1 rounded-full text-sm transition-colors ${hasReacted ? 'bg-[#F5B800]/20 border border-[#F5B800]' : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'}`}
                        >
                          <span>{emoji}</span>
                          {count > 0 && <span className={`text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{count}</span>}
                        </button>
                      );
                    })}
                  </div>
                </div>
                
                {/* Comments Section */}
                <div className="px-4 pb-4">
                  <button 
                    onClick={() => setShowComments({ ...showComments, [post.id]: !showComments[post.id] })}
                    className="text-xs text-gray-500 hover:text-gray-700 mb-2"
                  >
                    {post.comments?.length || 0} comments
                  </button>
                  
                  {showComments[post.id] && (
                    <div className="space-y-2">
                      {post.comments?.map(comment => (
                        <div key={comment.id} className="flex gap-2 p-2 bg-gray-50 rounded-lg">
                          {comment.authorPhoto ? (
                            <img src={comment.authorPhoto} className="w-6 h-6 rounded-full" alt="" />
                          ) : (
                            <div className="w-6 h-6 rounded-full bg-gray-300 text-gray-600 text-xs flex items-center justify-center">
                              {comment.author?.[0]}
                            </div>
                          )}
                          <div>
                            <p className="text-xs font-medium text-gray-800">{comment.author}</p>
                            <p className="text-xs text-gray-600">{comment.text}</p>
                          </div>
                        </div>
                      ))}
                      
                      {/* Add Comment */}
                      <div className="flex gap-2 mt-2">
                        <input
                          type="text"
                          value={commentTexts[post.id] || ''}
                          onChange={(e) => setCommentTexts({ ...commentTexts, [post.id]: e.target.value })}
                          placeholder="Write a comment..."
                          className="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 text-xs focus:outline-none focus:border-[#F5B800]"
                          onKeyPress={(e) => e.key === 'Enter' && addComment(post.id)}
                        />
                        <button 
                          onClick={() => addComment(post.id)}
                          className="px-3 py-1.5 bg-[#1E3A5F] text-white rounded-lg text-xs hover:bg-[#162D4D]"
                        >
                          <Send className="w-3 h-3" />
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            );})}
            
            {posts.length === 0 && (
              <div className={`rounded-xl p-8 border text-center ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                <Users className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                <p className="text-gray-500">No posts yet. Be the first to share!</p>
              </div>
            )}
          </div>
        )}

        {/* COMPETE VIEW */}
        {activeView === 'compete' && (
          <div className="space-y-4">
            {/* Header with Create Challenge */}
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-xl font-bold text-gray-800">Compete & Challenge</h2>
                <p className="text-sm text-gray-500">Challenge your teammates to reach their goals!</p>
              </div>
              <button 
                onClick={() => setShowNewBet(true)}
                className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-medium hover:opacity-90 transition-opacity"
              >
                <Swords className="w-4 h-4" />
                New Challenge
              </button>
            </div>
            
            {/* Leaderboard - Full */}
            <div className="bg-gradient-to-br from-[#1E3A5F] via-[#1E3A5F] to-purple-900 rounded-2xl p-6 text-white">
              <div className="flex items-center gap-3 mb-6">
                <div className="w-12 h-12 bg-[#F5B800] rounded-xl flex items-center justify-center">
                  <Trophy className="w-6 h-6 text-[#1E3A5F]" />
                </div>
                <div>
                  <h3 className="text-xl font-bold">Season Leaderboard</h3>
                  <p className="text-white/60 text-sm">Compete for the top spot!</p>
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {leaderboard.map((p, i) => {
                  const profile = getProfileByParticipant(p.name);
                  return (
                  <div key={p.name} className={`relative rounded-xl p-4 cursor-pointer hover:scale-[1.02] transition-transform ${i === 0 ? 'bg-gradient-to-br from-[#F5B800] to-amber-600 text-[#1E3A5F]' : 'bg-gray-700'}`} onClick={() => openProfileView(p.name)}>
                    {i === 0 && (
                      <div className="absolute -top-3 -right-3 w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-lg">
                        <Crown className="w-5 h-5 text-[#F5B800]" />
                      </div>
                    )}
                    <div className="flex items-center gap-3">
                      {profile?.photoURL ? (
                        <img src={profile.photoURL} alt="" className={`w-12 h-12 rounded-full object-cover border-2 ${i === 0 ? 'border-white' : 'border-white/30'}`} />
                      ) : (
                        <div className={`w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold ${i === 0 ? 'bg-white text-[#1E3A5F]' : i === 1 ? 'bg-gray-300 text-gray-700' : i === 2 ? 'bg-amber-600 text-white' : 'bg-white/20'}`}>
                          {i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : p.name[0]}
                        </div>
                      )}
                      <div className="flex-1">
                        <p className="font-bold text-lg hover:underline">{p.name}</p>
                        <p className={`text-sm ${i === 0 ? 'text-[#1E3A5F]/70' : 'text-white/60'}`}>{p.rate}% completion</p>
                      </div>
                      <div className="text-right">
                        <p className="text-3xl font-bold">{p.score}</p>
                        <p className={`text-xs ${i === 0 ? 'text-[#1E3A5F]/70' : 'text-white/60'}`}>points</p>
                      </div>
                    </div>
                    <div className="mt-3 flex items-center gap-2">
                      <Flame className={`w-4 h-4 ${i === 0 ? 'text-[#1E3A5F]' : 'text-orange-400'}`} />
                      <span className={`text-sm ${i === 0 ? 'text-[#1E3A5F]/70' : 'text-white/60'}`}>{p.streak} week streak</span>
                    </div>
                  </div>
                );})}
              </div>
            </div>
            
            {/* Active Challenges */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Pending Challenges */}
              <div className={`rounded-xl p-4 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                <h3 className="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <Gift className="w-5 h-5 text-purple-500" />
                  Pending Challenges
                </h3>
                {bets.filter(b => b.status === 'pending').length === 0 ? (
                  <p className="text-gray-400 text-sm text-center py-4">No pending challenges</p>
                ) : (
                  <div className="space-y-3">
                    {bets.filter(b => b.status === 'pending').map(bet => {
                      const challengedList = Array.isArray(bet.challenged) ? bet.challenged : [bet.challenged];
                      const myName = userProfile?.linkedParticipant || user?.displayName;
                      const isChallengee = challengedList.includes(myName);
                      const hasAccepted = bet.acceptedBy?.includes(myName);
                      const hasDeclined = bet.declinedBy?.includes(myName);
                      const isChallenger = bet.challengerId === user?.uid;
                      
                      return (
                        <div key={bet.id} className={`p-4 rounded-xl border-2 transition-all ${
                          isChallengee && !hasAccepted && !hasDeclined && !isChallenger
                            ? 'bg-gradient-to-r from-purple-100 via-pink-50 to-orange-50 border-purple-300 shadow-lg shadow-purple-200/50 animate-pulse'
                            : 'bg-purple-50 border-purple-100'
                        }`}>
                          <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center gap-2 flex-wrap">
                              {bet.isGroup && <span className="px-2 py-0.5 bg-purple-200 text-purple-800 text-xs font-bold rounded-full">GROUP</span>}
                              {bet.allowMultipleWinners && <span className="px-2 py-0.5 bg-green-200 text-green-800 text-xs font-bold rounded-full">MULTI-WIN</span>}
                              <Swords className="w-4 h-4 text-purple-600" />
                              <span className="font-bold text-purple-800">{bet.challenger}</span>
                              <span className="text-purple-400"></span>
                              <span className="font-bold text-purple-800">
                                {challengedList.length > 2 
                                  ? `${challengedList.slice(0, 2).join(', ')} +${challengedList.length - 2}`
                                  : challengedList.join(', ')}
                              </span>
                            </div>
                            <div className="flex items-center gap-1">
                              {isChallenger && (
                                <>
                                  <button onClick={() => setEditingBet(bet)} className="p-1 text-purple-400 hover:text-purple-600">
                                    <Wand2 className="w-4 h-4" />
                                  </button>
                                  <button onClick={() => deleteBet(bet.id)} className="p-1 text-purple-400 hover:text-red-500">
                                    <Trash2 className="w-4 h-4" />
                                  </button>
                                </>
                              )}
                            </div>
                          </div>
                          <p className="text-sm text-purple-700 mb-1 font-medium">{bet.goal}</p>
                          {bet.reward && <p className="text-xs text-purple-500 mb-1"> Stakes: {bet.reward}</p>}
                          <p className="text-xs text-purple-500 mb-2"> Deadline: {new Date(bet.deadline).toLocaleDateString()}</p>
                          
                          {/* Group challenge status */}
                          {bet.isGroup && bet.acceptedBy?.length > 0 && (
                            <p className="text-xs text-green-600 mb-2 bg-green-50 px-2 py-1 rounded-lg inline-block">
                               Accepted: {bet.acceptedBy.join(', ')}
                            </p>
                          )}
                          
                          {/* Dramatic View Challenge button for challangees */}
                          {isChallengee && !isChallenger && !hasAccepted && !hasDeclined && (
                            <button 
                              onClick={() => setShowIncomingChallenge(bet)}
                              className="w-full mt-2 py-3 bg-gradient-to-r from-purple-600 via-pink-600 to-orange-500 text-white rounded-xl font-black text-sm hover:from-purple-500 hover:via-pink-500 hover:to-orange-400 transition-all shadow-lg shadow-purple-500/30 flex items-center justify-center gap-2 animate-pulse"
                            >
                              <Flame className="w-4 h-4" />
                              VIEW CHALLENGE
                              <Flame className="w-4 h-4" />
                            </button>
                          )}
                          
                          {/* Quick accept/decline for returning users */}
                          {isChallengee && !isChallenger && !hasAccepted && !hasDeclined && (
                            <div className="flex gap-2 mt-2">
                              <button 
                                onClick={() => acceptBet(bet.id)}
                                className="flex-1 py-2 bg-green-500 text-white rounded-lg text-sm font-bold hover:bg-green-600 flex items-center justify-center gap-1"
                              >
                                <Check className="w-4 h-4" />
                                Quick Accept
                              </button>
                              <button 
                                onClick={() => declineBet(bet.id)}
                                className="flex-1 py-2 bg-red-100 text-red-600 rounded-lg text-sm font-bold hover:bg-red-200 flex items-center justify-center gap-1"
                              >
                                <X className="w-4 h-4" />
                                Decline
                              </button>
                            </div>
                          )}
                          
                          {hasAccepted && (
                            <p className="text-xs text-green-600 font-bold mt-2 bg-green-50 px-3 py-2 rounded-lg"> You accepted - waiting for others</p>
                          )}
                          
                          {isChallenger && (
                            <p className="text-xs text-purple-500 font-medium mt-2"> Waiting for response...</p>
                          )}
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
              
              {/* Active Challenges */}
              <div className={`rounded-xl p-4 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                <h3 className="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <Zap className="w-5 h-5 text-yellow-500" />
                  Active Challenges
                </h3>
                {bets.filter(b => b.status === 'accepted').length === 0 ? (
                  <p className="text-gray-400 text-sm text-center py-4">No active challenges</p>
                ) : (
                  <div className="space-y-3">
                    {bets.filter(b => b.status === 'accepted').map(bet => {
                      const challengedList = Array.isArray(bet.challenged) ? bet.challenged : [bet.challenged];
                      const allParticipantsInChallenge = [bet.challenger, ...challengedList];
                      const myName = userProfile?.linkedParticipant || user?.displayName;
                      const isParticipant = allParticipantsInChallenge.includes(myName) || bet.challengerId === user?.uid;
                      const currentWinners = bet.winners || [];
                      
                      return (
                        <div key={bet.id} className="p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl border border-yellow-200">
                          <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center gap-2 flex-wrap">
                              {bet.isGroup && <span className="px-2 py-0.5 bg-orange-200 text-orange-800 text-xs font-bold rounded-full">GROUP</span>}
                              {bet.allowMultipleWinners && <span className="px-2 py-0.5 bg-purple-200 text-purple-800 text-xs font-bold rounded-full">MULTI-WIN</span>}
                              <span className="text-lg"></span>
                              <span className="font-bold text-gray-800">{bet.challenger}</span>
                              <span className="text-gray-400 text-sm">vs</span>
                              <span className="font-bold text-gray-800">
                                {challengedList.length > 2 
                                  ? `${challengedList.slice(0, 2).join(', ')} +${challengedList.length - 2}`
                                  : challengedList.join(', ')}
                              </span>
                            </div>
                            <div className="flex items-center gap-1">
                              {bet.challengerId === user?.uid && (
                                <button onClick={() => deleteBet(bet.id)} className="p-1 text-gray-400 hover:text-red-500">
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              )}
                            </div>
                          </div>
                          <p className="text-sm text-gray-700 mb-2 font-medium">{bet.goal}</p>
                          {bet.reward && <p className="text-xs text-orange-600 mb-3 bg-orange-100 px-2 py-1 rounded-lg inline-block"> Stakes: {bet.reward}</p>}
                          
                          {/* Winner Selection */}
                          {isParticipant && (
                            <div className="mt-3 pt-3 border-t border-yellow-200">
                              <p className="text-xs text-gray-500 mb-2 font-medium">
                                {bet.allowMultipleWinners ? ' Select all winners:' : ' Who won?'}
                              </p>
                              <div className="flex gap-2 flex-wrap">
                                {allParticipantsInChallenge.map(p => {
                                  const isSelectedWinner = currentWinners.includes(p);
                                  return (
                                    <button 
                                      key={p}
                                      onClick={() => completeBet(bet.id, p, bet.allowMultipleWinners)}
                                      className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1 ${
                                        isSelectedWinner 
                                          ? 'bg-gradient-to-r from-amber-400 to-orange-500 text-white shadow-md' 
                                          : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                      }`}
                                    >
                                      {isSelectedWinner && <Crown className="w-3 h-3" />}
                                      {p}
                                      {!bet.allowMultipleWinners && ' won'}
                                    </button>
                                  );
                                })}
                              </div>
                              
                              {/* Finalize button for multi-winner challenges */}
                              {bet.allowMultipleWinners && currentWinners.length > 0 && (
                                <button
                                  onClick={() => finalizeBetWithWinners(bet.id)}
                                  className="mt-3 w-full py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg text-sm font-bold hover:from-green-400 hover:to-emerald-400 transition-all flex items-center justify-center gap-2"
                                >
                                  <Trophy className="w-4 h-4" />
                                  Finalize Challenge ({currentWinners.length} winner{currentWinners.length > 1 ? 's' : ''})
                                </button>
                              )}
                            </div>
                          )}
                          
                          <div className="flex items-center justify-between mt-3 pt-2 border-t border-yellow-200/50">
                            <p className="text-xs text-gray-500"> Ends: {new Date(bet.deadline).toLocaleDateString()}</p>
                            {currentWinners.length > 0 && bet.allowMultipleWinners && (
                              <p className="text-xs text-amber-600 font-medium">
                                Selected: {currentWinners.join(', ')}
                              </p>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            </div>
            
            {/* Completed Challenges */}
            {bets.filter(b => b.status === 'completed').length > 0 && (
              <div className={`rounded-xl p-4 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                <h3 className="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <PartyPopper className="w-5 h-5 text-pink-500" />
                  Completed Challenges
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  {bets.filter(b => b.status === 'completed').map(bet => {
                    const winnersList = bet.winners && bet.winners.length > 0 ? bet.winners : (bet.winner ? [bet.winner] : []);
                    const isMultipleWinners = winnersList.length > 1;
                    
                    return (
                      <div key={bet.id} className="p-4 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl border border-purple-100">
                        <div className="flex items-center justify-between mb-2">
                          <div className="flex items-center gap-2 flex-wrap">
                            {bet.isGroup && <span className="px-2 py-0.5 bg-purple-200 text-purple-800 text-xs font-bold rounded-full">GROUP</span>}
                            {isMultipleWinners && <span className="px-2 py-0.5 bg-amber-200 text-amber-800 text-xs font-bold rounded-full">CO-CHAMPS</span>}
                            <span className="text-sm text-gray-600">
                              {bet.challenger} vs {Array.isArray(bet.challenged) ? bet.challenged.join(', ') : bet.challenged}
                            </span>
                          </div>
                          <button onClick={() => deleteBet(bet.id)} className="p-1 text-gray-300 hover:text-red-400">
                            <Trash2 className="w-4 h-4" />
                          </button>
                        </div>
                        <p className="text-xs text-gray-500 mb-2">{bet.goal}</p>
                        {bet.reward && <p className="text-xs text-purple-500 mb-2"> {bet.reward}</p>}
                        
                        {/* Winner Display */}
                        <div className={`mt-3 p-3 rounded-xl ${isMultipleWinners ? 'bg-gradient-to-r from-amber-100 to-orange-100' : 'bg-gradient-to-r from-purple-100 to-pink-100'}`}>
                          <div className="flex items-center gap-2">
                            <div className="flex -space-x-2">
                              {winnersList.map((w, idx) => (
                                <div key={w} className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border-2 border-white ${
                                  idx === 0 ? 'bg-gradient-to-br from-amber-400 to-orange-500 text-white' : 'bg-gradient-to-br from-purple-400 to-pink-500 text-white'
                                }`}>
                                  {getParticipantPhoto(w) ? (
                                    <img src={getParticipantPhoto(w)} alt={w} className="w-full h-full rounded-full object-cover" />
                                  ) : (
                                    w.charAt(0)
                                  )}
                                </div>
                              ))}
                            </div>
                            <div>
                              <p className="text-xs text-gray-500">{isMultipleWinners ? 'Champions' : 'Champion'}</p>
                              <p className="font-bold text-purple-700 flex items-center gap-1">
                                <Crown className="w-4 h-4 text-amber-500" />
                                {winnersList.join(' & ')}
                              </p>
                            </div>
                          </div>
                        </div>
                        
                        {bet.completedAt && (
                          <p className="text-xs text-gray-400 mt-2">
                            Completed {new Date(bet.completedAt).toLocaleDateString()}
                          </p>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
            
            {/* New Challenge Modal - Game-like Experience */}
            {showNewBet && (
              <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                <div className="bg-gradient-to-br from-purple-900 via-indigo-900 to-purple-800 rounded-3xl w-full max-w-lg max-h-[90vh] overflow-y-auto relative">
                  {/* Animated Background Effects */}
                  <div className="absolute inset-0 overflow-hidden rounded-3xl pointer-events-none">
                    <div className="absolute -top-20 -right-20 w-40 h-40 bg-purple-500/30 rounded-full blur-3xl animate-pulse" />
                    <div className="absolute -bottom-20 -left-20 w-40 h-40 bg-pink-500/30 rounded-full blur-3xl animate-pulse" style={{ animationDelay: '1s' }} />
                  </div>
                  
                  {/* Header */}
                  <div className="relative p-6 pb-4 border-b border-gray-600">
                    <button 
                      onClick={() => { setShowNewBet(false); setNewBet({ challenger: '', challenged: [], goal: '', reward: '', deadline: '', isGroup: false, allowMultipleWinners: false }); setChallengeSuggestions([]); setPrizeSuggestions([]); }}
                      className="absolute top-4 right-4 w-8 h-8 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center transition-colors"
                    >
                      <X className="w-4 h-4 text-white" />
                    </button>
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center shadow-lg shadow-orange-500/30">
                        <Swords className="w-6 h-6 text-white" />
                      </div>
                      <div>
                        <h3 className="text-xl font-black text-white">Throw Down the Gauntlet</h3>
                        <p className="text-purple-300 text-sm">Create an epic challenge</p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="relative p-6 space-y-5">
                    {/* Challenge Type Toggle */}
                    <div>
                      <label className="text-purple-300 text-sm font-medium block mb-2">Battle Type</label>
                      <div className="flex gap-2">
                        <button
                          onClick={() => setNewBet({ ...newBet, isGroup: false, challenged: '', allowMultipleWinners: false })}
                          className={`flex-1 py-3 px-4 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${!newBet.isGroup ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg shadow-purple-500/30' : 'bg-gray-700 text-white/70 hover:bg-gray-600'}`}
                        >
                          <Swords className="w-4 h-4" />
                          1 vs 1 Duel
                        </button>
                        <button
                          onClick={() => setNewBet({ ...newBet, isGroup: true, challenged: [] })}
                          className={`flex-1 py-3 px-4 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${newBet.isGroup ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg shadow-purple-500/30' : 'bg-gray-700 text-white/70 hover:bg-gray-600'}`}
                        >
                          <Users className="w-4 h-4" />
                          Group Battle
                        </button>
                      </div>
                    </div>
                    
                    {/* Participant Selection */}
                    <div>
                      <label className="text-purple-300 text-sm font-medium block mb-2">
                        {newBet.isGroup ? ' Challenge Who?' : ' Your Opponent'}
                      </label>
                      
                      <div className="grid grid-cols-3 gap-2">
                        {allParticipants.filter(p => p !== userProfile?.linkedParticipant && p !== user?.displayName).map(p => {
                          const isSelected = newBet.isGroup 
                            ? (Array.isArray(newBet.challenged) && newBet.challenged.includes(p))
                            : newBet.challenged === p;
                          const photo = getParticipantPhoto(p);
                          return (
                            <button
                              key={p}
                              onClick={() => {
                                if (newBet.isGroup) {
                                  const current = Array.isArray(newBet.challenged) ? newBet.challenged : [];
                                  if (isSelected) {
                                    setNewBet({ ...newBet, challenged: current.filter(x => x !== p) });
                                  } else {
                                    setNewBet({ ...newBet, challenged: [...current, p] });
                                  }
                                } else {
                                  setNewBet({ ...newBet, challenged: p });
                                }
                              }}
                              className={`p-3 rounded-xl transition-all flex flex-col items-center gap-2 ${isSelected ? 'bg-gradient-to-br from-amber-400 to-orange-500 shadow-lg shadow-orange-500/30 scale-105' : 'bg-gray-700 hover:bg-gray-600'}`}
                            >
                              <div className={`w-12 h-12 rounded-full flex items-center justify-center text-lg font-bold ${isSelected ? 'bg-white/30' : 'bg-white/20'}`}>
                                {photo ? (
                                  <img src={photo} alt={p} className="w-full h-full rounded-full object-cover" />
                                ) : (
                                  p.charAt(0)
                                )}
                              </div>
                              <span className={`text-xs font-bold ${isSelected ? 'text-white' : 'text-white/80'}`}>{p}</span>
                              {isSelected && <Crown className="w-4 h-4 text-white absolute -top-1 -right-1" />}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                    
                    {/* The Challenge - with AI suggestions */}
                    <div>
                      <div className="flex items-center justify-between mb-2">
                        <label className="text-purple-300 text-sm font-medium"> The Challenge</label>
                        <button
                          onClick={generateChallengeSuggestions}
                          disabled={loadingChallengeSuggestions}
                          className="flex items-center gap-1 px-3 py-1 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 rounded-lg text-xs font-bold text-white transition-all disabled:opacity-50"
                        >
                          {loadingChallengeSuggestions ? <Loader2 className="w-3 h-3 animate-spin" /> : <Sparkles className="w-3 h-3" />}
                          AI Ideas
                        </button>
                      </div>
                      <input
                        type="text"
                        value={newBet.goal}
                        onChange={(e) => setNewBet({ ...newBet, goal: e.target.value })}
                        placeholder="e.g., First to 7 days of 100% completion wins"
                        className="w-full bg-gray-700 border-2 border-gray-600 focus:border-purple-400 rounded-xl px-4 py-3 text-white placeholder:text-white/30 outline-none transition-colors"
                      />
                      
                      {/* AI Challenge Suggestions */}
                      {challengeSuggestions.length > 0 && (
                        <div className="mt-2 space-y-1">
                          {challengeSuggestions.map((suggestion, idx) => (
                            <button
                              key={idx}
                              onClick={() => setNewBet({ ...newBet, goal: suggestion })}
                              className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-all ${newBet.goal === suggestion ? 'bg-purple-500/40 text-white border border-purple-400' : 'bg-gray-800 text-white/70 hover:bg-gray-700'}`}
                            >
                              {suggestion}
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                    
                    {/* Prize/Stakes - with AI suggestions */}
                    <div>
                      <div className="flex items-center justify-between mb-2">
                        <label className="text-purple-300 text-sm font-medium"> The Stakes</label>
                        <button
                          onClick={generatePrizeSuggestions}
                          disabled={loadingPrizeSuggestions}
                          className="flex items-center gap-1 px-3 py-1 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 rounded-lg text-xs font-bold text-white transition-all disabled:opacity-50"
                        >
                          {loadingPrizeSuggestions ? <Loader2 className="w-3 h-3 animate-spin" /> : <Gift className="w-3 h-3" />}
                          Prize Ideas
                        </button>
                      </div>
                      <input
                        type="text"
                        value={newBet.reward}
                        onChange={(e) => setNewBet({ ...newBet, reward: e.target.value })}
                        placeholder="Bragging rights, coffee, $10..."
                        className="w-full bg-gray-700 border-2 border-gray-600 focus:border-amber-400 rounded-xl px-4 py-3 text-white placeholder:text-white/30 outline-none transition-colors"
                      />
                      
                      {/* AI Prize Suggestions */}
                      {prizeSuggestions.length > 0 && (
                        <div className="mt-2 flex flex-wrap gap-1">
                          {prizeSuggestions.map((suggestion, idx) => (
                            <button
                              key={idx}
                              onClick={() => setNewBet({ ...newBet, reward: suggestion })}
                              className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${newBet.reward === suggestion ? 'bg-amber-500/40 text-white border border-amber-400' : 'bg-gray-800 text-white/70 hover:bg-gray-700'}`}
                            >
                              {suggestion}
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                    
                    {/* Deadline */}
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="text-purple-300 text-sm font-medium block mb-2"> Deadline</label>
                        <input
                          type="date"
                          value={newBet.deadline}
                          onChange={(e) => setNewBet({ ...newBet, deadline: e.target.value })}
                          className="w-full bg-gray-700 border-2 border-gray-600 focus:border-purple-400 rounded-xl px-4 py-3 text-white outline-none transition-colors"
                        />
                      </div>
                      
                      {/* Multiple Winners Option (for group challenges) */}
                      {newBet.isGroup && (
                        <div>
                          <label className="text-purple-300 text-sm font-medium block mb-2"> Winners</label>
                          <button
                            onClick={() => setNewBet({ ...newBet, allowMultipleWinners: !newBet.allowMultipleWinners })}
                            className={`w-full py-3 px-4 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${newBet.allowMultipleWinners ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white' : 'bg-gray-700 text-white/70 hover:bg-gray-600'}`}
                          >
                            <Users className="w-4 h-4" />
                            {newBet.allowMultipleWinners ? 'Multi-Winner' : 'Single Winner'}
                          </button>
                        </div>
                      )}
                    </div>
                    
                    {/* Quick Deadline Buttons */}
                    <div className="flex gap-2">
                      {[
                        { label: '1 Week', days: 7 },
                        { label: '2 Weeks', days: 14 },
                        { label: '1 Month', days: 30 }
                      ].map(opt => {
                        const date = new Date(Date.now() + opt.days * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                        return (
                          <button
                            key={opt.label}
                            onClick={() => setNewBet({ ...newBet, deadline: date })}
                            className={`flex-1 py-2 rounded-lg text-xs font-medium transition-all ${newBet.deadline === date ? 'bg-purple-500 text-white' : 'bg-gray-700 text-white/60 hover:bg-gray-600'}`}
                          >
                            {opt.label}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                  
                  {/* Send Challenge Button */}
                  <div className="relative p-6 pt-4 border-t border-gray-600">
                    <button 
                      onClick={createBet}
                      disabled={!(newBet.isGroup ? (Array.isArray(newBet.challenged) && newBet.challenged.length > 0) : newBet.challenged) || !newBet.goal}
                      className="w-full py-4 bg-gradient-to-r from-amber-400 via-orange-500 to-red-500 hover:from-amber-300 hover:via-orange-400 hover:to-red-400 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-xl font-black text-lg transition-all shadow-lg shadow-orange-500/30 flex items-center justify-center gap-2"
                    >
                      <Swords className="w-5 h-5" />
                      {newBet.isGroup ? 'SEND GROUP CHALLENGE' : 'SEND CHALLENGE'}
                      <Flame className="w-5 h-5" />
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Incoming Challenge Modal - Dramatic Reveal */}
            {showIncomingChallenge && (
              <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-[100] p-4 backdrop-blur-md">
                <div className="text-center max-w-lg animate-fade-in">
                  {/* Animated Background */}
                  <div className="absolute inset-0 pointer-events-none overflow-hidden">
                    <div className="absolute top-1/4 left-1/4 w-64 h-64 bg-red-500/20 rounded-full blur-3xl animate-pulse" />
                    <div className="absolute bottom-1/4 right-1/4 w-64 h-64 bg-orange-500/20 rounded-full blur-3xl animate-pulse" style={{ animationDelay: '0.5s' }} />
                  </div>
                  
                  {/* VS Animation */}
                  <div className="relative mb-8">
                    <div className="flex items-center justify-center gap-4">
                      {/* Challenger */}
                      <div className="text-center">
                        <div className="w-24 h-24 rounded-full bg-gradient-to-br from-red-500 to-orange-500 flex items-center justify-center text-4xl font-black text-white shadow-2xl shadow-red-500/50 border-4 border-red-400">
                          {getParticipantPhoto(showIncomingChallenge.challenger) ? (
                            <img src={getParticipantPhoto(showIncomingChallenge.challenger)} alt={showIncomingChallenge.challenger} className="w-full h-full rounded-full object-cover" />
                          ) : (
                            showIncomingChallenge.challenger?.charAt(0)
                          )}
                        </div>
                        <p className="text-red-400 font-bold mt-2">{showIncomingChallenge.challenger}</p>
                      </div>
                      
                      {/* VS Badge */}
                      <div className="relative">
                        <div className="w-16 h-16 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center shadow-2xl shadow-amber-500/50 animate-pulse">
                          <span className="text-xl font-black text-white">VS</span>
                        </div>
                        <Swords className="absolute -top-2 left-1/2 -translate-x-1/2 w-8 h-8 text-amber-400" />
                      </div>
                      
                      {/* You */}
                      <div className="text-center">
                        <div className="w-24 h-24 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-4xl font-black text-white shadow-2xl shadow-blue-500/50 border-4 border-blue-400">
                          {userProfile?.photoURL ? (
                            <img src={userProfile.photoURL} alt="You" className="w-full h-full rounded-full object-cover" />
                          ) : (
                            (userProfile?.linkedParticipant || 'Y').charAt(0)
                          )}
                        </div>
                        <p className="text-blue-400 font-bold mt-2">You</p>
                      </div>
                    </div>
                  </div>
                  
                  {/* Challenge Alert */}
                  <div className="mb-6">
                    <h1 className="text-4xl md:text-5xl font-black text-white mb-2 animate-pulse">
                       CHALLENGE! 
                    </h1>
                    <p className="text-amber-400 text-lg font-bold">
                      {showIncomingChallenge.challenger} has challenged you!
                    </p>
                  </div>
                  
                  {/* Challenge Details */}
                  <div className="bg-gray-700 backdrop-blur-sm rounded-2xl p-6 mb-6 border border-gray-600 text-left">
                    <div className="mb-4">
                      <p className="text-white/50 text-xs uppercase tracking-wider mb-1">The Challenge</p>
                      <p className="text-white text-xl font-bold">{showIncomingChallenge.goal}</p>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <p className="text-white/50 text-xs uppercase tracking-wider mb-1">Stakes</p>
                        <p className="text-amber-400 font-bold">{showIncomingChallenge.reward}</p>
                      </div>
                      <div>
                        <p className="text-white/50 text-xs uppercase tracking-wider mb-1">Deadline</p>
                        <p className="text-white font-bold">{new Date(showIncomingChallenge.deadline).toLocaleDateString()}</p>
                      </div>
                    </div>
                  </div>
                  
                  {/* Action Buttons */}
                  <div className="flex gap-4">
                    <button
                      onClick={() => declineBet(showIncomingChallenge.id)}
                      className="flex-1 py-4 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-bold transition-all flex items-center justify-center gap-2"
                    >
                      <X className="w-5 h-5" />
                      Decline
                    </button>
                    <button
                      onClick={() => acceptBet(showIncomingChallenge.id)}
                      className="flex-1 py-4 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-400 hover:to-emerald-400 text-white rounded-xl font-black transition-all shadow-lg shadow-green-500/30 flex items-center justify-center gap-2"
                    >
                      <Flame className="w-5 h-5" />
                      ACCEPT CHALLENGE
                    </button>
                  </div>
                  
                  <button
                    onClick={() => setShowIncomingChallenge(null)}
                    className="mt-4 text-white/50 hover:text-white/80 text-sm transition-colors"
                  >
                    Decide later
                  </button>
                </div>
              </div>
            )}
            
            {/* Edit Challenge Modal */}
            {editingBet && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div className={`rounded-2xl p-6 w-full max-w-md ${darkMode ? "bg-gray-800 text-white" : "bg-white"}`}>
                  <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <Wand2 className="w-5 h-5 text-purple-600" />
                    Edit Challenge
                  </h3>
                  
                  <div className="space-y-4">
                    <div>
                      <label className="text-sm text-gray-600 block mb-1">Challenge Who?</label>
                      <select 
                        value={editingBet.challenged}
                        onChange={(e) => setEditingBet({ ...editingBet, challenged: e.target.value })}
                        className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm"
                      >
                        {allParticipants.map(p => (
                          <option key={p} value={p}>{p}</option>
                        ))}
                      </select>
                    </div>
                    
                    <div>
                      <label className="text-sm text-gray-600 block mb-1">The Challenge</label>
                      <input
                        type="text"
                        value={editingBet.goal}
                        onChange={(e) => setEditingBet({ ...editingBet, goal: e.target.value })}
                        className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm"
                      />
                    </div>
                    
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="text-sm text-gray-600 block mb-1">Reward (optional)</label>
                        <input
                          type="text"
                          value={editingBet.reward || ''}
                          onChange={(e) => setEditingBet({ ...editingBet, reward: e.target.value })}
                          className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm"
                        />
                      </div>
                      <div>
                        <label className="text-sm text-gray-600 block mb-1">Deadline</label>
                        <input
                          type="date"
                          value={editingBet.deadline}
                          onChange={(e) => setEditingBet({ ...editingBet, deadline: e.target.value })}
                          className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm"
                        />
                      </div>
                    </div>
                  </div>
                  
                  <div className="flex gap-3 mt-6">
                    <button 
                      onClick={() => setEditingBet(null)}
                      className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200"
                    >
                      Cancel
                    </button>
                    <button 
                      onClick={updateBet}
                      disabled={!editingBet.challenged || !editingBet.goal}
                      className="flex-1 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-medium hover:opacity-90 disabled:opacity-50"
                    >
                      Save Changes
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {activeView === 'tracker' && (
          <div className="space-y-4">
            {/* Habit Manager Panel - personalized per user */}
            {myParticipant && (
              <div className={`rounded-xl p-4 ${darkMode ? 'bg-gradient-to-r from-purple-500/10 to-blue-500/10 border border-purple-500/20' : 'bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200'}`}>
                <div className="flex flex-wrap items-center justify-between gap-3">
                  <div className="flex items-center gap-2">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${darkMode ? 'bg-purple-500/20' : 'bg-purple-100'}`}>
                      <Brain className={`w-4 h-4 ${darkMode ? 'text-purple-400' : 'text-purple-600'}`} />
                    </div>
                    <div>
                      <h3 className={`font-semibold text-sm ${darkMode ? 'text-white' : 'text-gray-800'}`}>My Habit Manager</h3>
                      <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        {habits.filter(h => h.participant === myParticipant && !h.category).length} uncategorized  {Object.keys(habitNormGroups).length} groups
                      </p>
                    </div>
                  </div>
                  
                  <div className="flex flex-wrap gap-2">
                    <button
                      onClick={aiCategorizeHabits}
                      disabled={categorizingHabits}
                      className={`flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        darkMode ? 'bg-purple-500/20 text-purple-300 hover:bg-purple-500/30 disabled:opacity-50' : 'bg-purple-100 text-purple-700 hover:bg-purple-200 disabled:opacity-50'
                      }`}
                    >
                      {categorizingHabits ? <Loader2 className="w-4 h-4 animate-spin" /> : <Sparkles className="w-4 h-4" />}
                      {categorizingHabits ? 'Categorizing...' : 'Auto-Categorize'}
                    </button>
                    <button
                      onClick={aiNormalizeHabits}
                      disabled={normalizingHabits}
                      className={`flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        darkMode ? 'bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 disabled:opacity-50' : 'bg-blue-100 text-blue-700 hover:bg-blue-200 disabled:opacity-50'
                      }`}
                    >
                      {normalizingHabits ? <Loader2 className="w-4 h-4 animate-spin" /> : <Users className="w-4 h-4" />}
                      {normalizingHabits ? 'Analyzing...' : 'Find Similar'}
                    </button>
                    <button
                      onClick={() => setShowHabitManagerModal(true)}
                      className={`flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                        darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-white text-gray-700 hover:bg-gray-50 border border-gray-200'
                      }`}
                    >
                      <Settings className="w-4 h-4" />
                      Manage
                    </button>
                  </div>
                </div>
              </div>
            )}
            
            {(() => {
              const today = new Date();
              const dayOfWeek = today.getDay();
              const todayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
              const isCurrentWeek = currentWeek === getCurrentMonday();
              const myHabits = currentWeekHabits.filter(h => h.participant === myParticipant);
              const dailyHabits = myHabits.filter(h => h.habitType !== 'percentage');
              const todayCompleted = dailyHabits.filter(h => (h.daysCompleted || []).includes(todayIndex)).length;
              const todayTotal = dailyHabits.length;
              const weekCompleted = myHabits.reduce((sum, h) => sum + (h.daysCompleted?.length || 0), 0);
              const weekTarget = myHabits.reduce((sum, h) => sum + (h.target || 5), 0);
              const weekPct = weekTarget > 0 ? Math.round((weekCompleted / weekTarget) * 100) : 0;
              
              // Non-negotiables check
              const nonNegotiablesList = visionData ? [visionData.nonNegotiable1, visionData.nonNegotiable2, visionData.nonNegotiable3].filter(Boolean) : [];
              const isNonNegotiable = (habit) => {
                if (!habit || nonNegotiablesList.length === 0) return false;
                const habitLower = (habit.habit || '').toLowerCase().trim();
                return nonNegotiablesList.some(nn => {
                  const nnLower = nn.toLowerCase().trim();
                  if (habitLower === nnLower) return true;
                  const shorter = habitLower.length < nnLower.length ? habitLower : nnLower;
                  const longer = habitLower.length < nnLower.length ? nnLower : habitLower;
                  return longer.startsWith(shorter) && shorter.length >= longer.length * 0.5;
                });
              };
              
              return (
                <>
                  {/* Week Navigation Bar */}
                  <div className={`flex items-center justify-between p-2 rounded-xl ${darkMode ? 'bg-gray-800' : 'bg-white border border-gray-100'}`}>
                    <div className="flex items-center gap-1">
                      {DAYS.map((day, i) => {
                        const dayDate = new Date(currentWeek + 'T00:00:00');
                        dayDate.setDate(dayDate.getDate() + i);
                        const isToday = isCurrentWeek && i === todayIndex;
                        const dayHabits = dailyHabits.filter(h => (h.daysCompleted || []).includes(i));
                        const dayPct = dailyHabits.length > 0 ? Math.round((dayHabits.length / dailyHabits.length) * 100) : 0;
                        
                        return (
                          <div
                            key={day}
                            className={`flex flex-col items-center px-2 py-1.5 rounded-lg transition-all ${
                              isToday ? darkMode ? 'bg-[#1E3A5F] text-white' : 'bg-[#1E3A5F] text-white' : ''
                            }`}
                          >
                            <span className={`text-[10px] font-semibold uppercase ${
                              isToday ? 'text-white/80' : darkMode ? 'text-gray-500' : 'text-gray-400'
                            }`}>{day.slice(0, 1)}</span>
                            <span className={`text-sm font-bold ${
                              isToday ? 'text-white' : darkMode ? 'text-gray-300' : 'text-gray-700'
                            }`}>{dayDate.getDate()}</span>
                            {dailyHabits.length > 0 && (
                              <div className={`w-1.5 h-1.5 rounded-full mt-0.5 ${
                                dayPct >= 100 ? 'bg-green-500' : dayPct > 0 ? 'bg-amber-500' : (darkMode ? 'bg-gray-600' : 'bg-gray-200')
                              }`} />
                            )}
                          </div>
                        );
                      })}
                    </div>
                    <button 
                      onClick={() => setShowAddHabitModal(true)} 
                      className="flex items-center gap-1.5 px-3 py-2 bg-[#1E3A5F] text-white rounded-lg text-sm font-medium hover:bg-[#162D4D] transition-colors"
                    >
                      <Plus className="w-4 h-4" />
                      <span className="hidden sm:inline">Add Habit</span>
                    </button>
                  </div>

                  {/* Progress Summary Cards */}
                  {myHabits.length > 0 && (
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
                      {/* Today's Progress */}
                      {isCurrentWeek && (
                        <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-800' : 'bg-white border border-gray-100'}`}>
                          <div className="flex items-center justify-between mb-3">
                            <span className={`text-xs font-semibold uppercase tracking-wide ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Today</span>
                            <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${
                              todayCompleted === todayTotal && todayTotal > 0 ? 'bg-green-500 text-white' : darkMode ? 'bg-gray-700' : 'bg-gray-100'
                            }`}>
                              {todayCompleted === todayTotal && todayTotal > 0 ? (
                                <CheckCircle2 className="w-4 h-4" />
                              ) : (
                                <Target className={`w-4 h-4 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} />
                              )}
                            </div>
                          </div>
                          <div className="flex items-end gap-2">
                            <span className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{todayCompleted}</span>
                            <span className={`text-lg mb-1 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>/ {todayTotal}</span>
                          </div>
                          <div className={`mt-2 h-1.5 rounded-full overflow-hidden ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                            <div className={`h-full rounded-full transition-all duration-500 ${todayTotal > 0 && todayCompleted === todayTotal ? 'bg-green-500' : 'bg-[#1E3A5F]'}`}
                              style={{ width: `${todayTotal > 0 ? (todayCompleted / todayTotal) * 100 : 0}%` }} />
                          </div>
                        </div>
                      )}
                      
                      {/* Weekly Progress */}
                      <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-800' : 'bg-white border border-gray-100'} ${!isCurrentWeek ? 'col-span-2' : ''}`}>
                        <div className="flex items-center justify-between mb-3">
                          <span className={`text-xs font-semibold uppercase tracking-wide ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>This Week</span>
                          <div className={`px-2 py-0.5 rounded-full text-xs font-bold ${
                            weekPct >= 100 ? 'bg-green-100 text-green-700' : weekPct >= 70 ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700'
                          }`}>{weekPct}%</div>
                        </div>
                        <div className="flex items-end gap-2">
                          <span className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{weekCompleted}</span>
                          <span className={`text-lg mb-1 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>/ {weekTarget}</span>
                        </div>
                        <div className={`mt-2 h-1.5 rounded-full overflow-hidden ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                          <div className={`h-full rounded-full transition-all duration-500 ${weekPct >= 100 ? 'bg-green-500' : weekPct >= 70 ? 'bg-blue-500' : 'bg-amber-500'}`}
                            style={{ width: `${Math.min(weekPct, 100)}%` }} />
                        </div>
                      </div>
                      
                      {/* Streak */}
                      <div className={`p-4 rounded-xl ${darkMode ? 'bg-gradient-to-br from-orange-500/20 to-amber-500/10 border border-orange-500/20' : 'bg-gradient-to-br from-orange-50 to-amber-50 border border-orange-200'}`}>
                        <div className="flex items-center justify-between mb-3">
                          <span className={`text-xs font-semibold uppercase tracking-wide ${darkMode ? 'text-orange-400' : 'text-orange-600'}`}>Streak</span>
                          <Flame className={`w-5 h-5 ${darkMode ? 'text-orange-400' : 'text-orange-500'}`} />
                        </div>
                        <div className="flex items-end gap-1">
                          <span className={`text-3xl font-bold ${darkMode ? 'text-orange-400' : 'text-orange-600'}`}>{calculateStreaks[myParticipant] || 0}</span>
                          <span className={`text-lg mb-1 ${darkMode ? 'text-orange-400/60' : 'text-orange-400'}`}>weeks</span>
                        </div>
                      </div>
                      
                      {/* Quick Actions */}
                      <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-800' : 'bg-white border border-gray-100'}`}>
                        <span className={`text-xs font-semibold uppercase tracking-wide ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Quick Actions</span>
                        <div className="flex flex-col gap-1.5 mt-2">
                          <button onClick={() => setShowAnalytics(true)} className={`flex items-center gap-2 px-2 py-1.5 rounded-lg text-xs font-medium transition-colors ${darkMode ? 'hover:bg-gray-700 text-gray-300' : 'hover:bg-gray-50 text-gray-600'}`}>
                            <BarChart3 className="w-3.5 h-3.5" /> Analytics
                          </button>
                          <button onClick={() => setShowMonthlyReport(true)} className={`flex items-center gap-2 px-2 py-1.5 rounded-lg text-xs font-medium transition-colors ${darkMode ? 'hover:bg-gray-700 text-gray-300' : 'hover:bg-gray-50 text-gray-600'}`}>
                            <Calendar className="w-3.5 h-3.5" /> Monthly Report
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* View Toggle & Actions Row */}
                  <div className="flex items-center justify-between gap-3 flex-wrap">
                    <div className={`inline-flex p-1 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-gray-100'}`}>
                      <button onClick={() => setSelectedParticipant(myParticipant)} className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                        selectedParticipant === myParticipant ? darkMode ? 'bg-gray-700 text-white shadow-sm' : 'bg-white text-gray-900 shadow-sm' : darkMode ? 'text-gray-400' : 'text-gray-500'
                      }`}>My Habits</button>
                      <button onClick={() => setSelectedParticipant('All')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                        selectedParticipant === 'All' ? darkMode ? 'bg-gray-700 text-white shadow-sm' : 'bg-white text-gray-900 shadow-sm' : darkMode ? 'text-gray-400' : 'text-gray-500'
                      }`}>Team View</button>
                    </div>
                    
                    <div className="flex gap-2">
                      {getPreviousWeekHabits.length > 0 && myHabits.length === 0 && (
                        <button onClick={copyHabitsFromLastWeek} className={`flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium ${darkMode ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-50 text-blue-700'}`}>
                          <RefreshCw className="w-4 h-4" /> Copy Last Week
                        </button>
                      )}
                      <button onClick={suggestWeeklyHabits} disabled={weekSuggestLoading} className={`flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium ${darkMode ? 'bg-purple-500/20 text-purple-400' : 'bg-purple-50 text-purple-700'}`}>
                        {weekSuggestLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Sparkles className="w-4 h-4" />} AI Suggest
                      </button>
                    </div>
                  </div>

                  {/* Past Week Notice */}
                  {isWeekPast && (
                    <div className={`flex items-center justify-between p-3 rounded-xl ${
                      editingPastWeek ? darkMode ? 'bg-amber-500/10 border border-amber-500/30' : 'bg-amber-50 border border-amber-200'
                        : darkMode ? 'bg-gray-800/50 border border-gray-700' : 'bg-gray-50 border border-gray-200'
                    }`}>
                      <div className="flex items-center gap-2">
                        {editingPastWeek ? <Edit3 className="w-4 h-4 text-amber-500" /> : <Lock className={`w-4 h-4 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`} />}
                        <span className={`text-sm ${editingPastWeek ? 'text-amber-600 font-medium' : (darkMode ? 'text-gray-400' : 'text-gray-500')}`}>
                          {editingPastWeek ? 'Editing mode active' : 'This week is locked'}
                        </span>
                      </div>
                      <button onClick={() => setEditingPastWeek(!editingPastWeek)} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${
                        editingPastWeek ? 'bg-amber-500 text-white' : (darkMode ? 'bg-gray-700 text-white' : 'bg-white text-gray-700 border border-gray-200')
                      }`}>{editingPastWeek ? 'Done' : 'Edit'}</button>
                    </div>
                  )}

                  {/* AI Suggestions Panel */}
                  {weekHabitSuggestions.length > 0 && (
                    <div className={`rounded-xl overflow-hidden ${darkMode ? 'bg-purple-500/10 border border-purple-500/20' : 'bg-purple-50 border border-purple-100'}`}>
                      <div className={`flex items-center justify-between px-4 py-3 ${darkMode ? 'bg-purple-500/10' : 'bg-purple-100/50'}`}>
                        <div className="flex items-center gap-2">
                          <Sparkles className={`w-4 h-4 ${darkMode ? 'text-purple-400' : 'text-purple-600'}`} />
                          <span className={`font-semibold text-sm ${darkMode ? 'text-purple-300' : 'text-purple-800'}`}>AI Suggestions</span>
                        </div>
                        <button onClick={() => setWeekHabitSuggestions([])} className={darkMode ? 'text-purple-400' : 'text-purple-500'}><X className="w-4 h-4" /></button>
                      </div>
                      <div className="p-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                        {weekHabitSuggestions.map((habit, idx) => (
                          <div key={idx} className={`flex items-center justify-between p-3 rounded-lg ${
                            habit.added ? (darkMode ? 'bg-green-500/20' : 'bg-green-100') : (darkMode ? 'bg-gray-800/50' : 'bg-white')
                          }`}>
                            <div className="flex-1 min-w-0 mr-3">
                              <p className={`font-medium truncate ${habit.added ? 'text-green-600' : (darkMode ? 'text-white' : 'text-gray-800')}`}>{habit.habit}</p>
                              <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{habit.target} days/week</p>
                            </div>
                            {habit.added ? <CheckCircle2 className="w-5 h-5 text-green-500" /> : (
                              <button onClick={() => addWeeklyHabit(habit, idx)} className="px-3 py-1.5 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700">Add</button>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </>
              );
            })()}

            {/* Habit List */}
            {currentWeekHabits.filter(h => selectedParticipant === 'All' || h.participant === selectedParticipant).length === 0 ? (
              <div className={`rounded-2xl p-8 text-center ${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white border border-gray-100'}`}>
                <div className={`w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  <Target className={`w-8 h-8 ${darkMode ? 'text-gray-500' : 'text-gray-400'}`} />
                </div>
                <h3 className={`text-lg font-semibold mb-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Start Your Week</h3>
                <p className={`text-sm mb-6 max-w-sm mx-auto ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  Add habits to track your progress and build consistent routines.
                </p>
                <div className="flex flex-col sm:flex-row gap-3 justify-center">
                  <button onClick={() => setShowAddHabitModal(true)} className="px-5 py-2.5 bg-[#1E3A5F] text-white rounded-xl text-sm font-medium">
                    <Plus className="w-4 h-4 inline mr-2" />Add Habit
                  </button>
                  {getPreviousWeekHabits.length > 0 && (
                    <button onClick={copyHabitsFromLastWeek} className={`px-5 py-2.5 rounded-xl text-sm font-medium ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-700'}`}>
                      <RefreshCw className="w-4 h-4 inline mr-2" />Copy Last Week
                    </button>
                  )}
                </div>
              </div>
            ) : (
              <div className="space-y-2">
                {(() => {
                  const today = new Date();
                  const dayOfWeek = today.getDay();
                  const todayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                  const isCurrentWeek = currentWeek === getCurrentMonday();
                  
                  const nonNegotiablesList = visionData ? [visionData.nonNegotiable1, visionData.nonNegotiable2, visionData.nonNegotiable3].filter(Boolean) : [];
                  const isNonNegotiable = (habit) => {
                    if (!habit || nonNegotiablesList.length === 0) return false;
                    const habitLower = (habit.habit || '').toLowerCase().trim();
                    return nonNegotiablesList.some(nn => {
                      const nnLower = nn.toLowerCase().trim();
                      if (habitLower === nnLower) return true;
                      const shorter = habitLower.length < nnLower.length ? habitLower : nnLower;
                      const longer = habitLower.length < nnLower.length ? nnLower : habitLower;
                      return longer.startsWith(shorter) && shorter.length >= longer.length * 0.5;
                    });
                  };
                  
                  const sortedHabits = filteredHabits.sort((a, b) => {
                    const aIsNN = a.participant === myParticipant && isNonNegotiable(a);
                    const bIsNN = b.participant === myParticipant && isNonNegotiable(b);
                    if (aIsNN && !bIsNN) return -1;
                    if (!aIsNN && bIsNN) return 1;
                    return (a.order || 0) - (b.order || 0);
                  });
                  
                  return sortedHabits.map((h) => {
                    const isMyHabit = h.participant === myParticipant;
                    const canEdit = isMyHabit && (!isWeekPast || editingPastWeek);
                    const isPercentage = h.habitType === 'percentage';
                    const instances = h.instances || [];
                    const successCount = instances.filter(i => i.success).length;
                    const currentPct = instances.length > 0 ? Math.round((successCount / instances.length) * 100) : 0;
                    const daysCompleted = h.daysCompleted || [];
                    const target = h.target || 5;
                    const progress = isPercentage ? (instances.length > 0 ? Math.round((currentPct / target) * 100) : 0) : Math.round((daysCompleted.length / target) * 100);
                    const isComplete = progress >= 100;
                    const habitIsNN = isMyHabit && isNonNegotiable(h);
                    const isEditing = editingHabit?.id === h.id;
                    const isTodayComplete = daysCompleted.includes(todayIndex);
                    
                    if (isEditing && canEdit) {
                      return (
                        <div key={h.id} className={`rounded-xl p-4 ${darkMode ? 'bg-blue-500/10 border border-blue-500/30' : 'bg-blue-50 border border-blue-200'}`}>
                          <div className="space-y-3">
                            <div className="flex flex-col sm:flex-row gap-3">
                              <input type="text" value={editingHabit.habit} onChange={(e) => setEditingHabit({ ...editingHabit, habit: e.target.value })}
                                className={`flex-1 px-3 py-2 rounded-lg text-sm ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-200'} border focus:outline-none focus:ring-2 focus:ring-blue-500`} />
                              <div className="flex items-center gap-2">
                                <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Target:</span>
                                <input type="number" value={editingHabit.target} onChange={(e) => setEditingHabit({ ...editingHabit, target: parseInt(e.target.value) || 1 })}
                                  className={`w-16 px-2 py-2 rounded-lg text-sm text-center ${darkMode ? 'bg-gray-800 border-gray-600 text-white' : 'bg-white border-gray-200'} border`} min="1" max="7" />
                              </div>
                            </div>
                            {/* Category Selection */}
                            <div className="flex flex-wrap gap-1.5">
                              {HABIT_CATEGORIES.map(cat => (
                                <button key={cat.id} onClick={() => setEditingHabit({ ...editingHabit, category: editingHabit.category === cat.id ? '' : cat.id })}
                                  className={`px-2 py-1 rounded text-xs font-medium ${
                                    editingHabit.category === cat.id 
                                      ? darkMode ? cat.darkColor + ' ring-1 ring-white/30' : cat.color + ' ring-1 ring-gray-400'
                                      : darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-100 text-gray-600'
                                  }`}>
                                  {cat.icon} {cat.id}
                                </button>
                              ))}
                            </div>
                            <div className="flex gap-2">
                              <button onClick={() => { updateHabit(); }} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium">Save</button>
                              <button onClick={() => setEditingHabit(null)} className={`px-4 py-2 rounded-lg text-sm font-medium ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-200 text-gray-700'}`}>Cancel</button>
                            </div>
                          </div>
                        </div>
                      );
                    }
                    
                    return (
                      <div key={h.id} className={`group rounded-xl transition-all ${
                        darkMode ? `bg-gray-800 ${habitIsNN ? 'ring-1 ring-amber-500/30' : 'hover:bg-gray-750'}` : `bg-white border ${habitIsNN ? 'border-amber-200 bg-amber-50/30' : 'border-gray-100 hover:border-gray-200'}`
                      }`}>
                        <div className="p-4">
                          {/* Top Row: Habit info + Quick toggle for today */}
                          <div className="flex items-center gap-3 mb-3">
                            {/* Today's quick toggle */}
                            {isCurrentWeek && !isPercentage && (
                              <button onClick={() => canEdit && toggleDay(h.id, todayIndex)} disabled={!canEdit}
                                className={`w-11 h-11 rounded-xl flex items-center justify-center flex-shrink-0 transition-all ${
                                  isTodayComplete ? 'bg-green-500 text-white shadow-lg shadow-green-500/25' : darkMode ? `bg-gray-700 ${canEdit ? 'hover:bg-gray-600' : ''}` : `bg-gray-100 ${canEdit ? 'hover:bg-gray-200' : ''}`
                                }`}>
                                {isTodayComplete ? <Check className="w-5 h-5" /> : <span className={`text-lg font-bold ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>{DAYS[todayIndex]?.slice(0,1)}</span>}
                              </button>
                            )}
                            
                            {/* Habit name and meta */}
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2 flex-wrap">
                                <h3 className={`font-semibold truncate ${darkMode ? 'text-white' : 'text-gray-800'}`}>{h.habit}</h3>
                                {h.category && (() => {
                                  const cat = HABIT_CATEGORIES.find(c => c.id === h.category);
                                  return cat ? (
                                    <span className={`text-xs px-1.5 py-0.5 rounded ${darkMode ? cat.darkColor : cat.color}`}>
                                      {cat.icon}
                                    </span>
                                  ) : null;
                                })()}
                                {habitIsNN && <Lock className={`w-3.5 h-3.5 ${darkMode ? 'text-amber-400' : 'text-amber-500'}`} />}
                                {!isMyHabit && <span className={`text-xs px-2 py-0.5 rounded-full ${darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-100 text-gray-500'}`}>{h.participant}</span>}
                              </div>
                              <div className="flex items-center gap-3 mt-1">
                                <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                  {isPercentage ? `${currentPct}% of ${target}%` : `${daysCompleted.length}/${target} days`}
                                </span>
                                <div className={`flex-1 max-w-[120px] h-1.5 rounded-full overflow-hidden ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                                  <div className={`h-full rounded-full transition-all ${isComplete ? 'bg-green-500' : progress >= 70 ? 'bg-blue-500' : 'bg-amber-500'}`}
                                    style={{ width: `${Math.min(progress, 100)}%` }} />
                                </div>
                              </div>
                            </div>
                            
                            {/* Actions */}
                            {canEdit && (
                              <div className={`flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity`}>
                                <button onClick={() => setEditingHabit({ id: h.id, habit: h.habit, target: h.target, category: h.category || '' })} className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-100 text-gray-500'}`}>
                                  <Edit3 className="w-4 h-4" />
                                </button>
                                <button onClick={() => deleteHabit(h.id)} className={`p-2 rounded-lg ${darkMode ? 'hover:bg-red-500/20 text-red-400' : 'hover:bg-red-50 text-red-500'}`}>
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              </div>
                            )}
                          </div>
                          
                          {/* Day buttons grid */}
                          {isPercentage ? (
                            <div className="flex flex-wrap gap-1.5">
                              {instances.map((inst, idx) => (
                                <button key={idx} onClick={() => canEdit && toggleInstance(h.id, idx)} onContextMenu={(e) => { e.preventDefault(); canEdit && removeInstance(h.id, idx); }} disabled={!canEdit}
                                  className={`w-8 h-8 rounded-lg text-sm font-medium ${inst.success ? 'bg-green-500 text-white' : 'bg-red-500 text-white'} ${canEdit ? 'hover:opacity-80' : ''}`}>
                                  {inst.success ? '' : ''}
                                </button>
                              ))}
                              {canEdit && (
                                <>
                                  <button onClick={() => addPercentageInstance(h.id, true)} className={`w-8 h-8 rounded-lg border-2 border-dashed flex items-center justify-center ${darkMode ? 'border-green-500/50 text-green-400 hover:bg-green-500/10' : 'border-green-400 text-green-500 hover:bg-green-50'}`}><Plus className="w-4 h-4" /></button>
                                  <button onClick={() => addPercentageInstance(h.id, false)} className={`w-8 h-8 rounded-lg border-2 border-dashed flex items-center justify-center ${darkMode ? 'border-red-500/50 text-red-400 hover:bg-red-500/10' : 'border-red-400 text-red-500 hover:bg-red-50'}`}><Plus className="w-4 h-4" /></button>
                                </>
                              )}
                            </div>
                          ) : (
                            <div className="grid grid-cols-7 gap-1.5">
                              {DAYS.map((day, i) => {
                                const isCompleted = daysCompleted.includes(i);
                                const dayDate = new Date(currentWeek + 'T00:00:00');
                                dayDate.setDate(dayDate.getDate() + i);
                                const isToday = dayDate.toDateString() === new Date().toDateString() && isCurrentWeek;
                                
                                return (
                                  <button key={day} onClick={() => canEdit && toggleDay(h.id, i)} disabled={!canEdit}
                                    className={`relative py-2 rounded-lg transition-all flex flex-col items-center ${
                                      isCompleted ? 'bg-green-500 text-white' : isToday ? darkMode ? 'bg-[#1E3A5F]/30 border border-[#1E3A5F]' : 'bg-[#1E3A5F]/10 border border-[#1E3A5F]/30'
                                        : darkMode ? `bg-gray-700/50 ${canEdit ? 'hover:bg-gray-700' : ''}` : `bg-gray-50 ${canEdit ? 'hover:bg-gray-100' : ''}`
                                    }`}>
                                    <span className={`text-[10px] font-semibold ${isCompleted ? 'text-white/70' : isToday ? 'text-[#1E3A5F]' : (darkMode ? 'text-gray-500' : 'text-gray-400')}`}>{day.slice(0, 3)}</span>
                                    {isCompleted ? <Check className="w-4 h-4 mt-0.5" /> : <div className={`w-4 h-4 mt-0.5 rounded-full border-2 ${isToday ? 'border-[#1E3A5F]/50' : (darkMode ? 'border-gray-600' : 'border-gray-300')}`} />}
                                  </button>
                                );
                              })}
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  });
                })()}
              </div>
            )}
          </div>
        )}
        {/* Monthly Habit Grid View */}
        {activeView === 'monthly' && (
          <div className="space-y-4">
            {/* Month Navigation & View Toggle */}
            <div className="flex items-center justify-between flex-wrap gap-3">
              <div className="flex items-center gap-2">
                <button 
                  onClick={() => setMonthlyViewMonth(prev => {
                    const d = new Date(prev.year, prev.month - 1, 1);
                    return { year: d.getFullYear(), month: d.getMonth() };
                  })}
                  className="p-2 bg-white rounded-lg border border-gray-200 hover:border-[#F5B800]"
                >
                  <ChevronLeft className="w-4 h-4" />
                </button>
                <h2 className="text-lg font-bold text-gray-800 min-w-[150px] text-center">
                  {new Date(monthlyViewMonth.year, monthlyViewMonth.month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                </h2>
                <button 
                  onClick={() => setMonthlyViewMonth(prev => {
                    const d = new Date(prev.year, prev.month + 1, 1);
                    return { year: d.getFullYear(), month: d.getMonth() };
                  })}
                  className="p-2 bg-white rounded-lg border border-gray-200 hover:border-[#F5B800]"
                >
                  <ChevronRight className="w-4 h-4" />
                </button>
              </div>
              
              {/* View Toggle: My Data vs Team */}
              <div className="flex gap-1 bg-gray-100 rounded-lg p-1">
                <button 
                  onClick={() => setSelectedParticipant(myParticipant)} 
                  className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${selectedParticipant === myParticipant ? 'bg-white text-[#1E3A5F] shadow-sm' : 'text-gray-600'}`}
                >
                  My Data
                </button>
                <button 
                  onClick={() => setSelectedParticipant('All')} 
                  className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${selectedParticipant === 'All' ? 'bg-white text-[#1E3A5F] shadow-sm' : 'text-gray-600'}`}
                >
                  Team
                </button>
              </div>
            </div>

            {/* Stats Summary */}
            {(() => {
              const viewParticipant = selectedParticipant === 'All' ? null : selectedParticipant;
              const monthHabits = habits.filter(h => {
                const weekDate = new Date(h.weekStart + 'T00:00:00');
                return weekDate.getMonth() === monthlyViewMonth.month && 
                       weekDate.getFullYear() === monthlyViewMonth.year &&
                       (!viewParticipant || h.participant === viewParticipant);
              });
              const totalCompleted = monthHabits.reduce((sum, h) => sum + (h.daysCompleted?.length || 0), 0);
              const totalTarget = monthHabits.reduce((sum, h) => sum + (h.target || 0), 0);
              const progressPct = totalTarget > 0 ? Math.round((totalCompleted / totalTarget) * 100) : 0;
              
              return (
                <div className="grid grid-cols-4 gap-2">
                  <div className={`rounded-lg p-2 border text-center ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                    <p className="text-xl font-bold text-[#1E3A5F]">{monthHabits.length}</p>
                    <p className="text-[10px] text-gray-500">Habits</p>
                  </div>
                  <div className={`rounded-lg p-2 border text-center ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                    <p className="text-xl font-bold text-green-600">{totalCompleted}</p>
                    <p className="text-[10px] text-gray-500">Done</p>
                  </div>
                  <div className={`rounded-lg p-2 border text-center ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                    <p className="text-xl font-bold text-purple-600">{totalTarget}</p>
                    <p className="text-[10px] text-gray-500">Target</p>
                  </div>
                  <div className={`rounded-lg p-2 border text-center ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                    <div className="w-full bg-gray-200 rounded-full h-1.5 mb-0.5">
                      <div className={`h-1.5 rounded-full ${progressPct >= 80 ? 'bg-green-500' : progressPct >= 50 ? 'bg-amber-500' : 'bg-red-500'}`} style={{ width: `${progressPct}%` }}></div>
                    </div>
                    <p className="text-[10px] text-gray-500">{progressPct}%</p>
                  </div>
                </div>
              );
            })()}

            {/* Monthly Grid - Grouped by habit name */}
            <div className={`rounded-xl border overflow-x-auto ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
              <table className="w-full text-xs">
                <thead>
                  <tr className="bg-gray-50">
                    <th className="text-left p-2 font-semibold text-gray-700 sticky left-0 bg-gray-50 min-w-[160px] z-10">Habit</th>
                    {(() => {
                      const daysInMonth = new Date(monthlyViewMonth.year, monthlyViewMonth.month + 1, 0).getDate();
                      return Array.from({ length: daysInMonth }, (_, i) => {
                        const d = new Date(monthlyViewMonth.year, monthlyViewMonth.month, i + 1);
                        const dayName = d.toLocaleDateString('en-US', { weekday: 'short' })[0];
                        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                        const isToday = d.toDateString() === new Date().toDateString();
                        return (
                          <th key={i} className={`p-0.5 text-center min-w-[22px] ${isWeekend ? 'bg-gray-100' : ''} ${isToday ? 'bg-amber-100' : ''}`}>
                            <div className="text-[9px] text-gray-400">{dayName}</div>
                            <div className="text-[10px] font-medium">{i + 1}</div>
                          </th>
                        );
                      });
                    })()}
                    <th className="p-1 text-center bg-blue-50 w-12">Goal</th>
                    <th className="p-1 text-center bg-green-50 w-12">Done</th>
                    <th className="p-1 text-center bg-purple-50 w-14">%</th>
                  </tr>
                </thead>
                <tbody>
                  {(() => {
                    const viewParticipant = selectedParticipant === 'All' ? null : selectedParticipant;
                    const daysInMonth = new Date(monthlyViewMonth.year, monthlyViewMonth.month + 1, 0).getDate();
                    
                    // Get all habits for this month
                    const monthHabits = habits.filter(h => {
                      const weekDate = new Date(h.weekStart + 'T00:00:00');
                      return weekDate.getMonth() === monthlyViewMonth.month && 
                             weekDate.getFullYear() === monthlyViewMonth.year &&
                             (!viewParticipant || h.participant === viewParticipant);
                    });

                    // Group by habit name (not by individual week entries)
                    const habitGroups = {};
                    monthHabits.forEach(h => {
                      const key = `${h.participant}:${h.habit}`;
                      if (!habitGroups[key]) {
                        habitGroups[key] = { habit: h.habit, participant: h.participant, weeks: [], totalTarget: 0, totalCompleted: 0 };
                      }
                      habitGroups[key].weeks.push(h);
                      habitGroups[key].totalTarget += h.target || 0;
                      habitGroups[key].totalCompleted += h.daysCompleted?.length || 0;
                    });

                    const sortedGroups = Object.values(habitGroups).sort((a, b) => a.habit.localeCompare(b.habit));

                    if (sortedGroups.length === 0) {
                      return (
                        <tr>
                          <td colSpan={daysInMonth + 4} className="p-8 text-center text-gray-400">
                            No habits tracked this month
                          </td>
                        </tr>
                      );
                    }

                    return sortedGroups.map((group, idx) => {
                      const progressPct = group.totalTarget > 0 ? Math.round((group.totalCompleted / group.totalTarget) * 100) : 0;
                      
                      return (
                        <tr key={idx} className="border-t border-gray-50 hover:bg-gray-50/50">
                          <td className="p-1.5 sticky left-0 bg-white z-10">
                            <div className="font-medium text-gray-800 truncate max-w-[150px] text-[11px]" title={group.habit}>{group.habit}</div>
                            {selectedParticipant === 'All' && (
                              <div className="text-[9px] text-gray-400">{group.participant}</div>
                            )}
                          </td>
                          {Array.from({ length: daysInMonth }, (_, dayIdx) => {
                            const dayNum = dayIdx + 1;
                            const dayDate = new Date(monthlyViewMonth.year, monthlyViewMonth.month, dayNum);
                            const dayOfWeek = (dayDate.getDay() + 6) % 7; // Mon=0, Sun=6
                            const isWeekend = dayDate.getDay() === 0 || dayDate.getDay() === 6;
                            const isToday = dayDate.toDateString() === new Date().toDateString();
                            
                            // Find which week this day belongs to (if any) for this habit group
                            const weekHabit = group.weeks.find(w => {
                              const weekStart = new Date(w.weekStart + 'T00:00:00');
                              const weekEnd = new Date(weekStart);
                              weekEnd.setDate(weekEnd.getDate() + 6);
                              return dayDate >= weekStart && dayDate <= weekEnd;
                            });

                            const isInWeek = !!weekHabit;
                            const isCompleted = weekHabit?.daysCompleted?.includes(dayOfWeek);

                            return (
                              <td key={dayIdx} className={`p-0 text-center ${isWeekend && !isToday ? 'bg-gray-50/50' : ''} ${isToday ? 'bg-amber-50' : ''}`}>
                                {isInWeek ? (
                                  <div className={`w-4 h-4 mx-auto rounded-sm flex items-center justify-center text-[9px] ${isCompleted ? 'bg-[#1E3A5F] text-white' : 'bg-gray-200 text-gray-400'}`}>
                                    {isCompleted ? '' : ''}
                                  </div>
                                ) : (
                                  <div className="w-4 h-4 mx-auto rounded-sm bg-gray-100/30"></div>
                                )}
                              </td>
                            );
                          })}
                          <td className="p-1 text-center bg-blue-50/50 font-medium text-[10px]">{group.totalTarget}</td>
                          <td className="p-1 text-center bg-green-50/50 font-medium text-green-700 text-[10px]">{group.totalCompleted}</td>
                          <td className="p-1 bg-purple-50/50">
                            <div className="flex items-center gap-0.5">
                              <div className="flex-1 bg-gray-200 rounded-full h-1">
                                <div 
                                  className={`h-1 rounded-full ${progressPct >= 100 ? 'bg-green-500' : progressPct >= 70 ? 'bg-blue-500' : 'bg-amber-500'}`}
                                  style={{ width: `${Math.min(progressPct, 100)}%` }}
                                ></div>
                              </div>
                              <span className="text-[9px] font-medium w-6 text-right">{progressPct}%</span>
                            </div>
                          </td>
                        </tr>
                      );
                    });
                  })()}
                  {/* Daily Completion Rate Row */}
                  <tr className="bg-amber-50/50 border-t-2 border-amber-200">
                    <td className="p-1.5 sticky left-0 bg-amber-50/50 z-10 font-semibold text-gray-700 text-[11px]">Daily Rate</td>
                    {(() => {
                      const viewParticipant = selectedParticipant === 'All' ? null : selectedParticipant;
                      const daysInMonth = new Date(monthlyViewMonth.year, monthlyViewMonth.month + 1, 0).getDate();
                      const monthHabits = habits.filter(h => {
                        const weekDate = new Date(h.weekStart + 'T00:00:00');
                        return weekDate.getMonth() === monthlyViewMonth.month && 
                               weekDate.getFullYear() === monthlyViewMonth.year &&
                               (!viewParticipant || h.participant === viewParticipant);
                      });

                      return Array.from({ length: daysInMonth }, (_, dayIdx) => {
                        const dayNum = dayIdx + 1;
                        const dayDate = new Date(monthlyViewMonth.year, monthlyViewMonth.month, dayNum);
                        const dayOfWeek = (dayDate.getDay() + 6) % 7;
                        const isWeekend = dayDate.getDay() === 0 || dayDate.getDay() === 6;
                        const isToday = dayDate.toDateString() === new Date().toDateString();
                        
                        let completed = 0, total = 0;
                        monthHabits.forEach(h => {
                          const weekStart = new Date(h.weekStart + 'T00:00:00');
                          const weekEnd = new Date(weekStart);
                          weekEnd.setDate(weekEnd.getDate() + 6);
                          if (dayDate >= weekStart && dayDate <= weekEnd) {
                            total++;
                            if (h.daysCompleted?.includes(dayOfWeek)) completed++;
                          }
                        });

                        const pct = total > 0 ? Math.round((completed / total) * 100) : 0;

                        return (
                          <td key={dayIdx} className={`p-0 text-center ${isWeekend && !isToday ? 'bg-gray-50/50' : ''} ${isToday ? 'bg-amber-200' : ''}`}>
                            <span className={`text-[9px] font-bold ${total === 0 ? 'text-gray-300' : pct >= 80 ? 'text-green-600' : pct >= 50 ? 'text-amber-600' : 'text-red-600'}`}>
                              {total > 0 ? `${pct}%` : '-'}
                            </span>
                          </td>
                        );
                      });
                    })()}
                    <td colSpan="3" className="p-1 text-center text-[9px] text-gray-500 bg-amber-50/50">Avg</td>
                  </tr>
                </tbody>
              </table>
            </div>

            {/* Mood Tracker */}
            <div className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-3 border border-purple-200">
              <div className="flex items-center justify-between mb-2">
                <h3 className="font-semibold text-gray-800 flex items-center gap-2 text-sm">
                  <Heart className="w-4 h-4 text-purple-500" />
                  Mood & Motivation
                </h3>
                <button 
                  onClick={() => setShowMoodModal(true)}
                  className="px-2 py-1 bg-purple-500 text-white rounded-lg text-xs font-medium hover:bg-purple-600"
                >
                  {todaysMoodEntry ? 'Update' : 'Log Today'}
                </button>
              </div>
              {/* Mood/Motivation as aligned grid */}
              <div className="overflow-x-auto">
                <div className="inline-flex gap-0">
                  {(() => {
                    const daysInMonth = new Date(monthlyViewMonth.year, monthlyViewMonth.month + 1, 0).getDate();
                    return Array.from({ length: daysInMonth }, (_, dayIdx) => {
                      const dayNum = dayIdx + 1;
                      const dateStr = `${monthlyViewMonth.year}-${String(monthlyViewMonth.month + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
                      const moodEntry = moodData.find(m => m.date === dateStr && (selectedParticipant === 'All' || m.participant === selectedParticipant));
                      const isToday = dateStr === new Date().toISOString().split('T')[0];

                      return (
                        <div key={dayIdx} className={`flex flex-col items-center w-[22px] ${isToday ? 'bg-purple-200 rounded' : ''}`}>
                          <span className="text-[9px] text-purple-600 font-medium">{moodEntry?.mood || '-'}</span>
                          <span className="text-[9px] text-pink-600 font-medium">{moodEntry?.motivation || '-'}</span>
                          <span className="text-[8px] text-gray-400">{dayNum}</span>
                        </div>
                      );
                    });
                  })()}
                </div>
              </div>
              <div className="flex gap-3 mt-1 text-[10px] text-gray-500">
                <span className="flex items-center gap-1"><span className="w-1.5 h-1.5 bg-purple-500 rounded"></span> Mood</span>
                <span className="flex items-center gap-1"><span className="w-1.5 h-1.5 bg-pink-500 rounded"></span> Motivation</span>
              </div>
            </div>
          </div>
        )}


        {/* Enhanced Tasks View */}
        {activeView === 'tasks' && (
          <div className="space-y-4">
            {/* Focus Mode - Full Screen Single Task */}
            {taskViewMode === 'focus' && focusTask && (() => {
              const task = tasks.find(t => t.id === focusTask);
              if (!task) return null;
              
              return (
                <div className={`fixed inset-0 z-40 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
                  <div className="h-full flex flex-col items-center justify-center p-6 max-w-2xl mx-auto">
                    {/* Exit button */}
                    <button onClick={exitFocusMode} className={`absolute top-4 right-4 p-2 rounded-lg ${darkMode ? 'hover:bg-gray-800 text-gray-400' : 'hover:bg-gray-100 text-gray-500'}`}>
                      <X className="w-6 h-6" />
                    </button>
                    
                    {/* Focus label */}
                    <div className={`flex items-center gap-2 mb-8 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`}>
                      <Target className="w-5 h-5" />
                      <span className="text-sm font-semibold uppercase tracking-wider">Focus Mode</span>
                    </div>
                    
                    {/* Task name */}
                    <h1 className={`text-3xl md:text-4xl font-bold text-center mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                      {task.task}
                    </h1>
                    
                    {/* Timer */}
                    <div className="my-12">
                      <div className={`text-7xl md:text-8xl font-mono font-bold ${pomodoroRunning ? (darkMode ? 'text-red-400' : 'text-red-600') : (darkMode ? 'text-white' : 'text-gray-900')}`}>
                        {Math.floor(pomodoroTime / 60).toString().padStart(2, '0')}:{(pomodoroTime % 60).toString().padStart(2, '0')}
                      </div>
                    </div>
                    
                    {/* Timer controls */}
                    <div className="flex items-center gap-4">
                      <button onClick={() => setPomodoroRunning(!pomodoroRunning)}
                        className={`w-16 h-16 rounded-full flex items-center justify-center transition-all ${
                          pomodoroRunning ? 'bg-amber-500 hover:bg-amber-600' : 'bg-green-500 hover:bg-green-600'
                        } text-white shadow-lg`}>
                        {pomodoroRunning ? <Pause className="w-8 h-8" /> : <Play className="w-8 h-8 ml-1" />}
                      </button>
                      <button onClick={() => setPomodoroTime(25 * 60)}
                        className={`w-12 h-12 rounded-full flex items-center justify-center ${darkMode ? 'bg-gray-800 hover:bg-gray-700 text-gray-400' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'}`}>
                        <RotateCcw className="w-5 h-5" />
                      </button>
                    </div>
                    
                    {/* Preset times */}
                    <div className="flex gap-2 mt-6">
                      {[15, 25, 45, 60].map(mins => (
                        <button key={mins} onClick={() => { setPomodoroTime(mins * 60); setPomodoroRunning(false); }}
                          className={`px-4 py-2 rounded-lg text-sm font-medium ${
                            pomodoroTime === mins * 60 && !pomodoroRunning
                              ? 'bg-blue-500 text-white'
                              : darkMode ? 'bg-gray-800 text-gray-400 hover:bg-gray-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                          }`}>
                          {mins}m
                        </button>
                      ))}
                    </div>
                    
                    {/* Complete button */}
                    <button onClick={() => { updateTaskStatus(task.id, 'Completed'); exitFocusMode(); }}
                      className="mt-12 px-8 py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-semibold text-lg transition-colors">
                      <Check className="w-5 h-5 inline mr-2" />
                      Mark Complete
                    </button>
                  </div>
                </div>
              );
            })()}

            {/* Regular Task View (when not in focus mode) */}
            {taskViewMode !== 'focus' && (
              <>
                {/* Quick Add Bar */}
                <div className={`rounded-xl overflow-hidden ${darkMode ? 'bg-gray-800' : 'bg-white border border-gray-100'}`}>
                  <form onSubmit={(e) => { e.preventDefault(); quickAddTask(quickTaskInput); }} className="p-3">
                    <div className="flex gap-2">
                      <div className="flex-1 relative">
                        <input
                          type="text"
                          value={quickTaskInput}
                          onChange={(e) => setQuickTaskInput(e.target.value)}
                          placeholder='Add task... (e.g., "Call John tomorrow at 3pm !high")'
                          className={`w-full px-4 py-3 rounded-lg text-sm ${
                            darkMode ? 'bg-gray-700 text-white placeholder-gray-400' : 'bg-gray-50 text-gray-800 placeholder-gray-400'
                          } focus:outline-none focus:ring-2 focus:ring-[#1E3A5F]`}
                        />
                      </div>
                      <button type="submit" disabled={!quickTaskInput.trim()}
                        className="px-4 py-2 bg-[#1E3A5F] text-white rounded-lg font-medium hover:bg-[#162D4D] disabled:opacity-30 transition-colors">
                        <Plus className="w-5 h-5" />
                      </button>
                    </div>
                    
                    {/* Quick date buttons */}
                    <div className="flex gap-2 mt-2 overflow-x-auto pb-1">
                      <button type="button" onClick={() => quickAddTask(quickTaskInput, 'today')} disabled={!quickTaskInput.trim()}
                        className={`px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap disabled:opacity-30 ${darkMode ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-50 text-blue-600'}`}>
                        Today
                      </button>
                      <button type="button" onClick={() => quickAddTask(quickTaskInput, 'tomorrow')} disabled={!quickTaskInput.trim()}
                        className={`px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap disabled:opacity-30 ${darkMode ? 'bg-purple-500/20 text-purple-400' : 'bg-purple-50 text-purple-600'}`}>
                        Tomorrow
                      </button>
                      <button type="button" onClick={() => quickAddTask(quickTaskInput, 'nextweek')} disabled={!quickTaskInput.trim()}
                        className={`px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap disabled:opacity-30 ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-600'}`}>
                        Next Week
                      </button>
                      <button type="button" onClick={() => quickAddTask(quickTaskInput, 'inbox')} disabled={!quickTaskInput.trim()}
                        className={`px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap disabled:opacity-30 ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-600'}`}>
                        <Inbox className="w-3 h-3 inline mr-1" /> Inbox
                      </button>
                    </div>
                  </form>
                </div>

                {/* Stats Row - Compact */}
                {(() => {
                  const viewParticipant = selectedParticipant === 'All' ? null : selectedParticipant;
                  const viewTasks = viewParticipant ? tasks.filter(t => t.participant === viewParticipant) : tasks;
                  const today = new Date().toISOString().split('T')[0];
                  const todayTasks = viewTasks.filter(t => t.dueDate === today);
                  const todayCompleted = todayTasks.filter(t => t.status === 'Completed').length;
                  const overdueTasks = viewTasks.filter(t => t.dueDate && t.dueDate < today && t.status !== 'Completed');
                  const inboxTasks = viewTasks.filter(t => !t.dueDate && t.status !== 'Completed');
                  
                  return (
                    <div className="grid grid-cols-4 gap-2">
                      <div className={`p-3 rounded-xl text-center ${darkMode ? 'bg-gray-800' : 'bg-white border border-gray-100'}`}>
                        <p className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{todayCompleted}/{todayTasks.length}</p>
                        <p className={`text-[10px] uppercase tracking-wide ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Today</p>
                      </div>
                      <div className={`p-3 rounded-xl text-center ${overdueTasks.length > 0 ? (darkMode ? 'bg-red-500/10' : 'bg-red-50') : (darkMode ? 'bg-gray-800' : 'bg-white border border-gray-100')}`}>
                        <p className={`text-xl font-bold ${overdueTasks.length > 0 ? 'text-red-500' : (darkMode ? 'text-white' : 'text-gray-900')}`}>{overdueTasks.length}</p>
                        <p className={`text-[10px] uppercase tracking-wide ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Overdue</p>
                      </div>
                      <div className={`p-3 rounded-xl text-center ${darkMode ? 'bg-gray-800' : 'bg-white border border-gray-100'}`}>
                        <p className={`text-xl font-bold ${darkMode ? 'text-amber-400' : 'text-amber-600'}`}>{inboxTasks.length}</p>
                        <p className={`text-[10px] uppercase tracking-wide ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Inbox</p>
                      </div>
                      <div className={`p-3 rounded-xl text-center ${darkMode ? 'bg-gray-800' : 'bg-white border border-gray-100'}`}>
                        <p className={`text-xl font-bold ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                          {viewTasks.filter(t => t.status === 'Completed').length}
                        </p>
                        <p className={`text-[10px] uppercase tracking-wide ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Done</p>
                      </div>
                    </div>
                  );
                })()}

                {/* Top 3 Today - Morning Planning */}
                {top3Today.length > 0 && (
                  <div className={`rounded-xl p-4 ${darkMode ? 'bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/20' : 'bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200'}`}>
                    <div className="flex items-center gap-2 mb-3">
                      <Star className={`w-4 h-4 ${darkMode ? 'text-amber-400' : 'text-amber-600'}`} />
                      <span className={`text-sm font-semibold ${darkMode ? 'text-amber-300' : 'text-amber-800'}`}>Today's Top 3</span>
                    </div>
                    <div className="space-y-2">
                      {top3Today.map((taskId, idx) => {
                        const task = tasks.find(t => t.id === taskId);
                        if (!task) return null;
                        return (
                          <div key={taskId} className={`flex items-center gap-3 p-2 rounded-lg ${darkMode ? 'bg-gray-800/50' : 'bg-white/70'}`}>
                            <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                              task.status === 'Completed' ? 'bg-green-500 text-white' : 'bg-amber-500 text-white'
                            }`}>{idx + 1}</span>
                            <span className={`flex-1 text-sm ${task.status === 'Completed' ? 'line-through text-gray-400' : (darkMode ? 'text-white' : 'text-gray-800')}`}>
                              {task.task}
                            </span>
                            {task.status !== 'Completed' && (
                              <button onClick={() => enterFocusMode(taskId)} className={`p-1.5 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-amber-400' : 'hover:bg-amber-100 text-amber-600'}`}>
                                <Target className="w-4 h-4" />
                              </button>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* Pomodoro Timer (when active but not in focus mode) */}
                {pomodoroTask && taskViewMode !== 'focus' && (
                  <div className={`rounded-xl p-4 ${darkMode ? 'bg-red-500/10 border border-red-500/20' : 'bg-red-50 border border-red-200'}`}>
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <Timer className={`w-5 h-5 ${darkMode ? 'text-red-400' : 'text-red-600'}`} />
                        <div>
                          <p className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {tasks.find(t => t.id === pomodoroTask)?.task}
                          </p>
                          <p className={`text-2xl font-bold font-mono ${darkMode ? 'text-red-400' : 'text-red-600'}`}>
                            {Math.floor(pomodoroTime / 60).toString().padStart(2, '0')}:{(pomodoroTime % 60).toString().padStart(2, '0')}
                          </p>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => enterFocusMode(pomodoroTask)} className={`px-3 py-1.5 rounded-lg text-sm font-medium ${darkMode ? 'bg-gray-700 text-white' : 'bg-white text-gray-700'}`}>
                          Focus
                        </button>
                        <button onClick={() => setPomodoroRunning(!pomodoroRunning)}
                          className={`px-3 py-1.5 rounded-lg text-sm font-medium ${pomodoroRunning ? 'bg-amber-500 text-white' : 'bg-green-500 text-white'}`}>
                          {pomodoroRunning ? 'Pause' : 'Start'}
                        </button>
                        <button onClick={() => { setPomodoroTask(null); setPomodoroTime(25 * 60); setPomodoroRunning(false); }}
                          className={`p-1.5 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-200 text-gray-500'}`}>
                          <X className="w-4 h-4" />
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {/* Filters */}
                <div className="flex items-center justify-between flex-wrap gap-2">
                  <div className="flex gap-1.5 overflow-x-auto pb-1">
                    {[
                      { id: 'today', label: 'Today', icon: Calendar },
                      { id: 'inbox', label: 'Inbox', icon: Inbox },
                      { id: 'scheduled', label: 'Scheduled', icon: CalendarClock },
                      { id: 'all', label: 'All', icon: ListTodo },
                      { id: 'completed', label: 'Done', icon: CheckCircle2 }
                    ].map(filter => {
                      const Icon = filter.icon;
                      return (
                        <button key={filter.id} onClick={() => setTaskFilter(filter.id)}
                          className={`flex items-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium transition-all whitespace-nowrap ${
                            taskFilter === filter.id
                              ? darkMode ? 'bg-white text-gray-900' : 'bg-[#1E3A5F] text-white'
                              : darkMode ? 'bg-gray-800 text-gray-400' : 'bg-white text-gray-600 border border-gray-200'
                          }`}>
                          <Icon className="w-3.5 h-3.5" />
                          {filter.label}
                        </button>
                      );
                    })}
                  </div>
                  
                  <div className="flex items-center gap-2">
                    <div className={`flex p-0.5 rounded-lg ${darkMode ? 'bg-gray-800' : 'bg-gray-100'}`}>
                      <button onClick={() => setSelectedParticipant(myParticipant)}
                        className={`px-2.5 py-1 rounded-md text-xs font-medium ${selectedParticipant === myParticipant ? (darkMode ? 'bg-gray-700 text-white' : 'bg-white text-gray-900 shadow-sm') : (darkMode ? 'text-gray-400' : 'text-gray-500')}`}>
                        Mine
                      </button>
                      <button onClick={() => setSelectedParticipant('All')}
                        className={`px-2.5 py-1 rounded-md text-xs font-medium ${selectedParticipant === 'All' ? (darkMode ? 'bg-gray-700 text-white' : 'bg-white text-gray-900 shadow-sm') : (darkMode ? 'text-gray-400' : 'text-gray-500')}`}>
                        All
                      </button>
                    </div>
                    <button onClick={() => setShowAddTask(true)} className={`p-2 rounded-lg ${darkMode ? 'bg-gray-800 text-gray-400' : 'bg-white border border-gray-200 text-gray-500'}`}>
                      <Settings className="w-4 h-4" />
                    </button>
                  </div>
                </div>

                {/* Task List */}
                <div className="space-y-2">
                  {(() => {
                    const viewParticipant = selectedParticipant === 'All' ? null : selectedParticipant;
                    const today = new Date().toISOString().split('T')[0];
                    
                    let filteredTasks = viewParticipant ? tasks.filter(t => t.participant === viewParticipant) : tasks;
                    
                    if (taskFilter === 'today') {
                      filteredTasks = filteredTasks.filter(t => t.dueDate === today && t.status !== 'Completed');
                    } else if (taskFilter === 'inbox') {
                      filteredTasks = filteredTasks.filter(t => !t.dueDate && t.status !== 'Completed');
                    } else if (taskFilter === 'scheduled') {
                      filteredTasks = filteredTasks.filter(t => t.dueDate && t.dueDate >= today && t.status !== 'Completed');
                    } else if (taskFilter === 'completed') {
                      filteredTasks = filteredTasks.filter(t => t.status === 'Completed');
                    } else if (taskFilter === 'all') {
                      filteredTasks = filteredTasks.filter(t => t.status !== 'Completed');
                    }
                    
                    // Sort by priority then date
                    filteredTasks.sort((a, b) => {
                      // Top 3 first
                      const aIsTop3 = top3Today.includes(a.id);
                      const bIsTop3 = top3Today.includes(b.id);
                      if (aIsTop3 && !bIsTop3) return -1;
                      if (!aIsTop3 && bIsTop3) return 1;
                      
                      // Then overdue
                      const aOverdue = a.dueDate && a.dueDate < today && a.status !== 'Completed';
                      const bOverdue = b.dueDate && b.dueDate < today && b.status !== 'Completed';
                      if (aOverdue && !bOverdue) return -1;
                      if (!aOverdue && bOverdue) return 1;
                      
                      // Then priority
                      const order = { 'High': 0, 'Medium': 1, 'Low': 2 };
                      const priorityDiff = (order[a.priority] || 1) - (order[b.priority] || 1);
                      if (priorityDiff !== 0) return priorityDiff;
                      
                      // Then time slot
                      if (a.time_slot && b.time_slot) return a.time_slot.localeCompare(b.time_slot);
                      if (a.time_slot) return -1;
                      if (b.time_slot) return 1;
                      
                      // Then date
                      return (a.dueDate || 'z').localeCompare(b.dueDate || 'z');
                    });

                    if (filteredTasks.length === 0) {
                      return (
                        <div className={`rounded-xl p-8 text-center ${darkMode ? 'bg-gray-800' : 'bg-white border border-gray-100'}`}>
                          <div className={`w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-4 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                            <CheckCircle2 className={`w-7 h-7 ${darkMode ? 'text-green-400' : 'text-green-500'}`} />
                          </div>
                          <h3 className={`font-semibold mb-1 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                            {taskFilter === 'completed' ? 'No completed tasks' : taskFilter === 'inbox' ? 'Inbox empty' : 'All clear!'}
                          </h3>
                          <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                            {taskFilter === 'today' ? 'No tasks for today. Enjoy!' : 'Use the quick add above to create tasks.'}
                          </p>
                        </div>
                      );
                    }

                    return filteredTasks.map(task => {
                      const isOverdue = task.dueDate && task.dueDate < today && task.status !== 'Completed';
                      const isToday = task.dueDate === today;
                      const isMyTask = task.participant === myParticipant;
                      const isExpanded = expandedTask === task.id;
                      const isTop3 = top3Today.includes(task.id);
                      
                      return (
                        <div key={task.id} className={`group rounded-xl transition-all ${
                          task.status === 'Completed'
                            ? darkMode ? 'bg-gray-800/50 opacity-60' : 'bg-gray-50 opacity-70'
                            : isTop3
                              ? darkMode ? 'bg-amber-500/10 border border-amber-500/30' : 'bg-amber-50 border border-amber-200'
                              : isOverdue
                                ? darkMode ? 'bg-red-900/20 border border-red-500/30' : 'bg-red-50 border border-red-200'
                                : darkMode ? 'bg-gray-800' : 'bg-white border border-gray-100'
                        }`}>
                          <div className="p-3 sm:p-4">
                            <div className="flex items-start gap-3">
                              {/* Checkbox */}
                              <button
                                onClick={() => isMyTask && updateTaskStatus(task.id, task.status === 'Completed' ? 'Not Started' : 'Completed')}
                                disabled={!isMyTask}
                                className={`mt-0.5 w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 transition-all ${
                                  task.status === 'Completed'
                                    ? 'bg-green-500 border-green-500'
                                    : isMyTask
                                      ? `${darkMode ? 'border-gray-500 hover:border-green-500' : 'border-gray-300 hover:border-green-500'}`
                                      : 'border-gray-200 cursor-not-allowed opacity-50'
                                }`}
                              >
                                {task.status === 'Completed' && <Check className="w-3 h-3 text-white" />}
                              </button>
                              
                              {/* Content */}
                              <div className="flex-1 min-w-0">
                                <div className="flex items-start justify-between gap-2">
                                  <div className="flex-1 min-w-0">
                                    <p className={`font-medium ${task.status === 'Completed' ? 'line-through text-gray-400' : (darkMode ? 'text-white' : 'text-gray-800')}`}>
                                      {task.task}
                                    </p>
                                    
                                    {/* Meta info */}
                                    <div className="flex flex-wrap items-center gap-1.5 mt-1.5">
                                      {/* Time slot */}
                                      {task.time_slot && (
                                        <span className={`inline-flex items-center gap-1 text-xs px-1.5 py-0.5 rounded ${darkMode ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-100 text-blue-700'}`}>
                                          <Clock className="w-3 h-3" />
                                          {task.time_slot}
                                        </span>
                                      )}
                                      
                                      {/* Date */}
                                      {task.dueDate && (
                                        <span className={`inline-flex items-center gap-1 text-xs ${
                                          isOverdue ? 'text-red-500 font-medium' : isToday ? (darkMode ? 'text-amber-400' : 'text-amber-600') : (darkMode ? 'text-gray-400' : 'text-gray-500')
                                        }`}>
                                          <Calendar className="w-3 h-3" />
                                          {isOverdue && ' '}
                                          {isToday ? 'Today' : new Date(task.dueDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                        </span>
                                      )}
                                      
                                      {!task.dueDate && (
                                        <span className={`inline-flex items-center gap-1 text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                          <Inbox className="w-3 h-3" /> Inbox
                                        </span>
                                      )}
                                      
                                      {/* Priority */}
                                      {task.priority === 'High' && (
                                        <span className="inline-flex items-center gap-1 text-xs px-1.5 py-0.5 rounded bg-red-100 text-red-700">
                                           High
                                        </span>
                                      )}
                                      
                                      {/* Time estimate */}
                                      {task.time_estimate && (
                                        <span className={`text-xs ${darkMode ? 'text-gray-500' : 'text-gray-400'}`}>
                                          ~{task.time_estimate}m
                                        </span>
                                      )}
                                      
                                      {/* Recurring */}
                                      {task.recurring && (
                                        <Repeat className={`w-3 h-3 ${darkMode ? 'text-purple-400' : 'text-purple-500'}`} />
                                      )}
                                    </div>
                                  </div>
                                  
                                  {/* Actions - Desktop */}
                                  {isMyTask && task.status !== 'Completed' && (
                                    <div className="hidden sm:flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                      {/* AI Schedule */}
                                      <button onClick={() => getAITimeSlot(task.id)} disabled={aiScheduling} title="AI suggest time"
                                        className={`p-1.5 rounded-lg ${aiScheduling ? 'opacity-50' : ''} ${darkMode ? 'hover:bg-purple-500/20 text-purple-400' : 'hover:bg-purple-50 text-purple-500'}`}>
                                        <Brain className="w-4 h-4" />
                                      </button>
                                      
                                      {/* Top 3 */}
                                      <button onClick={() => toggleTop3(task.id)} title={isTop3 ? 'Remove from Top 3' : 'Add to Top 3'}
                                        className={`p-1.5 rounded-lg ${isTop3 ? (darkMode ? 'bg-amber-500/20 text-amber-400' : 'bg-amber-100 text-amber-600') : (darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-100 text-gray-400')}`}>
                                        <Star className={`w-4 h-4 ${isTop3 ? 'fill-current' : ''}`} />
                                      </button>
                                      
                                      {/* Focus */}
                                      <button onClick={() => enterFocusMode(task.id)} title="Focus mode"
                                        className={`p-1.5 rounded-lg ${darkMode ? 'hover:bg-blue-500/20 text-blue-400' : 'hover:bg-blue-50 text-blue-500'}`}>
                                        <Target className="w-4 h-4" />
                                      </button>
                                      
                                      {/* Expand */}
                                      <button onClick={() => setExpandedTask(isExpanded ? null : task.id)} title="More options"
                                        className={`p-1.5 rounded-lg ${darkMode ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-100 text-gray-400'}`}>
                                        {isExpanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                                      </button>
                                      
                                      {/* Delete */}
                                      <button onClick={() => deleteTask(task.id)} title="Delete"
                                        className={`p-1.5 rounded-lg ${darkMode ? 'hover:bg-red-500/20 text-red-400' : 'hover:bg-red-50 text-red-500'}`}>
                                        <Trash2 className="w-4 h-4" />
                                      </button>
                                    </div>
                                  )}
                                </div>
                              </div>
                              
                              {/* Mobile action button */}
                              {isMyTask && task.status !== 'Completed' && (
                                <button onClick={() => setExpandedTask(isExpanded ? null : task.id)}
                                  className={`sm:hidden p-1.5 rounded-lg ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>
                                  {isExpanded ? <ChevronUp className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}
                                </button>
                              )}
                            </div>
                          </div>
                          
                          {/* Expanded Actions */}
                          {isExpanded && isMyTask && task.status !== 'Completed' && (
                            <div className={`px-4 pb-4 pt-2 border-t ${darkMode ? 'border-gray-700' : 'border-gray-100'}`}>
                              {/* Quick actions row */}
                              <div className="flex flex-wrap gap-2 mb-3">
                                <button onClick={() => enterFocusMode(task.id)} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium ${darkMode ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-50 text-blue-600'}`}>
                                  <Target className="w-3.5 h-3.5" /> Focus
                                </button>
                                <button onClick={() => getAITimeSlot(task.id)} disabled={aiScheduling} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium ${darkMode ? 'bg-purple-500/20 text-purple-400' : 'bg-purple-50 text-purple-600'}`}>
                                  <Brain className="w-3.5 h-3.5" /> {aiScheduling ? 'Scheduling...' : 'AI Schedule'}
                                </button>
                                <button onClick={() => toggleTop3(task.id)} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium ${isTop3 ? (darkMode ? 'bg-amber-500/20 text-amber-400' : 'bg-amber-100 text-amber-600') : (darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-600')}`}>
                                  <Star className={`w-3.5 h-3.5 ${isTop3 ? 'fill-current' : ''}`} /> {isTop3 ? 'In Top 3' : 'Add to Top 3'}
                                </button>
                              </div>
                              
                              {/* Reschedule */}
                              <p className={`text-xs font-medium mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Reschedule</p>
                              <div className="flex flex-wrap gap-2 mb-3">
                                <button onClick={() => rescheduleTask(task.id, 'today')} className={`px-3 py-1.5 rounded-lg text-xs font-medium ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-600'}`}>Today</button>
                                <button onClick={() => rescheduleTask(task.id, 'tomorrow')} className={`px-3 py-1.5 rounded-lg text-xs font-medium ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-600'}`}>Tomorrow</button>
                                <button onClick={() => rescheduleTask(task.id, 'nextweek')} className={`px-3 py-1.5 rounded-lg text-xs font-medium ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-600'}`}>Next Week</button>
                                <button onClick={() => rescheduleTask(task.id, 'inbox')} className={`px-3 py-1.5 rounded-lg text-xs font-medium ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-600'}`}>Inbox</button>
                              </div>
                              
                              {/* Snooze */}
                              <p className={`text-xs font-medium mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Snooze</p>
                              <div className="flex flex-wrap gap-2 mb-3">
                                <button onClick={() => snoozeTask(task.id, '1h')} className={`px-3 py-1.5 rounded-lg text-xs font-medium ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-600'}`}>+1 hour</button>
                                <button onClick={() => snoozeTask(task.id, '3h')} className={`px-3 py-1.5 rounded-lg text-xs font-medium ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-600'}`}>+3 hours</button>
                                <button onClick={() => snoozeTask(task.id, 'tomorrow')} className={`px-3 py-1.5 rounded-lg text-xs font-medium ${darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-600'}`}>Tomorrow 9am</button>
                              </div>
                              
                              {/* Edit/Delete */}
                              <div className="flex gap-2 pt-2 border-t ${darkMode ? 'border-gray-700' : 'border-gray-100'}">
                                <button onClick={() => setEditingTask({ id: task.id, task: task.task, dueDate: task.dueDate || '', priority: task.priority, status: task.status, category: task.category, timeSlot: task.time_slot || '', timeEstimate: task.time_estimate || 15, notes: task.notes || '' })}
                                  className={`flex-1 flex items-center justify-center gap-1.5 py-2 rounded-lg text-sm font-medium ${darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-700'}`}>
                                  <Edit3 className="w-4 h-4" /> Edit
                                </button>
                                <button onClick={() => deleteTask(task.id)}
                                  className={`flex items-center justify-center gap-1.5 px-4 py-2 rounded-lg text-sm font-medium ${darkMode ? 'bg-red-500/20 text-red-400' : 'bg-red-50 text-red-600'}`}>
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    });
                  })()}
                </div>
              </>
            )}
          </div>
        )}

        {activeView === 'scorecard' && (
          <div className="space-y-4">
            {/* Range Selection */}
            <div className="flex gap-2 flex-wrap">
              {Object.entries(rangeLabels).map(([k, v]) => (
                <button key={k} onClick={() => setScorecardRange(k)} className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${scorecardRange === k ? 'bg-[#1E3A5F] text-white' : (darkMode ? 'bg-gray-800 text-gray-300 border border-gray-700' : 'bg-white text-gray-600 border border-gray-200')}`}>{v}</button>
              ))}
            </div>

            {/* Team Summary - Visible to everyone */}
            {(() => {
              const teamHabits = getRangeHabits;
              const teamCompleted = teamHabits.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
              const teamRate = teamHabits.length > 0 ? Math.round((teamCompleted / teamHabits.length) * 100) : 0;
              
              // Calculate user's rank
              const participantRates = allParticipants.map(p => {
                const pH = getRangeHabits.filter(h => h.participant === p);
                const completed = pH.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
                return { participant: p, rate: pH.length > 0 ? Math.round((completed / pH.length) * 100) : 0 };
              }).sort((a, b) => b.rate - a.rate);
              
              const myRank = participantRates.findIndex(p => p.participant === myParticipant) + 1;
              const myRate = participantRates.find(p => p.participant === myParticipant)?.rate || 0;
              
              return (
                <div className={`rounded-xl p-4 ${darkMode ? 'bg-gradient-to-br from-[#1E3A5F] to-gray-800' : 'bg-gradient-to-br from-[#1E3A5F] to-[#2D4A6F]'}`}>
                  <div className="flex items-center justify-between mb-4">
                    <div>
                      <h3 className="text-white font-bold text-lg">Team Performance</h3>
                      <p className="text-white/60 text-sm">{rangeLabels[scorecardRange]}</p>
                    </div>
                    <div className="text-right">
                      <p className="text-3xl font-bold text-white">{teamRate}%</p>
                      <p className="text-white/60 text-xs">Team Average</p>
                    </div>
                  </div>
                  
                  {/* Your Position */}
                  <div className="bg-white/10 backdrop-blur rounded-xl p-3 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${
                        myRank === 1 ? 'bg-amber-400 text-amber-900' : myRank === 2 ? 'bg-gray-300 text-gray-700' : myRank === 3 ? 'bg-amber-600 text-white' : 'bg-white/20 text-white'
                      }`}>
                        {myRank}
                      </div>
                      <div>
                        <p className="text-white font-semibold">Your Rank</p>
                        <p className="text-white/60 text-sm">{myRate}% completion  {myRate >= teamRate ? '+' : ''}{myRate - teamRate}% vs team</p>
                      </div>
                    </div>
                    {myRank === 1 && <Trophy className="w-6 h-6 text-amber-400" />}
                  </div>
                </div>
              );
            })()}

            {/* Individual Scorecards - Conditional visibility */}
            {allParticipants.map(p => {
              // Only show if: owner OR it's the user's own data
              const canView = isOwner || p === myParticipant;
              if (!canView) return null;
              
              const pH = getRangeHabits.filter(h => h.participant === p);
              const completed = pH.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
              const rate = pH.length > 0 ? Math.round((completed / pH.length) * 100) : 0;
              const profile = getProfileByParticipant(p);
              
              // Group by normalized habit name for metrics
              const habitGroups = {};
              pH.forEach(h => {
                const normName = getNormalizedHabitName(h.habit);
                if (!habitGroups[normName]) habitGroups[normName] = [];
                habitGroups[normName].push(h);
              });
              
              // Group by category
              const categoryStats = {};
              HABIT_CATEGORIES.forEach(cat => {
                const catHabits = pH.filter(h => h.category === cat.id);
                if (catHabits.length > 0) {
                  const catCompleted = catHabits.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
                  categoryStats[cat.id] = {
                    total: catHabits.length,
                    completed: catCompleted,
                    rate: Math.round((catCompleted / catHabits.length) * 100)
                  };
                }
              });
              
              return (
                <div key={p} className={`rounded-xl p-4 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                  <div className="flex items-center justify-between mb-3">
                    <button onClick={() => openProfileView(p)} className="flex items-center gap-3 hover:opacity-80">
                      {profile?.photoURL ? (
                        <img src={profile.photoURL} alt="" className="w-10 h-10 rounded-full object-cover" />
                      ) : (
                        <div className="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold text-sm" style={{ backgroundColor: PARTICIPANT_COLORS[p] || '#6366f1' }}>{p[0]}</div>
                      )}
                      <div>
                        <h3 className={`font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{p}</h3>
                        {p === myParticipant && <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>You</span>}
                      </div>
                    </button>
                    <div className="text-right">
                      <p className="text-2xl font-bold" style={{ color: PARTICIPANT_COLORS[p] || '#6366f1' }}>{rate}%</p>
                      <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>completion</p>
                    </div>
                  </div>
                  
                  <div className={`h-3 ${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-full overflow-hidden mb-3`}>
                    <div className="h-full rounded-full transition-all" style={{ width: `${rate}%`, backgroundColor: PARTICIPANT_COLORS[p] || '#6366f1' }} />
                  </div>
                  
                  {/* Stats Grid */}
                  <div className="grid grid-cols-4 gap-2 text-center mb-3">
                    <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg p-2`}>
                      <p className={`text-lg font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{pH.length}</p>
                      <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>Total</p>
                    </div>
                    <div className={`${darkMode ? 'bg-green-500/20' : 'bg-green-50'} rounded-lg p-2`}>
                      <p className={`text-lg font-bold ${darkMode ? 'text-green-400' : 'text-green-600'}`}>{completed}</p>
                      <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>Done</p>
                    </div>
                    <div className={`${darkMode ? 'bg-emerald-500/20' : 'bg-emerald-50'} rounded-lg p-2`}>
                      <p className={`text-lg font-bold ${darkMode ? 'text-emerald-400' : 'text-emerald-600'}`}>{pH.filter(h => getStatus(h) === 'Exceeded').length}</p>
                      <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>Exceeded</p>
                    </div>
                    <div className={`${darkMode ? 'bg-red-500/20' : 'bg-red-50'} rounded-lg p-2`}>
                      <p className={`text-lg font-bold ${darkMode ? 'text-red-400' : 'text-red-500'}`}>{pH.filter(h => getStatus(h) === 'Missed').length}</p>
                      <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>Missed</p>
                    </div>
                  </div>
                  
                  {/* Category Breakdown */}
                  {Object.keys(categoryStats).length > 0 && (
                    <div className={`border-t pt-3 ${darkMode ? 'border-gray-700' : 'border-gray-100'}`}>
                      <p className={`text-xs font-medium mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>By Category</p>
                      <div className="flex flex-wrap gap-2">
                        {Object.entries(categoryStats).map(([catId, stats]) => {
                          const cat = HABIT_CATEGORIES.find(c => c.id === catId);
                          return (
                            <div key={catId} className={`flex items-center gap-1.5 px-2 py-1 rounded-lg text-xs ${darkMode ? cat?.darkColor : cat?.color}`}>
                              <span>{cat?.icon}</span>
                              <span className="font-medium">{catId}</span>
                              <span className="opacity-70">{stats.rate}%</span>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                  
                  {/* Normalized Habit Groups - Show if there are merged habits */}
                  {Object.keys(habitNormGroups).length > 0 && Object.keys(habitGroups).some(k => habitGroups[k].length > 1) && (
                    <div className={`border-t pt-3 mt-3 ${darkMode ? 'border-gray-700' : 'border-gray-100'}`}>
                      <p className={`text-xs font-medium mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Merged Habits</p>
                      <div className="space-y-1">
                        {Object.entries(habitGroups).filter(([_, group]) => group.length > 1).map(([normName, group]) => {
                          const groupCompleted = group.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
                          return (
                            <div key={normName} className={`flex items-center justify-between text-xs ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                              <span>{normName} ({group.length} habits)</span>
                              <span className="font-medium">{Math.round((groupCompleted / group.length) * 100)}%</span>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                </div>
              );
            })}
            
            {/* Leaderboard - Visible to everyone but without detailed stats for others */}
            {!isOwner && (
              <div className={`rounded-xl p-4 ${darkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white border border-gray-100'}`}>
                <h3 className={`font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>Team Leaderboard</h3>
                <div className="space-y-2">
                  {allParticipants.map((p, idx) => {
                    const pH = getRangeHabits.filter(h => h.participant === p);
                    const completed = pH.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
                    const rate = pH.length > 0 ? Math.round((completed / pH.length) * 100) : 0;
                    const isMe = p === myParticipant;
                    
                    return (
                      <div key={p} className={`flex items-center gap-3 p-2 rounded-lg ${isMe ? (darkMode ? 'bg-[#1E3A5F]/30 border border-[#1E3A5F]/50' : 'bg-blue-50 border border-blue-200') : ''}`}>
                        <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                          idx === 0 ? 'bg-amber-400 text-amber-900' : idx === 1 ? 'bg-gray-300 text-gray-700' : idx === 2 ? 'bg-amber-600 text-white' : (darkMode ? 'bg-gray-700 text-gray-400' : 'bg-gray-200 text-gray-600')
                        }`}>
                          {idx + 1}
                        </div>
                        <span className={`flex-1 font-medium ${isMe ? (darkMode ? 'text-white' : 'text-gray-900') : (darkMode ? 'text-gray-300' : 'text-gray-700')}`}>
                          {p} {isMe && '(You)'}
                        </span>
                        <span className={`font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>{rate}%</span>
                      </div>
                    );
                  }).sort((a, b) => {
                    // Sort by rate descending
                    const aRate = getRangeHabits.filter(h => h.participant === a.key).filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
                    const bRate = getRangeHabits.filter(h => h.participant === b.key).filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
                    return bRate - aRate;
                  })}
                </div>
              </div>
            )}
          </div>
        )}

        {/* ADD HABIT MODAL */}
        {showAddHabitModal && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            {/* Backdrop */}
            <div 
              className={`absolute inset-0 backdrop-blur-md ${darkMode ? 'bg-black/70' : 'bg-black/50'}`}
              onClick={() => setShowAddHabitModal(false)}
            />
            {/* Modal */}
            <div className={`relative w-full max-w-md rounded-2xl p-5 shadow-2xl ${
              darkMode 
                ? 'bg-gray-800 border border-gray-600 shadow-black/50' 
                : 'bg-white'
            }`}>
              {/* Close button */}
              <button 
                onClick={() => setShowAddHabitModal(false)}
                className={`absolute top-4 right-4 p-1 rounded-lg transition-colors ${
                  darkMode ? 'text-gray-400 hover:bg-gray-700 hover:text-gray-200' : 'text-gray-400 hover:bg-gray-100'
                }`}
              >
                <X className="w-5 h-5" />
              </button>
              
              <h2 className={`font-bold text-lg mb-4 ${darkMode ? 'text-gray-100' : 'text-gray-800'}`}>
                Add Habits for {currentWeek ? formatWeekString(currentWeek) : 'this week'}
              </h2>
              
              {/* Single/Bulk toggle */}
              <div className={`flex gap-2 mb-4 p-1 rounded-xl ${darkMode ? 'bg-gray-800' : 'bg-gray-100'}`}>
                {['single', 'bulk'].map(m => (
                  <button 
                    key={m} 
                    onClick={() => setAddMode(m)} 
                    className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                      addMode === m 
                        ? darkMode ? 'bg-gradient-to-r from-[#1E3A5F] to-[#2d4a6f] text-white shadow-lg' : 'bg-[#1E3A5F] text-white' 
                        : darkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-600'
                    }`}
                  >
                    {m === 'single' ? 'Single Habit' : 'Bulk Add'}
                  </button>
                ))}
              </div>
              
              {addMode === 'single' ? (
                <div className="space-y-3">
                  <input 
                    type="text" 
                    value={newHabit.habit} 
                    onChange={(e) => setNewHabit({ ...newHabit, habit: e.target.value })} 
                    className={`w-full rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#F5B800] ${
                      darkMode 
                        ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20 text-white placeholder-gray-500' 
                        : 'bg-gray-50 border border-gray-200 text-gray-800'
                    }`} 
                    placeholder="What habit do you want to track?" 
                    autoFocus
                  />
                  
                  {/* Habit Type Toggle */}
                  <div>
                    <label className={`text-xs font-medium mb-1.5 block ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Tracking Type</label>
                    <div className={`flex gap-2 p-1 rounded-xl ${darkMode ? 'bg-gray-800' : 'bg-gray-100'}`}>
                      <button 
                        onClick={() => setNewHabit({ ...newHabit, habitType: 'daily', target: 5 })}
                        className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                          newHabit.habitType === 'daily' 
                            ? 'bg-[#1E3A5F] text-white' 
                            : darkMode ? 'text-gray-400' : 'text-gray-600'
                        }`}
                      >
                         Daily/Weekly
                      </button>
                      <button 
                        onClick={() => setNewHabit({ ...newHabit, habitType: 'percentage', target: 50 })}
                        className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                          newHabit.habitType === 'percentage' 
                            ? 'bg-[#1E3A5F] text-white' 
                            : darkMode ? 'text-gray-400' : 'text-gray-600'
                        }`}
                      >
                         Percentage
                      </button>
                    </div>
                  </div>
                  
                  {/* Category Selection */}
                  <div>
                    <label className={`text-xs font-medium mb-1.5 block ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Category (optional - AI will auto-detect if blank)</label>
                    <div className="grid grid-cols-4 gap-1.5">
                      {HABIT_CATEGORIES.map(cat => (
                        <button
                          key={cat.id}
                          onClick={() => setNewHabit({ ...newHabit, category: newHabit.category === cat.id ? '' : cat.id })}
                          className={`p-2 rounded-lg text-xs font-medium flex flex-col items-center gap-1 transition-colors ${
                            newHabit.category === cat.id 
                              ? darkMode ? cat.darkColor + ' ring-1 ring-white/30' : cat.color + ' ring-1 ring-gray-400'
                              : darkMode ? 'bg-gray-700 text-gray-400 hover:bg-gray-600' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                          }`}
                        >
                          <span className="text-base">{cat.icon}</span>
                          <span className="truncate w-full text-center">{cat.id}</span>
                        </button>
                      ))}
                    </div>
                  </div>
                  
                  <div>
                    <label className={`text-xs font-medium mb-1 block ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      {newHabit.habitType === 'percentage' ? 'Target %' : 'Target'}
                    </label>
                    {newHabit.habitType === 'percentage' ? (
                      <div className="relative">
                        <input 
                          type="number" 
                          min="1" 
                          max="100"
                          value={newHabit.target} 
                          onChange={(e) => setNewHabit({ ...newHabit, target: Math.min(100, Math.max(1, parseInt(e.target.value) || 1)) })} 
                          className={`w-full rounded-xl px-3 py-2.5 pr-8 text-sm focus:outline-none focus:ring-2 focus:ring-[#F5B800] ${
                            darkMode 
                              ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20 text-white' 
                              : 'bg-gray-50 border border-gray-200 text-gray-800'
                          }`}
                        />
                        <span className={`absolute right-3 top-1/2 -translate-y-1/2 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>%</span>
                      </div>
                    ) : (
                      <select 
                        value={newHabit.target} 
                        onChange={(e) => setNewHabit({ ...newHabit, target: e.target.value })} 
                        className={`w-full rounded-xl px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#F5B800] ${
                          darkMode 
                            ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20 text-white' 
                            : 'bg-gray-50 border border-gray-200 text-gray-800'
                        }`}
                      >
                        {[1,2,3,4,5,6,7].map(n => <option key={n} value={n}>{n} {n === 1 ? 'time' : 'times'}</option>)}
                      </select>
                    )}
                  </div>
                  
                  {/* Example hint for percentage */}
                  {newHabit.habitType === 'percentage' && (
                    <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>
                       Track each attempt individually (/) and get automatic percentage. Example: 3 successes out of 5 trades = 60%
                    </p>
                  )}
                  
                  <button 
                    onClick={() => { addHabit(); setShowAddHabitModal(false); }} 
                    disabled={!newHabit.habit.trim()}
                    className="w-full bg-[#1E3A5F] text-white py-3 rounded-xl text-sm font-medium hover:bg-[#162D4D] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Add Habit
                  </button>
                </div>
              ) : (
                <div className="space-y-3">
                  <textarea 
                    value={bulkHabits} 
                    onChange={(e) => setBulkHabits(e.target.value)} 
                    className={`w-full rounded-xl px-4 py-3 text-sm h-32 focus:outline-none focus:ring-2 focus:ring-[#F5B800] resize-none ${
                      darkMode 
                        ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20 text-white placeholder-gray-500' 
                        : 'bg-gray-50 border border-gray-200 text-gray-800'
                    }`} 
                    placeholder="Enter one habit per line...&#10;Example:&#10;Exercise 30 minutes&#10;Read for 20 minutes&#10;Meditate"
                    autoFocus
                  />
                  <div>
                    <label className={`text-xs font-medium mb-1 block ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Target (for all habits)</label>
                    <select 
                      value={bulkTarget} 
                      onChange={(e) => setBulkTarget(e.target.value)} 
                      className={`w-full rounded-xl px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#F5B800] ${
                        darkMode 
                          ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20 text-white' 
                          : 'bg-gray-50 border border-gray-200 text-gray-800'
                      }`}
                    >
                      {[1,2,3,4,5,6,7].map(n => <option key={n} value={n}>{n} {n === 1 ? 'time' : 'times'}</option>)}
                    </select>
                  </div>
                  <button 
                    onClick={() => { addBulkHabits(); setShowAddHabitModal(false); }} 
                    disabled={!bulkHabits.trim()}
                    className="w-full bg-[#1E3A5F] text-white py-3 rounded-xl text-sm font-medium hover:bg-[#162D4D] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Add {bulkHabits.split('\n').filter(l => l.trim()).length || 0} Habits
                  </button>
                </div>
              )}
            </div>
          </div>
        )}

        {/* HABIT MANAGER MODAL - Categories & Normalization */}
        {showHabitManagerModal && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            {/* Backdrop */}
            <div 
              className={`absolute inset-0 backdrop-blur-md ${darkMode ? 'bg-black/70' : 'bg-black/50'}`}
              onClick={() => setShowHabitManagerModal(false)}
            />
            {/* Modal */}
            <div className={`relative w-full max-w-2xl max-h-[85vh] rounded-2xl shadow-2xl flex flex-col ${
              darkMode 
                ? 'bg-gray-800 border border-gray-600' 
                : 'bg-white'
            }`}>
              {/* Header */}
              <div className={`flex items-center justify-between p-4 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${darkMode ? 'bg-purple-500/20' : 'bg-purple-100'}`}>
                    <Brain className={`w-5 h-5 ${darkMode ? 'text-purple-400' : 'text-purple-600'}`} />
                  </div>
                  <div>
                    <h2 className={`font-bold text-lg ${darkMode ? 'text-white' : 'text-gray-800'}`}>My Habit Manager</h2>
                    <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Organize your categories & similar habits</p>
                  </div>
                </div>
                <button 
                  onClick={() => setShowHabitManagerModal(false)}
                  className={`p-2 rounded-lg transition-colors ${darkMode ? 'text-gray-400 hover:bg-gray-700' : 'text-gray-400 hover:bg-gray-100'}`}
                >
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              {/* Tabs */}
              <div className={`flex gap-2 p-4 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                <button
                  onClick={() => setHabitManagerTab('uncategorized')}
                  className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                    habitManagerTab === 'uncategorized'
                      ? darkMode ? 'bg-purple-500/20 text-purple-400' : 'bg-purple-100 text-purple-700'
                      : darkMode ? 'text-gray-400 hover:bg-gray-700' : 'text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  <Sparkles className="w-4 h-4" />
                  Uncategorized
                  {(() => {
                    const count = habits.filter(h => h.participant === myParticipant && !h.category).length;
                    return count > 0 ? (
                      <span className={`px-1.5 py-0.5 rounded-full text-xs ${darkMode ? 'bg-amber-500/20 text-amber-400' : 'bg-amber-100 text-amber-700'}`}>{count}</span>
                    ) : null;
                  })()}
                </button>
                <button
                  onClick={() => setHabitManagerTab('groups')}
                  className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                    habitManagerTab === 'groups'
                      ? darkMode ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-100 text-blue-700'
                      : darkMode ? 'text-gray-400 hover:bg-gray-700' : 'text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  <Users className="w-4 h-4" />
                  Similar Habits
                  {Object.keys(habitNormGroups).length > 0 && (
                    <span className={`px-1.5 py-0.5 rounded-full text-xs ${darkMode ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-100 text-blue-700'}`}>
                      {Object.keys(habitNormGroups).length}
                    </span>
                  )}
                </button>
              </div>
              
              {/* Content */}
              <div className="flex-1 overflow-y-auto p-4">
                {habitManagerTab === 'uncategorized' && (
                  <div className="space-y-3">
                    {(() => {
                      const myHabitsOnly = habits.filter(h => h.participant === myParticipant);
                      const uncategorized = myHabitsOnly.filter(h => !h.category);
                      if (uncategorized.length === 0) {
                        return (
                          <div className={`text-center py-12 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                            <CheckCircle2 className="w-12 h-12 mx-auto mb-3 opacity-50" />
                            <p className="font-medium">All your habits are categorized!</p>
                            <p className="text-sm mt-1">Great job organizing your habits.</p>
                          </div>
                        );
                      }
                      
                      return uncategorized.map(habit => (
                        <div key={habit.id} className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                          <div className="flex items-center justify-between mb-3">
                            <div>
                              <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>{habit.habit}</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-1.5">
                            {HABIT_CATEGORIES.map(cat => (
                              <button
                                key={cat.id}
                                onClick={() => updateHabitCategory(habit.id, cat.id)}
                                className={`flex items-center gap-1 px-2.5 py-1.5 rounded-lg text-xs font-medium transition-colors ${
                                  darkMode ? cat.darkColor + ' hover:ring-1 hover:ring-white/30' : cat.color + ' hover:ring-1 hover:ring-gray-400'
                                }`}
                              >
                                <span>{cat.icon}</span>
                                <span>{cat.id}</span>
                              </button>
                            ))}
                          </div>
                        </div>
                      ));
                    })()}
                  </div>
                )}
                
                {habitManagerTab === 'groups' && (
                  <div className="space-y-4">
                    {Object.keys(habitNormGroups).length === 0 ? (
                      <div className={`text-center py-12 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        <Users className="w-12 h-12 mx-auto mb-3 opacity-50" />
                        <p className="font-medium">No similar habits grouped yet</p>
                        <p className="text-sm mt-1">Click "Find Similar Habits" to detect groups automatically.</p>
                        <button
                          onClick={() => { setShowHabitManagerModal(false); aiNormalizeHabits(); }}
                          className={`mt-4 px-4 py-2 rounded-lg text-sm font-medium ${darkMode ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-100 text-blue-700'}`}
                        >
                          Find Similar Habits
                        </button>
                      </div>
                    ) : (
                      <>
                        <div className="flex items-center justify-between">
                          <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                            {Object.keys(habitNormGroups).length} group{Object.keys(habitNormGroups).length !== 1 ? 's' : ''}  
                            {Object.values(habitNormGroups).flat().length} habits merged
                          </p>
                          <button
                            onClick={clearAllNormGroups}
                            className={`text-xs px-2 py-1 rounded ${darkMode ? 'text-red-400 hover:bg-red-500/20' : 'text-red-600 hover:bg-red-50'}`}
                          >
                            Clear All
                          </button>
                        </div>
                        
                        {Object.entries(habitNormGroups).map(([groupName, habitNames]) => (
                          <div key={groupName} className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                            <div className="flex items-center justify-between mb-3">
                              <div className="flex items-center gap-2">
                                <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${darkMode ? 'bg-blue-500/20' : 'bg-blue-100'}`}>
                                  <Users className={`w-4 h-4 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`} />
                                </div>
                                <div>
                                  <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>{groupName}</p>
                                  <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>{habitNames.length} habits treated as one</p>
                                </div>
                              </div>
                              <button
                                onClick={() => deleteNormGroup(groupName)}
                                className={`p-1.5 rounded-lg ${darkMode ? 'text-red-400 hover:bg-red-500/20' : 'text-red-500 hover:bg-red-50'}`}
                              >
                                <Trash2 className="w-4 h-4" />
                              </button>
                            </div>
                            <div className="flex flex-wrap gap-2">
                              {habitNames.map(name => (
                                <div
                                  key={name}
                                  className={`flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg text-sm ${darkMode ? 'bg-gray-600 text-gray-200' : 'bg-white text-gray-700 border border-gray-200'}`}
                                >
                                  <span>{name}</span>
                                  <button
                                    onClick={() => removeFromNormGroup(groupName, name)}
                                    className={`p-0.5 rounded hover:bg-gray-500/30 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}
                                  >
                                    <X className="w-3 h-3" />
                                  </button>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </>
                    )}
                  </div>
                )}
              </div>
              
              {/* Footer */}
              <div className={`flex items-center justify-between p-4 border-t ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  {habitManagerTab === 'uncategorized' 
                    ? `${habits.filter(h => h.participant === myParticipant && !h.category).length} uncategorized  ${habits.filter(h => h.participant === myParticipant && h.category).length} categorized`
                    : 'Similar habits are treated as one in your metrics'
                  }
                </div>
                <button
                  onClick={() => setShowHabitManagerModal(false)}
                  className={`px-4 py-2 rounded-lg text-sm font-medium ${darkMode ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                >
                  Done
                </button>
              </div>
            </div>
          </div>
        )}

        {/* QUOTE CUSTOMIZATION MODAL */}
        {showQuoteModal && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            {/* Backdrop */}
            <div 
              className={`absolute inset-0 backdrop-blur-md ${darkMode ? 'bg-black/70' : 'bg-black/50'}`}
              onClick={() => setShowQuoteModal(false)}
            />
            {/* Modal */}
            <div className={`relative w-full max-w-md rounded-2xl p-5 shadow-2xl ${
              darkMode 
                ? 'bg-gray-800 border border-gray-600 shadow-black/50' 
                : 'bg-white'
            }`}>
              {/* Close button */}
              <button 
                onClick={() => setShowQuoteModal(false)}
                className={`absolute top-4 right-4 p-1 rounded-lg transition-colors ${
                  darkMode ? 'text-gray-400 hover:bg-gray-700 hover:text-gray-200' : 'text-gray-400 hover:bg-gray-100'
                }`}
              >
                <X className="w-5 h-5" />
              </button>
              
              {/* Header with watermark */}
              <div className="flex items-center gap-3 mb-5">
                <img src={WATERMARK_BASE64} alt="Logo" className="w-12 h-12" />
                <div>
                  <h2 className={`font-bold text-lg ${darkMode ? 'text-gray-100' : 'text-gray-800'}`}>
                    Generate Quote
                  </h2>
                  <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    Customize your weekly wisdom
                  </p>
                </div>
              </div>
              
              {/* Theme Type Selection */}
              <div className="mb-4">
                <label className={`text-xs font-medium mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  Theme Style
                </label>
                <div className="grid grid-cols-2 gap-2">
                  {[
                    { value: 'random', label: ' Random', desc: 'Surprise me!' },
                    { value: 'motivational', label: ' Motivational', desc: 'Push forward' },
                    { value: 'stoic', label: ' Stoic', desc: 'Ancient wisdom' },
                    { value: 'business', label: ' Business', desc: 'Leadership' },
                    { value: 'faith', label: ' Faith', desc: 'Spiritual' },
                    { value: 'discipline', label: ' Discipline', desc: 'Self-control' }
                  ].map(type => (
                    <button
                      key={type.value}
                      onClick={() => setQuoteThemeType(type.value)}
                      className={`p-3 rounded-xl text-left transition-all ${
                        quoteThemeType === type.value
                          ? darkMode 
                            ? 'bg-gradient-to-r from-[#1E3A5F] to-[#2d4a6f] text-white ring-2 ring-[#F5B800]/50' 
                            : 'bg-[#1E3A5F] text-white ring-2 ring-[#F5B800]'
                          : darkMode
                            ? 'bg-gray-800 text-gray-300 hover:bg-gray-700 border border-gray-700'
                            : 'bg-gray-50 text-gray-700 hover:bg-gray-100 border border-gray-200'
                      }`}
                    >
                      <div className="font-medium text-sm">{type.label}</div>
                      <div className={`text-xs ${quoteThemeType === type.value ? 'text-white/70' : darkMode ? 'text-gray-400' : 'text-gray-400'}`}>
                        {type.desc}
                      </div>
                    </button>
                  ))}
                </div>
              </div>
              
              {/* Custom Direction */}
              <div className="mb-5">
                <label className={`text-xs font-medium mb-2 block ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                  Custom Direction <span className={darkMode ? 'text-gray-300' : 'text-gray-400'}>(optional)</span>
                </label>
                <textarea
                  value={quoteCustomDirection}
                  onChange={(e) => setQuoteCustomDirection(e.target.value)}
                  placeholder="E.g., 'Something about perseverance during hard times' or 'A quote from an athlete about dedication'"
                  className={`w-full rounded-xl px-4 py-3 text-sm h-20 focus:outline-none focus:ring-2 focus:ring-[#F5B800] resize-none ${
                    darkMode 
                      ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20 text-white placeholder-gray-500' 
                      : 'bg-gray-50 border border-gray-200 text-gray-800 placeholder-gray-400'
                  }`}
                />
              </div>
              
              {/* Action Buttons */}
              <div className="flex gap-3">
                <button
                  onClick={() => setShowQuoteModal(false)}
                  className={`flex-1 py-3 rounded-xl text-sm font-medium transition-colors ${
                    darkMode 
                      ? 'bg-gray-800 text-gray-300 hover:bg-gray-700 border border-gray-700' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  Cancel
                </button>
                <button
                  onClick={() => generateQuote()}
                  disabled={quoteLoading}
                  className="flex-1 py-3 rounded-xl text-sm font-medium transition-colors bg-gradient-to-r from-amber-500 to-amber-600 text-white hover:from-amber-600 hover:to-amber-700 disabled:opacity-50 flex items-center justify-center gap-2"
                >
                  {quoteLoading ? (
                    <>
                      <Loader2 className="w-4 h-4 animate-spin" />
                      Generating...
                    </>
                  ) : (
                    <>
                      <Sparkles className="w-4 h-4" />
                      Generate
                    </>
                  )}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* INSIGHTS VIEW */}
        {activeView === 'insights' && (
          <div className="space-y-4">
            {/* Main Stats Grid - Mobile: single column */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              {/* Radar Chart - Life Balance - Glass */}
              <div className={`rounded-2xl p-4 md:p-5 backdrop-blur-xl transition-all duration-300 ${
                darkMode 
                  ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20' 
                  : 'bg-white/60 border border-white shadow-xl'
              }`}>
                <h3 className={`text-sm mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Life Balance</h3>
                <ResponsiveContainer width="100%" height={220}>
                  <RadarChart data={(() => {
                    const categories = ['Fitness', 'Business', 'Finance', 'Health', 'Learning', 'Relationships', 'Spiritual'];
                    // Exclude current week for accurate historical balance
                    const myHabits = habits.filter(h => h.participant === myParticipant && h.weekStart !== currentWeekStart);
                    
                    return categories.map(cat => {
                      const catHabits = myHabits.filter(h => (h.category || 'Personal') === cat);
                      if (catHabits.length === 0) {
                        const keywords = {
                          'Fitness': ['workout', 'gym', 'run', 'exercise', 'walk', 'fitness'],
                          'Business': ['work', 'client', 'meeting', 'business', 'call', 'email'],
                          'Finance': ['budget', 'invest', 'money', 'finance', 'trade', 'save'],
                          'Health': ['sleep', 'wake', 'meditat', 'health', 'diet', 'water'],
                          'Learning': ['read', 'learn', 'study', 'course', 'book'],
                          'Relationships': ['family', 'friend', 'call', 'social', 'team'],
                          'Spiritual': ['pray', 'church', 'bible', 'spiritual', 'gratitude', 'journal']
                        };
                        const matched = myHabits.filter(h => 
                          keywords[cat]?.some(kw => h.habit.toLowerCase().includes(kw))
                        );
                        if (matched.length > 0) {
                          const completed = matched.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
                          return { category: cat, score: matched.length > 0 ? Math.round((completed / matched.length) * 100) : 0, fullMark: 100 };
                        }
                      }
                      const completed = catHabits.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
                      return { category: cat, score: catHabits.length > 0 ? Math.round((completed / catHabits.length) * 100) : 30 + Math.random() * 40, fullMark: 100 };
                    });
                  })()}>
                    <PolarGrid stroke={darkMode ? '#334155' : '#e2e8f0'} />
                    <PolarAngleAxis dataKey="category" tick={{ fill: darkMode ? '#94a3b8' : '#64748b', fontSize: 10 }} />
                    <PolarRadiusAxis angle={90} domain={[0, 100]} tick={{ fill: darkMode ? '#64748b' : '#94a3b8', fontSize: 8 }} />
                    <Radar name="Score" dataKey="score" stroke="#3b82f6" fill="#3b82f6" fillOpacity={0.4} strokeWidth={2} />
                  </RadarChart>
                </ResponsiveContainer>
              </div>

              {/* Heatmap + Life Score */}
              <div className="space-y-4">
                {/* GitHub-style Heatmap - Glass */}
                <div className={`rounded-2xl p-4 md:p-5 backdrop-blur-xl transition-all duration-300 ${
                  darkMode 
                    ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20' 
                    : 'bg-white/60 border border-white shadow-xl'
                }`}>
                  <div className="flex items-center justify-between mb-3">
                    <div>
                      <p className={`text-xs uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>Heatmap</p>
                      <h3 className={`text-lg font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Activity</h3>
                    </div>
                    <span className="text-emerald-500 text-sm font-medium">
                      {(() => {
                        // Exclude current week for accurate historical stats
                        const myHabits = habits.filter(h => h.participant === myParticipant && h.weekStart !== currentWeekStart);
                        const completed = myHabits.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
                        return myHabits.length > 0 ? Math.round((completed / myHabits.length) * 100) : 0;
                      })()}% Overall
                    </span>
                  </div>
                  
                  {/* Heatmap Grid - Days vertical, Weeks horizontal */}
                  {(() => {
                    const today = new Date();
                    const currentMonday = new Date(today);
                    currentMonday.setDate(today.getDate() - ((today.getDay() + 6) % 7));
                    const currentWeekStr = currentMonday.toISOString().split('T')[0];
                    
                    // Filter to weeks with data, up to and including current week
                    const weeksWithData = ALL_WEEKS.filter(week => {
                      if (week > currentWeekStr) return false;
                      const weekHabits = habits.filter(h => h.weekStart === week && h.participant === myParticipant);
                      return weekHabits.length > 0;
                    });
                    
                    const weeks = weeksWithData.slice(-12);
                    
                    if (weeks.length === 0) {
                      return (
                        <div className={`flex items-center justify-center py-8 text-sm ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>
                          No habit data yet. Start tracking to see your activity!
                        </div>
                      );
                    }
                    
                    // Get month labels for the weeks
                    const monthLabels = weeks.map((week, idx) => {
                      const weekDate = new Date(week + 'T00:00:00');
                      const month = weekDate.toLocaleDateString('en-US', { month: 'short' });
                      // Only show if first week or new month
                      if (idx === 0) return month;
                      const prevWeekDate = new Date(weeks[idx - 1] + 'T00:00:00');
                      if (weekDate.getMonth() !== prevWeekDate.getMonth()) return month;
                      return null;
                    });
                    
                    return (
                      <div className="flex gap-2">
                        {/* Day labels - vertical on left */}
                        <div className="flex flex-col gap-1 pt-5">
                          {['M', 'T', 'W', 'T', 'F', 'S', 'S'].map((d, i) => (
                            <div key={i} className={`w-4 h-4 flex items-center justify-center text-[10px] ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>
                              {i % 2 === 0 ? d : ''}
                            </div>
                          ))}
                        </div>
                        
                        {/* Grid */}
                        <div className="flex-1 overflow-x-auto">
                          {/* Month labels */}
                          <div className="flex gap-1 mb-1">
                            {monthLabels.map((label, idx) => (
                              <div key={idx} className={`w-4 text-[10px] ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>
                                {label || ''}
                              </div>
                            ))}
                          </div>
                          
                          {/* Weeks grid */}
                          <div className="flex gap-1">
                            {weeks.map((week, weekIdx) => {
                              const weekDate = new Date(week + 'T00:00:00');
                              const isCurrentWeek = week === currentWeekStr;
                              
                              return (
                                <div key={week} className="flex flex-col gap-1">
                                  {DAYS.map((day, dayIdx) => {
                                    const weekHabits = habits.filter(h => h.weekStart === week && h.participant === myParticipant);
                                    const dayCompleted = weekHabits.filter(h => h.daysCompleted?.includes(dayIdx)).length;
                                    const dayTotal = weekHabits.length;
                                    const pct = dayTotal > 0 ? (dayCompleted / dayTotal) * 100 : 0;
                                    
                                    const dayDate = new Date(weekDate);
                                    dayDate.setDate(dayDate.getDate() + dayIdx);
                                    const isFuture = dayDate > today;
                                    
                                    let bgColor = darkMode ? 'bg-gray-700/50' : 'bg-gray-200/60';
                                    if (isFuture) {
                                      bgColor = darkMode ? 'bg-gray-800/30' : 'bg-gray-100/50';
                                    } else if (pct > 0) {
                                      bgColor = darkMode ? 'bg-emerald-900/60' : 'bg-emerald-200';
                                    }
                                    if (!isFuture && pct >= 40) bgColor = darkMode ? 'bg-emerald-700/70' : 'bg-emerald-300';
                                    if (!isFuture && pct >= 70) bgColor = darkMode ? 'bg-emerald-500/80' : 'bg-emerald-400';
                                    if (!isFuture && pct >= 90) bgColor = 'bg-emerald-500';
                                    
                                    return (
                                      <div
                                        key={dayIdx}
                                        className={`w-4 h-4 rounded-sm ${bgColor} ${isCurrentWeek && !isFuture ? 'ring-1 ring-blue-400/40' : ''} hover:ring-2 hover:ring-blue-400/50 cursor-pointer transition-all`}
                                        title={`${day}, ${dayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}: ${isFuture ? 'Future' : `${Math.round(pct)}% (${dayCompleted}/${dayTotal})`}`}
                                      />
                                    );
                                  })}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      </div>
                    );
                  })()}
                  
                  {/* Legend */}
                  <div className={`flex items-center justify-end gap-1 mt-3 text-[10px] ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>
                    <span>Less</span>
                    <div className={`w-3 h-3 rounded-sm ${darkMode ? 'bg-gray-700/50' : 'bg-gray-200'}`}></div>
                    <div className={`w-3 h-3 rounded-sm ${darkMode ? 'bg-emerald-900/60' : 'bg-emerald-200'}`}></div>
                    <div className={`w-3 h-3 rounded-sm ${darkMode ? 'bg-emerald-700/70' : 'bg-emerald-300'}`}></div>
                    <div className={`w-3 h-3 rounded-sm ${darkMode ? 'bg-emerald-500/80' : 'bg-emerald-400'}`}></div>
                    <div className="w-3 h-3 rounded-sm bg-emerald-500"></div>
                    <span>More</span>
                  </div>
                </div>

                {/* Life Score - Glass */}
                <div className={`rounded-2xl p-5 backdrop-blur-xl transition-all duration-300 ${
                  darkMode 
                    ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20' 
                    : 'bg-white/60 border border-white shadow-xl'
                }`}>
                  <h3 className={`text-sm mb-2 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Your Accountability Score</h3>
                  <div className="flex items-end gap-4">
                    <div className="relative">
                      <div className="text-6xl font-bold bg-gradient-to-r from-emerald-500 to-cyan-500 bg-clip-text text-transparent">
                        {(() => {
                          const myHabits = habits.filter(h => h.participant === myParticipant);
                          const completed = myHabits.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
                          const rate = myHabits.length > 0 ? Math.round((completed / myHabits.length) * 100) : 0;
                          const streakBonus = Math.min((calculateStreaks[myParticipant] || 0) * 2, 20);
                          const challengeBonus = bets.filter(b => b.status === 'accepted' && (b.challenger === myParticipant || (Array.isArray(b.challenged) ? b.challenged.includes(myParticipant) : b.challenged === myParticipant))).length * 5;
                          return Math.min(rate + streakBonus + challengeBonus, 100);
                        })()}%
                      </div>
                      <div className="absolute -left-2 bottom-0 w-1 h-full bg-gradient-to-t from-emerald-500/0 via-emerald-500/50 to-emerald-500/0"></div>
                    </div>
                    <div className={`text-xs pb-2 ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>
                      <p>Completion + Streaks + Challenges</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Monthly Progress Bars - Glass */}
            <div className={`rounded-2xl p-5 backdrop-blur-xl transition-all duration-300 ${
              darkMode 
                ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20' 
                : 'bg-white/60 border border-white shadow-xl'
            }`}>
              <div className="flex items-center justify-between mb-4">
                <div>
                  <p className={`text-xs uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-400'}`}>Your Progress</p>
                  <h3 className={`text-lg font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>Monthly Trend</h3>
                </div>
              </div>
              
              <div className="flex items-end justify-around gap-2 h-48">
                {(() => {
                  const months = [];
                  const now = new Date();
                  for (let i = 5; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    months.push({
                      month: d.toLocaleDateString('en-US', { month: 'short' }),
                      year: d.getFullYear(),
                      monthNum: d.getMonth()
                    });
                  }
                  
                  return months.map((m, idx) => {
                    const monthHabits = habits.filter(h => {
                      if (h.participant !== myParticipant) return false;
                      const weekDate = new Date(h.weekStart + 'T00:00:00');
                      return weekDate.getMonth() === m.monthNum && weekDate.getFullYear() === m.year;
                    });
                    
                    const completed = monthHabits.filter(h => ['Done', 'Exceeded'].includes(getStatus(h))).length;
                    const rate = monthHabits.length > 0 ? Math.round((completed / monthHabits.length) * 100) : 0;
                    const isCurrentMonth = m.monthNum === now.getMonth() && m.year === now.getFullYear();
                    
                    return (
                      <div key={idx} className="flex flex-col items-center gap-2 flex-1">
                        <span className={`text-xs font-medium ${darkMode ? 'text-white' : 'text-gray-700'}`}>{rate}%</span>
                        <div className={`w-full max-w-[40px] rounded-t-lg relative ${darkMode ? 'bg-gray-700/30' : 'bg-gray-200/50'}`} style={{ height: '140px' }}>
                          <div 
                            className={`absolute bottom-0 left-0 right-0 rounded-t-lg transition-all duration-500 ${isCurrentMonth ? 'bg-gradient-to-t from-blue-600 to-blue-400' : 'bg-gradient-to-t from-blue-500/70 to-blue-400/70'}`}
                            style={{ height: `${rate}%` }}
                          ></div>
                        </div>
                        <span className={`text-xs ${isCurrentMonth ? darkMode ? 'text-white font-medium' : 'text-blue-600 font-medium' : darkMode ? 'text-gray-400' : 'text-gray-400'}`}>{m.month}</span>
                      </div>
                    );
                  });
                })()}
              </div>
            </div>

            {/* Bottom row - Streaks & Top Habits */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Current Streak - Glass */}
              <div className={`rounded-2xl p-5 backdrop-blur-xl transition-all duration-300 ${
                darkMode 
                  ? 'bg-orange-500/10 border border-orange-500/20' 
                  : 'bg-orange-50/80 border border-orange-200/50 shadow-xl'
              }`}>
                <div className="flex items-center gap-3 mb-4">
                  <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${darkMode ? 'bg-orange-500/20' : 'bg-orange-100'}`}>
                    <Flame className="w-6 h-6 text-orange-500" />
                  </div>
                  <div>
                    <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Current Streak</p>
                    <p className="text-3xl font-bold text-orange-500">{calculateStreaks[myParticipant] || 0} weeks</p>
                  </div>
                </div>
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>Keep your momentum going! Complete this week to extend your streak.</p>
              </div>

              {/* Top Performing Habits - Glass */}
              <div className={`rounded-2xl p-5 backdrop-blur-xl transition-all duration-300 ${
                darkMode 
                  ? 'bg-gray-800 border border-gray-700 shadow-xl shadow-black/20' 
                  : 'bg-white/60 border border-white shadow-xl'
              }`}>
                <h3 className={`text-sm mb-3 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Top Performing Habits</h3>
                <div className="space-y-2">
                  {(() => {
                    const habitStats = {};
                    habits.filter(h => h.participant === myParticipant).forEach(h => {
                      if (!habitStats[h.habit]) {
                        habitStats[h.habit] = { habit: h.habit, completed: 0, total: 0 };
                      }
                      habitStats[h.habit].total++;
                      if (['Done', 'Exceeded'].includes(getStatus(h))) {
                        habitStats[h.habit].completed++;
                      }
                    });
                    
                    return Object.values(habitStats)
                      .map(h => ({ ...h, rate: h.total > 0 ? Math.round((h.completed / h.total) * 100) : 0 }))
                      .sort((a, b) => b.rate - a.rate)
                      .slice(0, 4)
                      .map((h, idx) => (
                        <div key={h.habit} className="flex items-center gap-3">
                          <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                            idx === 0 
                              ? 'bg-yellow-400/20 text-yellow-600' 
                              : idx === 1 
                                ? darkMode ? 'bg-gray-500/20 text-gray-400' : 'bg-gray-200 text-gray-600'
                                : idx === 2 
                                  ? 'bg-orange-400/20 text-orange-500' 
                                  : darkMode ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-100 text-blue-600'
                          }`}>
                            {idx + 1}
                          </span>
                          <div className="flex-1">
                            <p className={`text-sm font-medium truncate ${darkMode ? 'text-white' : 'text-gray-800'}`}>{h.habit}</p>
                            <div className="flex items-center gap-2">
                              <div className={`flex-1 h-1.5 rounded-full overflow-hidden ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>
                                <div className="h-full bg-emerald-500 rounded-full" style={{ width: `${h.rate}%` }}></div>
                              </div>
                              <span className={`text-xs font-medium ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{h.rate}%</span>
                            </div>
                          </div>
                        </div>
                      ));
                  })()}
                </div>
              </div>
            </div>
          </div>
        )}

        {activeView === 'ai-coach' && (
          <div className="space-y-4">
            <div className="bg-gradient-to-r from-[#1E3A5F] to-[#0F2940] rounded-2xl p-6 text-white">
              <div className="flex items-center gap-3 mb-2">
                <Sparkles className="w-8 h-8" />
                <h2 className="text-2xl font-bold">AI Coach</h2>
              </div>
              <p className="text-[#EBE6D3]">Get personalized insights, feedback, and habit suggestions powered by AI.</p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* Weekly Feedback */}
              <div className={`rounded-xl p-4 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                <div className="flex items-center gap-2 mb-3">
                  <div className="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center">
                    <MessageCircle className="w-5 h-5 text-blue-600" />
                  </div>
                  <div>
                    <h3 className="font-semibold text-gray-800">Weekly Coach</h3>
                    <p className="text-xs text-gray-400">Get feedback on your progress</p>
                  </div>
                </div>
                <select 
                  value={selectedAiParticipant} 
                  onChange={(e) => setSelectedAiParticipant(e.target.value)}
                  className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm mb-3"
                >
                  {allParticipants.map(p => <option key={p} value={p}>{p}</option>)}
                </select>
                <button 
                  onClick={() => callAI('weekly-coach')}
                  disabled={aiLoading}
                  className="w-full bg-blue-500 text-white py-2 rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors disabled:opacity-50 flex items-center justify-center gap-2"
                >
                  {aiLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <MessageCircle className="w-4 h-4" />}
                  Get Feedback
                </button>
              </div>

              {/* Team Insights */}
              <div className={`rounded-xl p-4 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                <div className="flex items-center gap-2 mb-3">
                  <div className="w-10 h-10 rounded-xl bg-emerald-50 flex items-center justify-center">
                    <Lightbulb className="w-5 h-5 text-emerald-600" />
                  </div>
                  <div>
                    <h3 className="font-semibold text-gray-800">Team Insights</h3>
                    <p className="text-xs text-gray-400">Analyze patterns across everyone</p>
                  </div>
                </div>
                <p className="text-sm text-gray-500 mb-3">Discover trends, compare progress, and find opportunities for improvement.</p>
                <button 
                  onClick={() => callAI('insights')}
                  disabled={aiLoading}
                  className="w-full bg-emerald-500 text-white py-2 rounded-lg text-sm font-medium hover:bg-emerald-600 transition-colors disabled:opacity-50 flex items-center justify-center gap-2"
                >
                  {aiLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Lightbulb className="w-4 h-4" />}
                  Analyze Team
                </button>
              </div>

              {/* Habit Suggestions - Enhanced */}
              <div className="bg-white rounded-xl p-4 border border-gray-100 md:col-span-2">
                <div className="flex items-center gap-2 mb-3">
                  <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center">
                    <Sparkles className="w-5 h-5 text-white" />
                  </div>
                  <div>
                    <h3 className="font-semibold text-gray-800">Habit Discovery Lab</h3>
                    <p className="text-xs text-gray-400">AI-powered recommendations beyond your comfort zone</p>
                  </div>
                </div>
                
                {/* Goal Input */}
                <input 
                  type="text"
                  value={aiGoal}
                  onChange={(e) => setAiGoal(e.target.value)}
                  placeholder="I want to improve my..."
                  className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm mb-3"
                />
                
                {/* Main Suggestion Buttons - Redesigned */}
                <div className="grid grid-cols-4 gap-2 mb-4">
                  <button 
                    onClick={() => callAI('suggest-habits', aiGoal)}
                    disabled={aiLoading || !aiGoal.trim()}
                    className="bg-amber-500 text-white py-2.5 rounded-lg text-xs font-medium hover:bg-amber-600 transition-colors disabled:opacity-50 flex flex-col items-center justify-center gap-1"
                  >
                    {aiLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Target className="w-4 h-4" />}
                    Goal-Based
                  </button>
                  <button 
                    onClick={() => callAI('explore-new', '')}
                    disabled={aiLoading}
                    className="bg-purple-500 text-white py-2.5 rounded-lg text-xs font-medium hover:bg-purple-600 transition-colors disabled:opacity-50 flex flex-col items-center justify-center gap-1"
                  >
                    {aiLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Zap className="w-4 h-4" />}
                    Explore New
                  </button>
                  <button 
                    onClick={() => callAI('lifestyle-change', '')}
                    disabled={aiLoading}
                    className="bg-gradient-to-r from-rose-500 to-pink-500 text-white py-2.5 rounded-lg text-xs font-medium hover:from-rose-600 hover:to-pink-600 transition-colors disabled:opacity-50 flex flex-col items-center justify-center gap-1"
                  >
                    {aiLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Heart className="w-4 h-4" />}
                    Life Change
                  </button>
                  <button 
                    onClick={() => callAI('random-challenge', '')}
                    disabled={aiLoading}
                    className="bg-gradient-to-r from-cyan-500 to-blue-500 text-white py-2.5 rounded-lg text-xs font-medium hover:from-cyan-600 hover:to-blue-600 transition-colors disabled:opacity-50 flex flex-col items-center justify-center gap-1"
                  >
                    {aiLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Gift className="w-4 h-4" />}
                    Challenge
                  </button>
                </div>
                
                {/* Enhanced Category Grid */}
                <div className="mb-3">
                  <p className="text-xs text-gray-500 mb-2">Quick categories:</p>
                  <div className="flex flex-wrap gap-1.5">
                    {[' Fitness', ' Mental', ' Finance', ' Learning', ' Social', ' Spiritual', ' Creative', ' Growth', ' Productivity', ' Recovery'].map(cat => (
                      <button
                        key={cat}
                        onClick={() => callAI('category-suggest', cat.split(' ')[1])}
                        disabled={aiLoading}
                        className="px-2.5 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs text-gray-600 transition-colors disabled:opacity-50 hover:scale-105"
                      >
                        {cat}
                      </button>
                    ))}
                  </div>
                </div>
                
                {/* Trending/Unconventional Section */}
                <div className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-3 border border-indigo-100">
                  <div className="flex items-center gap-2 mb-2">
                    <TrendingUp className="w-4 h-4 text-indigo-600" />
                    <span className="text-xs font-semibold text-indigo-700">Outside the Box</span>
                  </div>
                  <div className="flex flex-wrap gap-1.5">
                    {[
                      { label: ' Random Habit', action: 'random-habit' },
                      { label: ' 30-Day Sprint', action: '30-day-sprint' },
                      { label: ' Experiment', action: 'habit-experiment' },
                      { label: ' Micro Habits', action: 'micro-habits' },
                      { label: ' Elite Level', action: 'elite-habits' },
                      { label: ' Global Trends', action: 'trending-habits' }
                    ].map(item => (
                      <button
                        key={item.action}
                        onClick={() => callAI(item.action, '')}
                        disabled={aiLoading}
                        className="px-2.5 py-1.5 bg-white hover:bg-indigo-100 rounded-lg text-xs text-indigo-700 transition-colors disabled:opacity-50 border border-indigo-200 hover:scale-105"
                      >
                        {item.label}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              {/* Habit Writer */}
              <div className={`rounded-xl p-4 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                <div className="flex items-center gap-2 mb-3">
                  <div className="w-10 h-10 rounded-xl bg-[#F5F3E8] flex items-center justify-center">
                    <Wand2 className="w-5 h-5 text-[#162D4D]" />
                  </div>
                  <div>
                    <h3 className="font-semibold text-gray-800">Habit Writer</h3>
                    <p className="text-xs text-gray-400">Turn goals into trackable habits</p>
                  </div>
                </div>
                <input 
                  type="text"
                  value={aiGoal}
                  onChange={(e) => setAiGoal(e.target.value)}
                  placeholder="Read more books..."
                  className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm mb-3"
                />
                <button 
                  onClick={() => callAI('write-habit', aiGoal)}
                  disabled={aiLoading || !aiGoal.trim()}
                  className="w-full bg-[#1E3A5F] text-white py-2 rounded-lg text-sm font-medium hover:bg-[#162D4D] transition-colors disabled:opacity-50 flex items-center justify-center gap-2"
                >
                  {aiLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Wand2 className="w-4 h-4" />}
                  Write Habit
                </button>
              </div>
            </div>

            {/* AI Response */}
            {(aiResponse || aiLoading) && (
              <div className={`rounded-xl p-4 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                <div className="flex items-center gap-2 mb-3">
                  <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-[#1E3A5F] to-[#0F2940] flex items-center justify-center">
                    <Sparkles className="w-4 h-4 text-white" />
                  </div>
                  <h3 className="font-semibold text-gray-800">AI Response</h3>
                  {aiResponse && (
                    <button 
                      onClick={() => { setAiResponse(''); setAiConversation([]); setSuggestedHabits([]); }}
                      className="ml-auto text-xs text-gray-400 hover:text-gray-600"
                    >
                      Clear
                    </button>
                  )}
                </div>
                {aiLoading ? (
                  <div className="flex items-center gap-3 text-gray-500">
                    <Loader2 className="w-5 h-5 animate-spin" />
                    <span>Thinking...</span>
                  </div>
                ) : (
                  <>
                    <div className="text-gray-700 text-sm mb-4">
                      <Markdown>{aiResponse}</Markdown>
                    </div>
                    
                    {/* Suggested Habits with Add Buttons */}
                    {suggestedHabits.length > 0 && (
                      <div className="border-t border-gray-100 pt-4 mt-4">
                        <h4 className="text-sm font-semibold text-gray-800 mb-3 flex items-center gap-2">
                          <Plus className="w-4 h-4" />
                          Quick Add Habits
                        </h4>
                        <div className="space-y-2">
                          {suggestedHabits.map((habit, idx) => (
                            <div key={idx} className={`flex items-center justify-between p-3 rounded-lg ${habit.added ? 'bg-green-50' : 'bg-gray-50'}`}>
                              <div className="flex-1">
                                <p className={`text-sm font-medium ${habit.added ? 'text-green-700' : 'text-gray-800'}`}>
                                  {habit.habit}
                                </p>
                                <p className="text-xs text-gray-500">{habit.target} times</p>
                              </div>
                              {habit.added ? (
                                <span className="flex items-center gap-1 text-green-600 text-sm">
                                  <CheckCircle2 className="w-4 h-4" />
                                  Added!
                                </span>
                              ) : (
                                <button
                                  onClick={() => addSuggestedHabit(habit, idx)}
                                  className="flex items-center gap-1 px-3 py-1.5 bg-[#1E3A5F] text-white rounded-lg text-sm hover:bg-[#162D4D] transition-colors"
                                >
                                  <Plus className="w-3 h-3" />
                                  Add
                                </button>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {/* Follow-up Conversation */}
                    <div className="border-t border-gray-100 pt-4 mt-4">
                      <div className="flex gap-2">
                        <input
                          type="text"
                          value={aiFollowUp}
                          onChange={(e) => setAiFollowUp(e.target.value)}
                          onKeyPress={(e) => e.key === 'Enter' && aiFollowUp.trim() && callAI('follow-up', '', aiFollowUp)}
                          placeholder="Ask a follow-up question..."
                          className="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-[#F5B800]"
                        />
                        <button
                          onClick={() => callAI('follow-up', '', aiFollowUp)}
                          disabled={aiLoading || !aiFollowUp.trim()}
                          className="px-4 py-2 bg-[#1E3A5F] text-white rounded-lg text-sm font-medium hover:bg-[#162D4D] transition-colors disabled:opacity-50 flex items-center gap-2"
                        >
                          <Send className="w-4 h-4" />
                        </button>
                      </div>
                    </div>
                  </>
                )}
              </div>
            )}
          </div>
        )}

        {/* VISION VIEW */}
        {activeView === 'vision' && (
          <div className="space-y-4">
            {/* Vision Hub Header */}
            <div className="bg-gradient-to-r from-[#1E3A5F] via-[#2d4a6f] to-[#1E3A5F] rounded-2xl p-6 text-white relative overflow-hidden">
              <div className="absolute inset-0 opacity-20">
                <div className="absolute top-4 right-4 w-32 h-32 bg-[#F5B800] rounded-full blur-3xl" />
                <div className="absolute bottom-4 left-4 w-24 h-24 bg-white rounded-full blur-2xl" />
              </div>
              <div className="relative">
                <div className="flex items-center gap-3 mb-2">
                  <div className="w-12 h-12 rounded-xl bg-[#F5B800] flex items-center justify-center">
                    <Star className="w-6 h-6 text-[#1E3A5F]" />
                  </div>
                  <div>
                    <h2 className="text-2xl font-bold">Your Journey Hub</h2>
                    <p className="text-[#F5B800]/80 text-sm">Reflect  Dream  Achieve</p>
                  </div>
                </div>
                <p className="text-white/70 text-sm mt-3">Look back at 2025, seal your time capsule, and set your vision for 2026.</p>
              </div>
            </div>

            {/* Three Cards: Reflection, Time Capsule, Vision */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              
              {/* 2025 Reflection Card */}
              <div className={`rounded-2xl p-5 border-2 transition-all ${
                reflectionData 
                  ? 'bg-gradient-to-br from-purple-50 to-indigo-50 border-purple-200' 
                  : 'bg-white border-gray-200 hover:border-purple-300'
              }`}>
                <div className="flex items-center gap-3 mb-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${reflectionData ? 'bg-purple-500' : 'bg-purple-100'}`}>
                    <Eye className={`w-5 h-5 ${reflectionData ? 'text-white' : 'text-purple-500'}`} />
                  </div>
                  <div>
                    <h3 className="font-bold text-gray-800">2025 Reflection</h3>
                    <p className="text-xs text-gray-500">Look back & learn</p>
                  </div>
                </div>
                {reflectionData ? (
                  <div className="space-y-2 mb-4">
                    <div className="bg-white/60 rounded-lg p-2">
                      <p className="text-xs text-gray-500">Word to describe 2025</p>
                      <p className="font-bold text-purple-700">{reflectionData.wordToDescribe2025 || ''}</p>
                    </div>
                    <div className="bg-white/60 rounded-lg p-2">
                      <p className="text-xs text-gray-500">Biggest Win</p>
                      <p className="text-sm text-gray-700 line-clamp-2">{reflectionData.biggestWin || ''}</p>
                    </div>
                  </div>
                ) : (
                  <p className="text-sm text-gray-500 mb-4">Take time to reflect on your 2025 journey - the wins, lessons, and growth.</p>
                )}
                <button
                  onClick={() => { setShowReflectionModal(true); setReflectionSlide(0); }}
                  className={`w-full py-2.5 rounded-xl font-semibold text-sm transition-all ${
                    reflectionData 
                      ? 'bg-purple-100 text-purple-700 hover:bg-purple-200' 
                      : 'bg-purple-500 text-white hover:bg-purple-600'
                  }`}
                >
                  {reflectionData ? 'View/Edit Reflection' : 'Start 2025 Reflection'}
                </button>
              </div>

              {/* Time Capsule Card */}
              <div className={`rounded-2xl p-5 border-2 transition-all relative overflow-hidden ${
                timeCapsuleData 
                  ? 'bg-gradient-to-br from-amber-50 to-orange-50 border-amber-200' 
                  : 'bg-white border-gray-200 hover:border-amber-300'
              }`}>
                {timeCapsuleData && !isEndYearUnlocked && (
                  <div className="absolute top-2 right-2">
                    <div className="px-2 py-1 bg-amber-100 rounded-full flex items-center gap-1">
                      <Lock className="w-3 h-3 text-amber-600" />
                      <span className="text-xs font-medium text-amber-600">Sealed</span>
                    </div>
                  </div>
                )}
                <div className="flex items-center gap-3 mb-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${timeCapsuleData ? 'bg-amber-500' : 'bg-amber-100'}`}>
                    <Gift className={`w-5 h-5 ${timeCapsuleData ? 'text-white' : 'text-amber-500'}`} />
                  </div>
                  <div>
                    <h3 className="font-bold text-gray-800">Time Capsule</h3>
                    <p className="text-xs text-gray-500">Message to future you</p>
                  </div>
                </div>
                {timeCapsuleData ? (
                  <div className="space-y-2 mb-4">
                    <div className="bg-white/60 rounded-lg p-2">
                      <p className="text-xs text-gray-500">Created</p>
                      <p className="text-sm font-medium text-amber-700">{new Date(timeCapsuleData.createdAt).toLocaleDateString()}</p>
                    </div>
                    <div className="bg-white/60 rounded-lg p-2">
                      <p className="text-xs text-gray-500">Unlocks</p>
                      <div className="flex items-center gap-2">
                        <span className={`text-xs px-2 py-0.5 rounded ${isMidYearUnlocked ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>
                          {isMidYearUnlocked ? ' Jul 1' : ' Jul 1'}
                        </span>
                        <span className={`text-xs px-2 py-0.5 rounded ${isEndYearUnlocked ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>
                          {isEndYearUnlocked ? ' Dec 26' : ' Dec 26'}
                        </span>
                      </div>
                    </div>
                  </div>
                ) : (
                  <p className="text-sm text-gray-500 mb-4">Seal a message to your future self. Opens at mid-year and year-end!</p>
                )}
                <button
                  onClick={() => setShowTimeCapsule(true)}
                  className={`w-full py-2.5 rounded-xl font-semibold text-sm transition-all ${
                    timeCapsuleData 
                      ? 'bg-amber-100 text-amber-700 hover:bg-amber-200' 
                      : 'bg-amber-500 text-white hover:bg-amber-600'
                  }`}
                >
                  {timeCapsuleData ? (isEndYearUnlocked ? 'Open Time Capsule' : 'View Sealed Capsule') : 'Create Time Capsule'}
                </button>
              </div>

              {/* 2026 Vision Card */}
              <div className={`rounded-2xl p-5 border-2 transition-all ${
                visionData 
                  ? 'bg-gradient-to-br from-blue-50 to-cyan-50 border-blue-200' 
                  : 'bg-white border-gray-200 hover:border-blue-300'
              }`}>
                <div className="flex items-center gap-3 mb-3">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${visionData ? 'bg-blue-500' : 'bg-blue-100'}`}>
                    <Target className={`w-5 h-5 ${visionData ? 'text-white' : 'text-blue-500'}`} />
                  </div>
                  <div>
                    <h3 className="font-bold text-gray-800">2026 Vision</h3>
                    <p className="text-xs text-gray-500">Set your intentions</p>
                  </div>
                </div>
                {visionData ? (
                  <div className="space-y-2 mb-4">
                    <div className="bg-white/60 rounded-lg p-2">
                      <p className="text-xs text-gray-500">Word of the Year</p>
                      <p className="font-bold text-blue-700">{visionData.wordOfYear || ''}</p>
                    </div>
                    <div className="bg-white/60 rounded-lg p-2">
                      <p className="text-xs text-gray-500">Biggest Goal</p>
                      <p className="text-sm text-gray-700 line-clamp-2">{visionData.biggestGoal || ''}</p>
                    </div>
                  </div>
                ) : (
                  <p className="text-sm text-gray-500 mb-4">Define your word, goals, and non-negotiables for an incredible 2026.</p>
                )}
                <button
                  onClick={() => { setShowVisionWrapped(true); setVisionSlide(0); }}
                  className={`w-full py-2.5 rounded-xl font-semibold text-sm transition-all ${
                    visionData 
                      ? 'bg-blue-100 text-blue-700 hover:bg-blue-200' 
                      : 'bg-blue-500 text-white hover:bg-blue-600'
                  }`}
                >
                  {visionData ? 'View/Edit Vision' : 'Start 2026 Vision'}
                </button>
              </div>
            </div>

            {/* Detailed View: Show selected data if exists */}
            {visionData && (
              <div className="space-y-4">
                {/* Section Header */}
                <div className="flex items-center gap-2 pt-2">
                  <div className="h-px flex-1 bg-gradient-to-r from-transparent via-gray-200 to-transparent" />
                  <span className="text-sm font-medium text-gray-400 px-2">2026 Vision Details</span>
                  <div className="h-px flex-1 bg-gradient-to-r from-transparent via-gray-200 to-transparent" />
                </div>

                {/* Summary Cards */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  {/* Word of Year */}
                  <div className="bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl p-6 text-white">
                    <p className="text-xs uppercase tracking-wider opacity-80 mb-1">Word of the Year</p>
                    <p className="text-3xl font-black uppercase tracking-wide">{visionData.wordOfYear || ''}</p>
                  </div>
                  
                  {/* Biggest Goal */}
                  <div className={`rounded-2xl p-5 border md:col-span-2 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-100'}`}>
                    <div className="flex items-center gap-2 mb-2">
                      <Target className={`w-5 h-5 ${darkMode ? 'text-[#F5B800]' : 'text-[#1E3A5F]'}`} />
                      <p className={`text-xs uppercase tracking-wider ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>Biggest Goal for 2026</p>
                    </div>
                    <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>{visionData.biggestGoal || 'Not set yet'}</p>
                  </div>
                </div>

                {/* Domain Scores */}
                <div className={`rounded-xl p-5 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                  <h3 className={`font-semibold mb-4 flex items-center gap-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    <BarChart3 className={`w-5 h-5 ${darkMode ? 'text-[#F5B800]' : 'text-[#1E3A5F]'}`} />
                    Life Domain Scores
                  </h3>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {[
                      { key: 'fitnessScore', label: 'Fitness', icon: '', color: 'from-green-400 to-emerald-500' },
                      { key: 'businessScore', label: 'Business', icon: '', color: 'from-blue-400 to-indigo-500' },
                      { key: 'financeScore', label: 'Finance', icon: '', color: 'from-yellow-400 to-amber-500' },
                      { key: 'healthScore', label: 'Health', icon: '', color: 'from-red-400 to-rose-500' },
                      { key: 'learningScore', label: 'Learning', icon: '', color: 'from-purple-400 to-violet-500' },
                      { key: 'relationshipsScore', label: 'Relationships', icon: '', color: 'from-pink-400 to-rose-500' },
                      { key: 'spiritualScore', label: 'Spiritual', icon: '', color: 'from-cyan-400 to-teal-500' }
                    ].map(domain => (
                      <div key={domain.key} className="text-center">
                        <div className={`w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br ${domain.color} flex items-center justify-center text-white text-2xl font-bold mb-2`}>
                          {visionData[domain.key] || 5}
                        </div>
                        <p className="text-xs text-gray-600">{domain.icon} {domain.label}</p>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Non-Negotiables */}
                <div className={`rounded-2xl p-5 border ${darkMode ? 'bg-gradient-to-br from-amber-500/10 to-orange-500/10 border-amber-500/30' : 'bg-gradient-to-br from-amber-50 to-orange-50 border-amber-200'}`}>
                  <h3 className={`font-semibold mb-3 flex items-center gap-2 ${darkMode ? 'text-amber-400' : 'text-amber-800'}`}>
                    <Lock className="w-5 h-5" />
                    My 3 Non-Negotiables for 2026
                  </h3>
                  <div className="space-y-2">
                    {[visionData.nonNegotiable1, visionData.nonNegotiable2, visionData.nonNegotiable3].filter(Boolean).map((nn, idx) => (
                      <div key={idx} className={`flex items-center gap-3 p-3 rounded-xl ${darkMode ? 'bg-gray-800/60' : 'bg-white/60'}`}>
                        <div className={`w-8 h-8 rounded-lg flex items-center justify-center font-bold ${darkMode ? 'bg-amber-500/30 text-amber-400' : 'bg-amber-200 text-amber-700'}`}>{idx + 1}</div>
                        <p className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>{nn}</p>
                      </div>
                    ))}
                    {![visionData.nonNegotiable1, visionData.nonNegotiable2, visionData.nonNegotiable3].filter(Boolean).length && (
                      <p className={`text-sm ${darkMode ? 'text-amber-400' : 'text-amber-600'}`}>No non-negotiables set yet</p>
                    )}
                  </div>
                </div>

                {/* Strategy & Support */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className={`rounded-xl p-5 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                    <h3 className={`font-semibold mb-2 flex items-center gap-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                      <Zap className="w-5 h-5 text-purple-500" />
                      My Success Strategy
                    </h3>
                    <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{visionData.overcomeStrategy || 'Not defined yet'}</p>
                  </div>
                  <div className={`rounded-xl p-5 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                    <h3 className={`font-semibold mb-2 flex items-center gap-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                      <Heart className="w-5 h-5 text-red-500" />
                      Accountability Partner
                    </h3>
                    <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{visionData.supportPerson || 'Not set yet'}</p>
                  </div>
                </div>

                {/* Letter to Self Preview */}
                {visionData.letterToSelf && (
                  <div className={`rounded-2xl p-5 border ${darkMode ? 'bg-gradient-to-br from-gray-800 to-gray-900 border-gray-700' : 'bg-gradient-to-br from-gray-50 to-slate-100 border-gray-200'}`}>
                    <h3 className={`font-semibold mb-2 flex items-center gap-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                      <MessageCircle className={`w-5 h-5 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`} />
                      Letter to My Future Self
                    </h3>
                    <p className={`text-sm italic line-clamp-3 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>"{visionData.letterToSelf}"</p>
                  </div>
                )}

                {/* Actions */}
                <div className="flex gap-3 pt-2">
                  <button
                    onClick={() => { setShowVisionWrapped(true); setVisionSlide(0); }}
                    className="flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-[#1E3A5F] text-white rounded-xl font-semibold hover:bg-[#162D4D] transition-colors"
                  >
                    <Edit3 className="w-5 h-5" />
                    Edit My Vision
                  </button>
                  <button
                    onClick={() => { setShowVisionWrapped(true); setVisionSlide(0); }}
                    className="flex items-center justify-center gap-2 px-6 py-3 bg-[#F5B800] text-[#1E3A5F] rounded-xl font-semibold hover:bg-[#e5a800] transition-colors"
                  >
                    <PartyPopper className="w-5 h-5" />
                    Replay Journey
                  </button>
                </div>

                {/* Last Updated */}
                <p className="text-center text-xs text-gray-400">
                  Last updated: {visionData.updatedAt ? new Date(visionData.updatedAt).toLocaleDateString() : 'Never'}
                </p>
              </div>
            )}
          </div>
        )}

        {activeView === 'quotes' && (
          <div className="space-y-4">
            {/* Header */}
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-xl font-bold text-gray-800">Weekly Themes & Quotes</h2>
                <p className="text-sm text-gray-500">Wisdom for the accountability journey</p>
              </div>
              <button
                onClick={() => setShowQuoteModal(true)}
                disabled={quoteLoading}
                className="flex items-center gap-2 px-4 py-2 bg-amber-500 text-white rounded-lg text-sm font-medium hover:bg-amber-600 transition-colors disabled:opacity-50"
              >
                {quoteLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <RefreshCw className="w-4 h-4" />}
                Generate New Quote
              </button>
            </div>

            {/* Quote List */}
            {quotes.length === 0 ? (
              <div className="bg-white rounded-xl p-8 text-center border border-gray-100">
                <Quote className="w-12 h-12 text-amber-300 mx-auto mb-4" />
                <p className="text-gray-500 mb-4">No quotes yet. Generate your first weekly theme!</p>
                <button
                  onClick={() => setShowQuoteModal(true)}
                  disabled={quoteLoading}
                  className="px-4 py-2 bg-amber-500 text-white rounded-lg text-sm font-medium hover:bg-amber-600 transition-colors disabled:opacity-50"
                >
                  {quoteLoading ? 'Generating...' : 'Generate Quote'}
                </button>
              </div>
            ) : (
              <div className="space-y-4">
                {quotes.map((quote, index) => {
                  const isExpanded = selectedQuoteIndex === index || index === 0;
                  const isCurrentWeek = index === 0;
                  
                  return (
                    <div 
                      key={quote.id} 
                      className={`bg-white rounded-xl border overflow-hidden transition-all ${isCurrentWeek ? 'border-amber-300 ring-2 ring-amber-100' : 'border-gray-100'}`}
                    >
                      {/* Collapsed Header - Always visible */}
                      <button
                        onClick={() => setSelectedQuoteIndex(selectedQuoteIndex === index ? -1 : index)}
                        className={`w-full p-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors ${isExpanded ? 'border-b border-gray-100' : ''}`}
                      >
                        <div className="flex items-center gap-4">
                          <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${isCurrentWeek ? 'bg-amber-100' : 'bg-gray-100'}`}>
                            <Quote className={`w-6 h-6 ${isCurrentWeek ? 'text-amber-600' : 'text-gray-400'}`} />
                          </div>
                          <div>
                            <div className="flex items-center gap-2">
                              {isCurrentWeek && (
                                <span className="px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-medium rounded">This Week</span>
                              )}
                              <span className="text-xs text-gray-400">
                                {new Date(quote.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                              </span>
                            </div>
                            <h3 className="text-lg font-bold text-gray-800">
                              {quote.theme || 'Weekly Wisdom'}
                            </h3>
                            <p className="text-sm text-gray-500"> {quote.author}</p>
                          </div>
                        </div>
                        <ChevronDown className={`w-5 h-5 text-gray-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                      </button>
                      
                      {/* Expanded Content */}
                      {isExpanded && (
                        <div className="p-4 md:p-6">
                          <blockquote className="text-lg md:text-xl font-medium text-gray-800 mb-3 italic">
                            "{quote.quote}"
                          </blockquote>
                          
                          <div className="flex items-start justify-between mb-4">
                            <div>
                              <p className="font-semibold text-gray-800">{quote.author}</p>
                              <p className="text-sm text-amber-600">{quote.authorTitle}</p>
                            </div>
                          </div>
                          
                          <p className="text-sm text-gray-600 mb-4">{quote.authorBio}</p>
                          
                          <div className="bg-gray-50 rounded-lg p-4 mb-4">
                            <p className="text-sm font-medium text-gray-700 mb-2">Why It Matters</p>
                            <p className="text-sm text-gray-600">{quote.whyItMatters}</p>
                          </div>
                          
                          {/* Application Layout */}
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div className="bg-[#F5F3E8] rounded-xl p-4">
                              <h4 className="text-sm font-semibold text-[#0F2940] mb-3 flex items-center gap-2">
                                <User className="w-4 h-4" />
                                Personal Application
                              </h4>
                              <ul className="space-y-2">
                                {(Array.isArray(quote.personalApplication) 
                                  ? quote.personalApplication 
                                  : (quote.personalApplication || '').split(/[.]/).filter(s => s.trim())
                                ).map((item, i) => (
                                  <li key={i} className="flex items-start gap-2 text-sm text-gray-700">
                                    <span className="text-[#F5B800] mt-0.5"></span>
                                    <span>{typeof item === 'string' ? item.trim() : item}</span>
                                  </li>
                                ))}
                              </ul>
                            </div>
                            <div className="bg-blue-50 rounded-xl p-4">
                              <h4 className="text-sm font-semibold text-blue-700 mb-3 flex items-center gap-2">
                                <Target className="w-4 h-4" />
                                Business Application
                              </h4>
                              <ul className="space-y-2">
                                {(Array.isArray(quote.businessApplication) 
                                  ? quote.businessApplication 
                                  : (quote.businessApplication || '').split(/[.]/).filter(s => s.trim())
                                ).map((item, i) => (
                                  <li key={i} className="flex items-start gap-2 text-sm text-gray-700">
                                    <span className="text-blue-500 mt-0.5"></span>
                                    <span>{typeof item === 'string' ? item.trim() : item}</span>
                                  </li>
                                ))}
                              </ul>
                            </div>
                          </div>
                          
                          {/* AI Habit Suggestions from Quote */}
                          <div className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4 mb-4">
                            <div className="flex items-center justify-between mb-3">
                              <h4 className="text-sm font-semibold text-purple-800 flex items-center gap-2">
                                <Sparkles className="w-4 h-4" />
                                Apply This Wisdom to Your Habits
                              </h4>
                              <button
                                onClick={() => suggestHabitsFromQuote(quote)}
                                disabled={quoteHabitLoading}
                                className="flex items-center gap-2 px-3 py-1.5 bg-purple-600 text-white rounded-lg text-xs font-medium hover:bg-purple-700 transition-colors disabled:opacity-50"
                              >
                                {quoteHabitLoading ? (
                                  <Loader2 className="w-3 h-3 animate-spin" />
                                ) : (
                                  <Wand2 className="w-3 h-3" />
                                )}
                                Suggest Habits
                              </button>
                            </div>
                            
                            {quoteHabitSuggestions.length > 0 ? (
                              <div className="space-y-2">
                                {quoteHabitSuggestions.map((habit, idx) => (
                                  <div key={idx} className={`flex items-center justify-between p-3 rounded-lg ${habit.added ? 'bg-green-100' : 'bg-white'}`}>
                                    <div className="flex-1">
                                      <p className={`text-sm font-medium ${habit.added ? 'text-green-700' : 'text-gray-800'}`}>
                                        {habit.habit}
                                      </p>
                                      <p className="text-xs text-gray-500">{habit.target} times</p>
                                    </div>
                                    {habit.added ? (
                                      <span className="flex items-center gap-1 text-green-600 text-sm">
                                        <CheckCircle2 className="w-4 h-4" />
                                        Added!
                                      </span>
                                    ) : (
                                      <button
                                        onClick={() => addQuoteHabit(habit, idx)}
                                        className="flex items-center gap-1 px-3 py-1.5 bg-purple-600 text-white rounded-lg text-xs hover:bg-purple-700 transition-colors"
                                      >
                                        <Plus className="w-3 h-3" />
                                        Add Habit
                                      </button>
                                    )}
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <p className="text-sm text-purple-600/70 text-center py-2">
                                Click "Suggest Habits" to get AI-powered habit ideas based on this quote's wisdom
                              </p>
                            )}
                          </div>
                          
                          <div className="flex items-center justify-between pt-4 border-t border-gray-100">
                            <p className="text-sm italic text-gray-500 flex-1 mr-4">"{quote.closingThought}"</p>
                            <div className="flex items-center gap-2">
                              <button
                                onClick={() => downloadQuotePPTX(quote)}
                                className="flex items-center gap-2 px-3 py-1.5 bg-[#F5F3E8] hover:bg-[#EBE6D3] rounded-lg text-sm text-[#1E3A5F] transition-colors"
                              >
                                <Download className="w-4 h-4" />
                                <span className="hidden md:inline">PowerPoint</span>
                              </button>
                              <button
                                onClick={() => deleteQuote(quote.id)}
                                className="flex items-center gap-1 px-3 py-1.5 bg-red-50 hover:bg-red-100 rounded-lg text-sm text-red-600 transition-colors"
                              >
                                <Trash2 className="w-4 h-4" />
                              </button>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        )}

        {/* PROFILE VIEW */}
        {activeView === 'profile' && (
          <div className="max-w-4xl mx-auto space-y-4">
            {/* Profile Header with Photo Upload */}
            <div className="bg-gradient-to-br from-[#1E3A5F] to-[#0F2940] rounded-2xl p-6 text-white">
              <div className="flex flex-col md:flex-row items-center gap-6">
                {/* Profile Photo with Upload */}
                <div className="relative group">
                  {profilePhotoPreview || userProfile?.photoURL || user?.photoURL ? (
                    <img 
                      src={profilePhotoPreview || userProfile?.photoURL || user?.photoURL} 
                      alt="" 
                      className="w-28 h-28 rounded-full border-4 border-gray-600 object-cover" 
                    />
                  ) : (
                    <div className="w-28 h-28 rounded-full bg-white/20 flex items-center justify-center">
                      <User className="w-14 h-14 text-white" />
                    </div>
                  )}
                  <input
                    type="file"
                    ref={profilePhotoRef}
                    onChange={handleProfilePhotoSelect}
                    accept="image/*"
                    className="hidden"
                  />
                  <button
                    onClick={() => profilePhotoRef.current?.click()}
                    className="absolute bottom-0 right-0 w-10 h-10 bg-[#F5B800] rounded-full flex items-center justify-center text-[#1E3A5F] hover:bg-[#E5AB00] transition-colors shadow-lg"
                  >
                    <Camera className="w-5 h-5" />
                  </button>
                </div>
                
                <div className="text-center md:text-left flex-1">
                  <h2 className="text-2xl font-bold">{userProfile?.displayName || user?.displayName || 'Anonymous'}</h2>
                  <p className="text-white/60">{user?.email}</p>
                  {userProfile?.location && (
                    <div className="flex items-center justify-center md:justify-start gap-1 mt-1 text-white/70">
                      <MapPin className="w-4 h-4" />
                      <span className="text-sm">{userProfile.location}</span>
                    </div>
                  )}
                  {userProfile?.linkedParticipant && (
                    <div className="flex items-center justify-center md:justify-start gap-2 mt-3">
                      <span className="px-3 py-1 bg-[#F5B800] text-[#1E3A5F] rounded-lg text-sm font-medium">
                         {userProfile.linkedParticipant}
                      </span>
                    </div>
                  )}
                </div>
                
                {/* Quick Stats */}
                {userProfile?.linkedParticipant && (() => {
                  const myStats = leaderboard.find(l => l.name === userProfile.linkedParticipant);
                  const myStreak = calculateStreaks[userProfile.linkedParticipant] || 0;
                  return myStats ? (
                    <div className="flex gap-4 md:gap-6">
                      <div className="text-center">
                        <p className="text-3xl font-bold text-[#F5B800]">{myStats.rate}%</p>
                        <p className="text-xs text-white/60">Completion</p>
                      </div>
                      <div className="text-center">
                        <p className="text-3xl font-bold text-[#F5B800]">{myStats.score}</p>
                        <p className="text-xs text-white/60">Points</p>
                      </div>
                      <div className="text-center">
                        <p className="text-3xl font-bold text-orange-400">{myStreak}</p>
                        <p className="text-xs text-white/60">Streak</p>
                      </div>
                    </div>
                  ) : null;
                })()}
              </div>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {/* Profile Settings - Left Column */}
              <div className="md:col-span-2 space-y-4">
                <div className={`rounded-xl p-6 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                  <h3 className="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <Edit3 className="w-5 h-5 text-[#1E3A5F]" />
                    Edit Profile
                  </h3>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="text-sm text-gray-600 block mb-1">Display Name</label>
                      <input
                        type="text"
                        value={profileForm.displayName}
                        onChange={(e) => setProfileForm({ ...profileForm, displayName: e.target.value })}
                        placeholder={user?.displayName || 'Your name'}
                        className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-[#F5B800]"
                      />
                    </div>
                    
                    <div>
                      <label className="text-sm text-gray-600 block mb-1">Location</label>
                      <input
                        type="text"
                        value={profileForm.location}
                        onChange={(e) => setProfileForm({ ...profileForm, location: e.target.value })}
                        placeholder="City, Country"
                        className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-[#F5B800]"
                      />
                    </div>
                    
                    <div className="md:col-span-2">
                      <label className="text-sm text-gray-600 block mb-1">Bio</label>
                      <textarea
                        value={profileForm.bio}
                        onChange={(e) => setProfileForm({ ...profileForm, bio: e.target.value })}
                        placeholder="Tell us about yourself..."
                        rows={2}
                        className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-[#F5B800] resize-none"
                      />
                    </div>
                    
                    <div className="md:col-span-2">
                      <label className="text-sm text-gray-600 block mb-1">Goals & Motivations</label>
                      <textarea
                        value={profileForm.goals}
                        onChange={(e) => setProfileForm({ ...profileForm, goals: e.target.value })}
                        placeholder="What are you working towards?"
                        rows={2}
                        className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-[#F5B800] resize-none"
                      />
                    </div>
                    
                    <div className="md:col-span-2">
                      <label className="text-sm text-gray-600 block mb-1">Link to Habit Tracker</label>
                      <div className="flex gap-2">
                        <select
                          value={profileForm.linkedParticipant}
                          onChange={(e) => setProfileForm({ ...profileForm, linkedParticipant: e.target.value })}
                          className="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-[#F5B800]"
                        >
                          <option value="">Not linked</option>
                          {allParticipants.map(p => (
                            <option key={p} value={p}>{p}</option>
                          ))}
                        </select>
                        <button
                          onClick={() => setShowAddParticipant(true)}
                          className="px-3 py-2 bg-[#F5B800] text-[#1E3A5F] rounded-lg text-sm font-medium hover:bg-[#E5AB00] transition-colors"
                        >
                          <Plus className="w-4 h-4" />
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <button
                    onClick={saveProfile}
                    className="w-full mt-4 py-2 bg-[#1E3A5F] text-white rounded-lg font-medium hover:bg-[#162D4D] transition-colors"
                  >
                    Save Profile
                  </button>
                </div>
                
                {/* Active Challenges */}
                <div className={`rounded-xl p-6 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                  <h3 className="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <Swords className="w-5 h-5 text-purple-500" />
                    Active Challenges
                  </h3>
                  {(() => {
                    const myChallenges = bets.filter(b => 
                      (b.status === 'pending' || b.status === 'accepted') &&
                      (b.challenger === userProfile?.linkedParticipant || 
                       (Array.isArray(b.challenged) ? b.challenged.includes(userProfile?.linkedParticipant) : b.challenged === userProfile?.linkedParticipant) ||
                       b.challengerId === user?.uid)
                    );
                    return myChallenges.length > 0 ? (
                      <div className="space-y-3">
                        {myChallenges.map(bet => (
                          <div key={bet.id} className={`p-3 rounded-lg ${bet.status === 'pending' ? 'bg-purple-50 border border-purple-100' : 'bg-yellow-50 border border-yellow-200'}`}>
                            <div className="flex items-center justify-between">
                              <div className="flex items-center gap-2">
                                <span className={`text-xs px-2 py-0.5 rounded ${bet.status === 'pending' ? 'bg-purple-200 text-purple-700' : 'bg-yellow-200 text-yellow-700'}`}>
                                  {bet.status}
                                </span>
                                <span className="font-medium text-gray-800">{bet.challenger} vs {Array.isArray(bet.challenged) ? bet.challenged.join(', ') : bet.challenged}</span>
                              </div>
                            </div>
                            <p className="text-sm text-gray-600 mt-1">{bet.goal}</p>
                            {bet.reward && <p className="text-xs text-gray-500 mt-1"> {bet.reward}</p>}
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-gray-400 text-sm text-center py-4">No active challenges</p>
                    );
                  })()}
                </div>
              </div>
              
              {/* Right Sidebar */}
              <div className="space-y-4">
                {/* Challenge Stats */}
                <div className={`rounded-xl p-4 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                  <h3 className="font-semibold text-gray-800 mb-3 text-sm">Challenge Record</h3>
                  {(() => {
                    const wonChallenges = bets.filter(b => 
                      b.status === 'completed' && 
                      (b.winner === userProfile?.linkedParticipant)
                    ).length;
                    const lostChallenges = bets.filter(b => 
                      b.status === 'completed' && 
                      (b.challenger === userProfile?.linkedParticipant || (Array.isArray(b.challenged) ? b.challenged.includes(userProfile?.linkedParticipant) : b.challenged === userProfile?.linkedParticipant)) &&
                      b.winner !== userProfile?.linkedParticipant
                    ).length;
                    return (
                      <div className="flex items-center justify-around">
                        <div className="text-center">
                          <p className="text-2xl font-bold text-green-600">{wonChallenges}</p>
                          <p className="text-xs text-gray-500">Won</p>
                        </div>
                        <div className="text-center">
                          <p className="text-2xl font-bold text-red-500">{lostChallenges}</p>
                          <p className="text-xs text-gray-500">Lost</p>
                        </div>
                      </div>
                    );
                  })()}
                </div>
                
                {/* Team Members */}
                <div className={`rounded-xl p-4 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                  <h3 className="font-semibold text-gray-800 mb-3 text-sm">Team Members</h3>
                  <div className="space-y-2">
                    {allParticipants.map(p => {
                      const profile = getProfileByParticipant(p);
                      return (
                        <button 
                          key={p}
                          onClick={() => openProfileView(p)}
                          className="w-full flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 transition-colors text-left"
                        >
                          {profile?.photoURL ? (
                            <img src={profile.photoURL} alt="" className="w-8 h-8 rounded-full object-cover" />
                          ) : (
                            <div className="w-8 h-8 rounded-full bg-[#1E3A5F] text-white flex items-center justify-center text-sm font-medium">
                              {p[0]}
                            </div>
                          )}
                          <div className="flex-1 min-w-0">
                            <p className="text-sm font-medium text-gray-800 truncate">{p}</p>
                            {profile?.bio && <p className="text-xs text-gray-400 truncate">{profile.bio}</p>}
                          </div>
                          <Eye className="w-4 h-4 text-gray-300" />
                        </button>
                      );
                    })}
                  </div>
                </div>
                
                {/* Account Actions */}
                <div className={`rounded-xl p-4 border ${darkMode ? "bg-gray-800 border-gray-700" : "bg-white border-gray-100"}`}>
                  <button
                    onClick={handleSignOut}
                    className="w-full flex items-center justify-center gap-2 py-2 bg-red-50 text-red-600 rounded-lg font-medium hover:bg-red-100 transition-colors"
                  >
                    <LogOut className="w-4 h-4" />
                    Sign Out
                  </button>
                </div>
              </div>
            </div>
            
            {/* Add New Participant Modal */}
            {showAddParticipant && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div className={`rounded-2xl p-6 w-full max-w-md ${darkMode ? "bg-gray-800 text-white" : "bg-white"}`}>
                  <h3 className="text-lg font-bold text-gray-800 mb-4">Add New Participant</h3>
                  <p className="text-sm text-gray-500 mb-4">Create a new participant name for the habit tracker</p>
                  
                  <input
                    type="text"
                    value={newParticipantName}
                    onChange={(e) => setNewParticipantName(e.target.value)}
                    placeholder="Enter participant name"
                    className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm mb-4 focus:outline-none focus:border-[#F5B800]"
                  />
                  
                  <div className="flex gap-3">
                    <button
                      onClick={() => { setShowAddParticipant(false); setNewParticipantName(''); }}
                      className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={addNewParticipant}
                      disabled={!newParticipantName.trim()}
                      className="flex-1 py-2 bg-[#1E3A5F] text-white rounded-lg font-medium hover:bg-[#162D4D] disabled:opacity-50"
                    >
                      Add & Link
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}
        
        {/* Profile Viewing Modal - for viewing other participants */}
        {viewingProfile && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div className={`rounded-2xl w-full max-w-2xl my-8 ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
              {/* Modal Header */}
              <div className="bg-gradient-to-br from-[#1E3A5F] to-[#0F2940] rounded-t-2xl p-6 text-white relative">
                <button 
                  onClick={() => setViewingProfile(null)}
                  className="absolute top-4 right-4 w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded-full flex items-center justify-center transition-colors"
                >
                  <X className="w-5 h-5" />
                </button>
                
                <div className="flex items-center gap-4">
                  {viewingProfile.photoURL ? (
                    <img src={viewingProfile.photoURL} alt="" className="w-20 h-20 rounded-full border-4 border-gray-600 object-cover" />
                  ) : (
                    <div className="w-20 h-20 rounded-full bg-white/20 flex items-center justify-center">
                      <span className="text-3xl font-bold">{viewingProfile.participantName?.[0] || '?'}</span>
                    </div>
                  )}
                  <div>
                    <h2 className="text-2xl font-bold">{viewingProfile.displayName || viewingProfile.participantName}</h2>
                    {viewingProfile.location && (
                      <div className="flex items-center gap-1 mt-1 text-white/70">
                        <MapPin className="w-4 h-4" />
                        <span className="text-sm">{viewingProfile.location}</span>
                      </div>
                    )}
                    <div className="flex items-center gap-2 mt-2">
                      <span className="px-3 py-1 bg-[#F5B800] text-[#1E3A5F] rounded-lg text-sm font-medium">
                         {viewingProfile.participantName}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Modal Content */}
              <div className="p-6">
                {/* Stats Row */}
                {(() => {
                  const stats = leaderboard.find(l => l.name === viewingProfile.participantName);
                  const streak = calculateStreaks[viewingProfile.participantName] || 0;
                  return stats ? (
                    <div className="grid grid-cols-4 gap-4 mb-6">
                      <div className="text-center p-3 bg-purple-50 rounded-xl">
                        <p className="text-2xl font-bold text-purple-600">{stats.rate}%</p>
                        <p className="text-xs text-purple-500">Completion</p>
                      </div>
                      <div className="text-center p-3 bg-amber-50 rounded-xl">
                        <p className="text-2xl font-bold text-amber-600">{stats.score}</p>
                        <p className="text-xs text-amber-500">Points</p>
                      </div>
                      <div className="text-center p-3 bg-orange-50 rounded-xl">
                        <p className="text-2xl font-bold text-orange-600">{streak}</p>
                        <p className="text-xs text-orange-500">Streak</p>
                      </div>
                      <div className="text-center p-3 bg-blue-50 rounded-xl">
                        <p className="text-2xl font-bold text-blue-600">#{leaderboard.findIndex(l => l.name === viewingProfile.participantName) + 1}</p>
                        <p className="text-xs text-blue-500">Rank</p>
                      </div>
                    </div>
                  ) : null;
                })()}
                
                {/* Bio */}
                {viewingProfile.bio && (
                  <div className="mb-6">
                    <h4 className={`text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>About</h4>
                    <p className={`text-sm rounded-lg p-3 ${darkMode ? 'text-gray-300 bg-gray-700' : 'text-gray-600 bg-gray-50'}`}>{viewingProfile.bio}</p>
                  </div>
                )}
                
                {/* Goals */}
                {viewingProfile.goals && (
                  <div className="mb-6">
                    <h4 className={`text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Goals & Motivations</h4>
                    <p className={`text-sm rounded-lg p-3 ${darkMode ? 'text-gray-300 bg-gray-700' : 'text-gray-600 bg-gray-50'}`}>{viewingProfile.goals}</p>
                  </div>
                )}
                
                {/* Active Challenges */}
                <div className="mb-6">
                  <h4 className={`text-sm font-semibold mb-2 ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>Active Challenges</h4>
                  {(() => {
                    const theirChallenges = bets.filter(b => 
                      (b.status === 'pending' || b.status === 'accepted') &&
                      (b.challenger === viewingProfile.participantName || (Array.isArray(b.challenged) ? b.challenged.includes(viewingProfile.participantName) : b.challenged === viewingProfile.participantName))
                    );
                    return theirChallenges.length > 0 ? (
                      <div className="space-y-2">
                        {theirChallenges.map(bet => (
                          <div key={bet.id} className={`p-3 rounded-lg text-sm ${darkMode ? 'bg-purple-500/20' : 'bg-purple-50'}`}>
                            <div className="flex items-center gap-2">
                              <Swords className="w-4 h-4 text-purple-500" />
                              <span className={`font-medium ${darkMode ? 'text-white' : ''}`}>{bet.challenger}</span>
                              <span className="text-gray-400">vs</span>
                              <span className={`font-medium ${darkMode ? 'text-white' : ''}`}>{Array.isArray(bet.challenged) ? bet.challenged.join(', ') : bet.challenged}</span>
                            </div>
                            <p className={`mt-1 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>{bet.goal}</p>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-gray-400 text-sm">No active challenges</p>
                    );
                  })()}
                </div>
                
                {/* Challenge Record */}
                <div>
                  <h4 className="text-sm font-semibold text-gray-700 mb-2">Challenge Record</h4>
                  {(() => {
                    const won = bets.filter(b => b.status === 'completed' && b.winner === viewingProfile.participantName).length;
                    const lost = bets.filter(b => 
                      b.status === 'completed' && 
                      (b.challenger === viewingProfile.participantName || (Array.isArray(b.challenged) ? b.challenged.includes(viewingProfile.participantName) : b.challenged === viewingProfile.participantName)) &&
                      b.winner !== viewingProfile.participantName
                    ).length;
                    return (
                      <div className="flex items-center gap-4">
                        <div className="flex items-center gap-2 px-4 py-2 bg-green-50 rounded-lg">
                          <Trophy className="w-4 h-4 text-green-600" />
                          <span className="font-bold text-green-600">{won}</span>
                          <span className="text-sm text-green-600">Won</span>
                        </div>
                        <div className="flex items-center gap-2 px-4 py-2 bg-red-50 rounded-lg">
                          <XCircle className="w-4 h-4 text-red-500" />
                          <span className="font-bold text-red-500">{lost}</span>
                          <span className="text-sm text-red-500">Lost</span>
                        </div>
                      </div>
                    );
                  })()}
                </div>
                
                {/* Challenge Button */}
                {viewingProfile.participantName !== userProfile?.linkedParticipant && (
                  <button
                    onClick={() => {
                      setViewingProfile(null);
                      setNewBet({ ...newBet, challenged: viewingProfile.participantName });
                      setShowNewBet(true);
                      setActiveView('compete');
                    }}
                    className="w-full mt-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-medium hover:opacity-90 transition-opacity flex items-center justify-center gap-2"
                  >
                    <Swords className="w-5 h-5" />
                    Challenge {viewingProfile.participantName}
                  </button>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Add Task Modal */}
        {showAddTask && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className={`rounded-2xl p-6 w-full max-w-md ${darkMode ? "bg-gray-800 text-white" : "bg-white"}`}>
              <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <Target className="w-5 h-5 text-[#1E3A5F]" />
                Add New Task
              </h3>
              
              <div className="space-y-4">
                <div>
                  <label className="text-sm text-gray-600 block mb-1">Task</label>
                  <input
                    type="text"
                    value={newTask.task}
                    onChange={(e) => setNewTask({ ...newTask, task: e.target.value })}
                    placeholder="What needs to be done?"
                    className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-[#F5B800]"
                  />
                </div>
                
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="text-sm text-gray-600 block mb-1">Due Date</label>
                    <input
                      type="date"
                      value={newTask.dueDate}
                      onChange={(e) => setNewTask({ ...newTask, dueDate: e.target.value })}
                      className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm"
                    />
                  </div>
                  <div>
                    <label className="text-sm text-gray-600 block mb-1">Priority</label>
                    <select
                      value={newTask.priority}
                      onChange={(e) => setNewTask({ ...newTask, priority: e.target.value })}
                      className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm"
                    >
                      <option value="High"> High</option>
                      <option value="Medium"> Medium</option>
                      <option value="Low"> Low</option>
                      <option value="Optional"> Optional</option>
                    </select>
                  </div>
                </div>
                
                <div>
                  <label className="text-sm text-gray-600 block mb-1">Category</label>
                  <div className="grid grid-cols-3 gap-2">
                    {TASK_CATEGORIES.map(cat => (
                      <button
                        key={cat.id}
                        onClick={() => setNewTask({ ...newTask, category: cat.id })}
                        className={`p-2 rounded-lg text-sm font-medium flex items-center justify-center gap-1 ${newTask.category === cat.id ? cat.color + ' ring-2 ring-offset-1' : 'bg-gray-50 text-gray-600'}`}
                      >
                        {cat.icon} {cat.id}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
              
              <div className="flex gap-3 mt-6">
                <button 
                  onClick={() => { setShowAddTask(false); setNewTask({ task: '', dueDate: '', priority: 'Medium', category: 'Work' }); }}
                  className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200"
                >
                  Cancel
                </button>
                <button 
                  onClick={addTask}
                  disabled={!newTask.task.trim()}
                  className="flex-1 py-2 bg-[#1E3A5F] text-white rounded-lg font-medium hover:bg-[#162D4D] disabled:opacity-50"
                >
                  Add Task
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Non-Negotiables Modal */}
        {showNonNegotiableModal && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className={`rounded-2xl p-6 w-full max-w-md ${darkMode ? "bg-gray-800 text-white" : "bg-white"}`}>
              <h3 className="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                <Lock className="w-5 h-5 text-amber-600" />
                Add Non-Negotiable Habit
              </h3>
              <p className="text-sm text-gray-500 mb-4">
                Non-negotiables are your 3 core habits that you commit to doing no matter what. These persist across all weeks.
              </p>
              
              <div className="space-y-4">
                <div>
                  <label className="text-sm text-gray-600 block mb-1">Habit Name *</label>
                  <input
                    type="text"
                    value={newNonNegotiable.habit}
                    onChange={(e) => setNewNonNegotiable({ ...newNonNegotiable, habit: e.target.value })}
                    placeholder="e.g., Morning meditation, Exercise, Reading"
                    className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-amber-500"
                  />
                </div>
                
                <div>
                  <label className="text-sm text-gray-600 block mb-1">Why is this important?</label>
                  <textarea
                    value={newNonNegotiable.description}
                    onChange={(e) => setNewNonNegotiable({ ...newNonNegotiable, description: e.target.value })}
                    placeholder="Remind yourself why this matters..."
                    rows={2}
                    className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-amber-500 resize-none"
                  />
                </div>
                
                <div>
                  <label className="text-sm text-gray-600 block mb-1">Frequency</label>
                  <div className="grid grid-cols-3 gap-2">
                    {['Daily', 'Weekdays', 'Weekly'].map(freq => (
                      <button
                        key={freq}
                        onClick={() => setNewNonNegotiable({ ...newNonNegotiable, frequency: freq })}
                        className={`p-2 rounded-lg text-sm font-medium transition-colors ${
                          newNonNegotiable.frequency === freq 
                            ? 'bg-amber-100 text-amber-700 ring-2 ring-amber-300' 
                            : 'bg-gray-50 text-gray-600 hover:bg-gray-100'
                        }`}
                      >
                        {freq}
                      </button>
                    ))}
                  </div>
                </div>
                
                {/* Show existing non-negotiables */}
                {nonNegotiables.filter(n => n.userId === user?.uid).length > 0 && (
                  <div className="pt-3 border-t border-gray-100">
                    <p className="text-xs text-gray-500 mb-2">Your current non-negotiables ({nonNegotiables.filter(n => n.userId === user?.uid).length}/3):</p>
                    <div className="space-y-1">
                      {nonNegotiables.filter(n => n.userId === user?.uid).map((nn, idx) => (
                        <div key={nn.id} className="flex items-center gap-2 text-sm text-gray-600">
                          <span className="w-5 h-5 rounded bg-amber-100 text-amber-700 flex items-center justify-center text-xs font-bold">{idx + 1}</span>
                          {nn.habit}
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
              
              <div className="flex gap-3 mt-6">
                <button 
                  onClick={() => { setShowNonNegotiableModal(false); setNewNonNegotiable({ habit: '', description: '', frequency: 'Daily' }); }}
                  className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200"
                >
                  Cancel
                </button>
                <button 
                  onClick={saveNonNegotiable}
                  disabled={!newNonNegotiable.habit.trim() || nonNegotiables.filter(n => n.userId === user?.uid).length >= 3}
                  className="flex-1 py-2 bg-amber-500 text-white rounded-lg font-medium hover:bg-amber-600 disabled:opacity-50 flex items-center justify-center gap-2"
                >
                  <Lock className="w-4 h-4" />
                  Lock In Habit
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Mood Modal */}
        {showMoodModal && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className={`rounded-2xl p-6 w-full max-w-md ${darkMode ? "bg-gray-800 text-white" : "bg-white"}`}>
              <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <Heart className="w-5 h-5 text-purple-500" />
                Log Today's Mood
              </h3>
              
              <div className="space-y-6">
                <div>
                  <label className="text-sm text-gray-600 block mb-2">How's your mood today? ({todayMood.mood}/10)</label>
                  <input
                    type="range"
                    min="1"
                    max="10"
                    value={todayMood.mood}
                    onChange={(e) => setTodayMood({ ...todayMood, mood: parseInt(e.target.value) })}
                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-500"
                  />
                  <div className="flex justify-between text-xs text-gray-400 mt-1">
                    <span> Low</span>
                    <span> Great</span>
                  </div>
                </div>
                
                <div>
                  <label className="text-sm text-gray-600 block mb-2">Motivation level? ({todayMood.motivation}/10)</label>
                  <input
                    type="range"
                    min="1"
                    max="10"
                    value={todayMood.motivation}
                    onChange={(e) => setTodayMood({ ...todayMood, motivation: parseInt(e.target.value) })}
                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-pink-500"
                  />
                  <div className="flex justify-between text-xs text-gray-400 mt-1">
                    <span> Low</span>
                    <span> High</span>
                  </div>
                </div>
                
                <div>
                  <label className="text-sm text-gray-600 block mb-1">Notes (optional)</label>
                  <textarea
                    value={todayMood.notes}
                    onChange={(e) => setTodayMood({ ...todayMood, notes: e.target.value })}
                    placeholder="How are you feeling? Any wins or challenges today?"
                    className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm h-20 resize-none"
                  />
                </div>
              </div>
              
              <div className="flex gap-3 mt-6">
                <button 
                  onClick={() => { setShowMoodModal(false); setTodayMood({ mood: 5, motivation: 5, notes: '' }); }}
                  className="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200"
                >
                  Cancel
                </button>
                <button 
                  onClick={saveMood}
                  className="flex-1 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:opacity-90"
                >
                  Save Mood
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Vision Wrapped Full-Screen Experience - Spotify Style */}
        {showVisionWrapped && (
          <div className="fixed inset-0 z-[100] bg-[#0d1321] overflow-hidden">
            {/* Animated Background */}
            <div className="absolute inset-0">
              <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-[#1E3A5F]/50 via-transparent to-[#F5B800]/20 animate-pulse" style={{ animationDuration: '4s' }} />
              <div className="absolute top-1/4 -left-20 w-96 h-96 bg-[#F5B800]/20 rounded-full blur-3xl animate-pulse" style={{ animationDuration: '6s' }} />
              <div className="absolute bottom-1/4 -right-20 w-80 h-80 bg-[#1E3A5F]/40 rounded-full blur-3xl animate-pulse" style={{ animationDuration: '5s' }} />
              <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-gradient-radial from-[#F5B800]/5 to-transparent rounded-full" />
            </div>
            
            {/* Progress Dots */}
            <div className="absolute top-4 left-1/2 -translate-x-1/2 z-20 flex gap-1.5">
              {Array.from({ length: 18 }).map((_, i) => (
                <button
                  key={i}
                  onClick={() => setVisionSlide(i)}
                  className={`h-1.5 rounded-full transition-all duration-300 ${
                    i === visionSlide ? 'w-6 bg-[#F5B800]' : i < visionSlide ? 'w-1.5 bg-[#F5B800]/60' : 'w-1.5 bg-white/30'
                  }`}
                />
              ))}
            </div>

            {/* Close Button */}
            <button
              onClick={() => setShowVisionWrapped(false)}
              className="absolute top-4 right-4 z-20 w-10 h-10 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center transition-colors"
            >
              <X className="w-5 h-5 text-white" />
            </button>

            {/* Slide Container */}
            <div className="h-full flex flex-col items-center justify-center p-6 md:p-12 relative z-10">
              
              {/* ==================== REVIEW SLIDES (0-9) ==================== */}
              
              {/* Slide 0: Welcome - Your Wrapped is Here! */}
              {visionSlide === 0 && (
                <div className="text-center max-w-2xl animate-fade-in">
                  <div className="relative mb-8">
                    <div className="w-32 h-32 mx-auto rounded-3xl bg-gradient-to-br from-[#F5B800] to-amber-500 flex items-center justify-center transform rotate-12 shadow-2xl shadow-amber-500/30">
                      <PartyPopper className="w-16 h-16 text-[#1E3A5F] transform -rotate-12" />
                    </div>
                    <div className="absolute -top-4 -right-4 w-12 h-12 bg-green-500 rounded-full flex items-center justify-center animate-bounce">
                      <span className="text-2xl"></span>
                    </div>
                  </div>
                  <p className="text-[#F5B800] text-sm uppercase tracking-[0.3em] mb-4 font-bold">It's finally here</p>
                  <h1 className="text-5xl md:text-7xl font-black text-white mb-4">
                    Your 2025
                  </h1>
                  <h1 className="text-5xl md:text-7xl font-black bg-gradient-to-r from-[#F5B800] to-amber-400 bg-clip-text text-transparent mb-6">
                    WRAPPED
                  </h1>
                  <p className="text-xl text-white/60 mb-2">
                    Let's celebrate how far you've come.
                  </p>
                  <p className="text-white/40 text-sm">
                    {wrappedStats?.totalWeeks || 0} weeks of grinding. {wrappedStats?.totalDaysCompleted || 0} days of progress.
                  </p>
                </div>
              )}

              {/* Slide 1: The Big Numbers */}
              {visionSlide === 1 && wrappedStats && (
                <div className="text-center max-w-3xl animate-fade-in">
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-6">Your year in numbers</p>
                  <div className="grid grid-cols-2 gap-6 mb-8">
                    <div className="bg-gray-800 backdrop-blur-sm rounded-3xl p-6 border border-gray-600">
                      <p className="text-6xl md:text-8xl font-black bg-gradient-to-r from-green-400 to-emerald-500 bg-clip-text text-transparent">
                        {wrappedStats.totalHabitsTracked}
                      </p>
                      <p className="text-white/60 mt-2">habits tracked</p>
                    </div>
                    <div className="bg-gray-800 backdrop-blur-sm rounded-3xl p-6 border border-gray-600">
                      <p className="text-6xl md:text-8xl font-black bg-gradient-to-r from-blue-400 to-cyan-500 bg-clip-text text-transparent">
                        {wrappedStats.totalDaysCompleted}
                      </p>
                      <p className="text-white/60 mt-2">days completed</p>
                    </div>
                    <div className="bg-gray-800 backdrop-blur-sm rounded-3xl p-6 border border-gray-600">
                      <p className="text-6xl md:text-8xl font-black bg-gradient-to-r from-purple-400 to-violet-500 bg-clip-text text-transparent">
                        {wrappedStats.totalWeeks}
                      </p>
                      <p className="text-white/60 mt-2">weeks strong</p>
                    </div>
                    <div className="bg-gray-800 backdrop-blur-sm rounded-3xl p-6 border border-gray-600">
                      <p className="text-6xl md:text-8xl font-black bg-gradient-to-r from-[#F5B800] to-amber-500 bg-clip-text text-transparent">
                        {wrappedStats.overallCompletionRate}%
                      </p>
                      <p className="text-white/60 mt-2">completion rate</p>
                    </div>
                  </div>
                  <p className="text-white/40 text-sm">That's {wrappedStats.totalDaysCompleted} moments you chose discipline over comfort </p>
                </div>
              )}

              {/* Slide 2: Your #1 Habit - The Champion */}
              {visionSlide === 2 && wrappedStats?.topHabit && (
                <div className="text-center max-w-2xl animate-fade-in">
                  <div className="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-yellow-400 to-amber-500 flex items-center justify-center shadow-2xl shadow-amber-500/30">
                    <Crown className="w-12 h-12 text-[#1E3A5F]" />
                  </div>
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-4">Your #1 Habit</p>
                  <h2 className="text-3xl md:text-5xl font-black text-white mb-4">
                    "{wrappedStats.topHabit.name}"
                  </h2>
                  <div className="bg-gradient-to-r from-green-500/20 to-emerald-500/20 backdrop-blur-sm rounded-2xl p-8 border border-green-500/30 mb-6">
                    <p className="text-7xl md:text-9xl font-black bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text text-transparent">
                      {wrappedStats.topHabit.rate}%
                    </p>
                    <p className="text-green-400 mt-2 font-medium">completion rate</p>
                  </div>
                  <p className="text-white/60">
                    You tracked this {wrappedStats.topHabit.weeks} times and crushed it {wrappedStats.topHabit.completed} days!
                  </p>
                  <p className="text-white/40 text-sm mt-4">This is your signature move </p>
                </div>
              )}

              {/* Slide 3: The Struggle Habit */}
              {visionSlide === 3 && wrappedStats?.worstHabit && wrappedStats.worstHabit !== wrappedStats.topHabit && (
                <div className="text-center max-w-2xl animate-fade-in">
                  <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-br from-orange-400/50 to-red-500/50 flex items-center justify-center">
                    <Target className="w-10 h-10 text-white/80" />
                  </div>
                  <p className="text-orange-400 text-sm uppercase tracking-widest mb-4">Your Growth Opportunity</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-4">
                    "{wrappedStats.worstHabit.name}"
                  </h2>
                  <div className="bg-gray-800 backdrop-blur-sm rounded-2xl p-6 border border-gray-600 mb-6">
                    <p className="text-5xl md:text-6xl font-black text-orange-400">
                      {wrappedStats.worstHabit.rate}%
                    </p>
                    <p className="text-white/40 mt-2">completion rate</p>
                  </div>
                  <p className="text-white/60 mb-4">
                    This one challenged you the most - and that's okay!
                  </p>
                  <div className="bg-gradient-to-r from-[#1E3A5F] to-[#2d4a6f] rounded-xl p-4 inline-block">
                    <p className="text-[#F5B800] font-medium"> 2026 Focus Area?</p>
                  </div>
                </div>
              )}

              {/* Slide 3 Alt: If top and worst are same, show all habits */}
              {visionSlide === 3 && wrappedStats?.worstHabit && wrappedStats.worstHabit === wrappedStats.topHabit && (
                <div className="text-center max-w-2xl animate-fade-in">
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-4">Consistency King </p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-6">
                    All your habits performed similarly!
                  </h2>
                  <p className="text-white/60 mb-4">
                    That's the sign of a well-balanced approach.
                  </p>
                </div>
              )}

              {/* Slide 4: Best Week Ever */}
              {visionSlide === 4 && wrappedStats?.bestWeek && (
                <div className="text-center max-w-2xl animate-fade-in">
                  <div className="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center shadow-2xl shadow-purple-500/30">
                    <Flame className="w-12 h-12 text-white" />
                  </div>
                  <p className="text-purple-400 text-sm uppercase tracking-widest mb-4">Your Best Week</p>
                  <h2 className="text-3xl md:text-5xl font-black text-white mb-2">
                    Week of {new Date(wrappedStats.bestWeek.week).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                  </h2>
                  <div className="bg-gradient-to-r from-purple-500/20 to-pink-500/20 backdrop-blur-sm rounded-2xl p-8 border border-purple-500/30 my-6">
                    <p className="text-7xl md:text-8xl font-black bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                      {wrappedStats.bestWeek.rate}%
                    </p>
                    <p className="text-purple-300 mt-2">completion rate</p>
                  </div>
                  <p className="text-white/60">
                    {wrappedStats.bestWeek.completed}/{wrappedStats.bestWeek.target} habits completed across {wrappedStats.bestWeek.habitCount} goals
                  </p>
                  {wrappedStats.perfectWeeks > 0 && (
                    <p className="text-[#F5B800] mt-4 font-medium">
                       You had {wrappedStats.perfectWeeks} PERFECT week{wrappedStats.perfectWeeks > 1 ? 's' : ''}!
                    </p>
                  )}
                </div>
              )}

              {/* Slide 5: Category Breakdown */}
              {visionSlide === 5 && wrappedStats?.categoryRankings?.length > 0 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-4">Where You Focused</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-8">
                    Your Life Categories
                  </h2>
                  <div className="space-y-3 max-w-md mx-auto">
                    {wrappedStats.categoryRankings.slice(0, 5).map((cat, idx) => {
                      const colors = [
                        'from-[#F5B800] to-amber-500',
                        'from-blue-400 to-cyan-500',
                        'from-green-400 to-emerald-500',
                        'from-purple-400 to-violet-500',
                        'from-pink-400 to-rose-500'
                      ];
                      const icons = { fitness: '', health: '', business: '', finance: '', learning: '', mindfulness: '', social: '', discipline: '' };
                      return (
                        <div key={cat.name} className="bg-gray-800 backdrop-blur-sm rounded-xl p-4 border border-gray-600">
                          <div className="flex items-center justify-between mb-2">
                            <span className="text-white font-medium flex items-center gap-2">
                              <span className="text-xl">{icons[cat.name] || ''}</span>
                              <span className="capitalize">{cat.name}</span>
                            </span>
                            <span className="text-white/60 text-sm">{cat.count} habits</span>
                          </div>
                          <div className="h-3 bg-gray-700 rounded-full overflow-hidden">
                            <div 
                              className={`h-full bg-gradient-to-r ${colors[idx]} rounded-full transition-all duration-1000`}
                              style={{ width: `${(cat.count / wrappedStats.categoryRankings[0].count) * 100}%` }}
                            />
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  {wrappedStats.topCategory && (
                    <p className="text-white/40 text-sm mt-6">
                      {wrappedStats.topCategory.name.charAt(0).toUpperCase() + wrappedStats.topCategory.name.slice(1)} was your main focus area!
                    </p>
                  )}
                </div>
              )}

              {/* Slide 6: Streak Stats */}
              {visionSlide === 6 && wrappedStats && (
                <div className="text-center max-w-2xl animate-fade-in">
                  <div className="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center shadow-2xl shadow-orange-500/30 animate-pulse">
                    <Flame className="w-14 h-14 text-white" />
                  </div>
                  <p className="text-orange-400 text-sm uppercase tracking-widest mb-4">Streak Master</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-8">
                    Your Consistency Game
                  </h2>
                  <div className="grid grid-cols-2 gap-6">
                    <div className="bg-gradient-to-br from-orange-500/20 to-red-500/20 backdrop-blur-sm rounded-2xl p-6 border border-orange-500/30">
                      <p className="text-6xl md:text-7xl font-black text-orange-400">
                        {wrappedStats.longestStreak}
                      </p>
                      <p className="text-white/60 mt-2">longest streak</p>
                      <p className="text-white/40 text-sm">weeks of 70%+</p>
                    </div>
                    <div className="bg-gradient-to-br from-green-500/20 to-emerald-500/20 backdrop-blur-sm rounded-2xl p-6 border border-green-500/30">
                      <p className="text-6xl md:text-7xl font-black text-green-400">
                        {wrappedStats.currentStreak}
                      </p>
                      <p className="text-white/60 mt-2">current streak</p>
                      <p className="text-white/40 text-sm">and counting!</p>
                    </div>
                  </div>
                  {wrappedStats.longestStreak >= 4 && (
                    <p className="text-[#F5B800] mt-6 font-medium">
                       A {wrappedStats.longestStreak}-week streak? That's elite-level consistency!
                    </p>
                  )}
                </div>
              )}

              {/* Slide 7: Fun Facts */}
              {visionSlide === 7 && wrappedStats?.funFacts?.length > 0 && (
                <div className="text-center max-w-2xl animate-fade-in">
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-4">Fun Facts</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-8">
                    Did You Know?
                  </h2>
                  <div className="space-y-4">
                    {wrappedStats.funFacts.slice(0, 4).map((fact, idx) => (
                      <div 
                        key={idx} 
                        className="bg-gray-800 backdrop-blur-sm rounded-xl p-5 border border-gray-600 text-left"
                        style={{ animationDelay: `${idx * 0.2}s` }}
                      >
                        <p className="text-white/90 text-lg">{fact}</p>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Slide 8: Group Comparison */}
              {visionSlide === 8 && wrappedStats?.groupStats?.length > 1 && (
                <div className="text-center max-w-2xl animate-fade-in">
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-4">Squad Goals</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-2">
                    The Accountability Group
                  </h2>
                  <p className="text-white/40 mb-8">How everyone stacked up</p>
                  <div className="space-y-4">
                    {wrappedStats.groupStats.map((member, idx) => {
                      const isMe = member.name === wrappedStats.myParticipantName;
                      const medals = ['', '', ''];
                      return (
                        <div 
                          key={member.name}
                          className={`rounded-xl p-4 border transition-all ${
                            isMe 
                              ? 'bg-gradient-to-r from-[#F5B800]/20 to-amber-500/20 border-[#F5B800]/50' 
                              : 'bg-gray-800 border-gray-600'
                          }`}
                        >
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                              <span className="text-2xl">{medals[idx] || ''}</span>
                              <div className="text-left">
                                <p className={`font-bold ${isMe ? 'text-[#F5B800]' : 'text-white'}`}>
                                  {member.name} {isMe && '(You!)'}
                                </p>
                                <p className="text-white/40 text-sm">{member.totalHabits} habits tracked</p>
                              </div>
                            </div>
                            <div className="text-right">
                              <p className={`text-3xl font-black ${isMe ? 'text-[#F5B800]' : 'text-white'}`}>
                                {member.rate}%
                              </p>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  {wrappedStats.myRank === 1 && (
                    <p className="text-[#F5B800] mt-6 font-medium"> You led the pack! Champion status!</p>
                  )}
                </div>
              )}

              {/* Slide 9: Your Grade - The Big Reveal */}
              {visionSlide === 9 && wrappedStats && (
                <div className="text-center max-w-2xl animate-fade-in">
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-6">Your 2025 Performance</p>
                  <div className="relative mb-8">
                    <div className="w-48 h-48 mx-auto rounded-full bg-gradient-to-br from-[#1E3A5F] to-[#2d4a6f] flex items-center justify-center border-4 border-[#F5B800] shadow-2xl shadow-[#F5B800]/20">
                      <div className="text-center">
                        <p className="text-7xl font-black text-[#F5B800]">{wrappedStats.grade}</p>
                        <p className="text-4xl">{wrappedStats.gradeEmoji}</p>
                      </div>
                    </div>
                  </div>
                  <h2 className="text-2xl md:text-3xl font-bold text-white mb-4">
                    {wrappedStats.gradeMessage}
                  </h2>
                  <div className="bg-gray-800 backdrop-blur-sm rounded-xl p-6 border border-gray-600 mt-6">
                    <div className="grid grid-cols-3 gap-4 text-center">
                      <div>
                        <p className="text-2xl font-bold text-[#F5B800]">{wrappedStats.overallCompletionRate}%</p>
                        <p className="text-white/40 text-xs">Overall Rate</p>
                      </div>
                      <div>
                        <p className="text-2xl font-bold text-green-400">{wrappedStats.perfectWeeks}</p>
                        <p className="text-white/40 text-xs">Perfect Weeks</p>
                      </div>
                      <div>
                        <p className="text-2xl font-bold text-orange-400">{wrappedStats.longestStreak}</p>
                        <p className="text-white/40 text-xs">Best Streak</p>
                      </div>
                    </div>
                  </div>
                  <p className="text-white/40 text-sm mt-6">Now let's make 2026 even better! </p>
                </div>
              )}

              {/* ==================== VISION SLIDES (10-17) ==================== */}

              {/* Slide 10: Transition to 2026 */}
              {visionSlide === 10 && (
                <div className="text-center max-w-2xl animate-fade-in">
                  <div className="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-[#F5B800] to-amber-500 flex items-center justify-center">
                    <Sparkles className="w-12 h-12 text-[#1E3A5F]" />
                  </div>
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-4">Part 2</p>
                  <h1 className="text-4xl md:text-6xl font-black text-white mb-4">
                    Your 2026 Vision
                  </h1>
                  <p className="text-xl text-white/60 mb-8">
                    Let's set powerful intentions for the year ahead.
                  </p>
                  <p className="text-white/40 text-sm">This takes about 3 minutes</p>
                </div>
              )}

              {/* Slide 11: Word of Year */}
              {visionSlide === 11 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-4">Define Your Year</p>
                  <h2 className="text-3xl md:text-5xl font-bold text-white mb-6">
                    Choose Your Word of the Year
                  </h2>
                  <p className="text-white/60 mb-8">One word that will guide your decisions and actions in 2026.</p>
                  <input
                    type="text"
                    value={visionAnswers.wordOfYear}
                    onChange={(e) => setVisionAnswers({ ...visionAnswers, wordOfYear: e.target.value.toUpperCase() })}
                    placeholder="e.g., DISCIPLINE, GROWTH, BALANCE"
                    className="w-full max-w-md mx-auto block bg-gray-700 border-2 border-gray-600 focus:border-[#F5B800] rounded-xl px-6 py-4 text-2xl text-white text-center uppercase tracking-widest placeholder:text-white/30 outline-none transition-colors"
                    maxLength={20}
                  />
                  <div className="flex flex-wrap justify-center gap-2 mt-6">
                    {['FOCUS', 'STRENGTH', 'DISCIPLINE', 'GROWTH', 'BALANCE', 'FREEDOM', 'IMPACT', 'CONSISTENCY'].map(word => (
                      <button
                        key={word}
                        onClick={() => setVisionAnswers({ ...visionAnswers, wordOfYear: word })}
                        className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${
                          visionAnswers.wordOfYear === word 
                            ? 'bg-[#F5B800] text-[#1E3A5F]' 
                            : 'bg-gray-700 text-white/70 hover:bg-gray-600'
                        }`}
                      >
                        {word}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {/* Slide 12: Biggest Goal */}
              {visionSlide === 12 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-4">Your Mission</p>
                  <h2 className="text-3xl md:text-5xl font-bold text-white mb-6">
                    What's Your #1 Goal for 2026?
                  </h2>
                  <p className="text-white/60 mb-8">If you could only accomplish one thing this year, what would it be?</p>
                  <textarea
                    value={visionAnswers.biggestGoal}
                    onChange={(e) => setVisionAnswers({ ...visionAnswers, biggestGoal: e.target.value })}
                    placeholder="Describe your biggest goal in detail..."
                    className="w-full max-w-lg mx-auto block bg-gray-700 border-2 border-gray-600 focus:border-[#F5B800] rounded-xl px-6 py-4 text-lg text-white placeholder:text-white/30 outline-none transition-colors resize-none h-32"
                  />
                </div>
              )}

              {/* Slide 13: Domain Scores */}
              {visionSlide === 13 && (
                <div className="text-center max-w-3xl animate-fade-in w-full">
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-4">2026 Life Assessment</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-6">
                    Where Do You Want To Be?
                  </h2>
                  <p className="text-white/60 mb-8">Rate your target satisfaction in each area for 2026 (1-10)</p>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
                    {[
                      { key: 'fitnessScore', label: 'Fitness', icon: '' },
                      { key: 'businessScore', label: 'Business/Career', icon: '' },
                      { key: 'financeScore', label: 'Finance', icon: '' },
                      { key: 'healthScore', label: 'Health', icon: '' },
                      { key: 'learningScore', label: 'Learning', icon: '' },
                      { key: 'relationshipsScore', label: 'Relationships', icon: '' },
                      { key: 'spiritualScore', label: 'Spiritual', icon: '' }
                    ].map(domain => (
                      <div key={domain.key} className="bg-gray-800 rounded-xl p-4">
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-white font-medium">{domain.icon} {domain.label}</span>
                          <span className="text-[#F5B800] font-bold text-xl">{visionAnswers[domain.key]}</span>
                        </div>
                        <input
                          type="range"
                          min="1"
                          max="10"
                          value={visionAnswers[domain.key]}
                          onChange={(e) => setVisionAnswers({ ...visionAnswers, [domain.key]: parseInt(e.target.value) })}
                          className="w-full h-2 bg-white/20 rounded-lg appearance-none cursor-pointer accent-[#F5B800]"
                        />
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Slide 14: Non-Negotiables */}
              {visionSlide === 14 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-4">Your Foundation</p>
                  <h2 className="text-3xl md:text-5xl font-bold text-white mb-6">
                    Your 3 Non-Negotiables
                  </h2>
                  <p className="text-white/60 mb-8">Three habits you commit to doing NO MATTER WHAT.</p>
                  <div className="space-y-4 max-w-lg mx-auto">
                    {[1, 2, 3].map(num => (
                      <div key={num} className="flex items-center gap-3">
                        <div className="w-10 h-10 rounded-xl bg-[#F5B800] flex items-center justify-center font-bold text-[#1E3A5F] shrink-0">
                          {num}
                        </div>
                        <input
                          type="text"
                          value={visionAnswers[`nonNegotiable${num}`]}
                          onChange={(e) => setVisionAnswers({ ...visionAnswers, [`nonNegotiable${num}`]: e.target.value })}
                          placeholder={`Non-negotiable habit #${num}`}
                          className="flex-1 bg-gray-700 border-2 border-gray-600 focus:border-[#F5B800] rounded-xl px-4 py-3 text-white placeholder:text-white/30 outline-none transition-colors"
                        />
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Slide 15: Accountability Partner */}
              {visionSlide === 15 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-4">Your Support System</p>
                  <h2 className="text-3xl md:text-5xl font-bold text-white mb-6">
                    Who Will Hold You Accountable?
                  </h2>
                  <p className="text-white/60 mb-8">Name someone who will check in on your progress.</p>
                  <input
                    type="text"
                    value={visionAnswers.supportPerson}
                    onChange={(e) => setVisionAnswers({ ...visionAnswers, supportPerson: e.target.value })}
                    placeholder="Name of your accountability partner"
                    className="w-full max-w-lg mx-auto block bg-gray-700 border-2 border-gray-600 focus:border-[#F5B800] rounded-xl px-6 py-4 text-lg text-white placeholder:text-white/30 outline-none transition-colors"
                  />
                  <div className="flex flex-wrap justify-center gap-2 mt-6">
                    {['Brandon', 'John', 'Taylor'].filter(p => p !== userProfile?.linkedParticipant).map(name => (
                      <button
                        key={name}
                        onClick={() => setVisionAnswers({ ...visionAnswers, supportPerson: name })}
                        className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${
                          visionAnswers.supportPerson === name 
                            ? 'bg-[#F5B800] text-[#1E3A5F]' 
                            : 'bg-gray-700 text-white/70 hover:bg-gray-600'
                        }`}
                      >
                        {name}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {/* Slide 16: Reward */}
              {visionSlide === 16 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-4">Celebrate Success</p>
                  <h2 className="text-3xl md:text-5xl font-bold text-white mb-6">
                    How Will You Reward Yourself?
                  </h2>
                  <p className="text-white/60 mb-8">What will you treat yourself to when you achieve your goal?</p>
                  <input
                    type="text"
                    value={visionAnswers.rewardForSuccess}
                    onChange={(e) => setVisionAnswers({ ...visionAnswers, rewardForSuccess: e.target.value })}
                    placeholder="e.g., Vacation, new gadget, special experience..."
                    className="w-full max-w-lg mx-auto block bg-gray-700 border-2 border-gray-600 focus:border-[#F5B800] rounded-xl px-6 py-4 text-lg text-white placeholder:text-white/30 outline-none transition-colors"
                  />
                </div>
              )}

              {/* Slide 17: Letter to Self */}
              {visionSlide === 17 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <p className="text-[#F5B800] text-sm uppercase tracking-widest mb-4">Final Reflection</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-6">
                    Write a Letter to Your Future Self
                  </h2>
                  <p className="text-white/60 mb-6">You'll read this at the end of 2026. What do you want to tell yourself?</p>
                  <textarea
                    value={visionAnswers.letterToSelf}
                    onChange={(e) => setVisionAnswers({ ...visionAnswers, letterToSelf: e.target.value })}
                    placeholder="Dear Future Me,&#10;&#10;As I write this in early 2026, I want you to remember..."
                    className="w-full max-w-lg mx-auto block bg-gray-700 border-2 border-gray-600 focus:border-[#F5B800] rounded-xl px-6 py-4 text-lg text-white placeholder:text-white/30 outline-none transition-colors resize-none h-48"
                  />
                </div>
              )}
            </div>

            {/* Navigation */}
            <div className="absolute bottom-8 left-0 right-0 flex justify-center gap-4 px-6 z-20">
              {visionSlide > 0 && (
                <button
                  onClick={() => setVisionSlide(visionSlide - 1)}
                  className="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-medium transition-colors flex items-center gap-2"
                >
                  <ChevronLeft className="w-5 h-5" />
                  Back
                </button>
              )}
              {visionSlide < 17 ? (
                <button
                  onClick={() => setVisionSlide(visionSlide + 1)}
                  className="px-8 py-3 bg-[#F5B800] hover:bg-[#e5a800] text-[#1E3A5F] rounded-xl font-bold transition-colors flex items-center gap-2"
                >
                  {visionSlide === 0 ? "Let's Go! " : visionSlide === 9 ? "Set 2026 Goals" : 'Continue'}
                  <ChevronRight className="w-5 h-5" />
                </button>
              ) : (
                <button
                  onClick={saveVision}
                  className="px-8 py-3 bg-gradient-to-r from-[#F5B800] to-amber-500 hover:from-[#e5a800] hover:to-amber-400 text-[#1E3A5F] rounded-xl font-bold transition-all flex items-center gap-2 shadow-lg shadow-amber-500/25"
                >
                  <CheckCircle2 className="w-5 h-5" />
                  Save My Vision
                </button>
              )}
            </div>
          </div>
        )}

        {/* 2025 Reflection Modal */}
        {showReflectionModal && (
          <div className="fixed inset-0 z-[100] bg-gradient-to-br from-purple-900 via-indigo-900 to-purple-800 overflow-y-auto">
            {/* Progress Dots */}
            <div className="fixed top-4 left-1/2 -translate-x-1/2 z-20 flex gap-1.5">
              {Array.from({ length: 10 }).map((_, i) => (
                <button
                  key={i}
                  onClick={() => setReflectionSlide(i)}
                  className={`h-1.5 rounded-full transition-all duration-300 ${
                    i === reflectionSlide ? 'w-6 bg-purple-300' : i < reflectionSlide ? 'w-1.5 bg-purple-400/60' : 'w-1.5 bg-white/30'
                  }`}
                />
              ))}
            </div>

            {/* Close Button */}
            <button
              onClick={() => setShowReflectionModal(false)}
              className="fixed top-4 right-4 z-20 w-10 h-10 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center transition-colors"
            >
              <X className="w-5 h-5 text-white" />
            </button>

            {/* Slide Container */}
            <div className="min-h-screen flex flex-col items-center justify-center p-6 md:p-12">
              
              {/* Slide 0: Welcome */}
              {reflectionSlide === 0 && (
                <div className="text-center max-w-2xl animate-fade-in">
                  <div className="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-purple-400 to-indigo-500 flex items-center justify-center shadow-2xl shadow-purple-500/30">
                    <Eye className="w-12 h-12 text-white" />
                  </div>
                  <p className="text-purple-300 text-sm uppercase tracking-[0.3em] mb-4 font-bold">Looking Back</p>
                  <h1 className="text-4xl md:text-6xl font-black text-white mb-4">
                    Your 2025
                  </h1>
                  <h1 className="text-4xl md:text-6xl font-black bg-gradient-to-r from-purple-300 to-pink-300 bg-clip-text text-transparent mb-6">
                    Reflection
                  </h1>
                  <p className="text-xl text-white/60 mb-2">
                    Take a moment to honor your journey.
                  </p>
                  <p className="text-white/40 text-sm">This takes about 5 minutes</p>
                </div>
              )}

              {/* Slide 1: Word to Describe 2025 */}
              {reflectionSlide === 1 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <p className="text-purple-300 text-sm uppercase tracking-widest mb-4">One Word</p>
                  <h2 className="text-3xl md:text-5xl font-bold text-white mb-6">
                    What word describes your 2025?
                  </h2>
                  <p className="text-white/60 mb-8">If you had to sum up this year in one word...</p>
                  <input
                    type="text"
                    value={reflectionAnswers.wordToDescribe2025}
                    onChange={(e) => setReflectionAnswers({ ...reflectionAnswers, wordToDescribe2025: e.target.value.toUpperCase() })}
                    placeholder="e.g., GROWTH, CHALLENGING, TRANSFORMATIVE"
                    className="w-full max-w-md mx-auto block bg-gray-700 border-2 border-gray-600 focus:border-purple-400 rounded-xl px-6 py-4 text-2xl text-white text-center uppercase tracking-widest placeholder:text-white/30 outline-none transition-colors"
                    maxLength={20}
                  />
                  <div className="flex flex-wrap justify-center gap-2 mt-6">
                    {['GROWTH', 'CHALLENGING', 'TRANSFORMATIVE', 'REWARDING', 'SURPRISING', 'BUILDING', 'HEALING'].map(word => (
                      <button
                        key={word}
                        onClick={() => setReflectionAnswers({ ...reflectionAnswers, wordToDescribe2025: word })}
                        className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${
                          reflectionAnswers.wordToDescribe2025 === word 
                            ? 'bg-purple-400 text-white' 
                            : 'bg-gray-700 text-white/70 hover:bg-gray-600'
                        }`}
                      >
                        {word}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {/* Slide 2: Biggest Win */}
              {reflectionSlide === 2 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-yellow-400 to-amber-500 flex items-center justify-center">
                    <Trophy className="w-8 h-8 text-white" />
                  </div>
                  <p className="text-amber-300 text-sm uppercase tracking-widest mb-4">Celebrate</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-6">
                    What was your biggest win in 2025?
                  </h2>
                  <textarea
                    value={reflectionAnswers.biggestWin}
                    onChange={(e) => setReflectionAnswers({ ...reflectionAnswers, biggestWin: e.target.value })}
                    placeholder="Describe your proudest achievement this year..."
                    className="w-full max-w-lg mx-auto block bg-gray-700 border-2 border-gray-600 focus:border-amber-400 rounded-xl px-6 py-4 text-lg text-white placeholder:text-white/30 outline-none transition-colors resize-none h-32"
                  />
                </div>
              )}

              {/* Slide 3: Biggest Challenge */}
              {reflectionSlide === 3 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <p className="text-orange-300 text-sm uppercase tracking-widest mb-4">Growth Edge</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-6">
                    What was your biggest challenge?
                  </h2>
                  <p className="text-white/60 mb-8">The struggles that shaped you...</p>
                  <textarea
                    value={reflectionAnswers.biggestChallenge}
                    onChange={(e) => setReflectionAnswers({ ...reflectionAnswers, biggestChallenge: e.target.value })}
                    placeholder="What obstacle tested you the most?"
                    className="w-full max-w-lg mx-auto block bg-gray-700 border-2 border-gray-600 focus:border-orange-400 rounded-xl px-6 py-4 text-lg text-white placeholder:text-white/30 outline-none transition-colors resize-none h-32"
                  />
                </div>
              )}

              {/* Slide 4: Lesson Learned */}
              {reflectionSlide === 4 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center">
                    <Lightbulb className="w-8 h-8 text-white" />
                  </div>
                  <p className="text-cyan-300 text-sm uppercase tracking-widest mb-4">Wisdom Gained</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-6">
                    What's the most important lesson you learned?
                  </h2>
                  <textarea
                    value={reflectionAnswers.lessonLearned}
                    onChange={(e) => setReflectionAnswers({ ...reflectionAnswers, lessonLearned: e.target.value })}
                    placeholder="Share the wisdom you gained..."
                    className="w-full max-w-lg mx-auto block bg-gray-700 border-2 border-gray-600 focus:border-cyan-400 rounded-xl px-6 py-4 text-lg text-white placeholder:text-white/30 outline-none transition-colors resize-none h-32"
                  />
                </div>
              )}

              {/* Slide 5: Domain Reflection */}
              {reflectionSlide === 5 && (
                <div className="text-center max-w-3xl animate-fade-in w-full">
                  <p className="text-purple-300 text-sm uppercase tracking-widest mb-4">Life Assessment</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-6">
                    How did 2025 go in each area?
                  </h2>
                  <p className="text-white/60 mb-8">Rate your satisfaction (1-10)</p>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
                    {[
                      { key: 'fitnessReflection', label: 'Fitness', icon: '' },
                      { key: 'businessReflection', label: 'Business/Career', icon: '' },
                      { key: 'financeReflection', label: 'Finance', icon: '' },
                      { key: 'healthReflection', label: 'Health', icon: '' },
                      { key: 'learningReflection', label: 'Learning', icon: '' },
                      { key: 'relationshipsReflection', label: 'Relationships', icon: '' },
                      { key: 'spiritualReflection', label: 'Spiritual', icon: '' }
                    ].map(domain => (
                      <div key={domain.key} className="bg-gray-800 rounded-xl p-4">
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-white font-medium">{domain.icon} {domain.label}</span>
                          <span className="text-purple-300 font-bold text-xl">{reflectionAnswers[domain.key]}</span>
                        </div>
                        <input
                          type="range"
                          min="1"
                          max="10"
                          value={reflectionAnswers[domain.key]}
                          onChange={(e) => setReflectionAnswers({ ...reflectionAnswers, [domain.key]: parseInt(e.target.value) })}
                          className="w-full h-2 bg-white/20 rounded-lg appearance-none cursor-pointer accent-purple-400"
                        />
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Slide 6: Habit Reflection */}
              {reflectionSlide === 6 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <p className="text-green-300 text-sm uppercase tracking-widest mb-4">Habits</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-6">
                    Habit Wins & Struggles
                  </h2>
                  <div className="space-y-6">
                    <div>
                      <label className="text-white/70 text-sm block mb-2">What habit did you master? </label>
                      <input
                        type="text"
                        value={reflectionAnswers.habitMastered}
                        onChange={(e) => setReflectionAnswers({ ...reflectionAnswers, habitMastered: e.target.value })}
                        placeholder="e.g., Morning workouts, Daily reading..."
                        className="w-full max-w-lg mx-auto block bg-gray-700 border-2 border-gray-600 focus:border-green-400 rounded-xl px-6 py-3 text-white placeholder:text-white/30 outline-none transition-colors"
                      />
                    </div>
                    <div>
                      <label className="text-white/70 text-sm block mb-2">What habit did you struggle with? </label>
                      <input
                        type="text"
                        value={reflectionAnswers.habitStruggled}
                        onChange={(e) => setReflectionAnswers({ ...reflectionAnswers, habitStruggled: e.target.value })}
                        placeholder="e.g., Consistent sleep, Diet tracking..."
                        className="w-full max-w-lg mx-auto block bg-gray-700 border-2 border-gray-600 focus:border-orange-400 rounded-xl px-6 py-3 text-white placeholder:text-white/30 outline-none transition-colors"
                      />
                    </div>
                  </div>
                </div>
              )}

              {/* Slide 7: Unexpected Joy */}
              {reflectionSlide === 7 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-pink-400 to-rose-500 flex items-center justify-center">
                    <Heart className="w-8 h-8 text-white" />
                  </div>
                  <p className="text-pink-300 text-sm uppercase tracking-widest mb-4">Surprise</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-6">
                    What brought you unexpected joy?
                  </h2>
                  <textarea
                    value={reflectionAnswers.unexpectedJoy}
                    onChange={(e) => setReflectionAnswers({ ...reflectionAnswers, unexpectedJoy: e.target.value })}
                    placeholder="A moment, person, or experience that surprised you with happiness..."
                    className="w-full max-w-lg mx-auto block bg-gray-700 border-2 border-gray-600 focus:border-pink-400 rounded-xl px-6 py-4 text-lg text-white placeholder:text-white/30 outline-none transition-colors resize-none h-32"
                  />
                </div>
              )}

              {/* Slide 8: Gratitude */}
              {reflectionSlide === 8 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <p className="text-amber-300 text-sm uppercase tracking-widest mb-4">Gratitude</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-6">
                    What are you most grateful for from 2025?
                  </h2>
                  <textarea
                    value={reflectionAnswers.gratefulFor}
                    onChange={(e) => setReflectionAnswers({ ...reflectionAnswers, gratefulFor: e.target.value })}
                    placeholder="People, experiences, lessons, opportunities..."
                    className="w-full max-w-lg mx-auto block bg-gray-700 border-2 border-gray-600 focus:border-amber-400 rounded-xl px-6 py-4 text-lg text-white placeholder:text-white/30 outline-none transition-colors resize-none h-32"
                  />
                </div>
              )}

              {/* Slide 9: Advice to Future Self */}
              {reflectionSlide === 9 && (
                <div className="text-center max-w-2xl animate-fade-in w-full">
                  <p className="text-purple-300 text-sm uppercase tracking-widest mb-4">Final Wisdom</p>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-6">
                    What advice would you give yourself going into 2026?
                  </h2>
                  <textarea
                    value={reflectionAnswers.adviceToFutureSelf}
                    onChange={(e) => setReflectionAnswers({ ...reflectionAnswers, adviceToFutureSelf: e.target.value })}
                    placeholder="Based on everything you learned in 2025..."
                    className="w-full max-w-lg mx-auto block bg-gray-700 border-2 border-gray-600 focus:border-purple-400 rounded-xl px-6 py-4 text-lg text-white placeholder:text-white/30 outline-none transition-colors resize-none h-40"
                  />
                </div>
              )}
            </div>

            {/* Navigation */}
            <div className="fixed bottom-8 left-0 right-0 flex justify-center gap-4 px-6 z-20">
              {reflectionSlide > 0 && (
                <button
                  onClick={() => setReflectionSlide(reflectionSlide - 1)}
                  className="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-medium transition-colors flex items-center gap-2"
                >
                  <ChevronLeft className="w-5 h-5" />
                  Back
                </button>
              )}
              {reflectionSlide < 9 ? (
                <button
                  onClick={() => setReflectionSlide(reflectionSlide + 1)}
                  className="px-8 py-3 bg-purple-500 hover:bg-purple-400 text-white rounded-xl font-bold transition-colors flex items-center gap-2"
                >
                  {reflectionSlide === 0 ? "Let's Reflect" : 'Continue'}
                  <ChevronRight className="w-5 h-5" />
                </button>
              ) : (
                <button
                  onClick={saveReflection}
                  className="px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-400 hover:to-pink-400 text-white rounded-xl font-bold transition-all flex items-center gap-2 shadow-lg shadow-purple-500/25"
                >
                  <CheckCircle2 className="w-5 h-5" />
                  Save Reflection
                </button>
              )}
            </div>
          </div>
        )}

        {/* Onboarding Modal - Full Screen Experience */}
        {showOnboarding && (
          <div className="fixed inset-0 z-[200] bg-gradient-to-br from-[#1E3A5F] via-[#2d4a6f] to-[#1E3A5F] overflow-y-auto">
            {/* Background Effects */}
            <div className="fixed inset-0 pointer-events-none overflow-hidden">
              <div className="absolute top-1/4 -left-20 w-80 h-80 bg-[#F5B800]/20 rounded-full blur-3xl animate-pulse" />
              <div className="absolute bottom-1/4 -right-20 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl animate-pulse" style={{ animationDelay: '1s' }} />
              <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-gray-800 rounded-full blur-3xl" />
            </div>

            {/* Progress Bar */}
            <div className="fixed top-0 left-0 right-0 h-1 bg-gray-700 z-30">
              <div 
                className="h-full bg-gradient-to-r from-[#F5B800] to-amber-400 transition-all duration-500"
                style={{ width: `${((onboardingSlide + 1) / 8) * 100}%` }}
              />
            </div>

            {/* Progress Dots */}
            <div className="fixed top-6 left-1/2 -translate-x-1/2 z-20 flex gap-2">
              {Array.from({ length: 8 }).map((_, i) => (
                <button
                  key={i}
                  onClick={() => i <= onboardingSlide && setOnboardingSlide(i)}
                  className={`h-2 rounded-full transition-all duration-300 ${
                    i === onboardingSlide ? 'w-8 bg-[#F5B800]' : i < onboardingSlide ? 'w-2 bg-[#F5B800]/60 cursor-pointer' : 'w-2 bg-white/20'
                  }`}
                />
              ))}
            </div>

            {/* Skip Button (only on first few slides) */}
            {onboardingSlide < 6 && (
              <button
                onClick={() => setOnboardingSlide(7)}
                className="fixed top-6 right-6 z-20 text-white/50 hover:text-white/80 text-sm transition-colors"
              >
                Skip Setup 
              </button>
            )}

            {/* Slide Container */}
            <div className="min-h-screen flex flex-col items-center justify-center p-6 md:p-12 relative z-10">
              
              {/* Slide 0: Welcome */}
              {onboardingSlide === 0 && (
                <div className="text-center max-w-2xl animate-fade-in">
                  {/* Logo */}
                  <div className="w-24 h-24 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-[#F5B800] to-amber-500 flex items-center justify-center shadow-2xl shadow-amber-500/30">
                    <img src={LOGO_BASE64} alt="Logo" className="w-16 h-16" />
                  </div>
                  <h1 className="text-4xl md:text-5xl font-black text-white mb-4">
                    Welcome to
                  </h1>
                  <h1 className="text-4xl md:text-5xl font-black bg-gradient-to-r from-[#F5B800] to-amber-300 bg-clip-text text-transparent mb-6">
                    The Accountability Group
                  </h1>
                  <p className="text-xl text-white/70 mb-2">
                    Track habits. Stay accountable. Achieve more.
                  </p>
                  <p className="text-white/50 mb-8">Let's get you set up in about 2 minutes</p>
                  
                  <div className="flex flex-wrap justify-center gap-4 mb-8">
                    <div className="flex items-center gap-2 px-4 py-2 bg-gray-700 rounded-full">
                      <Target className="w-4 h-4 text-[#F5B800]" />
                      <span className="text-white/80 text-sm">Track Habits</span>
                    </div>
                    <div className="flex items-center gap-2 px-4 py-2 bg-gray-700 rounded-full">
                      <Users className="w-4 h-4 text-[#F5B800]" />
                      <span className="text-white/80 text-sm">Group Accountability</span>
                    </div>
                    <div className="flex items-center gap-2 px-4 py-2 bg-gray-700 rounded-full">
                      <TrendingUp className="w-4 h-4 text-[#F5B800]" />
                      <span className="text-white/80 text-sm">See Progress</span>
                    </div>
                  </div>
                </div>
              )}

              {/* Slide 1: Name */}
              {onboardingSlide === 1 && (
                <div className="text-center max-w-xl w-full animate-fade-in">
                  <div className="w-16 h-16 mx-auto mb-6 rounded-full bg-gradient-to-br from-blue-400 to-cyan-500 flex items-center justify-center">
                    <User className="w-8 h-8 text-white" />
                  </div>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-3">
                    What should we call you?
                  </h2>
                  <p className="text-white/60 mb-8">This is how you'll appear to your accountability partners</p>
                  
                  <div className="space-y-4 max-w-md mx-auto">
                    <div>
                      <label className="text-white/70 text-sm block mb-2 text-left">Full Name</label>
                      <input
                        type="text"
                        value={onboardingData.displayName}
                        onChange={(e) => setOnboardingData({ ...onboardingData, displayName: e.target.value })}
                        placeholder="John Smith"
                        className="w-full bg-gray-700 border-2 border-gray-600 focus:border-[#F5B800] rounded-xl px-5 py-4 text-lg text-white placeholder:text-white/30 outline-none transition-colors"
                      />
                    </div>
                    <div>
                      <label className="text-white/70 text-sm block mb-2 text-left">Nickname (optional)</label>
                      <input
                        type="text"
                        value={onboardingData.nickname}
                        onChange={(e) => setOnboardingData({ ...onboardingData, nickname: e.target.value })}
                        placeholder="Johnny"
                        className="w-full bg-gray-700 border-2 border-gray-600 focus:border-[#F5B800] rounded-xl px-5 py-4 text-lg text-white placeholder:text-white/30 outline-none transition-colors"
                      />
                    </div>
                  </div>
                </div>
              )}

              {/* Slide 2: Join or Create Participant */}
              {onboardingSlide === 2 && (
                <div className="text-center max-w-2xl w-full animate-fade-in">
                  <div className="w-16 h-16 mx-auto mb-6 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center">
                    <Users className="w-8 h-8 text-white" />
                  </div>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-3">
                    Link your account
                  </h2>
                  <p className="text-white/60 mb-8">Are you joining as an existing participant or creating a new profile?</p>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-xl mx-auto mb-6">
                    <button
                      onClick={() => setOnboardingData({ ...onboardingData, participantType: 'existing' })}
                      className={`p-6 rounded-2xl border-2 transition-all text-left ${
                        onboardingData.participantType === 'existing'
                          ? 'bg-[#F5B800]/20 border-[#F5B800] shadow-lg shadow-[#F5B800]/20'
                          : 'bg-gray-800 border-gray-600 hover:border-white/40'
                      }`}
                    >
                      <div className={`w-10 h-10 rounded-lg flex items-center justify-center mb-3 ${
                        onboardingData.participantType === 'existing' ? 'bg-[#F5B800]' : 'bg-gray-700'
                      }`}>
                        <Users className={`w-5 h-5 ${onboardingData.participantType === 'existing' ? 'text-[#1E3A5F]' : 'text-white'}`} />
                      </div>
                      <h3 className="text-white font-bold mb-1">Join Existing</h3>
                      <p className="text-white/50 text-sm">Link to Taylor, Brandon, or John</p>
                    </button>
                    
                    <button
                      onClick={() => setOnboardingData({ ...onboardingData, participantType: 'new' })}
                      className={`p-6 rounded-2xl border-2 transition-all text-left ${
                        onboardingData.participantType === 'new'
                          ? 'bg-[#F5B800]/20 border-[#F5B800] shadow-lg shadow-[#F5B800]/20'
                          : 'bg-gray-800 border-gray-600 hover:border-white/40'
                      }`}
                    >
                      <div className={`w-10 h-10 rounded-lg flex items-center justify-center mb-3 ${
                        onboardingData.participantType === 'new' ? 'bg-[#F5B800]' : 'bg-gray-700'
                      }`}>
                        <Plus className={`w-5 h-5 ${onboardingData.participantType === 'new' ? 'text-[#1E3A5F]' : 'text-white'}`} />
                      </div>
                      <h3 className="text-white font-bold mb-1">Create New</h3>
                      <p className="text-white/50 text-sm">Start fresh as a new participant</p>
                    </button>
                  </div>

                  {onboardingData.participantType === 'existing' && (
                    <div className="max-w-md mx-auto animate-fade-in">
                      <label className="text-white/70 text-sm block mb-3">Select your participant profile:</label>
                      <div className="grid grid-cols-3 gap-3">
                        {PARTICIPANTS.map(p => (
                          <button
                            key={p}
                            onClick={() => setOnboardingData({ ...onboardingData, linkedParticipant: p })}
                            className={`p-4 rounded-xl border-2 transition-all ${
                              onboardingData.linkedParticipant === p
                                ? 'bg-[#F5B800] border-[#F5B800] text-[#1E3A5F]'
                                : 'bg-gray-800 border-gray-600 text-white hover:border-white/40'
                            }`}
                          >
                            <span className="font-bold">{p}</span>
                          </button>
                        ))}
                      </div>
                    </div>
                  )}

                  {onboardingData.participantType === 'new' && (
                    <div className="max-w-md mx-auto animate-fade-in">
                      <label className="text-white/70 text-sm block mb-2 text-left">Your participant name:</label>
                      <input
                        type="text"
                        value={onboardingData.newParticipantName}
                        onChange={(e) => setOnboardingData({ ...onboardingData, newParticipantName: e.target.value })}
                        placeholder="Enter your name"
                        className="w-full bg-gray-700 border-2 border-gray-600 focus:border-[#F5B800] rounded-xl px-5 py-4 text-lg text-white placeholder:text-white/30 outline-none transition-colors"
                      />
                    </div>
                  )}
                </div>
              )}

              {/* Slide 3: Primary Goal */}
              {onboardingSlide === 3 && (
                <div className="text-center max-w-xl w-full animate-fade-in">
                  <div className="w-16 h-16 mx-auto mb-6 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center">
                    <Target className="w-8 h-8 text-white" />
                  </div>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-3">
                    What's your main goal?
                  </h2>
                  <p className="text-white/60 mb-8">What do you want to achieve with habit tracking?</p>
                  
                  <textarea
                    value={onboardingData.primaryGoal}
                    onChange={(e) => setOnboardingData({ ...onboardingData, primaryGoal: e.target.value })}
                    placeholder="e.g., Build consistent fitness habits, grow my business, improve work-life balance..."
                    className="w-full bg-gray-700 border-2 border-gray-600 focus:border-[#F5B800] rounded-xl px-5 py-4 text-lg text-white placeholder:text-white/30 outline-none transition-colors resize-none h-32"
                  />
                  
                  <div className="flex flex-wrap justify-center gap-2 mt-4">
                    {['Get healthier', 'Build my business', 'Improve productivity', 'Better work-life balance', 'Learn new skills'].map(goal => (
                      <button
                        key={goal}
                        onClick={() => setOnboardingData({ ...onboardingData, primaryGoal: goal })}
                        className={`px-4 py-2 rounded-full text-sm transition-all ${
                          onboardingData.primaryGoal === goal
                            ? 'bg-[#F5B800] text-[#1E3A5F] font-bold'
                            : 'bg-gray-700 text-white/70 hover:bg-gray-600'
                        }`}
                      >
                        {goal}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {/* Slide 4: Focus Areas */}
              {onboardingSlide === 4 && (
                <div className="text-center max-w-2xl w-full animate-fade-in">
                  <div className="w-16 h-16 mx-auto mb-6 rounded-full bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center">
                    <BarChart3 className="w-8 h-8 text-white" />
                  </div>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-3">
                    Which areas do you want to focus on?
                  </h2>
                  <p className="text-white/60 mb-8">Select all that apply (we'll help you track these)</p>
                  
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3 max-w-2xl mx-auto">
                    {[
                      { key: 'Fitness', icon: '', color: 'from-green-400 to-emerald-500' },
                      { key: 'Business', icon: '', color: 'from-blue-400 to-indigo-500' },
                      { key: 'Finance', icon: '', color: 'from-yellow-400 to-amber-500' },
                      { key: 'Health', icon: '', color: 'from-red-400 to-rose-500' },
                      { key: 'Learning', icon: '', color: 'from-purple-400 to-violet-500' },
                      { key: 'Relationships', icon: '', color: 'from-pink-400 to-rose-500' },
                      { key: 'Spiritual', icon: '', color: 'from-cyan-400 to-teal-500' },
                      { key: 'Discipline', icon: '', color: 'from-orange-400 to-red-500' }
                    ].map(area => {
                      const isSelected = onboardingData.focusAreas.includes(area.key);
                      return (
                        <button
                          key={area.key}
                          onClick={() => {
                            const newAreas = isSelected
                              ? onboardingData.focusAreas.filter(a => a !== area.key)
                              : [...onboardingData.focusAreas, area.key];
                            setOnboardingData({ ...onboardingData, focusAreas: newAreas });
                          }}
                          className={`p-4 rounded-xl border-2 transition-all ${
                            isSelected
                              ? 'bg-gradient-to-br ' + area.color + ' border-white/50 shadow-lg'
                              : 'bg-gray-800 border-gray-600 hover:border-white/40'
                          }`}
                        >
                          <span className="text-2xl mb-2 block">{area.icon}</span>
                          <span className={`font-medium text-sm ${isSelected ? 'text-white' : 'text-white/80'}`}>{area.key}</span>
                        </button>
                      );
                    })}
                  </div>
                </div>
              )}

              {/* Slide 5: Accountability Style */}
              {onboardingSlide === 5 && (
                <div className="text-center max-w-2xl w-full animate-fade-in">
                  <div className="w-16 h-16 mx-auto mb-6 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center">
                    <Heart className="w-8 h-8 text-white" />
                  </div>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-3">
                    What's your accountability style?
                  </h2>
                  <p className="text-white/60 mb-8">This helps us personalize your experience</p>
                  
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-2xl mx-auto">
                    {[
                      { 
                        key: 'supportive', 
                        title: 'Supportive', 
                        desc: 'Encouraging words and gentle reminders',
                        icon: '',
                        color: 'from-pink-400 to-rose-500'
                      },
                      { 
                        key: 'competitive', 
                        title: 'Competitive', 
                        desc: 'Rankings, challenges, and leaderboards',
                        icon: '',
                        color: 'from-amber-400 to-orange-500'
                      },
                      { 
                        key: 'balanced', 
                        title: 'Balanced', 
                        desc: 'Mix of support and healthy competition',
                        icon: '',
                        color: 'from-blue-400 to-cyan-500'
                      }
                    ].map(style => (
                      <button
                        key={style.key}
                        onClick={() => setOnboardingData({ ...onboardingData, accountabilityStyle: style.key })}
                        className={`p-6 rounded-2xl border-2 transition-all text-left ${
                          onboardingData.accountabilityStyle === style.key
                            ? `bg-gradient-to-br ${style.color} border-white/50 shadow-lg`
                            : 'bg-gray-800 border-gray-600 hover:border-white/40'
                        }`}
                      >
                        <span className="text-3xl mb-3 block">{style.icon}</span>
                        <h3 className="text-white font-bold mb-1">{style.title}</h3>
                        <p className="text-white/60 text-sm">{style.desc}</p>
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {/* Slide 6: Initial Habits */}
              {onboardingSlide === 6 && (
                <div className="text-center max-w-xl w-full animate-fade-in">
                  <div className="w-16 h-16 mx-auto mb-6 rounded-full bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center">
                    <CheckCircle2 className="w-8 h-8 text-white" />
                  </div>
                  <h2 className="text-3xl md:text-4xl font-bold text-white mb-3">
                    Start with 3 habits
                  </h2>
                  <p className="text-white/60 mb-8">What habits do you want to track this week? (You can always add more later)</p>
                  
                  <div className="space-y-4 max-w-md mx-auto">
                    {[0, 1, 2].map(idx => (
                      <div key={idx} className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 ${
                          onboardingData.initialHabits[idx] ? 'bg-green-500' : 'bg-gray-700'
                        }`}>
                          {onboardingData.initialHabits[idx] ? (
                            <Check className="w-5 h-5 text-white" />
                          ) : (
                            <span className="text-white/50 font-bold">{idx + 1}</span>
                          )}
                        </div>
                        <input
                          type="text"
                          value={onboardingData.initialHabits[idx]}
                          onChange={(e) => {
                            const newHabits = [...onboardingData.initialHabits];
                            newHabits[idx] = e.target.value;
                            setOnboardingData({ ...onboardingData, initialHabits: newHabits });
                          }}
                          placeholder={idx === 0 ? 'e.g., Workout 4x per week' : idx === 1 ? 'e.g., Read 30 minutes' : 'e.g., No social media until noon'}
                          className="flex-1 bg-gray-700 border-2 border-gray-600 focus:border-[#F5B800] rounded-xl px-4 py-3 text-white placeholder:text-white/30 outline-none transition-colors"
                        />
                      </div>
                    ))}
                  </div>

                  <div className="mt-6 p-4 bg-gray-800 rounded-xl">
                    <p className="text-white/50 text-sm mb-3">Popular habits in your focus areas:</p>
                    <div className="flex flex-wrap justify-center gap-2">
                      {(() => {
                        const suggestions = [];
                        if (onboardingData.focusAreas.includes('Fitness')) suggestions.push('Workout', '10K steps', 'Morning run');
                        if (onboardingData.focusAreas.includes('Health')) suggestions.push('8hrs sleep', 'Meditate', 'Drink 8 glasses');
                        if (onboardingData.focusAreas.includes('Business')) suggestions.push('3 sales calls', 'Client follow-ups', 'Networking');
                        if (onboardingData.focusAreas.includes('Learning')) suggestions.push('Read 30min', 'Online course', 'Practice skill');
                        if (onboardingData.focusAreas.includes('Discipline')) suggestions.push('No social media', 'Wake at 6am', 'Plan tomorrow');
                        if (suggestions.length === 0) suggestions.push('Workout', 'Read', 'Meditate', 'Plan day');
                        return suggestions.slice(0, 6).map(s => (
                          <button
                            key={s}
                            onClick={() => {
                              const emptyIdx = onboardingData.initialHabits.findIndex(h => !h);
                              if (emptyIdx !== -1) {
                                const newHabits = [...onboardingData.initialHabits];
                                newHabits[emptyIdx] = s;
                                setOnboardingData({ ...onboardingData, initialHabits: newHabits });
                              }
                            }}
                            className="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-lg text-white/70 text-sm transition-colors"
                          >
                            + {s}
                          </button>
                        ));
                      })()}
                    </div>
                  </div>
                </div>
              )}

              {/* Slide 7: Ready! */}
              {onboardingSlide === 7 && (
                <div className="text-center max-w-xl animate-fade-in">
                  <div className="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-[#F5B800] to-amber-500 flex items-center justify-center shadow-2xl shadow-amber-500/30 animate-pulse">
                    <PartyPopper className="w-12 h-12 text-white" />
                  </div>
                  <h1 className="text-4xl md:text-5xl font-black text-white mb-4">
                    You're all set!
                  </h1>
                  <p className="text-xl text-white/70 mb-8">
                    Welcome to the accountability group, {onboardingData.nickname || onboardingData.displayName?.split(' ')[0] || 'friend'}!
                  </p>
                  
                  {/* Summary Card */}
                  <div className="bg-gray-700 backdrop-blur-sm rounded-2xl p-6 text-left mb-8 border border-gray-600">
                    <h3 className="text-white font-bold mb-4 text-center">Your Setup Summary</h3>
                    <div className="space-y-3">
                      <div className="flex justify-between items-center py-2 border-b border-gray-600">
                        <span className="text-white/60">Participant</span>
                        <span className="text-white font-medium">
                          {onboardingData.participantType === 'new' ? onboardingData.newParticipantName : onboardingData.linkedParticipant}
                        </span>
                      </div>
                      <div className="flex justify-between items-center py-2 border-b border-gray-600">
                        <span className="text-white/60">Focus Areas</span>
                        <span className="text-white font-medium">
                          {onboardingData.focusAreas.length > 0 ? onboardingData.focusAreas.slice(0, 3).join(', ') : 'Not set'}
                          {onboardingData.focusAreas.length > 3 && ` +${onboardingData.focusAreas.length - 3}`}
                        </span>
                      </div>
                      <div className="flex justify-between items-center py-2 border-b border-gray-600">
                        <span className="text-white/60">Style</span>
                        <span className="text-white font-medium capitalize">{onboardingData.accountabilityStyle}</span>
                      </div>
                      <div className="flex justify-between items-center py-2">
                        <span className="text-white/60">Starting Habits</span>
                        <span className="text-white font-medium">{onboardingData.initialHabits.filter(h => h).length} habits</span>
                      </div>
                    </div>
                  </div>

                  <div className="flex flex-col items-center gap-4">
                    <button
                      onClick={completeOnboarding}
                      className="px-10 py-4 bg-gradient-to-r from-[#F5B800] to-amber-500 hover:from-[#e5a800] hover:to-amber-400 text-[#1E3A5F] rounded-xl font-black text-lg transition-all shadow-lg shadow-amber-500/25 flex items-center gap-2"
                    >
                      <Sparkles className="w-5 h-5" />
                      Let's Go!
                    </button>
                    <p className="text-white/40 text-sm">You can always update these settings later</p>
                  </div>
                </div>
              )}
            </div>

            {/* Navigation Buttons */}
            {onboardingSlide < 7 && (
              <div className="fixed bottom-8 left-0 right-0 flex justify-center gap-4 px-6 z-20">
                {onboardingSlide > 0 && (
                  <button
                    onClick={() => setOnboardingSlide(onboardingSlide - 1)}
                    className="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-medium transition-colors flex items-center gap-2"
                  >
                    <ChevronLeft className="w-5 h-5" />
                    Back
                  </button>
                )}
                <button
                  onClick={() => setOnboardingSlide(onboardingSlide + 1)}
                  disabled={
                    (onboardingSlide === 1 && !onboardingData.displayName) ||
                    (onboardingSlide === 2 && onboardingData.participantType === 'existing' && !onboardingData.linkedParticipant) ||
                    (onboardingSlide === 2 && onboardingData.participantType === 'new' && !onboardingData.newParticipantName)
                  }
                  className="px-8 py-3 bg-[#F5B800] hover:bg-[#e5a800] disabled:opacity-50 disabled:cursor-not-allowed text-[#1E3A5F] rounded-xl font-bold transition-colors flex items-center gap-2"
                >
                  {onboardingSlide === 0 ? "Get Started" : "Continue"}
                  <ChevronRight className="w-5 h-5" />
                </button>
              </div>
            )}
          </div>
        )}

        {/* Time Capsule Modal */}
        {showTimeCapsule && (
          <div className="fixed inset-0 z-[100] bg-gradient-to-br from-amber-900 via-orange-900 to-amber-800 overflow-y-auto">
            {/* Close Button */}
            <button
              onClick={() => setShowTimeCapsule(false)}
              className="fixed top-4 right-4 z-20 w-10 h-10 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center transition-colors"
            >
              <X className="w-5 h-5 text-white" />
            </button>

            <div className="min-h-screen flex flex-col items-center justify-center p-6 md:p-12">
              {/* If capsule exists and is locked */}
              {timeCapsuleData && !isEndYearUnlocked ? (
                <div className="text-center max-w-lg">
                  <div className="w-32 h-32 mx-auto mb-6 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center shadow-2xl shadow-amber-500/30 relative">
                    <Gift className="w-16 h-16 text-white" />
                    <div className="absolute -top-2 -right-2 w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">
                      <Lock className="w-6 h-6 text-amber-600" />
                    </div>
                  </div>
                  <h1 className="text-3xl md:text-4xl font-black text-white mb-4">
                    Your Time Capsule is Sealed
                  </h1>
                  <p className="text-white/70 mb-6">
                    You created this capsule on {new Date(timeCapsuleData.createdAt).toLocaleDateString()}. 
                    It contains your hopes, predictions, and a message to your future self.
                  </p>
                  
                  <div className="bg-gray-700 rounded-2xl p-6 mb-6">
                    <h3 className="text-amber-300 font-bold mb-4">Unlock Schedule</h3>
                    <div className="space-y-3">
                      <div className={`flex items-center justify-between p-3 rounded-xl ${isMidYearUnlocked ? 'bg-green-500/20' : 'bg-gray-800'}`}>
                        <div className="flex items-center gap-3">
                          {isMidYearUnlocked ? <Check className="w-5 h-5 text-green-400" /> : <Lock className="w-5 h-5 text-white/40" />}
                          <span className="text-white font-medium">Mid-Year Review</span>
                        </div>
                        <span className={isMidYearUnlocked ? 'text-green-400' : 'text-white/40'}>July 1, 2026</span>
                      </div>
                      <div className={`flex items-center justify-between p-3 rounded-xl ${isEndYearUnlocked ? 'bg-green-500/20' : 'bg-gray-800'}`}>
                        <div className="flex items-center gap-3">
                          {isEndYearUnlocked ? <Check className="w-5 h-5 text-green-400" /> : <Lock className="w-5 h-5 text-white/40" />}
                          <span className="text-white font-medium">Full Capsule</span>
                        </div>
                        <span className={isEndYearUnlocked ? 'text-green-400' : 'text-white/40'}>December 26, 2026</span>
                      </div>
                    </div>
                  </div>

                  {/* Mid-year preview if unlocked */}
                  {isMidYearUnlocked && (
                    <div className="bg-gray-700 rounded-2xl p-6 text-left mb-6">
                      <h3 className="text-amber-300 font-bold mb-3 flex items-center gap-2">
                        <PartyPopper className="w-5 h-5" />
                        Mid-Year Preview
                      </h3>
                      <div className="space-y-3">
                        <div>
                          <p className="text-white/50 text-xs uppercase">Your Current Challenge Was:</p>
                          <p className="text-white">{timeCapsuleData.currentChallenge || ''}</p>
                        </div>
                        <div>
                          <p className="text-white/50 text-xs uppercase">Your Hopes For End of Year:</p>
                          <p className="text-white">{timeCapsuleData.hopesForEndOfYear || ''}</p>
                        </div>
                      </div>
                    </div>
                  )}

                  <p className="text-white/50 text-sm">
                    Come back {isEndYearUnlocked ? 'now' : isMidYearUnlocked ? 'on Dec 26' : 'on Jul 1 for your mid-year peek'} to open!
                  </p>
                </div>
              ) : timeCapsuleData && isEndYearUnlocked ? (
                /* Full capsule unlocked! */
                <div className="text-center max-w-2xl w-full">
                  <div className="w-32 h-32 mx-auto mb-6 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center shadow-2xl shadow-amber-500/30 animate-pulse">
                    <PartyPopper className="w-16 h-16 text-white" />
                  </div>
                  <h1 className="text-3xl md:text-4xl font-black text-white mb-4">
                     Your Time Capsule is Open!
                  </h1>
                  <p className="text-white/70 mb-8">
                    Created on {new Date(timeCapsuleData.createdAt).toLocaleDateString()}  Let's see what past you wrote!
                  </p>
                  
                  <div className="space-y-4 text-left">
                    {timeCapsuleData.currentMood && (
                      <div className="bg-gray-700 rounded-xl p-4">
                        <p className="text-amber-300 text-xs uppercase font-bold mb-1">Your Mood Back Then</p>
                        <p className="text-white">{timeCapsuleData.currentMood}</p>
                      </div>
                    )}
                    {timeCapsuleData.currentChallenge && (
                      <div className="bg-gray-700 rounded-xl p-4">
                        <p className="text-amber-300 text-xs uppercase font-bold mb-1">Challenge You Were Facing</p>
                        <p className="text-white">{timeCapsuleData.currentChallenge}</p>
                      </div>
                    )}
                    {timeCapsuleData.hopesForEndOfYear && (
                      <div className="bg-gray-700 rounded-xl p-4">
                        <p className="text-amber-300 text-xs uppercase font-bold mb-1">Your Hopes for End of Year</p>
                        <p className="text-white">{timeCapsuleData.hopesForEndOfYear}</p>
                      </div>
                    )}
                    {timeCapsuleData.predictionsFor2026 && (
                      <div className="bg-gray-700 rounded-xl p-4">
                        <p className="text-amber-300 text-xs uppercase font-bold mb-1">Your Predictions</p>
                        <p className="text-white">{timeCapsuleData.predictionsFor2026}</p>
                      </div>
                    )}
                    {timeCapsuleData.secretGoal && (
                      <div className="bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-xl p-4 border border-purple-500/30">
                        <p className="text-purple-300 text-xs uppercase font-bold mb-1"> Your Secret Goal</p>
                        <p className="text-white">{timeCapsuleData.secretGoal}</p>
                      </div>
                    )}
                    {timeCapsuleData.messageToFutureSelf && (
                      <div className="bg-gradient-to-r from-amber-500/20 to-orange-500/20 rounded-xl p-4 border border-amber-500/30">
                        <p className="text-amber-300 text-xs uppercase font-bold mb-1"> Message to Future You</p>
                        <p className="text-white italic">"{timeCapsuleData.messageToFutureSelf}"</p>
                      </div>
                    )}
                    {timeCapsuleData.currentFavorites && (
                      <div className="bg-gray-700 rounded-xl p-4">
                        <p className="text-amber-300 text-xs uppercase font-bold mb-1">Your Favorites Back Then</p>
                        <p className="text-white">{timeCapsuleData.currentFavorites}</p>
                      </div>
                    )}
                  </div>
                </div>
              ) : (
                /* Create new capsule */
                <div className="text-center max-w-2xl w-full">
                  <div className="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center shadow-2xl shadow-amber-500/30">
                    <Gift className="w-12 h-12 text-white" />
                  </div>
                  <h1 className="text-3xl md:text-4xl font-black text-white mb-4">
                    Create Your 2026 Time Capsule
                  </h1>
                  <p className="text-white/70 mb-8">
                    Seal a message to your future self. Opens at mid-year and year-end!
                  </p>
                  
                  <div className="space-y-4 text-left max-w-lg mx-auto">
                    <div>
                      <label className="text-amber-300 text-sm font-medium block mb-2">How are you feeling right now?</label>
                      <input
                        type="text"
                        value={timeCapsuleAnswers.currentMood}
                        onChange={(e) => setTimeCapsuleAnswers({ ...timeCapsuleAnswers, currentMood: e.target.value })}
                        placeholder="Describe your current state of mind..."
                        className="w-full bg-gray-700 border-2 border-gray-600 focus:border-amber-400 rounded-xl px-4 py-3 text-white placeholder:text-white/30 outline-none"
                      />
                    </div>
                    <div>
                      <label className="text-amber-300 text-sm font-medium block mb-2">What challenge are you facing?</label>
                      <input
                        type="text"
                        value={timeCapsuleAnswers.currentChallenge}
                        onChange={(e) => setTimeCapsuleAnswers({ ...timeCapsuleAnswers, currentChallenge: e.target.value })}
                        placeholder="Your biggest obstacle right now..."
                        className="w-full bg-gray-700 border-2 border-gray-600 focus:border-amber-400 rounded-xl px-4 py-3 text-white placeholder:text-white/30 outline-none"
                      />
                    </div>
                    <div>
                      <label className="text-amber-300 text-sm font-medium block mb-2">What do you hope to achieve by December?</label>
                      <textarea
                        value={timeCapsuleAnswers.hopesForEndOfYear}
                        onChange={(e) => setTimeCapsuleAnswers({ ...timeCapsuleAnswers, hopesForEndOfYear: e.target.value })}
                        placeholder="Your hopes and dreams for this year..."
                        className="w-full bg-gray-700 border-2 border-gray-600 focus:border-amber-400 rounded-xl px-4 py-3 text-white placeholder:text-white/30 outline-none resize-none h-24"
                      />
                    </div>
                    <div>
                      <label className="text-amber-300 text-sm font-medium block mb-2">Make a prediction for 2026 </label>
                      <input
                        type="text"
                        value={timeCapsuleAnswers.predictionsFor2026}
                        onChange={(e) => setTimeCapsuleAnswers({ ...timeCapsuleAnswers, predictionsFor2026: e.target.value })}
                        placeholder="Something you think will happen..."
                        className="w-full bg-gray-700 border-2 border-gray-600 focus:border-amber-400 rounded-xl px-4 py-3 text-white placeholder:text-white/30 outline-none"
                      />
                    </div>
                    <div>
                      <label className="text-purple-300 text-sm font-medium block mb-2"> Secret goal (just between you and future you)</label>
                      <input
                        type="text"
                        value={timeCapsuleAnswers.secretGoal}
                        onChange={(e) => setTimeCapsuleAnswers({ ...timeCapsuleAnswers, secretGoal: e.target.value })}
                        placeholder="Something you haven't told anyone..."
                        className="w-full bg-gray-700 border-2 border-purple-500/30 focus:border-purple-400 rounded-xl px-4 py-3 text-white placeholder:text-white/30 outline-none"
                      />
                    </div>
                    <div>
                      <label className="text-amber-300 text-sm font-medium block mb-2">Message to your future self </label>
                      <textarea
                        value={timeCapsuleAnswers.messageToFutureSelf}
                        onChange={(e) => setTimeCapsuleAnswers({ ...timeCapsuleAnswers, messageToFutureSelf: e.target.value })}
                        placeholder="Dear future me..."
                        className="w-full bg-gray-700 border-2 border-gray-600 focus:border-amber-400 rounded-xl px-4 py-3 text-white placeholder:text-white/30 outline-none resize-none h-32"
                      />
                    </div>
                    <div>
                      <label className="text-amber-300 text-sm font-medium block mb-2">Current favorites (song, show, food, etc)</label>
                      <input
                        type="text"
                        value={timeCapsuleAnswers.currentFavorites}
                        onChange={(e) => setTimeCapsuleAnswers({ ...timeCapsuleAnswers, currentFavorites: e.target.value })}
                        placeholder="What you're loving right now..."
                        className="w-full bg-gray-700 border-2 border-gray-600 focus:border-amber-400 rounded-xl px-4 py-3 text-white placeholder:text-white/30 outline-none"
                      />
                    </div>
                  </div>

                  <button
                    onClick={saveTimeCapsule}
                    className="mt-8 px-8 py-4 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 text-white rounded-xl font-bold transition-all flex items-center gap-2 mx-auto shadow-lg shadow-amber-500/25"
                  >
                    <Lock className="w-5 h-5" />
                    Seal My Time Capsule
                  </button>
                  <p className="text-white/40 text-xs mt-4">
                    Once sealed, you can peek at mid-year (Jul 1) and open fully on Dec 26
                  </p>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Habit Breakdown Modal */}
        {showHabitBreakdown && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl p-6 w-full max-w-lg max-h-[80vh] overflow-hidden flex flex-col">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                  {showHabitBreakdown === 'exceeded' && <><Award className="w-5 h-5 text-green-500" /> Exceeded Goals</>}
                  {showHabitBreakdown === 'missed' && <><XCircle className="w-5 h-5 text-red-500" /> Missed Goals</>}
                  {showHabitBreakdown === 'completed' && <><CheckCircle2 className="w-5 h-5 text-blue-500" /> Completed Goals</>}
                  {showHabitBreakdown === 'total' && <><Target className="w-5 h-5 text-purple-500" /> All Habits</>}
                </h3>
                <button onClick={() => setShowHabitBreakdown(null)} className="text-gray-400 hover:text-gray-600">
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              <p className="text-sm text-gray-500 mb-4">
                {dashboardView === 'personal' ? 'Your habits  ' : 'Team  '}
                {scorecardRange === 'week' ? 'This week' : scorecardRange === '4weeks' ? 'Last 4 weeks' : scorecardRange === 'quarter' ? 'This quarter' : 'All time'}
              </p>
              
              <div className="overflow-y-auto flex-1 space-y-2">
                {(() => {
                  let habitsToShow = dashboardView === 'personal' ? myRangeHabits : getRangeHabits;
                  if (showHabitBreakdown === 'exceeded') {
                    habitsToShow = habitsToShow.filter(h => getStatus(h) === 'Exceeded');
                  } else if (showHabitBreakdown === 'missed') {
                    habitsToShow = habitsToShow.filter(h => getStatus(h) === 'Missed');
                  } else if (showHabitBreakdown === 'completed') {
                    habitsToShow = habitsToShow.filter(h => ['Done', 'Exceeded'].includes(getStatus(h)));
                  }
                  
                  // Group by habit name to show frequency
                  const habitFrequency = {};
                  habitsToShow.forEach(h => {
                    if (!habitFrequency[h.habit]) {
                      habitFrequency[h.habit] = { habit: h.habit, participant: h.participant, count: 0, totalCompleted: 0, totalTarget: 0 };
                    }
                    habitFrequency[h.habit].count++;
                    habitFrequency[h.habit].totalCompleted += h.daysCompleted?.length || 0;
                    habitFrequency[h.habit].totalTarget += h.target || 0;
                  });
                  
                  const sortedHabits = Object.values(habitFrequency).sort((a, b) => b.count - a.count);
                  
                  if (sortedHabits.length === 0) {
                    return (
                      <div className="text-center py-8 text-gray-400">
                        No habits in this category
                      </div>
                    );
                  }
                  
                  return sortedHabits.map((h, idx) => {
                    const rate = h.totalTarget > 0 ? Math.round((h.totalCompleted / h.totalTarget) * 100) : 0;
                    return (
                      <div key={idx} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div className="flex-1">
                          <p className="font-medium text-gray-800 text-sm">{h.habit}</p>
                          <p className="text-xs text-gray-500">{h.participant}  {h.count} week{h.count > 1 ? 's' : ''}</p>
                        </div>
                        <div className="text-right">
                          <p className={`font-bold text-sm ${rate >= 100 ? 'text-green-600' : rate >= 70 ? 'text-blue-600' : rate >= 50 ? 'text-amber-600' : 'text-red-600'}`}>
                            {rate}%
                          </p>
                          <p className="text-xs text-gray-400">{h.totalCompleted}/{h.totalTarget}</p>
                        </div>
                      </div>
                    );
                  });
                })()}
              </div>
              
              <button 
                onClick={() => setShowHabitBreakdown(null)}
                className="w-full mt-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200"
              >
                Close
              </button>
            </div>
          </div>
        )}

        {/* Analytics Modal */}
        {showAnalytics && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className={`rounded-2xl w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
              <div className={`p-4 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                <div className="flex items-center justify-between">
                  <h3 className={`text-lg font-bold flex items-center gap-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    <BarChart3 className="w-5 h-5 text-green-500" />
                    Analytics
                  </h3>
                  <button onClick={() => setShowAnalytics(false)} className="text-gray-400 hover:text-gray-600">
                    <X className="w-5 h-5" />
                  </button>
                </div>
                
                {/* Analytics Tabs */}
                <div className={`flex gap-1 mt-3 p-1 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                  {[
                    { id: 'overview', label: 'Overview' },
                    { id: 'days', label: 'Best/Worst Days' },
                    { id: 'streaks', label: 'Habit Streaks' },
                    { id: 'correlations', label: 'Correlations' }
                  ].map(tab => (
                    <button
                      key={tab.id}
                      onClick={() => setAnalyticsTab(tab.id)}
                      className={`flex-1 py-2 px-2 rounded-md text-xs font-medium transition-colors ${
                        analyticsTab === tab.id
                          ? darkMode ? 'bg-gray-600 text-white' : 'bg-white text-gray-800 shadow-sm'
                          : darkMode ? 'text-gray-400' : 'text-gray-600'
                      }`}
                    >
                      {tab.label}
                    </button>
                  ))}
                </div>
              </div>
              
              <div className="p-4 overflow-y-auto flex-1">
                {/* Overview Tab */}
                {analyticsTab === 'overview' && (
                  <div className="space-y-4">
                    <div className="grid grid-cols-2 gap-3">
                      <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-blue-50'}`}>
                        <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-blue-600'}`}>Current Streak</p>
                        <p className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-blue-700'}`}>
                          {calculateStreaks[myParticipant] || 0} weeks
                        </p>
                      </div>
                      <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-green-50'}`}>
                        <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-green-600'}`}>Best Day</p>
                        <p className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-green-700'}`}>
                          {dayAnalytics.best?.day || '-'}
                        </p>
                        <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-green-600'}`}>
                          {dayAnalytics.best?.rate || 0}% completion
                        </p>
                      </div>
                    </div>
                    
                    <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-amber-50'}`}>
                      <h4 className={`font-semibold mb-2 ${darkMode ? 'text-white' : 'text-amber-800'}`}>
                         Quick Stats
                      </h4>
                      <div className="grid grid-cols-2 gap-2 text-sm">
                        <div className={darkMode ? 'text-gray-300' : 'text-amber-700'}>
                          Total habits tracked: <strong>{Object.keys(habitStreaks).length}</strong>
                        </div>
                        <div className={darkMode ? 'text-gray-300' : 'text-amber-700'}>
                          Habit correlations: <strong>{habitCorrelations.length}</strong>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Best/Worst Days Tab */}
                {analyticsTab === 'days' && (
                  <div className="space-y-4">
                    <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                      Your completion rate by day of the week
                    </p>
                    
                    <div className="space-y-2">
                      {dayAnalytics.dayStats.map((day, idx) => (
                        <div key={idx} className="flex items-center gap-3">
                          <span className={`w-12 text-sm font-medium ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                            {day.day}
                          </span>
                          <div className={`flex-1 h-6 rounded-full overflow-hidden ${darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}>
                            <div 
                              className={`h-full rounded-full ${
                                day.rate >= 80 ? 'bg-green-500' : day.rate >= 50 ? 'bg-blue-500' : 'bg-amber-500'
                              }`}
                              style={{ width: `${day.rate}%` }}
                            />
                          </div>
                          <span className={`w-12 text-sm font-medium text-right ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                            {day.rate}%
                          </span>
                        </div>
                      ))}
                    </div>
                    
                    {dayAnalytics.best && dayAnalytics.worst && (
                      <div className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-blue-50'}`}>
                        <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-blue-700'}`}>
                           <strong>Insight:</strong> You perform best on <strong>{dayAnalytics.best.day}</strong> ({dayAnalytics.best.rate}%) 
                          and may need more focus on <strong>{dayAnalytics.worst.day}</strong> ({dayAnalytics.worst.rate}%).
                        </p>
                      </div>
                    )}
                  </div>
                )}
                
                {/* Habit Streaks Tab */}
                {analyticsTab === 'streaks' && (
                  <div className="space-y-3">
                    {Object.keys(habitStreaks).length === 0 ? (
                      <p className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        No habit data yet. Start tracking to see streaks!
                      </p>
                    ) : (
                      Object.entries(habitStreaks)
                        .sort((a, b) => b[1].currentStreak - a[1].currentStreak)
                        .map(([key, streak]) => (
                          <div key={key} className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                            <div className="flex items-center justify-between">
                              <span className={`font-medium ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                                {streak.displayName}
                              </span>
                              <div className="flex items-center gap-2">
                                {streak.currentStreak > 0 && (
                                  <span className="flex items-center gap-1 text-orange-500 font-medium">
                                    <Flame className="w-4 h-4" />
                                    {streak.currentStreak}
                                  </span>
                                )}
                              </div>
                            </div>
                            <div className={`text-xs mt-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              Best: {streak.longestStreak} weeks  Total: {streak.totalDays} days  Avg: {streak.avgPerWeek}/week
                            </div>
                          </div>
                        ))
                    )}
                  </div>
                )}
                
                {/* Correlations Tab */}
                {analyticsTab === 'correlations' && (
                  <div className="space-y-3">
                    {habitCorrelations.length === 0 ? (
                      <p className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                        Need at least 2 weeks of data with multiple habits to find correlations.
                      </p>
                    ) : (
                      <>
                        <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                          Habits you tend to complete together
                        </p>
                        {habitCorrelations.map((corr, idx) => (
                          <div key={idx} className={`p-3 rounded-lg ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                            <div className="flex items-center justify-between mb-2">
                              <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                                {corr.habit1} + {corr.habit2}
                              </span>
                              <span className={`font-bold ${corr.correlation >= 70 ? 'text-green-500' : corr.correlation >= 40 ? 'text-blue-500' : 'text-gray-500'}`}>
                                {corr.correlation}%
                              </span>
                            </div>
                            <div className={`h-2 rounded-full overflow-hidden ${darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
                              <div 
                                className={`h-full rounded-full ${corr.correlation >= 70 ? 'bg-green-500' : corr.correlation >= 40 ? 'bg-blue-500' : 'bg-gray-400'}`}
                                style={{ width: `${corr.correlation}%` }}
                              />
                            </div>
                          </div>
                        ))}
                        
                        {habitCorrelations.length > 0 && habitCorrelations[0].correlation >= 60 && (
                          <div className={`p-3 rounded-lg ${darkMode ? 'bg-green-900/30' : 'bg-green-50'}`}>
                            <p className={`text-sm ${darkMode ? 'text-green-300' : 'text-green-700'}`}>
                               <strong>Insight:</strong> "{habitCorrelations[0].habit1}" and "{habitCorrelations[0].habit2}" 
                              are often done together. Try stacking them as a routine!
                            </p>
                          </div>
                        )}
                      </>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Monthly Report Modal */}
        {showMonthlyReport && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className={`rounded-2xl w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col ${darkMode ? 'bg-gray-800' : 'bg-white'}`}>
              <div className={`p-4 border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                <div className="flex items-center justify-between">
                  <h3 className={`text-lg font-bold flex items-center gap-2 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    <Calendar className="w-5 h-5 text-indigo-500" />
                    Monthly Report
                  </h3>
                  <button onClick={() => setShowMonthlyReport(false)} className="text-gray-400 hover:text-gray-600">
                    <X className="w-5 h-5" />
                  </button>
                </div>
                
                {/* Month Selector */}
                <div className="flex items-center justify-center gap-4 mt-3">
                  <button
                    onClick={() => setReportMonth(prev => {
                      const newMonth = prev.month === 0 ? 11 : prev.month - 1;
                      const newYear = prev.month === 0 ? prev.year - 1 : prev.year;
                      return { year: newYear, month: newMonth };
                    })}
                    className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'}`}
                  >
                    <ChevronLeft className="w-5 h-5" />
                  </button>
                  <span className={`text-lg font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                    {monthlyStats?.monthName || new Date(reportMonth.year, reportMonth.month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                  </span>
                  <button
                    onClick={() => setReportMonth(prev => {
                      const newMonth = prev.month === 11 ? 0 : prev.month + 1;
                      const newYear = prev.month === 11 ? prev.year + 1 : prev.year;
                      return { year: newYear, month: newMonth };
                    })}
                    className={`p-2 rounded-lg ${darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'}`}
                  >
                    <ChevronRight className="w-5 h-5" />
                  </button>
                </div>
              </div>
              
              <div className="p-4 overflow-y-auto flex-1">
                {!monthlyStats ? (
                  <div className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                    <Calendar className="w-12 h-12 mx-auto mb-3 opacity-30" />
                    <p>No data for this month</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {/* Summary Stats */}
                    <div className="grid grid-cols-3 gap-3">
                      <div className={`p-3 rounded-xl text-center ${darkMode ? 'bg-gray-700' : 'bg-indigo-50'}`}>
                        <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-indigo-700'}`}>
                          {monthlyStats.completionRate}%
                        </p>
                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-indigo-600'}`}>Completion</p>
                      </div>
                      <div className={`p-3 rounded-xl text-center ${darkMode ? 'bg-gray-700' : 'bg-green-50'}`}>
                        <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-green-700'}`}>
                          {monthlyStats.perfectWeeks}
                        </p>
                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-green-600'}`}>Perfect Weeks</p>
                      </div>
                      <div className={`p-3 rounded-xl text-center ${darkMode ? 'bg-gray-700' : 'bg-amber-50'}`}>
                        <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-amber-700'}`}>
                          {monthlyStats.totalCompleted}
                        </p>
                        <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-amber-600'}`}>Days Done</p>
                      </div>
                    </div>
                    
                    {/* Weekly Breakdown */}
                    <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                      <h4 className={`font-semibold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                        Weekly Breakdown
                      </h4>
                      <div className="space-y-2">
                        {monthlyStats.weeklyBreakdown.map((week, idx) => (
                          <div key={idx} className="flex items-center gap-3">
                            <span className={`text-xs w-16 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                              {formatWeekString(week.week)}
                            </span>
                            <div className={`flex-1 h-4 rounded-full overflow-hidden ${darkMode ? 'bg-gray-600' : 'bg-gray-200'}`}>
                              <div 
                                className={`h-full rounded-full ${week.rate >= 100 ? 'bg-green-500' : week.rate >= 70 ? 'bg-blue-500' : 'bg-amber-500'}`}
                                style={{ width: `${Math.min(week.rate, 100)}%` }}
                              />
                            </div>
                            <span className={`text-xs w-10 text-right font-medium ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                              {week.rate}%
                            </span>
                          </div>
                        ))}
                      </div>
                    </div>
                    
                    {/* Top Habits */}
                    {monthlyStats.topHabits.length > 0 && (
                      <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                        <h4 className={`font-semibold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                           Top Habits
                        </h4>
                        <div className="space-y-2">
                          {monthlyStats.topHabits.map((h, idx) => (
                            <div key={idx} className="flex items-center justify-between">
                              <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>{h.name}</span>
                              <span className={`text-sm font-medium ${h.rate >= 80 ? 'text-green-500' : h.rate >= 50 ? 'text-blue-500' : 'text-amber-500'}`}>
                                {h.rate}%
                              </span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
      </div>
      <MobileNav activeView={activeView} setActiveView={setActiveView} darkMode={darkMode} onAddHabit={() => setShowAddHabitModal(true)} />
    </div>
  );
}
